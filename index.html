<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="liguang.zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/15/test5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/15/test5/" class="post-title-link" itemprop="url">test5</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-15 17:19:30" itemprop="dateCreated datePublished" datetime="2024-04-15T17:19:30+08:00">2024-04-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/15/search/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/15/search/" class="post-title-link" itemprop="url">search</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-15 16:45:55" itemprop="dateCreated datePublished" datetime="2024-04-15T16:45:55+08:00">2024-04-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/15/test3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/15/test3/" class="post-title-link" itemprop="url">test3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-15 16:41:16" itemprop="dateCreated datePublished" datetime="2024-04-15T16:41:16+08:00">2024-04-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/15/test2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/15/test2/" class="post-title-link" itemprop="url">test2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-15 11:33:52" itemprop="dateCreated datePublished" datetime="2024-04-15T11:33:52+08:00">2024-04-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/15/test1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/15/test1/" class="post-title-link" itemprop="url">test1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-04-15 11:20:09 / 修改时间：13:47:39" itemprop="dateCreated datePublished" datetime="2024-04-15T11:20:09+08:00">2024-04-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">0</span>  sm_init (cold_boot=cold_boot@entry=<span class="number">1</span>) at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/lib/sbi/optee/sm.c:<span class="number">120</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x00000000a00026aa</span> in <span class="title function_">nuclei_final_init</span> <span class="params">(cold_boot=&lt;optimized out&gt;)</span></span><br><span class="line">    at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/platform/nuclei/evalsoc/platform.c:66</span><br><span class="line">#2  0x00000000a0000c18 in <span class="title function_">sbi_platform_final_init</span> <span class="params">(cold_boot=<span class="number">1</span>, plat=<span class="number">0xa00138a8</span> &lt;platform&gt;)</span></span><br><span class="line">    at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/include/sbi/sbi_platform.h:401</span><br><span class="line">#3  <span class="title function_">init_coldboot</span> <span class="params">(hartid=<span class="number">0</span>, scratch=<span class="number">0xa002d000</span>)</span> at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/lib/sbi/sbi_init.c:295</span><br><span class="line">#4  <span class="title function_">sbi_init</span> <span class="params">(scratch=<span class="number">0xa002d000</span>)</span> at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/lib/sbi/sbi_init.c:425</span><br><span class="line">#5  0x00000000a00004b6 in _<span class="title function_">start_warm</span> <span class="params">()</span> at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/firmware/fw_base.S:443</span><br></pre></td></tr></table></figure>

<p>重点关注 sm_init 函数</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">-+ void sm_init<span class="params">(bool cold_boot)</span></span><br><span class="line"> \ -|+ if cold_boot</span><br><span class="line">     \ -+ sbi_ecall_register_extension<span class="params">(&amp;ecall_optee)</span>;</span><br><span class="line">        \ -  .extid_start = SBI_EXT_OPTEE  <span class="string">&quot;0x4F505445&quot;</span></span><br><span class="line">        | -  .handle = sbi_ecall_optee_handler,  <span class="string">&quot;注册 optee ext handler&quot;</span></span><br><span class="line">     | -  sm_region_id = smm_init(); <span class="string">&quot;添加 opensbi text 段 pmp entry， 并保存 id为 sm_region_id&quot;</span></span><br><span class="line">     | -  os_region_id = osm_init(); <span class="string">&quot;添加 0xfffffffff bottom entry&quot;</span></span><br><span class="line">     | -  tee_region_id = teem_init(); <span class="string">&quot;添加 FW_OPTEE_TZDRAM_BASE  optee_os 的text 内存 pmp entry&quot;</span></span><br><span class="line">     | -  shm_region_id = shm_init(); <span class="string">&quot;添加 share memory （secure与non sec 的共享内存的） pmp entry&quot;</span></span><br><span class="line">     | -  plicm_region_id = plicm_init(); <span class="string">&quot;添加 plic 的 mmio的 pmp entry&quot;</span></span><br><span class="line">     | -  timer_region_id = timerm_init(); <span class="string">&quot;添加 timer 的 mmio的pmp entry&quot;</span></span><br><span class="line">  <span class="string">&quot;没有判断 cold_boot 说明是所有核都会走&quot;</span></span><br><span class="line">| -+ pmp_init() <span class="string">&quot;将所有可用的 pmpaddr pmpcfg 置0&quot;</span></span><br><span class="line">| -+ pmp_set_keystone(sm_region_id, PMP_NO_PERM); <span class="string">&quot;设置 opensbi text 段不可读，这个是对 S-mode 有效，对 M-mode 不起作用&quot;</span></span><br><span class="line">| -+ pmp_set_keystone(os_region_id, PMP_ALL_PERM); <span class="string">&quot;设置优先级最低的 osm entry 0xfffffffff 保底读写执行权限，排在它前面的 entry 如果设置了不一样的权限， 以前面的 entry 设置的为准&quot;</span></span><br><span class="line">| -+ pmp_set_keystone(tee_region_id, PMP_NO_PERM); <span class="string">&quot;设置 optee text 无权限&quot;</span></span><br><span class="line">| -|+ <span class="keyword">if</span> cold_boot</span><br><span class="line">    \ -+ opteed_init()</span><br><span class="line">       \ -  sbi_memset(psci_ns_context, <span class="number">0</span>, sizeof(psci_ns_context));  <span class="string">&quot;normal world context 初始化为 0&quot;</span></span><br><span class="line">       | -  sbi_memset(opteed_sp_context, <span class="number">0</span>, sizeof(opteed_sp_context)); <span class="string">&quot;secure world context 初始化为 0&quot;</span></span><br><span class="line">       | -+ img_entry_point.sec_attr = SECURE;   <span class="string">&quot;保存状态， 后面会用. 该结构体最终会被放到 当前 cpu context 中&quot;</span></span><br><span class="line">       | -+ img_entry_point.pc = OPTEE_OS_LOAD_ADDR;  <span class="string">&quot;optee 的 text 段起始地址&quot;</span></span><br><span class="line">       | -  img_entry_point.arg0 = current_hartid(); <span class="string">&quot;cpu core id&quot;</span></span><br><span class="line">       | -  img_entry_point.arg1 = <span class="number">8</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">       | -  img_entry_point.arg2 = FW_JUMP_FDT_ADDR; <span class="string">&quot;fdt 的地址，optee 和 opensbi 共用一个 fdt&quot;</span></span><br><span class="line">       | -+ cm_init_my_context(&amp;img_entry_point); </span><br><span class="line">          \ -+ cm_init_context_by_index(current_hartid(), &amp;img_entry_point);</span><br><span class="line">             \ -+ ctx = cm_get_context_by_index(cpu_idx, &amp;img_entry_point-&gt;sec_attr);  <span class="string">&quot;根据 cpu id 和 sec_attr 属性找到 context 指针&quot;</span></span><br><span class="line">                \ -  <span class="keyword">if</span> secure? &amp;opteed_sp_context[cpu_idx].cpu_ctx : &amp;psci_ns_context[cpu_idx]; </span><br><span class="line">		                <span class="string">&quot;secure 和 non sec 分别有一个context 数组， 按cpuid 保存对应的 当前cpu的context&quot;</span></span><br><span class="line">		     | -+ cm_setup_context(ctx, ep); <span class="string">&quot;填 context &quot;</span></span><br><span class="line">		        \ -  ctx-&gt;sec_attr = (ep-&gt;sec_attr == SECURE) ? SECURE : NON_SECURE;</span><br><span class="line">		        | -  ctx-&gt;gp_regs.mepc = ep-&gt;pc;</span><br><span class="line">		        | -  ctx-&gt;gp_regs.mstatus = (<span class="number">1</span> &lt;&lt; MSTATUS_MPP_SHIFT);  <span class="string">&quot;S-mode&quot;</span></span><br><span class="line">		        | -  ctx-&gt;gp_regs.a0 = ep-&gt;arg0;</span><br><span class="line">		        | -  ctx-&gt;gp_regs.a1 = ep-&gt;arg1;</span><br><span class="line">		        | -  ctx-&gt;gp_regs.a2 = ep-&gt;arg2;</span><br><span class="line">		        | -  ctx-&gt;gp_regs....   直到 arg7</span><br><span class="line">		        | -|+ <span class="keyword">if</span> ep-&gt;sec_attr == SECURE</span><br><span class="line">		            \ -  ctx-&gt;s_csrs.sie = <span class="number">0</span>;   <span class="string">&quot;初始 sie 为0, S-mode 中断关闭&quot;</span></span><br><span class="line">	  | -  saved_mie = csr_read(CSR_MIE); <span class="string">&quot;保存中断使能状态&quot;</span></span><br><span class="line">	  | -  csr_write(CSR_MIE, <span class="number">0</span>); <span class="string">&quot;关闭所有中断&quot;</span></span><br><span class="line">	  | -  rc = opteed_synchronous_sp_entry(optee_ctx); <span class="string">&quot;进入 sec world optee_os 的准备工作, 及要进入 optee_os, 下面拆解&quot;</span></span><br><span class="line">	  -----------------------------------------------------------------------------------------------------</span><br><span class="line">	     <span class="string">&quot;回到 M-mode的 opensbi&quot;</span></span><br><span class="line">	  -----------------------------------------------------------------------------------------------------</span><br><span class="line">	  | -+ ... sbi_ecall_optee_handler 处理流程 --&gt;<span class="number">1</span> </span><br><span class="line">	  | -  csr_write(CSR_MIE, saved_mie); <span class="string">&quot;恢复中断状态&quot;</span></span><br><span class="line">	  | -  sbi_memset(&amp;img_entry_point, <span class="number">0</span>, sizeof(entry_point_info_t));</span><br><span class="line">	  | -  img_entry_point.sec_attr = NON_SECURE;　<span class="string">&quot;下一个 image　为　non sec 的 u-boot&quot;</span></span><br><span class="line">	  | -  cm_init_my_context(&amp;img_entry_point); <span class="string">&quot;初始化 non sec 的 context&quot;</span></span><br><span class="line">	  | -  cm_set_next_eret_context(NON_SECURE);       </span><br></pre></td></tr></table></figure>

<p>下面对 opteed_synchronous_sp_entry 进行拆解</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-+ uint64_t opteed_synchronous_sp_entry<span class="params">(optee_context_t *optee_ctx)</span></span><br><span class="line"> \ -+ cm_sysregs_context_restore<span class="params">(SECURE)</span>; &quot;从context 中恢复 s 开头的 csr, 这里主要是 sepc sie &quot;</span><br><span class="line"> | -+ cm_set_next_eret_context<span class="params">(SECURE)</span>;</span><br><span class="line">    \ -+ ctx = cm_get_context<span class="params">(security_state)</span>; &quot;拿 当前 cpu的 context 指针&quot;</span><br><span class="line">    | -+ cm_set_next_context<span class="params">(ctx)</span>; </span><br><span class="line">       \ -  next_cpu_context_ptr[current_hartid<span class="params">()</span>] = context; &quot;设置 next_cpu_context_ptr 全局变量, 保存当前cpu的下一个 context&quot;</span><br><span class="line">    | -|+ if secure_state == SECURE ?</span><br><span class="line">        \ -+ switch_plic_int_enable_mode<span class="params">(SECURE)</span>; &quot;设置中断使能状态为 secure_state 方案&quot;</span><br><span class="line">        | -+ switch_vector_sec<span class="params">()</span>;</span><br><span class="line">           \ -  csr_write<span class="params">(CSR_MTVEC, &amp;_trap_handler_sec)</span>;  &quot;设置 secure 方案的 trap handler&quot;</span><br><span class="line">        | -  osm_pmp_set<span class="params">(PMP_NO_PERM)</span>; &quot;bottom pmp entry 设置所有内存无权限&quot;</span><br><span class="line">        | -  shm_pmp_set<span class="params">(PMP_ALL_PERM)</span>; &quot;sec 与 non sec 的 share memory 设置 all 权限&quot;</span><br><span class="line">        | -  plicm_pmp_set<span class="params">(PMP_ALL_PERM)</span>;</span><br><span class="line">        | -  timerm_pmp_set<span class="params">(PMP_ALL_PERM)</span>;</span><br><span class="line">        | -  teem_pmp_set<span class="params">(PMP_ALL_PERM)</span>;  &quot;设置 tee 的 text data bss 等的 all 权限&quot;</span><br><span class="line"> | -+ rc = opteed_enter_sp<span class="params">(&amp;optee_ctx-&gt;c_rt_ctx)</span>; &quot;进入汇编函数, 保存当前 opensbi的 cpu context, </span><br><span class="line">						 恢复 context 中保存的上下文, 即为 optee_os 准备的初始的 cpu context&quot;</span><br><span class="line">    \ -  REG_L s1, SBI_TRAP_REGS_OFFSET<span class="params">(mepc)</span><span class="params">(s0)</span></span><br><span class="line">    | -  csrw CSR_MEPC, s1</span><br><span class="line">    | -  REG_L s1, SBI_TRAP_REGS_OFFSET<span class="params">(mstatus)</span><span class="params">(s0)</span></span><br><span class="line">    | -  csrw CSR_MSTATUS, s1</span><br><span class="line">    | -  mret &quot;进入到 optee_os, M-mode 切换为 S-mode&quot; </span><br></pre></td></tr></table></figure>

<p>–&gt;1  optee_os 初始化完毕后, 会发 ecall 调用, 调用号 SBI_EXT_OPTEE “0x4F505445” 回到 opensbi 中, opensbi 由前面设置的 <code>_trap_handler_sec</code> 处理, 进而由<br>opensbi <code>sbi_ecall_optee_handler</code> 处理该 ecall 调用,其中 funcid 为 <code>TEESMC_OPTEED_RETURN_ENTRY_DONE</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-+ static int sbi_ecall_optee_handler<span class="params">(unsigned long extid, unsigned long funcid,</span></span><br><span class="line"><span class="params">				    const struct sbi_trap_regs *regs,</span></span><br><span class="line"><span class="params">				    unsigned long *out_val,</span></span><br><span class="line"><span class="params">				    struct sbi_trap_info *out_trap)</span></span><br><span class="line"> \ -+ switch <span class="params">(funcid)</span></span><br><span class="line">    \ -+ case TEESMC_OPTEED_RETURN_ENTRY_DONE			  </span><br><span class="line">       \ -+ cm_gpregs_context_save<span class="params">(SECURE, regs)</span>; &quot;保存 optee_os 的上下文到 context 中&quot;</span><br><span class="line">          \ -  ctx = cm_get_context<span class="params">(security_state)</span>;</span><br><span class="line">          | -  sbi_memcpy<span class="params">(&amp;ctx-&gt;gp_regs, trap_reg, sizeof(struct sbi_trap_regs))</span>;  &quot;regs 已经由 _trap_handler_sec 保存下来了, 这里转移到 context 下&quot;</span><br><span class="line">       | -+ cm_sysregs_context_save<span class="params">(SECURE)</span>; &quot;保存 s 开头的 csr 到 context 下, 这里不用参数, 因为 M-mode 基本上不会改动 S-mode 的寄存器, 直接读即可&quot;</span><br><span class="line">       | -  optee_vector_table = <span class="params">(optee_vectors_t *)</span> regs-&gt;a1; &quot;regs-&gt;a1锚点 optee_os的 thread_vector_table 基址在 ecall 时会保存到 a1 寄存器中, 进而转移到这里&quot;</span><br><span class="line">       | -  if optee_vector_table ? set_optee_pstate<span class="params">(optee_ctx-&gt;state, OPTEE_PSTATE_ON)</span> &quot;optee_os的 power state, 这里on 表示正在运行&quot;</span><br><span class="line">       | -+ opteed_synchronous_sp_exit<span class="params">(optee_ctx, regs-&gt;a1)</span>; &quot;回到 进入 optee_os 时的地方&quot;</span><br><span class="line">          \ -+ cm_sysregs_context_save<span class="params">(SECURE)</span>;</span><br><span class="line">             \ -+ opteed_exit_sp<span class="params">(optee_ctx-&gt;c_rt_ctx, ret)</span>;</span><br><span class="line">                \ -  REG_L s0, <span class="params">(<span class="number">12</span>-<span class="number">13</span>)</span> * __SIZEOF_POINTER__<span class="params">(sp)</span></span><br><span class="line">                | -  ... <span class="string">&quot;恢复 callee 即 s0-s11 寄存器&quot;</span></span><br><span class="line">                | -  REG_L ra, (<span class="number">0</span>-<span class="number">13</span>) * __SIZEOF_POINTER__(sp) <span class="string">&quot;恢复 ra&quot;</span></span><br><span class="line">                | -  ret <span class="string">&quot;回到 进入 optee_os 时的地方 接着往下执行&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="optee-os-启动流程"><a href="#optee-os-启动流程" class="headerlink" title="optee_os 启动流程"></a>optee_os 启动流程</h1><p>上面讲到在调用 opteed_synchronous_sp_entry-&gt;opteed_enter_sp mret 后进入了 optee_os 中<br>下面就讲下 optee_os 的启动流程.</p>
<p>optee_os&#x2F;core&#x2F;arch&#x2F;riscv&#x2F;kernel&#x2F;entry.S</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">-+ _start</span><br><span class="line"> \ -  mv s1, a0 &quot;保存hartid&quot;</span><br><span class="line"> | -  la a0, reset_vect_table</span><br><span class="line"> | -  csrw stvec, a0 &quot;保存 stvec 中断入口 为 reset_vect_table&quot;</span><br><span class="line"> | -+ clear_bss __bss_start, __bss_end</span><br><span class="line"> | -+ set_sp s1 &quot;为 hartid 设置 sp&quot;</span><br><span class="line"> | -+ jal thread_init_thread_core_local &quot;初始化线程本地存储&quot;</span><br><span class="line"> | -+ jal dcache_cleaninv_range __text_start, cached_mem_end  &quot;dcache inv clean&quot;</span><br><span class="line"> | -+ jal console_init &quot;初始化console&quot;</span><br><span class="line"> | -+ jal core_init_mmu_map<span class="params">(<span class="number">0</span>, boot_mmu_config)</span> &quot;初始化mmu 映射mmu 页表&quot;</span><br><span class="line"> | -+ jal enable_mmu<span class="params">(hartid)</span> &quot;开启mmu&quot;</span><br><span class="line"> | -+ jal boot_init_primary_early &quot;主核初始化&quot;</span><br><span class="line">    \ -+ init_primary<span class="params">()</span></span><br><span class="line">       \ -+ thread_init_core_local_stacks<span class="params">()</span> &quot;由于std smc需要支持线程（thread）功能，而每个线程都需要含有独立的线程栈，</span><br><span class="line">		       用于保存该线程相关的上下文。该函数用于为每个cpu核初始化相关的线程栈, tmp_stack_va_end用于指定每个ARM核的栈空间&quot;</span><br><span class="line">	   | -+ thread_set_exceptions<span class="params">(THREAD_EXCP_ALL)</span>;  &quot;由于在接下来的初始化流程中需要切换异常向量表的基地址，</span><br><span class="line">						   因此在切换之前需要先mask掉相关的异常使能位&quot;     </span><br><span class="line">	   | -  primary_save_cntfrq<span class="params">()</span>	&quot;未实现&quot;			   </span><br><span class="line">       | -  init_vfp_sec<span class="params">()</span>  &quot;未实现,初始化浮点运算单元vfp&quot; </span><br><span class="line">       | -  thread_get_core_local<span class="params">()</span>-&gt;curr_thread = 0;  &quot;curr_thread用于表示当前核使用的是哪个线程空间。&quot;</span><br><span class="line">       | -+ init_runtime<span class="params">()</span>; &quot;初始化tee运行时所需的各种内存&quot;</span><br><span class="line">       | -+ thread_init_boot_thread<span class="params">()</span>; &quot;将当前执行上下文转换为启动线程，</span><br><span class="line">			       它主要包括从当前cpu的线程栈内存中分配一个栈空间，初始化线程页表和线程状态等&quot;</span><br><span class="line">	   | -+ thread_init_primary<span class="params">()</span>;	&quot;该函数主要用于增强线程的运行安全，如设置线程栈的canary值，以用于监测栈溢出&quot;</span><br><span class="line">	   | -+ thread_init_per_cpu<span class="params">()</span>;  </span><br><span class="line">	      \ -+ thread_init_tvec<span class="params">()</span>;	 &quot;为每个cpu 设置中断入口为 thread_trap_vect&quot;</span><br><span class="line">	   | -+ init_sec_mon<span class="params">(nsec_entry)</span>;   &quot;未实现&quot;</span><br><span class="line"> | -+ jal boot_init_primary_late<span class="params">(fdt)</span>	&quot;该函数用于建立optee的系统运行环境，</span><br><span class="line">					 包括从devcicetree中解析相关的配置，初始化中断控制器，调用initcall回调函数等&quot; </span><br><span class="line">	\ -+ init_external_dt<span class="params">(fdt)</span>; &quot;初始化devicetree，包括映射其物理内存，初始化dtb overlay等&quot;</span><br><span class="line">	| -+ tpm_map_log_area<span class="params">(get_external_dt())</span>; &quot;初始化tpm的log buffer，其主要操作是为log buffer建立虚拟地址页表&quot;</span><br><span class="line">	| -+ discover_nsec_memory<span class="params">()</span>; &quot;optee与non secure world可通过共享内存通信，它一共支持静态映射和动态映射两种共享内存方式。</span><br><span class="line">				其中静态映射shm在optee启动时就为其建立了相应的内存页表，</span><br><span class="line">				而动态映射方式可以在运行过程中动态地为shm建立页表。该接口用于从devicetree中获取non secure内存，以支持动态共享内存机制&quot;</span><br><span class="line">	| -+ update_external_dt<span class="params">()</span>; &quot;在devicetree中添加与optee相关的一些节点和属性，这些节点和属性将由hlos内核解析并用于初始化相应的模块。</span><br><span class="line">					如它会创建/firmware/optee节点，并在该节点中配置一些与optee相关的属性&quot;</span><br><span class="line">	| -+ configure_console_from_dt<span class="params">()</span> &quot;从devicetree中解析串口参数，并将optee的控制台切换为该串口&quot;</span><br><span class="line">	| -  main_init_gic<span class="params">()</span>; &quot;未实现&quot;</span><br><span class="line">	| -  init_vfp_nsec<span class="params">()</span>; &quot;未实现&quot;</span><br><span class="line">	| -+ init_tee_runtime<span class="params">()</span>; </span><br><span class="line">	   \ -+ core_mmu_init_ta_ram<span class="params">()</span>; &quot;用户空间中使用的栈空间是从 tee_mm_sec_ddr 内存池中分配出来的，</span><br><span class="line">					   该内存池属于MEM_AREA_TA_RAM内存区域，该区域是由OPTEE分配，用于运行TA镜像。&quot;</span><br><span class="line">		 \ -+ tee_mm_init<span class="params">(&amp;tee_mm_sec_ddr, ps, size, CORE_MMU_USER_CODE_SHIFT, TEE_MM_POOL_NO_FLAGS)</span>;</span><br><span class="line">	   | -+ call_initcalls<span class="params">()</span>; --&gt;2 &quot;调用已注册的initcall回调函数, 被各模块用于注册启动时调用的初始化接口, core/include/initcall.h<span class="string">&quot;			   </span></span><br><span class="line"><span class="string"> | -+ jal thread_clr_boot_thread &quot;</span>thread 结束阶段, 将thread-&gt;state 置为 THREAD_STATE_FREE<span class="string">&quot;</span></span><br><span class="line"><span class="string"> | -+ ecall SBI_EXT_OPTEE a6-&gt;TEESMC_OPTEED_RETURN_ENTRY_DONE a1-&gt; thread_vector_table load offset --&gt;3 </span></span><br><span class="line"><span class="string">					 &quot;</span>ecall 回opensbi, 将optee_os 的 vector address load offset(此处就是其物理地址,这里mmu 是直接映射的) 放到 a1 中, 给opensbi 用, </span><br><span class="line">					 参照 sbi_ecall_optee_handler 的 regs-&gt;a1锚点 <span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p>–&gt;2 initcall 按顺序执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> preinit_early(fn)		__define_initcall(preinit, 1, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> preinit(fn)			__define_initcall(preinit, 2, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> preinit_late(fn)		__define_initcall(preinit, 3, fn)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> early_init(fn)			__define_initcall(init, 1, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> early_init_late(fn)		__define_initcall(init, 2, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> service_init(fn)		__define_initcall(init, 3, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> service_init_late(fn)		__define_initcall(init, 4, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> driver_init(fn)			__define_initcall(init, 5, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> driver_init_late(fn)		__define_initcall(init, 6, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> release_init_resource(fn)	__define_initcall(init, 7, fn)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> boot_final(fn)			__define_initcall(final, 1, fn)</span></span><br></pre></td></tr></table></figure>

<p>–&gt;3 thread_vector_table</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FUNC thread_vector_table , : , .identity_map, , nobti</span><br><span class="line">	.option push</span><br><span class="line">	.option norvc</span><br><span class="line">	j	vector_std_smc_entry</span><br><span class="line">	j	vector_fast_smc_entry</span><br><span class="line">	j	vector_cpu_on_entry</span><br><span class="line">	j	vector_cpu_off_entry</span><br><span class="line">	j	vector_cpu_resume_entry</span><br><span class="line">	j	vector_cpu_suspend_entry</span><br><span class="line">	j	vector_fiq_entry</span><br><span class="line">	j	vector_system_off_entry</span><br><span class="line">	j	vector_system_reset_entry</span><br><span class="line">	.option pop</span><br><span class="line">END_FUNC thread_vector_table</span><br></pre></td></tr></table></figure>

<h1 id="中断处理"><a href="#中断处理" class="headerlink" title="中断处理"></a>中断处理</h1><p>原生的 riscv 下并没有安全世界&#x2F;非安全世界的区分, 没有对中断进行区分.<br>而 arm trustzone 下可以根据 SCR.NS bit 位来标记进入安全世界还是非安全世界或者在进 monitor 时, 是来自于安全世界还是非安全世界.<br>且 arm 在硬件上做到了将非安全中断绑定到 irq 事件, 安全中断绑定到了 fiq 事件. irq 由 REE 处理, fiq 由 TEE 处理.</p>
<p>因此 riscv 想做 tee 方案,</p>
<ul>
<li>需要由软件管理安全世界&#x2F;非安全世界的运行状态</li>
<li>需要有软件管理非安全中断和安全中断<br>上述这两点增加了软件实现的复杂度</li>
</ul>
<p>看下 nuclei 上怎么做到上述这两点的</p>
<h2 id="安全状态标记"><a href="#安全状态标记" class="headerlink" title="安全状态标记"></a>安全状态标记</h2><p><img src="/attachments/nuclei_optee_switch.png"></p>
<p>opensbi 中实现 ATF 类似的功能, 不同的是, 需要由软件维护安全状态.</p>
<ul>
<li>opteeos 初始化阶段, opensbi 在平台初始化节点, 通过 mret 进入 optee_os, optee_os 完成初始化后返回 opensbi, opensbi 需要保存 optee 的 context, 即安全世界上下文</li>
<li>ree os 运行阶段, 当需要 optee 服务时, ree os 通过 ecall 发送 optee 请求, opensbi 收到请求, 保存当前 cpu 状态到非安全 context, 然后恢复安全世界上下文, 将请求给 optee_os 处理. optee_os 处理完后, 发送 ecall 到 opensbi, opensbi 保存安全世界上下文恢复非安全世界上下文, 保存 optee 返回值, 恢复到 ree os 执行.<br>维护安全状态中引入了多个数组指针, 保存当前 cpu 安全世界上下文&#x2F;非安全世界上下文的指针. 以及 next context</li>
</ul>
<p>从 next context 的 sec_attr 判断是来自 安全世界还是非安全世界</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">is_caller_non_secure</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">cpu_context_t</span> *ctx;</span><br><span class="line">	ctx = cm_get_next_context();</span><br><span class="line">	<span class="keyword">return</span> (ctx-&gt;sec_attr == NON_SECURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安全世界状态切换时, 需要更新维护 next context. 这点是比较容易理解的, 无论当前 cpu 是处在安全世界(TEE)还是非安全世界(TEE) 中, 进入这个模式前, 都需要 opensbi 切换世界状态的代码参与, 而这个代码 <code>cm_set_next_context</code> 维护了 sec_attr 的状态.</p>
<p>而 arm 类似判断来自于安全世界&#x2F;非安全世界的 smc 调用时, 用的 SCR.NS 硬件状态.</p>
<h2 id="维护中断状态"><a href="#维护中断状态" class="headerlink" title="维护中断状态"></a>维护中断状态</h2><p>要实现类似 arm FIQ&#x2F;IRQ 的能力, nuclei 做了如下方案</p>
<ul>
<li>软件维护了一个表记录哪些中断是安全中断 (arm 使用 group 标记)</li>
<li>安全中断应该由 M-mode 响应还是由 S-mode 响应<ul>
<li>进入 TEE, 设置安全中断由 S-mode 响应, 非安全中断由 M-mode 响应.</li>
<li>进入 REE, 设置安全中断由 M-mode 响应, 非安全中断由 S-mode 响应.</li>
</ul>
</li>
</ul>
<p>当处在 M-mode 时, 中断都由 M-mode 响应, 根据中断类型再分发给 TEE&#x2F;REE</p>
<p>plic_secure_int 数组中每个元素是由 hartid 和中断号组成，各占16bit, plic_secure_int[0]是个特殊值记录安全中断总个数。</p>
<ul>
<li>plic_secure_int[0]：表示有 plic_secure_int[0] &amp; 0xFFFF 个安全中断</li>
<li>plic_secure_int[x] 表示 plic_secure_int[x] &amp; 0xFFFF 这个安全中断绑定到了hartid为plic_secure_int[x] &gt;&gt; 16 的core上</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册安全中断</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">plic_register_sec_interrupt</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> intr)</span> &#123;</span><br><span class="line">	hartid = current_hartid();</span><br><span class="line">	<span class="comment">// 检查安全中断是否已经被注册. 已经注册则返回</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; cnt ; i++)</span><br><span class="line">		<span class="keyword">if</span> ((plic_secure_int[i + <span class="number">1</span>] &amp; <span class="number">0xFFFF</span>) == intr)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="comment">// 注册安全中断</span></span><br><span class="line">	plic_secure_int[cnt + <span class="number">1</span>] = (hartid &lt;&lt; <span class="number">16</span>) | intr;</span><br><span class="line">	<span class="comment">// 更新安全中断总个数</span></span><br><span class="line">	plic_secure_int[<span class="number">0</span>] = (<span class="number">0xFFFF</span> &lt;&lt; <span class="number">16</span>) | (cnt + <span class="number">1</span>);		</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">plic_is_sec_interrupt</span><span class="params">(<span class="type">int</span> intr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">     <span class="comment">// plic_secure_int[0]是个特殊值记录安全中断总个数。</span></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; (plic_secure_int[<span class="number">0</span>] &amp; <span class="number">0xFFFF</span>); i++)</span><br><span class="line">		<span class="keyword">if</span> (intr == (plic_secure_int[i+<span class="number">1</span>] &amp; <span class="number">0xFFFF</span>))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">switch_plic_int_enable_mode</span><span class="params">(<span class="type">int</span> next_state)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> en_mode, plic_int_num;</span><br><span class="line">	<span class="type">int</span> i, j;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>* secint;</span><br><span class="line"></span><br><span class="line">	plic_int_num = irqchip_plic_get_interrupt_num();</span><br><span class="line">	secint = plic_get_sec_interrupt_tab();</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= plic_int_num; i++) &#123;</span><br><span class="line">		en_mode = irqchip_plic_get_en_mode(i, NON_SECURE);</span><br><span class="line">		<span class="keyword">if</span> (en_mode == <span class="number">-1</span> || plic_is_sec_interrupt(i))</span><br><span class="line">		<span class="comment">/* skip disabled interrupt and secure interrupt */</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * set all non-secure interrupt enable to S mode when next_state is NON_SECURE</span></span><br><span class="line"><span class="comment">			 * set all non-secure interrupt enable to M mode when next_state is SECURE</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			irqchip_plic_set_en_mode((u32*)&amp;i, next_state == NON_SECURE, NON_SECURE);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * set all secure interrupt enable to M mode when next_state is NON_SECURE</span></span><br><span class="line"><span class="comment">	 * set all secure interrupt enable to S mode when next_state is SECURE</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; (secint[<span class="number">0</span>] &amp; <span class="number">0xFFFF</span>); j++)</span><br><span class="line">		irqchip_plic_set_en_mode(&amp;secint[j+<span class="number">1</span>], !(next_state == NON_SECURE), SECURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">irqchip_plic_set_en_mode</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> *pintid, <span class="type">unsigned</span> <span class="type">int</span> mode, <span class="type">int</span> secure)</span></span><br><span class="line">&#123;</span><br><span class="line">	hartid = current_hartid();</span><br><span class="line">	<span class="comment">// 判断安全中断是否绑定到了一个hartid 上, 如果没有则重新绑定到当前hartid上</span></span><br><span class="line">	<span class="keyword">if</span> (secure == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/* judge if int_id is bind to a hart */</span></span><br><span class="line">		<span class="keyword">if</span> ((*pintid &gt;&gt; <span class="number">16</span>) != <span class="number">0xFFFF</span>) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * int_id have been bind to a hart, bind hart</span></span><br><span class="line"><span class="comment">			 * is not equal current return do nothing</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> ((*pintid &gt;&gt; <span class="number">16</span>) != hartid)</span><br><span class="line">				<span class="keyword">return</span> SBI_EFAIL;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* bind int_id to current hart id */</span></span><br><span class="line">			*pintid = (hartid &lt;&lt; <span class="number">16</span>) | (*pintid &amp; <span class="number">0xFFFF</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 安全中断, int_id 取 低16位</span></span><br><span class="line">		int_id = *pintid &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	    <span class="comment">// 非安全中断, int_id = *pintid</span></span><br><span class="line">		int_id = *pintid;</span><br><span class="line">    <span class="comment">// 取plic 结构体</span></span><br><span class="line">	plic = plic_hartid2data[hartid];</span><br><span class="line">	<span class="comment">// 取 intid 对应的 plic寄存器里的 stride offset</span></span><br><span class="line">	int_src_idx = int_id / <span class="number">32</span>;</span><br><span class="line">...</span><br><span class="line">	<span class="comment">// 设置 plic 寄存器的 对应 int_id的 ie 使能位, 使能位分为 S-mode 和 M-mode的, 分别设置</span></span><br><span class="line">	<span class="comment">// plic_hartid2context[hartid][!!mode] 中保存了对应hartid的 world_index, world_index在 plic里实际为 M-mode 还是 S-mode</span></span><br><span class="line">	<span class="comment">// mode为0 plic_hartid2context[hartid][0]  存的是 M-mode 的 offset, plic_hartid2context[hartid][!0=1]  存的是 S-mode 的 offset</span></span><br><span class="line">	<span class="comment">// mode:  next_state == NON_SECURE       next_state为sec,     则 mode 为 0, M-mode offset 置1, S-mode offset 置0</span></span><br><span class="line">	<span class="comment">// mode:  !(next_state == NON_SECURE)    next_state为sec,     则 mode 为 1, S-mode offset 置1, M-mode offset 置0</span></span><br><span class="line">	<span class="comment">// mode:  next_state == NON_SECURE       next_state为non_sec, 则 mode 为 1, S-mode offset 置1, M-mode offset 置0</span></span><br><span class="line">	<span class="comment">// mode:  !(next_state == NON_SECURE)    next_state为non_sec, 则 mode 为 0, M-mode offset 置1, S-mode offset 置0</span></span><br><span class="line">	<span class="comment">// 即要进入sec 时,     将非安全中断 M-mode 使能, S-mode 关闭, 将安全中断 M-mode 关闭, S-mode 使能</span></span><br><span class="line">	<span class="comment">// 即要进入non_sec 时, 将非安全中断 S-mode 使能, M-mode 关闭, 将安全中断 M-mode 使能, S-mode 关闭</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/*set M/S mode, M:1,S;0, or M:0,S:1*/</span></span><br><span class="line">		ie_val = plic_get_ie(plic, plic_hartid2context[hartid][!!mode], int_src_idx);</span><br><span class="line">		ie_val |= <span class="number">1</span> &lt;&lt; (int_id % <span class="number">32</span>);</span><br><span class="line">		plic_set_ie(plic, plic_hartid2context[hartid][!!mode], int_src_idx, ie_val);</span><br><span class="line"></span><br><span class="line">		ie_val = plic_get_ie(plic, plic_hartid2context[hartid][!mode], int_src_idx);</span><br><span class="line">		ie_val &amp;= ~(<span class="number">1</span> &lt;&lt; (int_id % <span class="number">32</span>));</span><br><span class="line">		plic_set_ie(plic, plic_hartid2context[hartid][!mode], int_src_idx, ie_val);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">plic_set_ie</span><span class="params">(<span class="keyword">struct</span> plic_data *plic, u32 cntxid, u32 word_index, u32 val)</span></span><br><span class="line">&#123;</span><br><span class="line">	plic_ie = (<span class="type">void</span> *)plic-&gt;addr +</span><br><span class="line">		   PLIC_ENABLE_BASE + PLIC_ENABLE_STRIDE * cntxid;</span><br><span class="line">	writel(val, plic_ie + word_index * <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与 arm 差异</p>
<p>维护中断是否是安全中断&#x2F;非安全中断</p>
<ul>
<li>nuclei riscv 哪个中断号是安全的, 哪个是不安全的, 由软件维护</li>
<li>arm 由设置 gic group 寄存器确定了, 然后硬件维护中断状态, 根据运行模式将中断绑定到 fiq 或 irq<br>中断的处理:</li>
<li>nuclei riscv , optee 只处理安全中断, ree 只处理非安全中断, M-mode opensbi 处理剩下的, 因为在运行到 tee 时, 非安全中断的 S-mode ie 关闭了, 在运行到 ree 时, 安全中断在 S-mode ie 被关闭了</li>
<li>arm 上, tee ree 还是会处理 irq fiq, 需要陷入到 monitor 或 EL3 转给对方.</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/15/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/15/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-15 11:17:30" itemprop="dateCreated datePublished" datetime="2024-04-15T11:17:30+08:00">2024-04-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liguang.zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liguang.zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
