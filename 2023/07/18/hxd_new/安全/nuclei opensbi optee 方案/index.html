<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liguangzhang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="sm_init 调用栈12345678#0  sm_init (cold_boot&#x3D;cold_boot@entry&#x3D;1) at &#x2F;home&#x2F;liguang&#x2F;program&#x2F;riscv-lab&#x2F;nuclei-linux-sdk&#x2F;opensbi&#x2F;lib&#x2F;sbi&#x2F;optee&#x2F;sm.c:120#1  0x00000000a00026aa in nuclei_final_init (cold_boot&#x3D;&amp;l">
<meta property="og:type" content="article">
<meta property="og:title" content="nuclei opensbi optee 方案">
<meta property="og:url" content="https://liguangzhang.github.io/2023/07/18/hxd_new/%E5%AE%89%E5%85%A8/nuclei%20opensbi%20optee%20%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:description" content="sm_init 调用栈12345678#0  sm_init (cold_boot&#x3D;cold_boot@entry&#x3D;1) at &#x2F;home&#x2F;liguang&#x2F;program&#x2F;riscv-lab&#x2F;nuclei-linux-sdk&#x2F;opensbi&#x2F;lib&#x2F;sbi&#x2F;optee&#x2F;sm.c:120#1  0x00000000a00026aa in nuclei_final_init (cold_boot&#x3D;&amp;l">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-07-18T10:15:54.000Z">
<meta property="article:modified_time" content="2024-04-16T02:43:03.555Z">
<meta property="article:author" content="liguang.zhang">
<meta property="article:tag" content="riscv">
<meta property="article:tag" content="optee_os">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liguangzhang.github.io/2023/07/18/hxd_new/%E5%AE%89%E5%85%A8/nuclei%20opensbi%20optee%20%E6%96%B9%E6%A1%88/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>nuclei opensbi optee 方案 | blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2023/07/18/hxd_new/%E5%AE%89%E5%85%A8/nuclei%20opensbi%20optee%20%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          nuclei opensbi optee 方案
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-18 18:15:54" itemprop="dateCreated datePublished" datetime="2023-07-18T18:15:54+08:00">2023-07-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-16 10:43:03" itemprop="dateModified" datetime="2024-04-16T10:43:03+08:00">2024-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TEE/" itemprop="url" rel="index"><span itemprop="name">TEE</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TEE/optee-os/" itemprop="url" rel="index"><span itemprop="name">optee_os</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TEE/optee-os/RISCV/" itemprop="url" rel="index"><span itemprop="name">RISCV</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="sm-init-调用栈"><a href="#sm-init-调用栈" class="headerlink" title="sm_init 调用栈"></a>sm_init 调用栈</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">0</span>  sm_init (cold_boot=cold_boot@entry=<span class="number">1</span>) at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/lib/sbi/optee/sm.c:<span class="number">120</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x00000000a00026aa</span> in <span class="title function_">nuclei_final_init</span> <span class="params">(cold_boot=&lt;optimized out&gt;)</span></span><br><span class="line">    at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/platform/nuclei/evalsoc/platform.c:66</span><br><span class="line">#2  0x00000000a0000c18 in <span class="title function_">sbi_platform_final_init</span> <span class="params">(cold_boot=<span class="number">1</span>, plat=<span class="number">0xa00138a8</span> &lt;platform&gt;)</span></span><br><span class="line">    at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/include/sbi/sbi_platform.h:401</span><br><span class="line">#3  <span class="title function_">init_coldboot</span> <span class="params">(hartid=<span class="number">0</span>, scratch=<span class="number">0xa002d000</span>)</span> at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/lib/sbi/sbi_init.c:295</span><br><span class="line">#4  <span class="title function_">sbi_init</span> <span class="params">(scratch=<span class="number">0xa002d000</span>)</span> at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/lib/sbi/sbi_init.c:425</span><br><span class="line">#5  0x00000000a00004b6 in _<span class="title function_">start_warm</span> <span class="params">()</span> at /home/liguang/program/riscv-lab/nuclei-linux-sdk/opensbi/firmware/fw_base.S:443</span><br></pre></td></tr></table></figure>

<p>重点关注 sm_init 函数</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">-+ void sm_init<span class="params">(bool cold_boot)</span></span><br><span class="line"> \ -|+ if cold_boot</span><br><span class="line">     \ -+ sbi_ecall_register_extension<span class="params">(&amp;ecall_optee)</span>;</span><br><span class="line">        \ -  .extid_start = SBI_EXT_OPTEE  <span class="string">&quot;0x4F505445&quot;</span></span><br><span class="line">        | -  .handle = sbi_ecall_optee_handler,  <span class="string">&quot;注册 optee ext handler&quot;</span></span><br><span class="line">     | -  sm_region_id = smm_init(); <span class="string">&quot;添加 opensbi text 段 pmp entry， 并保存 id为 sm_region_id&quot;</span></span><br><span class="line">     | -  os_region_id = osm_init(); <span class="string">&quot;添加 0xfffffffff bottom entry&quot;</span></span><br><span class="line">     | -  tee_region_id = teem_init(); <span class="string">&quot;添加 FW_OPTEE_TZDRAM_BASE  optee_os 的text 内存 pmp entry&quot;</span></span><br><span class="line">     | -  shm_region_id = shm_init(); <span class="string">&quot;添加 share memory （secure与non sec 的共享内存的） pmp entry&quot;</span></span><br><span class="line">     | -  plicm_region_id = plicm_init(); <span class="string">&quot;添加 plic 的 mmio的 pmp entry&quot;</span></span><br><span class="line">     | -  timer_region_id = timerm_init(); <span class="string">&quot;添加 timer 的 mmio的pmp entry&quot;</span></span><br><span class="line">  <span class="string">&quot;没有判断 cold_boot 说明是所有核都会走&quot;</span></span><br><span class="line">| -+ pmp_init() <span class="string">&quot;将所有可用的 pmpaddr pmpcfg 置0&quot;</span></span><br><span class="line">| -+ pmp_set_keystone(sm_region_id, PMP_NO_PERM); <span class="string">&quot;设置 opensbi text 段不可读，这个是对 S-mode 有效，对 M-mode 不起作用&quot;</span></span><br><span class="line">| -+ pmp_set_keystone(os_region_id, PMP_ALL_PERM); <span class="string">&quot;设置优先级最低的 osm entry 0xfffffffff 保底读写执行权限，排在它前面的 entry 如果设置了不一样的权限， 以前面的 entry 设置的为准&quot;</span></span><br><span class="line">| -+ pmp_set_keystone(tee_region_id, PMP_NO_PERM); <span class="string">&quot;设置 optee text 无权限&quot;</span></span><br><span class="line">| -|+ <span class="keyword">if</span> cold_boot</span><br><span class="line">    \ -+ opteed_init()</span><br><span class="line">       \ -  sbi_memset(psci_ns_context, <span class="number">0</span>, sizeof(psci_ns_context));  <span class="string">&quot;normal world context 初始化为 0&quot;</span></span><br><span class="line">       | -  sbi_memset(opteed_sp_context, <span class="number">0</span>, sizeof(opteed_sp_context)); <span class="string">&quot;secure world context 初始化为 0&quot;</span></span><br><span class="line">       | -+ img_entry_point.sec_attr = SECURE;   <span class="string">&quot;保存状态， 后面会用. 该结构体最终会被放到 当前 cpu context 中&quot;</span></span><br><span class="line">       | -+ img_entry_point.pc = OPTEE_OS_LOAD_ADDR;  <span class="string">&quot;optee 的 text 段起始地址&quot;</span></span><br><span class="line">       | -  img_entry_point.arg0 = current_hartid(); <span class="string">&quot;cpu core id&quot;</span></span><br><span class="line">       | -  img_entry_point.arg1 = <span class="number">8</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">       | -  img_entry_point.arg2 = FW_JUMP_FDT_ADDR; <span class="string">&quot;fdt 的地址，optee 和 opensbi 共用一个 fdt&quot;</span></span><br><span class="line">       | -+ cm_init_my_context(&amp;img_entry_point); </span><br><span class="line">          \ -+ cm_init_context_by_index(current_hartid(), &amp;img_entry_point);</span><br><span class="line">             \ -+ ctx = cm_get_context_by_index(cpu_idx, &amp;img_entry_point-&gt;sec_attr);  <span class="string">&quot;根据 cpu id 和 sec_attr 属性找到 context 指针&quot;</span></span><br><span class="line">                \ -  <span class="keyword">if</span> secure? &amp;opteed_sp_context[cpu_idx].cpu_ctx : &amp;psci_ns_context[cpu_idx]; </span><br><span class="line">		                <span class="string">&quot;secure 和 non sec 分别有一个context 数组， 按cpuid 保存对应的 当前cpu的context&quot;</span></span><br><span class="line">		     | -+ cm_setup_context(ctx, ep); <span class="string">&quot;填 context &quot;</span></span><br><span class="line">		        \ -  ctx-&gt;sec_attr = (ep-&gt;sec_attr == SECURE) ? SECURE : NON_SECURE;</span><br><span class="line">		        | -  ctx-&gt;gp_regs.mepc = ep-&gt;pc;</span><br><span class="line">		        | -  ctx-&gt;gp_regs.mstatus = (<span class="number">1</span> &lt;&lt; MSTATUS_MPP_SHIFT);  <span class="string">&quot;S-mode&quot;</span></span><br><span class="line">		        | -  ctx-&gt;gp_regs.a0 = ep-&gt;arg0;</span><br><span class="line">		        | -  ctx-&gt;gp_regs.a1 = ep-&gt;arg1;</span><br><span class="line">		        | -  ctx-&gt;gp_regs.a2 = ep-&gt;arg2;</span><br><span class="line">		        | -  ctx-&gt;gp_regs....   直到 arg7</span><br><span class="line">		        | -|+ <span class="keyword">if</span> ep-&gt;sec_attr == SECURE</span><br><span class="line">		            \ -  ctx-&gt;s_csrs.sie = <span class="number">0</span>;   <span class="string">&quot;初始 sie 为0, S-mode 中断关闭&quot;</span></span><br><span class="line">	  | -  saved_mie = csr_read(CSR_MIE); <span class="string">&quot;保存中断使能状态&quot;</span></span><br><span class="line">	  | -  csr_write(CSR_MIE, <span class="number">0</span>); <span class="string">&quot;关闭所有中断&quot;</span></span><br><span class="line">	  | -  rc = opteed_synchronous_sp_entry(optee_ctx); <span class="string">&quot;进入 sec world optee_os 的准备工作, 及要进入 optee_os, 下面拆解&quot;</span></span><br><span class="line">	  -----------------------------------------------------------------------------------------------------</span><br><span class="line">	     <span class="string">&quot;回到 M-mode的 opensbi&quot;</span></span><br><span class="line">	  -----------------------------------------------------------------------------------------------------</span><br><span class="line">	  | -+ ... sbi_ecall_optee_handler 处理流程 --&gt;<span class="number">1</span> </span><br><span class="line">	  | -  csr_write(CSR_MIE, saved_mie); <span class="string">&quot;恢复中断状态&quot;</span></span><br><span class="line">	  | -  sbi_memset(&amp;img_entry_point, <span class="number">0</span>, sizeof(entry_point_info_t));</span><br><span class="line">	  | -  img_entry_point.sec_attr = NON_SECURE;　<span class="string">&quot;下一个 image　为　non sec 的 u-boot&quot;</span></span><br><span class="line">	  | -  cm_init_my_context(&amp;img_entry_point); <span class="string">&quot;初始化 non sec 的 context&quot;</span></span><br><span class="line">	  | -  cm_set_next_eret_context(NON_SECURE);         </span><br></pre></td></tr></table></figure>


<p>下面对 opteed_synchronous_sp_entry 进行拆解</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-+ uint64_t opteed_synchronous_sp_entry<span class="params">(optee_context_t *optee_ctx)</span></span><br><span class="line"> \ -+ cm_sysregs_context_restore<span class="params">(SECURE)</span>; &quot;从context 中恢复 s 开头的 csr, 这里主要是 sepc sie &quot;</span><br><span class="line"> | -+ cm_set_next_eret_context<span class="params">(SECURE)</span>;</span><br><span class="line">    \ -+ ctx = cm_get_context<span class="params">(security_state)</span>; &quot;拿 当前 cpu的 context 指针&quot;</span><br><span class="line">    | -+ cm_set_next_context<span class="params">(ctx)</span>; </span><br><span class="line">       \ -  next_cpu_context_ptr[current_hartid<span class="params">()</span>] = context; &quot;设置 next_cpu_context_ptr 全局变量, 保存当前cpu的下一个 context&quot;</span><br><span class="line">    | -|+ if secure_state == SECURE ?</span><br><span class="line">        \ -+ switch_plic_int_enable_mode<span class="params">(SECURE)</span>; &quot;设置中断使能状态为 secure_state 方案&quot;</span><br><span class="line">        | -+ switch_vector_sec<span class="params">()</span>;</span><br><span class="line">           \ -  csr_write<span class="params">(CSR_MTVEC, &amp;_trap_handler_sec)</span>;  &quot;设置 secure 方案的 trap handler&quot;</span><br><span class="line">        | -  osm_pmp_set<span class="params">(PMP_NO_PERM)</span>; &quot;bottom pmp entry 设置所有内存无权限&quot;</span><br><span class="line">        | -  shm_pmp_set<span class="params">(PMP_ALL_PERM)</span>; &quot;sec 与 non sec 的 share memory 设置 all 权限&quot;</span><br><span class="line">        | -  plicm_pmp_set<span class="params">(PMP_ALL_PERM)</span>;</span><br><span class="line">        | -  timerm_pmp_set<span class="params">(PMP_ALL_PERM)</span>;</span><br><span class="line">        | -  teem_pmp_set<span class="params">(PMP_ALL_PERM)</span>;  &quot;设置 tee 的 text data bss 等的 all 权限&quot;</span><br><span class="line"> | -+ rc = opteed_enter_sp<span class="params">(&amp;optee_ctx-&gt;c_rt_ctx)</span>; &quot;进入汇编函数, 保存当前 opensbi的 cpu context, </span><br><span class="line">						 恢复 context 中保存的上下文, 即为 optee_os 准备的初始的 cpu context&quot;</span><br><span class="line">    \ -  REG_L s1, SBI_TRAP_REGS_OFFSET<span class="params">(mepc)</span><span class="params">(s0)</span></span><br><span class="line">    | -  csrw CSR_MEPC, s1</span><br><span class="line">    | -  REG_L s1, SBI_TRAP_REGS_OFFSET<span class="params">(mstatus)</span><span class="params">(s0)</span></span><br><span class="line">    | -  csrw CSR_MSTATUS, s1</span><br><span class="line">    | -  mret &quot;进入到 optee_os, M-mode 切换为 S-mode&quot; </span><br></pre></td></tr></table></figure>


<p>–&gt;1  optee_os 初始化完毕后, 会发 ecall 调用, 调用号 SBI_EXT_OPTEE “0x4F505445” 回到 opensbi 中, opensbi 由前面设置的 <code>_trap_handler_sec</code> 处理, 进而由<br>opensbi <code>sbi_ecall_optee_handler</code> 处理该 ecall 调用,其中 funcid 为 <code>TEESMC_OPTEED_RETURN_ENTRY_DONE</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-+ static int sbi_ecall_optee_handler<span class="params">(unsigned long extid, unsigned long funcid,</span></span><br><span class="line"><span class="params">				    const struct sbi_trap_regs *regs,</span></span><br><span class="line"><span class="params">				    unsigned long *out_val,</span></span><br><span class="line"><span class="params">				    struct sbi_trap_info *out_trap)</span></span><br><span class="line"> \ -+ switch <span class="params">(funcid)</span></span><br><span class="line">    \ -+ case TEESMC_OPTEED_RETURN_ENTRY_DONE			    </span><br><span class="line">       \ -+ cm_gpregs_context_save<span class="params">(SECURE, regs)</span>; &quot;保存 optee_os 的上下文到 context 中&quot;</span><br><span class="line">          \ -  ctx = cm_get_context<span class="params">(security_state)</span>;</span><br><span class="line">          | -  sbi_memcpy<span class="params">(&amp;ctx-&gt;gp_regs, trap_reg, sizeof(struct sbi_trap_regs))</span>;  &quot;regs 已经由 _trap_handler_sec 保存下来了, 这里转移到 context 下&quot;</span><br><span class="line">       | -+ cm_sysregs_context_save<span class="params">(SECURE)</span>; &quot;保存 s 开头的 csr 到 context 下, 这里不用参数, 因为 M-mode 基本上不会改动 S-mode 的寄存器, 直接读即可&quot;</span><br><span class="line">       | -  optee_vector_table = <span class="params">(optee_vectors_t *)</span> regs-&gt;a1; &quot;regs-&gt;a1锚点 optee_os的 thread_vector_table 基址在 ecall 时会保存到 a1 寄存器中, 进而转移到这里&quot;</span><br><span class="line">       | -  if optee_vector_table ? set_optee_pstate<span class="params">(optee_ctx-&gt;state, OPTEE_PSTATE_ON)</span> &quot;optee_os的 power state, 这里on 表示正在运行&quot;</span><br><span class="line">       | -+ opteed_synchronous_sp_exit<span class="params">(optee_ctx, regs-&gt;a1)</span>; &quot;回到 进入 optee_os 时的地方&quot;</span><br><span class="line">          \ -+ cm_sysregs_context_save<span class="params">(SECURE)</span>;</span><br><span class="line">             \ -+ opteed_exit_sp<span class="params">(optee_ctx-&gt;c_rt_ctx, ret)</span>;</span><br><span class="line">                \ -  REG_L s0, <span class="params">(<span class="number">12</span>-<span class="number">13</span>)</span> * __SIZEOF_POINTER__<span class="params">(sp)</span></span><br><span class="line">                | -  ... <span class="string">&quot;恢复 callee 即 s0-s11 寄存器&quot;</span></span><br><span class="line">                | -  REG_L ra, (<span class="number">0</span>-<span class="number">13</span>) * __SIZEOF_POINTER__(sp) <span class="string">&quot;恢复 ra&quot;</span></span><br><span class="line">                | -  ret <span class="string">&quot;回到 进入 optee_os 时的地方 接着往下执行&quot;</span></span><br></pre></td></tr></table></figure>


<h1 id="optee-os-启动流程"><a href="#optee-os-启动流程" class="headerlink" title="optee_os 启动流程"></a>optee_os 启动流程</h1><p>上面讲到在调用 opteed_synchronous_sp_entry-&gt;opteed_enter_sp mret 后进入了 optee_os 中<br>下面就讲下 optee_os 的启动流程.</p>
<p>optee_os&#x2F;core&#x2F;arch&#x2F;riscv&#x2F;kernel&#x2F;entry.S</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">-+ _start</span><br><span class="line"> \ -  mv s1, a0 &quot;保存hartid&quot;</span><br><span class="line"> | -  la a0, reset_vect_table</span><br><span class="line"> | -  csrw stvec, a0 &quot;保存 stvec 中断入口 为 reset_vect_table&quot;</span><br><span class="line"> | -+ clear_bss __bss_start, __bss_end</span><br><span class="line"> | -+ set_sp s1 &quot;为 hartid 设置 sp&quot;</span><br><span class="line"> | -+ jal thread_init_thread_core_local &quot;初始化线程本地存储&quot;</span><br><span class="line"> | -+ jal dcache_cleaninv_range __text_start, cached_mem_end  &quot;dcache inv clean&quot;</span><br><span class="line"> | -+ jal console_init &quot;初始化console&quot;</span><br><span class="line"> | -+ jal core_init_mmu_map<span class="params">(<span class="number">0</span>, boot_mmu_config)</span> &quot;初始化mmu 映射mmu 页表&quot;</span><br><span class="line"> | -+ jal enable_mmu<span class="params">(hartid)</span> &quot;开启mmu&quot;</span><br><span class="line"> | -+ jal boot_init_primary_early &quot;主核初始化&quot;</span><br><span class="line">    \ -+ init_primary<span class="params">()</span></span><br><span class="line">       \ -+ thread_init_core_local_stacks<span class="params">()</span> &quot;由于std smc需要支持线程（thread）功能，而每个线程都需要含有独立的线程栈，</span><br><span class="line">		       用于保存该线程相关的上下文。该函数用于为每个cpu核初始化相关的线程栈, tmp_stack_va_end用于指定每个ARM核的栈空间&quot;</span><br><span class="line">	   | -+ thread_set_exceptions<span class="params">(THREAD_EXCP_ALL)</span>;  &quot;由于在接下来的初始化流程中需要切换异常向量表的基地址，</span><br><span class="line">						   因此在切换之前需要先mask掉相关的异常使能位&quot;       </span><br><span class="line">	   | -  primary_save_cntfrq<span class="params">()</span>	&quot;未实现&quot;			   </span><br><span class="line">       | -  init_vfp_sec<span class="params">()</span>  &quot;未实现,初始化浮点运算单元vfp&quot; </span><br><span class="line">       | -  thread_get_core_local<span class="params">()</span>-&gt;curr_thread = 0;  &quot;curr_thread用于表示当前核使用的是哪个线程空间。&quot;</span><br><span class="line">       | -+ init_runtime<span class="params">()</span>; &quot;初始化tee运行时所需的各种内存&quot;</span><br><span class="line">       | -+ thread_init_boot_thread<span class="params">()</span>; &quot;将当前执行上下文转换为启动线程，</span><br><span class="line">			       它主要包括从当前cpu的线程栈内存中分配一个栈空间，初始化线程页表和线程状态等&quot;</span><br><span class="line">	   | -+ thread_init_primary<span class="params">()</span>;	&quot;该函数主要用于增强线程的运行安全，如设置线程栈的canary值，以用于监测栈溢出&quot;</span><br><span class="line">	   | -+ thread_init_per_cpu<span class="params">()</span>;  </span><br><span class="line">	      \ -+ thread_init_tvec<span class="params">()</span>;	 &quot;为每个cpu 设置中断入口为 thread_trap_vect&quot;</span><br><span class="line">	   | -+ init_sec_mon<span class="params">(nsec_entry)</span>;   &quot;未实现&quot;</span><br><span class="line"> | -+ jal boot_init_primary_late<span class="params">(fdt)</span>	&quot;该函数用于建立optee的系统运行环境，</span><br><span class="line">					 包括从devcicetree中解析相关的配置，初始化中断控制器，调用initcall回调函数等&quot; </span><br><span class="line">	\ -+ init_external_dt<span class="params">(fdt)</span>; &quot;初始化devicetree，包括映射其物理内存，初始化dtb overlay等&quot;	</span><br><span class="line">	| -+ tpm_map_log_area<span class="params">(get_external_dt())</span>; &quot;初始化tpm的log buffer，其主要操作是为log buffer建立虚拟地址页表&quot;</span><br><span class="line">	| -+ discover_nsec_memory<span class="params">()</span>; &quot;optee与non secure world可通过共享内存通信，它一共支持静态映射和动态映射两种共享内存方式。</span><br><span class="line">				其中静态映射shm在optee启动时就为其建立了相应的内存页表，</span><br><span class="line">				而动态映射方式可以在运行过程中动态地为shm建立页表。该接口用于从devicetree中获取non secure内存，以支持动态共享内存机制&quot;</span><br><span class="line">	| -+ update_external_dt<span class="params">()</span>; &quot;在devicetree中添加与optee相关的一些节点和属性，这些节点和属性将由hlos内核解析并用于初始化相应的模块。</span><br><span class="line">					如它会创建/firmware/optee节点，并在该节点中配置一些与optee相关的属性&quot;</span><br><span class="line">	| -+ configure_console_from_dt<span class="params">()</span> &quot;从devicetree中解析串口参数，并将optee的控制台切换为该串口&quot;</span><br><span class="line">	| -  main_init_gic<span class="params">()</span>; &quot;未实现&quot;</span><br><span class="line">	| -  init_vfp_nsec<span class="params">()</span>; &quot;未实现&quot;</span><br><span class="line">	| -+ init_tee_runtime<span class="params">()</span>; </span><br><span class="line">	   \ -+ core_mmu_init_ta_ram<span class="params">()</span>; &quot;用户空间中使用的栈空间是从 tee_mm_sec_ddr 内存池中分配出来的，</span><br><span class="line">					   该内存池属于MEM_AREA_TA_RAM内存区域，该区域是由OPTEE分配，用于运行TA镜像。&quot;</span><br><span class="line">		 \ -+ tee_mm_init<span class="params">(&amp;tee_mm_sec_ddr, ps, size, CORE_MMU_USER_CODE_SHIFT, TEE_MM_POOL_NO_FLAGS)</span>;</span><br><span class="line">	   | -+ call_initcalls<span class="params">()</span>; --&gt;2 &quot;调用已注册的initcall回调函数, 被各模块用于注册启动时调用的初始化接口, core/include/initcall.h<span class="string">&quot;			   </span></span><br><span class="line"><span class="string"> | -+ jal thread_clr_boot_thread &quot;</span>thread 结束阶段, 将thread-&gt;state 置为 THREAD_STATE_FREE<span class="string">&quot;</span></span><br><span class="line"><span class="string"> | -+ ecall SBI_EXT_OPTEE a6-&gt;TEESMC_OPTEED_RETURN_ENTRY_DONE a1-&gt; thread_vector_table load offset --&gt;3 </span></span><br><span class="line"><span class="string">					 &quot;</span>ecall 回opensbi, 将optee_os 的 vector address load offset(此处就是其物理地址,这里mmu 是直接映射的) 放到 a1 中, 给opensbi 用, </span><br><span class="line">					 参照 sbi_ecall_optee_handler 的 regs-&gt;a1锚点 <span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p>–&gt;2 initcall 按顺序执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> preinit_early(fn)		__define_initcall(preinit, 1, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> preinit(fn)			__define_initcall(preinit, 2, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> preinit_late(fn)		__define_initcall(preinit, 3, fn)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> early_init(fn)			__define_initcall(init, 1, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> early_init_late(fn)		__define_initcall(init, 2, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> service_init(fn)		__define_initcall(init, 3, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> service_init_late(fn)		__define_initcall(init, 4, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> driver_init(fn)			__define_initcall(init, 5, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> driver_init_late(fn)		__define_initcall(init, 6, fn)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> release_init_resource(fn)	__define_initcall(init, 7, fn)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> boot_final(fn)			__define_initcall(final, 1, fn)</span></span><br></pre></td></tr></table></figure>

<p>–&gt;3 thread_vector_table</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FUNC thread_vector_table , : , .identity_map, , nobti</span><br><span class="line">	.option push</span><br><span class="line">	.option norvc</span><br><span class="line">	j	vector_std_smc_entry</span><br><span class="line">	j	vector_fast_smc_entry</span><br><span class="line">	j	vector_cpu_on_entry</span><br><span class="line">	j	vector_cpu_off_entry</span><br><span class="line">	j	vector_cpu_resume_entry</span><br><span class="line">	j	vector_cpu_suspend_entry</span><br><span class="line">	j	vector_fiq_entry</span><br><span class="line">	j	vector_system_off_entry</span><br><span class="line">	j	vector_system_reset_entry</span><br><span class="line">	.option pop</span><br><span class="line">END_FUNC thread_vector_table</span><br></pre></td></tr></table></figure>



<h1 id="中断处理"><a href="#中断处理" class="headerlink" title="中断处理"></a>中断处理</h1><p>原生的 riscv 下并没有安全世界&#x2F;非安全世界的区分, 没有对中断进行区分.<br>而 arm trustzone 下可以根据 SCR.NS bit 位来标记进入安全世界还是非安全世界或者在进 monitor 时, 是来自于安全世界还是非安全世界.<br>且 arm 在硬件上做到了将非安全中断绑定到 irq 事件, 安全中断绑定到了 fiq 事件. irq 由 REE 处理, fiq 由 TEE 处理. </p>
<p>因此 riscv 想做 tee 方案, </p>
<ul>
<li>需要由软件管理安全世界&#x2F;非安全世界的运行状态</li>
<li>需要有软件管理非安全中断和安全中断<br>上述这两点增加了软件实现的复杂度</li>
</ul>
<p>看下 nuclei 上怎么做到上述这两点的</p>
<h2 id="安全状态标记"><a href="#安全状态标记" class="headerlink" title="安全状态标记"></a>安全状态标记</h2><p><img src="data:image/png;base64,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"></p>
<p>opensbi 中实现 ATF 类似的功能, 不同的是, 需要由软件维护安全状态.</p>
<ul>
<li>opteeos 初始化阶段, opensbi 在平台初始化节点, 通过 mret 进入 optee_os, optee_os 完成初始化后返回 opensbi, opensbi 需要保存 optee 的 context, 即安全世界上下文</li>
<li>ree os 运行阶段, 当需要 optee 服务时, ree os 通过 ecall 发送 optee 请求, opensbi 收到请求, 保存当前 cpu 状态到非安全 context, 然后恢复安全世界上下文, 将请求给 optee_os 处理. optee_os 处理完后, 发送 ecall 到 opensbi, opensbi 保存安全世界上下文恢复非安全世界上下文, 保存 optee 返回值, 恢复到 ree os 执行.<br>维护安全状态中引入了多个数组指针, 保存当前 cpu 安全世界上下文&#x2F;非安全世界上下文的指针. 以及 next context</li>
</ul>
<p>从 next context 的 sec_attr 判断是来自 安全世界还是非安全世界</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">is_caller_non_secure</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">cpu_context_t</span> *ctx;</span><br><span class="line">	ctx = cm_get_next_context();</span><br><span class="line">	<span class="keyword">return</span> (ctx-&gt;sec_attr == NON_SECURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安全世界状态切换时, 需要更新维护 next context. 这点是比较容易理解的, 无论当前 cpu 是处在安全世界(TEE)还是非安全世界(TEE) 中, 进入这个模式前, 都需要 opensbi 切换世界状态的代码参与, 而这个代码 <code>cm_set_next_context</code> 维护了 sec_attr 的状态.</p>
<p>而 arm 类似判断来自于安全世界&#x2F;非安全世界的 smc 调用时, 用的 SCR.NS 硬件状态.</p>
<h2 id="维护中断状态"><a href="#维护中断状态" class="headerlink" title="维护中断状态"></a>维护中断状态</h2><p>要实现类似 arm FIQ&#x2F;IRQ 的能力, nuclei 做了如下方案</p>
<ul>
<li>软件维护了一个表记录哪些中断是安全中断 (arm 使用 group 标记)</li>
<li>安全中断应该由 M-mode 响应还是由 S-mode 响应<ul>
<li>进入 TEE, 设置安全中断由 S-mode 响应, 非安全中断由 M-mode 响应.</li>
<li>进入 REE, 设置安全中断由 M-mode 响应, 非安全中断由 S-mode 响应.</li>
</ul>
</li>
</ul>
<p>当处在 M-mode 时, 中断都由 M-mode 响应, 根据中断类型再分发给 TEE&#x2F;REE</p>
<p>plic_secure_int 数组中每个元素是由 hartid 和中断号组成，各占16bit, plic_secure_int[0]是个特殊值记录安全中断总个数。</p>
<ul>
<li>plic_secure_int[0]：表示有 plic_secure_int[0] &amp; 0xFFFF 个安全中断</li>
<li>plic_secure_int[x] 表示 plic_secure_int[x] &amp; 0xFFFF 这个安全中断绑定到了hartid为plic_secure_int[x] &gt;&gt; 16 的core上</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册安全中断</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">plic_register_sec_interrupt</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> intr)</span> &#123;</span><br><span class="line">	hartid = current_hartid();</span><br><span class="line">	<span class="comment">// 检查安全中断是否已经被注册. 已经注册则返回</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; cnt ; i++)</span><br><span class="line">		<span class="keyword">if</span> ((plic_secure_int[i + <span class="number">1</span>] &amp; <span class="number">0xFFFF</span>) == intr)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="comment">// 注册安全中断</span></span><br><span class="line">	plic_secure_int[cnt + <span class="number">1</span>] = (hartid &lt;&lt; <span class="number">16</span>) | intr;</span><br><span class="line">	<span class="comment">// 更新安全中断总个数</span></span><br><span class="line">	plic_secure_int[<span class="number">0</span>] = (<span class="number">0xFFFF</span> &lt;&lt; <span class="number">16</span>) | (cnt + <span class="number">1</span>);			</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">plic_is_sec_interrupt</span><span class="params">(<span class="type">int</span> intr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">     <span class="comment">// plic_secure_int[0]是个特殊值记录安全中断总个数。</span></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; (plic_secure_int[<span class="number">0</span>] &amp; <span class="number">0xFFFF</span>); i++)</span><br><span class="line">		<span class="keyword">if</span> (intr == (plic_secure_int[i+<span class="number">1</span>] &amp; <span class="number">0xFFFF</span>))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">switch_plic_int_enable_mode</span><span class="params">(<span class="type">int</span> next_state)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> en_mode, plic_int_num;</span><br><span class="line">	<span class="type">int</span> i, j;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>* secint;</span><br><span class="line"></span><br><span class="line">	plic_int_num = irqchip_plic_get_interrupt_num();</span><br><span class="line">	secint = plic_get_sec_interrupt_tab();</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= plic_int_num; i++) &#123;</span><br><span class="line">		en_mode = irqchip_plic_get_en_mode(i, NON_SECURE);</span><br><span class="line">		<span class="keyword">if</span> (en_mode == <span class="number">-1</span> || plic_is_sec_interrupt(i))</span><br><span class="line">		<span class="comment">/* skip disabled interrupt and secure interrupt */</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * set all non-secure interrupt enable to S mode when next_state is NON_SECURE</span></span><br><span class="line"><span class="comment">			 * set all non-secure interrupt enable to M mode when next_state is SECURE</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			irqchip_plic_set_en_mode((u32*)&amp;i, next_state == NON_SECURE, NON_SECURE);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * set all secure interrupt enable to M mode when next_state is NON_SECURE</span></span><br><span class="line"><span class="comment">	 * set all secure interrupt enable to S mode when next_state is SECURE</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; (secint[<span class="number">0</span>] &amp; <span class="number">0xFFFF</span>); j++)</span><br><span class="line">		irqchip_plic_set_en_mode(&amp;secint[j+<span class="number">1</span>], !(next_state == NON_SECURE), SECURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">irqchip_plic_set_en_mode</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> *pintid, <span class="type">unsigned</span> <span class="type">int</span> mode, <span class="type">int</span> secure)</span></span><br><span class="line">&#123;</span><br><span class="line">	hartid = current_hartid();</span><br><span class="line">	<span class="comment">// 判断安全中断是否绑定到了一个hartid 上, 如果没有则重新绑定到当前hartid上</span></span><br><span class="line">	<span class="keyword">if</span> (secure == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/* judge if int_id is bind to a hart */</span></span><br><span class="line">		<span class="keyword">if</span> ((*pintid &gt;&gt; <span class="number">16</span>) != <span class="number">0xFFFF</span>) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * int_id have been bind to a hart, bind hart</span></span><br><span class="line"><span class="comment">			 * is not equal current return do nothing</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> ((*pintid &gt;&gt; <span class="number">16</span>) != hartid)</span><br><span class="line">				<span class="keyword">return</span> SBI_EFAIL;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* bind int_id to current hart id */</span></span><br><span class="line">			*pintid = (hartid &lt;&lt; <span class="number">16</span>) | (*pintid &amp; <span class="number">0xFFFF</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 安全中断, int_id 取 低16位</span></span><br><span class="line">		int_id = *pintid &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	    <span class="comment">// 非安全中断, int_id = *pintid</span></span><br><span class="line">		int_id = *pintid;</span><br><span class="line">    <span class="comment">// 取plic 结构体</span></span><br><span class="line">	plic = plic_hartid2data[hartid];</span><br><span class="line">	<span class="comment">// 取 intid 对应的 plic寄存器里的 stride offset</span></span><br><span class="line">	int_src_idx = int_id / <span class="number">32</span>;</span><br><span class="line">...</span><br><span class="line">	<span class="comment">// 设置 plic 寄存器的 对应 int_id的 ie 使能位, 使能位分为 S-mode 和 M-mode的, 分别设置</span></span><br><span class="line">	<span class="comment">// plic_hartid2context[hartid][!!mode] 中保存了对应hartid的 world_index, world_index在 plic里实际为 M-mode 还是 S-mode</span></span><br><span class="line">	<span class="comment">// mode为0 plic_hartid2context[hartid][0]  存的是 M-mode 的 offset, plic_hartid2context[hartid][!0=1]  存的是 S-mode 的 offset</span></span><br><span class="line">	<span class="comment">// mode:  next_state == NON_SECURE       next_state为sec,     则 mode 为 0, M-mode offset 置1, S-mode offset 置0</span></span><br><span class="line">	<span class="comment">// mode:  !(next_state == NON_SECURE)    next_state为sec,     则 mode 为 1, S-mode offset 置1, M-mode offset 置0</span></span><br><span class="line">	<span class="comment">// mode:  next_state == NON_SECURE       next_state为non_sec, 则 mode 为 1, S-mode offset 置1, M-mode offset 置0</span></span><br><span class="line">	<span class="comment">// mode:  !(next_state == NON_SECURE)    next_state为non_sec, 则 mode 为 0, M-mode offset 置1, S-mode offset 置0</span></span><br><span class="line">	<span class="comment">// 即要进入sec 时,     将非安全中断 M-mode 使能, S-mode 关闭, 将安全中断 M-mode 关闭, S-mode 使能</span></span><br><span class="line">	<span class="comment">// 即要进入non_sec 时, 将非安全中断 S-mode 使能, M-mode 关闭, 将安全中断 M-mode 使能, S-mode 关闭</span></span><br><span class="line">	</span><br><span class="line">		<span class="comment">/*set M/S mode, M:1,S;0, or M:0,S:1*/</span></span><br><span class="line">		ie_val = plic_get_ie(plic, plic_hartid2context[hartid][!!mode], int_src_idx);</span><br><span class="line">		ie_val |= <span class="number">1</span> &lt;&lt; (int_id % <span class="number">32</span>);</span><br><span class="line">		plic_set_ie(plic, plic_hartid2context[hartid][!!mode], int_src_idx, ie_val);</span><br><span class="line"></span><br><span class="line">		ie_val = plic_get_ie(plic, plic_hartid2context[hartid][!mode], int_src_idx);</span><br><span class="line">		ie_val &amp;= ~(<span class="number">1</span> &lt;&lt; (int_id % <span class="number">32</span>));</span><br><span class="line">		plic_set_ie(plic, plic_hartid2context[hartid][!mode], int_src_idx, ie_val);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">plic_set_ie</span><span class="params">(<span class="keyword">struct</span> plic_data *plic, u32 cntxid, u32 word_index, u32 val)</span></span><br><span class="line">&#123;</span><br><span class="line">	plic_ie = (<span class="type">void</span> *)plic-&gt;addr +</span><br><span class="line">		   PLIC_ENABLE_BASE + PLIC_ENABLE_STRIDE * cntxid;</span><br><span class="line">	writel(val, plic_ie + word_index * <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与 arm 差异</p>
<p>维护中断是否是安全中断&#x2F;非安全中断</p>
<ul>
<li>nuclei riscv 哪个中断号是安全的, 哪个是不安全的, 由软件维护</li>
<li>arm 由设置 gic group 寄存器确定了, 然后硬件维护中断状态, 根据运行模式将中断绑定到 fiq 或 irq<br>中断的处理:</li>
<li>nuclei riscv , optee 只处理安全中断, ree 只处理非安全中断, M-mode opensbi 处理剩下的, 因为在运行到 tee 时, 非安全中断的 S-mode ie 关闭了, 在运行到 ree 时, 安全中断在 S-mode ie 被关闭了</li>
<li>arm 上, tee ree 还是会处理 irq fiq, 需要陷入到 monitor 或 EL3 转给对方.</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/riscv/" rel="tag"># riscv</a>
              <a href="/tags/optee-os/" rel="tag"># optee_os</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/07/11/hxd_new/riscv%E8%B0%83%E7%A0%94/riscv_aosp_requirements(thead)/" rel="prev" title="riscv aosp requirements (thead)">
      <i class="fa fa-chevron-left"></i> riscv aosp requirements (thead)
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/08/02/hxd_new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/iommu/xt%20iommu%20%E7%A7%BB%E6%A4%8D%E9%97%AE%E9%A2%98/" rel="next" title="riscv iommu 玄铁升级 移植">
      riscv iommu 玄铁升级 移植 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#sm-init-%E8%B0%83%E7%94%A8%E6%A0%88"><span class="nav-number">1.</span> <span class="nav-text">sm_init 调用栈</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#optee-os-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">optee_os 启动流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">中断处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E7%8A%B6%E6%80%81%E6%A0%87%E8%AE%B0"><span class="nav-number">3.1.</span> <span class="nav-text">安全状态标记</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%B4%E6%8A%A4%E4%B8%AD%E6%96%AD%E7%8A%B6%E6%80%81"><span class="nav-number">3.2.</span> <span class="nav-text">维护中断状态</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liguang.zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">147</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">90</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">102</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liguang.zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
