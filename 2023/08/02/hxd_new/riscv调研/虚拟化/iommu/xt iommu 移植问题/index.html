<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liguangzhang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="首先 probe 失败的问题 需要先添加 iommu capable 函数, 表明 IOMMU_CAP_CACHE_COHERENCY 能力为 true, 否则 probe 时会失败. 1234567891011121314static struct iommu_ops xt_iommu_ops &#x3D; &#123;	.capable	&#x3D; xt_iommu_capable,&#125;static b">
<meta property="og:type" content="article">
<meta property="og:title" content="riscv iommu 玄铁升级 移植">
<meta property="og:url" content="https://liguangzhang.github.io/2023/08/02/hxd_new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/iommu/xt%20iommu%20%E7%A7%BB%E6%A4%8D%E9%97%AE%E9%A2%98/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:description" content="首先 probe 失败的问题 需要先添加 iommu capable 函数, 表明 IOMMU_CAP_CACHE_COHERENCY 能力为 true, 否则 probe 时会失败. 1234567891011121314static struct iommu_ops xt_iommu_ops &#x3D; &#123;	.capable	&#x3D; xt_iommu_capable,&#125;static b">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-08-02T10:15:54.000Z">
<meta property="article:modified_time" content="2024-04-16T06:01:21.709Z">
<meta property="article:author" content="liguang.zhang">
<meta property="article:tag" content="riscv">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liguangzhang.github.io/2023/08/02/hxd_new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/iommu/xt%20iommu%20%E7%A7%BB%E6%A4%8D%E9%97%AE%E9%A2%98/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>riscv iommu 玄铁升级 移植 | blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2023/08/02/hxd_new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/iommu/xt%20iommu%20%E7%A7%BB%E6%A4%8D%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          riscv iommu 玄铁升级 移植
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-02 18:15:54" itemprop="dateCreated datePublished" datetime="2023-08-02T18:15:54+08:00">2023-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-16 14:01:21" itemprop="dateModified" datetime="2024-04-16T14:01:21+08:00">2024-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%8E%84%E9%93%81/" itemprop="url" rel="index"><span itemprop="name">玄铁</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%8E%84%E9%93%81/RISCV/" itemprop="url" rel="index"><span itemprop="name">RISCV</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%8E%84%E9%93%81/RISCV/%E7%A7%BB%E6%A4%8D/" itemprop="url" rel="index"><span itemprop="name">移植</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>首先 probe 失败的问题</p>
<p>需要先添加 iommu capable 函数, 表明 <code>IOMMU_CAP_CACHE_COHERENCY</code> 能力为 true, 否则 probe 时会失败.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">iommu_ops</span> <span class="title">xt_iommu_ops</span> =</span> &#123;</span><br><span class="line">	.capable	= xt_iommu_capable,</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> xt_iommu_capable(<span class="keyword">struct</span> device *dev, <span class="keyword">enum</span> iommu_cap cap)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">switch</span> (cap) &#123;</span><br><span class="line">	<span class="keyword">case</span> IOMMU_CAP_CACHE_COHERENCY:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">case</span> IOMMU_CAP_NOEXEC:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开 option allow_unsafe_interrupts&#x3D;1<br>编译为动态模块时, insmod 会读取 <code>/etc/modprobe.d/iommu_unsafe_interrupts.conf</code> 文件, 将 allow_unsafe_interrupts 设置为 1.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options vfio_iommu_type1 allow_unsafe_interrupts=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>如果不是动态模块, 包含在 kernel Image 中, 则需要强制打开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> allow_unsafe_interrupts = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>其次 xt_iommu 在 base 版本上使用的一些接口在升级版本上发生了变化:<br>如 <code>iommu_device_set_ops</code>  <code>iommu_device_set_fwnode</code> <code>bus_set_iommu</code> 不见了, 取而代之的是总结成了一个接口 <code>iommu_device_register</code>, 该接口支持的参数也有变化.<br>其次某些函数的参数个数意义变化:<br><code>xt_iommu_map</code> <code>xt_iommu_unmap</code> , size 变成了 pgsize 和 pgcount.</p>
<p>需要相应的适配修改.</p>
<p>kernel 的相关 config 需要打开:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_IOMMU_IOVA=y</span><br><span class="line">CONFIG_IOMMU_API=y</span><br><span class="line">CONFIG_IOMMU_SUPPORT=y</span><br><span class="line">CONFIG_IOMMU_DMA=y</span><br><span class="line">unset CONFIG_IOMMUFD</span><br><span class="line">CONFIG_VFIO=y</span><br><span class="line">CONFIG_VFIO_CONTAINER=y</span><br><span class="line">CONFIG_VFIO_IOMMU_TYPE1=y</span><br><span class="line">CONFIG_VFIO_VIRQFD=y</span><br><span class="line">CONFIG_VFIO_PCI_CORE=y</span><br><span class="line">CONFIG_VFIO_PCI_MMAP=y</span><br><span class="line">CONFIG_VFIO_PCI_INTX=y</span><br><span class="line">CONFIG_VFIO_PCI=y</span><br><span class="line">CONFIG_PCI=y</span><br><span class="line">CONFIG_PCI_DOMAINS=y</span><br><span class="line">CONFIG_PCI_DOMAINS_GENERIC=y</span><br><span class="line"># kvm-mode 下支持vfio</span><br><span class="line">CONFIG_KVM_VFIO=y</span><br></pre></td></tr></table></figure>

<p>移植 iommu 后, 直通给 guest 的网卡 e1000e 报错, log 如下:<br>经过分析后, 得出结论, 网卡通过 dma 发包出现异常, 最后由 ndo_tx_timeout 回调了 e1000e 的 <code>e1000_tx_timeout</code> 函数将网卡重启.</p>
<p>由监控的 watchdog</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WARN_ONCE(<span class="number">1</span>, <span class="string">&quot;NETDEV WATCHDOG: %s (%s): transmit queue %u timed out %u ms\n&quot;</span>,</span><br><span class="line">	  dev-&gt;name, netdev_drivername(dev), i, timedout_ms);</span><br><span class="line">dev-&gt;netdev_ops-&gt;ndo_tx_timeout(dev, i);</span><br></pre></td></tr></table></figure>
<p>打印出了下面的堆栈:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[   <span class="number">42.096669</span>] NETDEV WATCHDOG: eth0 (e1000e): transmit <span class="built_in">queue</span> <span class="number">0</span> timed out <span class="number">9960</span> ms</span><br><span class="line">[   <span class="number">42.248201</span>] WARNING: CPU: <span class="number">3</span> PID: <span class="number">0</span> at net/sched/sch_generic.c:<span class="number">525</span> dev_watchdog+<span class="number">0x224</span>/<span class="number">0x228</span></span><br><span class="line">[   <span class="number">42.250411</span>] Modules linked in:</span><br><span class="line">[   <span class="number">42.250692</span>] CPU: <span class="number">3</span> PID: <span class="number">0</span> Comm: swapper/<span class="number">3</span> Not tainted <span class="number">6.4</span><span class="number">.0</span>-rc1<span class="number">-00026</span>-g80e62bc8487b-dirty #<span class="number">91</span></span><br><span class="line">[   <span class="number">42.250818</span>] Hardware name: riscv-virtio,qemu (DT)</span><br><span class="line">[   <span class="number">42.250926</span>] epc : dev_watchdog+<span class="number">0x224</span>/<span class="number">0x228</span></span><br><span class="line">[   <span class="number">42.251014</span>]  ra : dev_watchdog+<span class="number">0x224</span>/<span class="number">0x228</span></span><br><span class="line">[   <span class="number">42.251042</span>] epc : ffffffff806e48dc ra : ffffffff806e48dc sp : ff20000000693b90</span><br><span class="line">[   <span class="number">42.251058</span>]  gp : ffffffff814a2b00 tp : ff600000018cd240 t0 : ffffffff8082fba0</span><br><span class="line">[   <span class="number">42.251074</span>]  t1 : <span class="number">0720072007200720</span> t2 : <span class="number">4157205645445445</span> s0 : ff20000000693c00</span><br><span class="line">[   <span class="number">42.251089</span>]  s1 : ff600000024bc498 a0 : <span class="number">0000000000000042</span> a1 : ffffffff8147e108</span><br><span class="line">[   <span class="number">42.251103</span>]  a2 : <span class="number">00000000f</span>fffefff a3 : fffffffffffffffe a4 : b6182cbfc7d9c400</span><br><span class="line">[   <span class="number">42.251117</span>]  a5 : b6182cbfc7d9c400 a6 : <span class="number">0000000000000050</span> a7 : ffffffff8048d172</span><br><span class="line">[   <span class="number">42.251131</span>]  s2 : ff600000024bc000 s3 : ff600000018e3a00 s4 : ff600000024bc3e0</span><br><span class="line">[   <span class="number">42.251145</span>]  s5 : <span class="number">0000000000000000</span> s6 : ffffffff8140a980 s7 : <span class="number">00000000000026e8</span></span><br><span class="line">[   <span class="number">42.251159</span>]  s8 : ffffffff80c15470 s9 : ffffffff81408088 s10: <span class="number">0000000000000101</span></span><br><span class="line">[   <span class="number">42.251173</span>]  s11: <span class="number">0000000000000282</span> t3 : ff60000001818f00 t4 : ff60000001818f00</span><br><span class="line">[   <span class="number">42.251186</span>]  t5 : ff60000001818000 t6 : ff20000000693978</span><br><span class="line">[   <span class="number">42.251199</span>] status: <span class="number">0000000200000120</span> badaddr: <span class="number">0000000000000000</span> cause: <span class="number">0000000000000003</span></span><br><span class="line">[   <span class="number">42.251303</span>] [&lt;ffffffff806e48dc&gt;] dev_watchdog+<span class="number">0x224</span>/<span class="number">0x228</span></span><br><span class="line">[   <span class="number">42.251402</span>] [&lt;ffffffff800940e4&gt;] call_timer_fn.constprop<span class="number">.0</span>+<span class="number">0x14</span>/<span class="number">0x5e</span></span><br><span class="line">[   <span class="number">42.252827</span>] [&lt;ffffffff800941b8&gt;] expire_timers+<span class="number">0x8a</span>/<span class="number">0xbc</span></span><br><span class="line">[   <span class="number">42.252840</span>] [&lt;ffffffff80094782&gt;] run_timer_softirq+<span class="number">0xe0</span>/<span class="number">0x202</span></span><br><span class="line">[   <span class="number">42.252850</span>] [&lt;ffffffff80844460&gt;] __do_softirq+<span class="number">0x100</span>/<span class="number">0x27e</span></span><br><span class="line">[   <span class="number">42.256472</span>] [&lt;ffffffff80024a9c&gt;] __irq_exit_rcu+<span class="number">0xa8</span>/<span class="number">0xde</span></span><br><span class="line">[   <span class="number">42.258214</span>] [&lt;ffffffff80024bb6&gt;] irq_exit_rcu+<span class="number">0xc</span>/<span class="number">0x14</span></span><br><span class="line">[   <span class="number">42.258389</span>] [&lt;ffffffff8083c238&gt;] do_irq+<span class="number">0x6c</span>/<span class="number">0x86</span></span><br><span class="line">[   <span class="number">42.258543</span>] [&lt;ffffffff800035ac&gt;] ret_from_exception+<span class="number">0x0</span>/<span class="number">0x64</span></span><br><span class="line">[   <span class="number">42.258646</span>] [&lt;ffffffff8083cb2a&gt;] default_idle_call+<span class="number">0x26</span>/<span class="number">0x34</span></span><br><span class="line">[   <span class="number">42.259488</span>] [&lt;ffffffff8005a7ee&gt;] do_idle+<span class="number">0x206</span>/<span class="number">0x226</span></span><br><span class="line">[   <span class="number">42.259983</span>] [&lt;ffffffff8005a970&gt;] cpu_startup_entry+<span class="number">0x1a</span>/<span class="number">0x1c</span></span><br><span class="line">[   <span class="number">42.259997</span>] [&lt;ffffffff8000618a&gt;] handle_IPI+<span class="number">0x0</span>/<span class="number">0xfc</span></span><br><span class="line">[   <span class="number">45.988551</span>] e1000e <span class="number">0000</span>:<span class="number">00</span>:<span class="number">01.0</span> eth0: Reset adapter unexpectedly</span><br><span class="line">[   <span class="number">46.743848</span>] e1000e <span class="number">0000</span>:<span class="number">00</span>:<span class="number">01.0</span> eth0: NIC Link is Up <span class="number">1000</span> Mbps Full Duplex, Flow Control: Rx/Tx</span><br></pre></td></tr></table></figure>


<p>首先状态上来说, 中断是正常的, 但是 dma remapping 不正常.<br>在 riscv 基础版本上 (未开启 AIA), 只支持 intx 线中断模式<br><code>e1000_intr</code> 中断处理函数可以正常触发.</p>
<p>再由不同版本对比后, 发现 qemu (host) &#x2F; qemu (guest) 以及 kernel (guest) 为不变量, 变量仅有 kernel (host) 从 5.10 版本升级到了 6.4 版本.<br>在 kernel 变更版本后, 相对应的 vfio 框架发生了一些变化, 在确认 5.10 -&gt; 6.4 iommu &#x2F; vfio 相关的 config 都相同时, 无明显的其他异常 log.<br>无明显的排查点, 再往下追只能根据代码行为去正向跟踪.</p>
<h1 id="qemu-xmmuv1-模拟行为"><a href="#qemu-xmmuv1-模拟行为" class="headerlink" title="qemu xmmuv1 模拟行为"></a>qemu xmmuv1 模拟行为</h1><p>正常的 log, 未开启虚拟化时, host 中对 e1000e 网卡的处理就经由了 dma, 而在将 kernel 版本升级到 6.4 后, 却没触发对应的 xmmuv1_translate.<br>说明 base 版本上开了 e1000e 网卡的 iommu 支持, 而升级版本后关闭了网卡的 iommu 支持.<br>未开启虚拟化时, 还没有涉及到 vfio 的特性, 所以应重点排查 iommu 相关的 feature.</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">0</span>  <span class="number">0</span>x000055555591fa12 in xmmuv1_translate (mr=&lt;optimized out&gt;, addr=<span class="number">4294963200</span>, flag=&lt;optimized out&gt;, iommu_idx=&lt;optimized out&gt;) at ../hw/riscv/xmmuv1.c:<span class="number">186</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0</span>x00005555559fe0b6 in address_space_translate_iommu (iommu_mr=<span class="number">0</span>x555557025af0, xlat=xlat@entry=<span class="number">0</span>x7fffe9c61d40, plen_out=plen_out@entry=<span class="number">0</span>x7fffe9c61d38, page_mask_out=page_mask_out@entry=<span class="number">0</span>x0, is_write=is_write@entry=<span class="literal">false</span>, is_mmio=<span class="literal">true</span>, target_as=<span class="number">0</span>x7fffe9c61cc8, attrs=...) at ../softmmu/physmem.c:<span class="number">435</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0</span>x00005555559fe340 in flatview_do_translate (fv=fv@entry=<span class="number">0</span>x7ffee830ab40, addr=addr@entry=<span class="number">4294963200</span>, xlat=xlat@entry=<span class="number">0</span>x7fffe9c61d40, plen_out=plen_out@entry=<span class="number">0</span>x7fffe9c61d38, page_mask_out=page_mask_out@entry=<span class="number">0</span>x0, is_write=<span class="literal">false</span>, is_mmio=<span class="literal">true</span>, target_as=<span class="number">0</span>x7fffe9c61cc8, attrs=...) at ../softmmu/physmem.c:<span class="number">508</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0</span>x00005555559feed1 in flatview_translate (fv=fv@entry=<span class="number">0</span>x7ffee830ab40, addr=addr@entry=<span class="number">4294963200</span>, xlat=xlat@entry=<span class="number">0</span>x7fffe9c61d40, plen=plen@entry=<span class="number">0</span>x7fffe9c61d38, is_write=is_write@entry=<span class="literal">false</span>, attrs=...) at ../softmmu/physmem.c:<span class="number">568</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0</span>x0000555555a02b91 in flatview_read (fv=<span class="number">0</span>x7ffee830ab40, addr=addr@entry=<span class="number">4294963200</span>, attrs=attrs@entry=..., buf=buf@entry=<span class="number">0</span>x7fffe9c61e10, len=len@entry=<span class="number">16</span>) at ../softmmu/physmem.c:<span class="number">2753</span></span><br><span class="line">#<span class="number">5</span>  <span class="number">0</span>x0000555555a02cf8 in address_space_read_full (as=<span class="number">0</span>x7fffe8416250, addr=addr@entry=<span class="number">4294963200</span>, attrs=..., buf=buf@entry=<span class="number">0</span>x7fffe9c61e10, len=len@entry=<span class="number">16</span>) at ../softmmu/physmem.c:<span class="number">2770</span></span><br><span class="line">#<span class="number">6</span>  <span class="number">0</span>x0000555555a02e31 in address_space_rw (as=&lt;optimized out&gt;, addr=addr@entry=<span class="number">4294963200</span>, attrs=..., attrs@entry=..., buf=buf@entry=<span class="number">0</span>x7fffe9c61e10, len=len@entry=<span class="number">16</span>, is_write=is_write@entry=<span class="literal">false</span>) at ../softmmu/physmem.c:<span class="number">2798</span></span><br><span class="line">#<span class="number">7</span>  <span class="number">0</span>x00005555557bd7e9 in dma_memory_rw_relaxed (attrs=..., dir=DMA_DIRECTION_TO_DEVICE, len=<span class="number">16</span>, buf=<span class="number">0</span>x7fffe9c61e10, addr=<span class="number">4294963200</span>, as=&lt;optimized out&gt;) at /home/liguang/program/riscv-lab/qemu/include/sysemu/dma.h:<span class="number">87</span></span><br><span class="line">#<span class="number">8</span>  <span class="number">0</span>x00005555557bd7e9 in dma_memory_rw (attrs=..., dir=DMA_DIRECTION_TO_DEVICE, len=<span class="number">16</span>, buf=<span class="number">0</span>x7fffe9c61e10, addr=<span class="number">4294963200</span>, as=&lt;optimized out&gt;) at /home/liguang/program/riscv-lab/qemu/include/sysemu/dma.h:<span class="number">130</span></span><br><span class="line">#<span class="number">9</span>  <span class="number">0</span>x00005555557bd7e9 in pci_dma_rw (attrs=..., dir=DMA_DIRECTION_TO_DEVICE, len=<span class="number">16</span>, buf=<span class="number">0</span>x7fffe9c61e10, addr=&lt;optimized out&gt;, dev=&lt;optimized out&gt;) at /home/liguang/program/riscv-lab/qemu/include/hw/pci/pci_device.h:<span class="number">233</span></span><br><span class="line">#<span class="number">10</span> <span class="number">0</span>x00005555557bd7e9 in pci_dma_read (len=<span class="number">16</span>, buf=<span class="number">0</span>x7fffe9c61e10, addr=&lt;optimized out&gt;, dev=&lt;optimized out&gt;) at /home/liguang/program/riscv-lab/qemu/include/hw/pci/pci_device.h:<span class="number">252</span></span><br><span class="line">#<span class="number">11</span> <span class="number">0</span>x00005555557bd7e9 in e1000e_start_xmit (core=<span class="number">0</span>x7fffe8418eb0, txr=txr@entry=<span class="number">0</span>x7fffe9c61e80) at ../hw/net/e1000e_core.c:<span class="number">944</span></span><br><span class="line">#<span class="number">12</span> <span class="number">0</span>x00005555557bdda6 in e1000e_set_tdt (core=&lt;optimized out&gt;, index=&lt;optimized out&gt;, val=&lt;optimized out&gt;) at ../hw/net/e1000e_core.c:<span class="number">2456</span></span><br><span class="line">#<span class="number">13</span> <span class="number">0</span>x00005555557c1130 in e1000e_core_write (core=<span class="number">0</span>x7fffe8418eb0, addr=&lt;optimized out&gt;, val=<span class="number">1</span>, size=<span class="number">4</span>) at ../hw/net/e1000e_core.c:<span class="number">3280</span></span><br><span class="line">#<span class="number">14</span> <span class="number">0</span>x00005555557b7b66 in e1000e_mmio_write (opaque=&lt;optimized out&gt;, addr=&lt;optimized out&gt;, val=&lt;optimized out&gt;, size=&lt;optimized out&gt;) at ../hw/net/e1000e.c:<span class="number">112</span></span><br><span class="line">#<span class="number">15</span> <span class="number">0</span>x00005555559f9060 in memory_region_write_accessor (mr=<span class="number">0</span>x7fffe8418a60, addr=<span class="number">14360</span>, value=&lt;optimized out&gt;, size=<span class="number">4</span>, shift=&lt;optimized out&gt;, mask=&lt;optimized out&gt;, attrs=...) at ../softmmu/memory.c:<span class="number">493</span></span><br><span class="line">#<span class="number">16</span> <span class="number">0</span>x00005555559f8a8b in access_with_adjusted_size (addr=addr@entry=<span class="number">14360</span>, value=value@entry=<span class="number">0</span>x7fffe9c62038, size=size@entry=<span class="number">4</span>, access_size_min=&lt;optimized out&gt;, access_size_max=&lt;optimized out&gt;, access_fn=access_fn@entry=<span class="number">0</span>x5555559f8ffe &lt;memory_region_write_accessor&gt;, mr=<span class="number">0</span>x7fffe8418a60, attrs=...) at ../softmmu/memory.c:<span class="number">569</span></span><br><span class="line">#<span class="number">17</span> <span class="number">0</span>x00005555559f8d58 in memory_region_dispatch_write (mr=mr@entry=<span class="number">0</span>x7fffe8418a60, addr=addr@entry=<span class="number">14360</span>, data=&lt;optimized out&gt;, data@entry=<span class="number">1</span>, op=op@entry=MO_32, attrs=...) at ../softmmu/memory.c:<span class="number">1533</span></span><br><span class="line">#<span class="number">18</span> <span class="number">0</span>x0000555555a3d245 in io_writex (env=env@entry=<span class="number">0</span>x55555669e430, full=<span class="number">0</span>x7ffef0d6cf38, mmu_idx=<span class="number">1</span>, val=val@entry=<span class="number">1</span>, addr=<span class="number">18446743867826518040</span>, retaddr=retaddr@entry=<span class="number">140736773646269</span>, op=MO_32) at ../accel/tcg/cputlb.c:<span class="number">1435</span></span><br><span class="line">#<span class="number">19</span> <span class="number">0</span>x0000555555a40cf1 in do_st_4 (ra=<span class="number">140736773646269</span>, memop=&lt;optimized out&gt;, mmu_idx=&lt;optimized out&gt;, val=<span class="number">1</span>, p=<span class="number">0</span>x7fffe9c62140, env=<span class="number">0</span>x55555669e430) at ../accel/tcg/cputlb.c:<span class="number">2772</span></span><br><span class="line">#<span class="number">20</span> <span class="number">0</span>x0000555555a40cf1 in do_st4_mmu (env=<span class="number">0</span>x55555669e430, addr=&lt;optimized out&gt;, val=<span class="number">1</span>, oi=&lt;optimized out&gt;, ra=<span class="number">140736773646269</span>) at ../accel/tcg/cputlb.c:<span class="number">2850</span></span><br><span class="line">#<span class="number">21</span> <span class="number">0</span>x0000555555a42727 in helper_stl_mmu (env=&lt;optimized out&gt;, addr=&lt;optimized out&gt;, val=&lt;optimized out&gt;, oi=&lt;optimized out&gt;, retaddr=&lt;optimized out&gt;) at ../accel/tcg/cputlb.c:<span class="number">2866</span></span><br></pre></td></tr></table></figure>


<ol>
<li>怀疑点 CONFIG_IOMMU_DMA, 这个开关在 base 和升级版本上都开了.</li>
</ol>
<p>升级版本的开机日志:<br>dmesg | grep -E “DMAR|IOMMU”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[    <span class="number">1.156855</span>] Failed to <span class="built_in">set</span> up IOMMU <span class="keyword">for</span> device Fixed MDIO bus<span class="number">.0</span>; retaining platform DMA ops</span><br><span class="line">[    <span class="number">1.102567</span>] Failed to <span class="built_in">set</span> up IOMMU <span class="keyword">for</span> device riscv-pmu; retaining platform DMA ops</span><br></pre></td></tr></table></figure>

<p>base 版本中的开机日志中并没有上述异常.</p>
<p>先看下这处异常:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> iommu_domain *<span class="title function_">iommu_get_domain_for_dev</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iommu_domain</span> *<span class="title">domain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iommu_group</span> *<span class="title">group</span>;</span></span><br><span class="line">	group = iommu_group_get(dev);</span><br><span class="line">	<span class="comment">// error: 此处domain 为 null, 未找到 dev-&gt;group-&gt;domain</span></span><br><span class="line">	domain = group-&gt;domain;</span><br><span class="line">	<span class="keyword">return</span> domain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该 domain 应该来自于 iommu driver 设置的 default_domain<br>跟踪堆栈, 发现 xt_iommu driver 分配 default_domain 时失败了.</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">0</span>  xt_iommu_domain_alloc (type=&lt;optimized out&gt;) at ../drivers/iommu/xuantie-iommu.c:<span class="number">365</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0</span>xffffffff804f7444 in __iommu_domain_alloc (bus=<span class="number">0</span>xffffffff8150c0a0 &lt;platform_bus_type&gt;, type=&lt;optimized out&gt;) at ../drivers/iommu/iommu.c:<span class="number">1987</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0</span>xffffffff804f754c in iommu_group_alloc_default_domain (bus=bus@entry=<span class="number">0</span>xffffffff8150c0a0 &lt;platform_bus_type&gt;, group=group@entry=<span class="number">0</span>xff60000080015e00, type=&lt;optimized out&gt;) at ../drivers/iommu/iommu.c:<span class="number">1667</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0</span>xffffffff804f7d46 in probe_alloc_default_domain (group=<span class="number">0</span>xff60000080015e00, bus=<span class="number">0</span>xffffffff8150c0a0 &lt;platform_bus_type&gt;) at ../drivers/iommu/iommu.c:<span class="number">1819</span></span><br><span class="line">#<span class="number">4</span>  bus_iommu_probe (bus=bus@entry=<span class="number">0</span>xffffffff8150c0a0 &lt;platform_bus_type&gt;) at ../drivers/iommu/iommu.c:<span class="number">1882</span></span><br><span class="line">#<span class="number">5</span>  <span class="number">0</span>xffffffff804f7e24 in iommu_device_register (iommu=<span class="number">0</span>xff600000801f3d20, ops=ops@entry=<span class="number">0</span>xffffffff8150b120 &lt;xt_iommu_ops&gt;, hwdev=hwdev@entry=<span class="number">0</span>xff600000802c1010) at ../drivers/iommu/iommu.c:<span class="number">245</span></span><br><span class="line">#<span class="number">6</span>  <span class="number">0</span>xffffffff80837748 in xt_iommu_device_probe (pdev=<span class="number">0</span>xff600000802c1000) at ../drivers/iommu/xuantie-iommu.c:<span class="number">718</span></span><br></pre></td></tr></table></figure>

<p>在 <code>__iommu_domain_alloc</code> 函数中, 这个地方退出了, 而 base 版本没有这个逻辑.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (iommu_is_dma_domain(domain) &amp;&amp; iommu_get_dma_cookie(domain)) &#123;</span><br><span class="line">	iommu_domain_free(domain);</span><br><span class="line">	domain = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将这段注释掉后, 继而需要将 pci_bus_type 注册 iommu_ops, 但其他的 bus 类型 (platform_bus_type) 不能注册, 会导致异常, base 版本上的 xtiommu 只支持 pci_bus.<br>但升级版本已经没有 bus_set_iommu 相关的函数了, 只能改代码进行定制.</p>
<p>在改完后, 网卡在进行 dma 操作时, 已经使用 xtiommu, 但仍出现了异常.<br>还是表现在地址翻译时, 触发的地址 iova 不正常.</p>
<p>正常的 log:<br>xmmuv1_translate addr 4294963200<br>xmmuv1_translate addr 4294963201<br>xmmuv1_translate addr 4294963202<br>xmmuv1_translate addr 4294963203<br>…</p>
<p>而异常的 log:<br>xmmuv1_translate addr 4294963200<br>xmmuv1_translate addr 4294963204<br>xmmuv1_translate addr 4294963208<br>xmmuv1_translate addr 4294963212<br>退出</p>
<p>堆栈:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">0</span>  <span class="number">0</span>x000055555591f75b in xmmuv1_translate (mr=<span class="number">0</span>x555557025af0, addr=<span class="number">4294963201</span>, flag=IOMMU_RO, iommu_idx=<span class="number">0</span>) at ../hw/riscv/xmmuv1.c:<span class="number">104</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0</span>x00005555559fe09a in address_space_translate_iommu (iommu_mr=<span class="number">0</span>x555557025af0, xlat=xlat@entry=<span class="number">0</span>x7ffef59fdcc8, plen_out=plen_out@entry=<span class="number">0</span>x7ffef59fdd20, page_mask_out=page_mask_out@entry=<span class="number">0</span>x0, is_write=is_write@entry=<span class="literal">false</span>, is_mmio=<span class="literal">true</span>, target_as=<span class="number">0</span>x7ffef59fdc38, attrs=...) at ../softmmu/physmem.c:<span class="number">435</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0</span>x00005555559fe324 in flatview_do_translate (fv=fv@entry=<span class="number">0</span>x7ffef0252180, addr=addr@entry=<span class="number">4294963201</span>, xlat=xlat@entry=<span class="number">0</span>x7ffef59fdcc8, plen_out=plen_out@entry=<span class="number">0</span>x7ffef59fdd20, page_mask_out=page_mask_out@entry=<span class="number">0</span>x0, is_write=<span class="literal">false</span>, is_mmio=<span class="literal">true</span>, target_as=<span class="number">0</span>x7ffef59fdc38, attrs=...) at ../softmmu/physmem.c:<span class="number">508</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0</span>x00005555559feeb5 in flatview_translate (fv=fv@entry=<span class="number">0</span>x7ffef0252180, addr=addr@entry=<span class="number">4294963201</span>, xlat=xlat@entry=<span class="number">0</span>x7ffef59fdcc8, plen=plen@entry=<span class="number">0</span>x7ffef59fdd20, is_write=is_write@entry=<span class="literal">false</span>, attrs=..., attrs@entry=...) at ../softmmu/physmem.c:<span class="number">568</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0</span>x0000555555a02aa9 in flatview_read_continue (fv=fv@entry=<span class="number">0</span>x7ffef0252180, addr=<span class="number">4294963201</span>, addr@entry=<span class="number">4294963200</span>, attrs=..., ptr=ptr@entry=<span class="number">0</span>x7ffef59fde10, len=<span class="number">15</span>, len@entry=<span class="number">16</span>, addr1=&lt;optimized out&gt;, l=&lt;optimized out&gt;, mr=<span class="number">0</span>x55555656aee0) at ../softmmu/physmem.c:<span class="number">2738</span></span><br><span class="line">#<span class="number">5</span>  <span class="number">0</span>x0000555555a02baf in flatview_read (fv=<span class="number">0</span>x7ffef0252180, addr=addr@entry=<span class="number">4294963200</span>, attrs=attrs@entry=..., buf=buf@entry=<span class="number">0</span>x7ffef59fde10, len=len@entry=<span class="number">16</span>) at ../softmmu/physmem.c:<span class="number">2757</span></span><br><span class="line">#<span class="number">6</span>  <span class="number">0</span>x0000555555a02cdc in address_space_read_full (as=<span class="number">0</span>x7fffe8416250, addr=addr@entry=<span class="number">4294963200</span>, attrs=..., buf=buf@entry=<span class="number">0</span>x7ffef59fde10, len=len@entry=<span class="number">16</span>) at ../softmmu/physmem.c:<span class="number">2770</span></span><br><span class="line">#<span class="number">7</span>  <span class="number">0</span>x0000555555a02e15 in address_space_rw (as=&lt;optimized out&gt;, addr=addr@entry=<span class="number">4294963200</span>, attrs=..., attrs@entry=..., buf=buf@entry=<span class="number">0</span>x7ffef59fde10, len=len@entry=<span class="number">16</span>, is_write=is_write@entry=<span class="literal">false</span>) at ../softmmu/physmem.c:<span class="number">2798</span></span><br><span class="line">#<span class="number">8</span>  <span class="number">0</span>x00005555557bd7e9 in dma_memory_rw_relaxed (attrs=..., dir=DMA_DIRECTION_TO_DEVICE, len=<span class="number">16</span>, buf=<span class="number">0</span>x7ffef59fde10, addr=<span class="number">4294963200</span>, as=&lt;optimized out&gt;) at /home/liguang/program/riscv-lab/qemu/include/sysemu/dma.h:<span class="number">87</span></span><br><span class="line">#<span class="number">9</span>  <span class="number">0</span>x00005555557bd7e9 in dma_memory_rw (attrs=..., dir=DMA_DIRECTION_TO_DEVICE, len=<span class="number">16</span>, buf=<span class="number">0</span>x7ffef59fde10, addr=<span class="number">4294963200</span>, as=&lt;optimized out&gt;) at /home/liguang/program/riscv-lab/qemu/include/sysemu/dma.h:<span class="number">130</span></span><br><span class="line">#<span class="number">10</span> <span class="number">0</span>x00005555557bd7e9 in pci_dma_rw (attrs=..., dir=DMA_DIRECTION_TO_DEVICE, len=<span class="number">16</span>, buf=<span class="number">0</span>x7ffef59fde10, addr=&lt;optimized out&gt;, dev=&lt;optimized out&gt;) at /home/liguang/program/riscv-lab/qemu/include/hw/pci/pci_device.h:<span class="number">233</span></span><br><span class="line">#<span class="number">11</span> <span class="number">0</span>x00005555557bd7e9 in pci_dma_read (len=<span class="number">16</span>, buf=<span class="number">0</span>x7ffef59fde10, addr=&lt;optimized out&gt;, dev=&lt;optimized out&gt;) at /home/liguang/program/riscv-lab/qemu/include/hw/pci/pci_device.h:<span class="number">252</span></span><br><span class="line">#<span class="number">12</span> <span class="number">0</span>x00005555557bd7e9 in e1000e_start_xmit (core=<span class="number">0</span>x7fffe8418eb0, txr=txr@entry=<span class="number">0</span>x7ffef59fde80) at ../hw/net/e1000e_core.c:<span class="number">944</span></span><br><span class="line">#<span class="number">13</span> <span class="number">0</span>x00005555557bdda6 in e1000e_set_tdt (core=&lt;optimized out&gt;, index=&lt;optimized out&gt;, val=&lt;optimized out&gt;) at ../hw/net/e1000e_core.c:<span class="number">2456</span></span><br><span class="line">#<span class="number">14</span> <span class="number">0</span>x00005555557c1130 in e1000e_core_write (core=<span class="number">0</span>x7fffe8418eb0, addr=&lt;optimized out&gt;, val=<span class="number">1</span>, size=<span class="number">4</span>) at ../hw/net/e1000e_core.c:<span class="number">3280</span></span><br><span class="line">#<span class="number">15</span> <span class="number">0</span>x00005555557b7b66 in e1000e_mmio_write (opaque=&lt;optimized out&gt;, addr=&lt;optimized out&gt;, val=&lt;optimized out&gt;, size=&lt;optimized out&gt;) at ../hw/net/e1000e.c:<span class="number">112</span></span><br></pre></td></tr></table></figure>

<p>在 flatview_read_continue 处追踪, 发现步长来自于翻译结果, 进一步跟踪发现<br>xt iommu 在第一级地址转换处出问题了 <code>riscv_one_stage</code>, 地址翻译出错了.</p>
<p>qemu 中的 xt iommu 是未改动的, 且在 base 版本和升级版本都是同一份, 所以问题应该出现在 map 的地方.</p>
<p>跟踪 kernel 中 xt_iommu_map 的过程</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">0</span>  xt_iommu_map (domain=<span class="number">0</span>xff6000008023a6b0, iova=<span class="number">4294963200</span>, paddr=<span class="number">4397146112</span>, pgsize=<span class="number">4096</span>, pgcount=<span class="number">1</span>, iommu_prot=<span class="number">7</span>, gfp=<span class="number">3520</span>, mapped=<span class="number">0</span>xff20000000d13218) at ../drivers/iommu/xuantie-iommu.c:<span class="number">70</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0</span>xffffffff804f56bc in __iommu_map_pages (mapped=<span class="number">0</span>xff20000000d13218, gfp=<span class="number">3520</span>, prot=<span class="number">7</span>, size=<span class="number">4096</span>, paddr=&lt;optimized out&gt;, iova=<span class="number">4294963200</span>, domain=<span class="number">0</span>xff6000008023a6b0) at ../drivers/iommu/iommu.c:<span class="number">2359</span></span><br><span class="line">#<span class="number">2</span>  __iommu_map (domain=domain@entry=<span class="number">0</span>xff6000008023a6b0, iova=iova@entry=<span class="number">4294963200</span>, paddr=&lt;optimized out&gt;, paddr@entry=<span class="number">4397146112</span>, size=size@entry=<span class="number">4096</span>, prot=prot@entry=<span class="number">7</span>, gfp=gfp@entry=<span class="number">3520</span>) at ../drivers/iommu/iommu.c:<span class="number">2405</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0</span>xffffffff804f58f4 in iommu_map_sg (domain=domain@entry=<span class="number">0</span>xff6000008023a6b0, iova=iova@entry=<span class="number">4294963200</span>, sg=sg@entry=<span class="number">0</span>xff600000822a9ac0, nents=&lt;optimized out&gt;, prot=prot@entry=<span class="number">7</span>, gfp=gfp@entry=<span class="number">3520</span>) at ../drivers/iommu/iommu.c:<span class="number">2560</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0</span>xffffffff804f9644 in __iommu_dma_alloc_noncontiguous (dev=dev@entry=<span class="number">0</span>xff600000802890c8, size=size@entry=<span class="number">4096</span>, sgt=sgt@entry=<span class="number">0</span>xff20000000d133f8, gfp=<span class="number">3520</span>, attrs=attrs@entry=<span class="number">0</span>, prot=...) at ../drivers/iommu/dma-iommu.c:<span class="number">846</span></span><br><span class="line">#<span class="number">5</span>  <span class="number">0</span>xffffffff804fa042 in iommu_dma_alloc_remap (attrs=<span class="number">0</span>, prot=..., gfp=&lt;optimized out&gt;, dma_handle=<span class="number">0</span>xff600000808ce990, size=<span class="number">4096</span>, dev=<span class="number">0</span>xff600000802890c8) at ../drivers/iommu/dma-iommu.c:<span class="number">872</span></span><br><span class="line">#<span class="number">6</span>  iommu_dma_alloc (dev=<span class="number">0</span>xff600000802890c8, size=<span class="number">4096</span>, handle=<span class="number">0</span>xff600000808ce990, gfp=&lt;optimized out&gt;, attrs=<span class="number">0</span>) at ../drivers/iommu/dma-iommu.c:<span class="number">1462</span></span><br><span class="line">#<span class="number">7</span>  <span class="number">0</span>xffffffff80088072 in dma_alloc_attrs (dev=<span class="number">0</span>xff600000802890c8, size=<span class="number">4096</span>, dma_handle=dma_handle@entry=<span class="number">0</span>xff600000808ce990, flag=flag@entry=<span class="number">3264</span>, attrs=attrs@entry=<span class="number">0</span>) at ../kernel/dma/mapping.c:<span class="number">522</span></span><br><span class="line">#<span class="number">8</span>  <span class="number">0</span>xffffffff805aea92 in dma_alloc_coherent (gfp=<span class="number">3264</span>, dma_handle=<span class="number">0</span>xff600000808ce990, size=&lt;optimized out&gt;, dev=&lt;optimized out&gt;) at ../include/linux/dma-mapping.h:<span class="number">423</span></span><br><span class="line">#<span class="number">9</span>  e1000_alloc_ring_dma (adapter=<span class="number">0</span>xff600000811a4980, adapter=<span class="number">0</span>xff600000811a4980, ring=<span class="number">0</span>xff600000808ce980) at ../drivers/net/ethernet/intel/e1000e/netdev.c:<span class="number">2317</span></span><br><span class="line">#<span class="number">10</span> e1000e_setup_tx_resources (tx_ring=<span class="number">0</span>xff600000808ce980) at ../drivers/net/ethernet/intel/e1000e/netdev.c:<span class="number">2345</span></span><br><span class="line">#<span class="number">11</span> <span class="number">0</span>xffffffff805b044a in e1000e_open (netdev=<span class="number">0</span>xff600000811a4000) at ../drivers/net/ethernet/intel/e1000e/netdev.c:<span class="number">4630</span></span><br></pre></td></tr></table></figure>

<p>追踪 map 的过程, 发现 xt iommu 驱动代码中做 mmu 映射时, 启用的 sv39 mode, 第一级的 pgd_shift 错误了使用了系统中定义的<br><code>PGDIR_SHIFT</code></p>
<p>这个值是跟着系统的页表模式走的, 当前系统使用了 sv57 mode 5 级页表, 所以这个值是 48, 而 sv39 mode 这个值应该是 30.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loop; ++i) &#123;</span><br><span class="line">	vpn2_idx = (iova &gt;&gt; PGDIR_SHIFT) &amp; PAGE_TABLE_LEVEL_MASK;</span><br><span class="line">	vpn1_idx = (iova &gt;&gt; PMD_SHIFT) &amp; PAGE_TABLE_LEVEL_MASK;</span><br><span class="line">	vpn0_idx = (iova &gt;&gt; PAGE_SHIFT) &amp; PAGE_TABLE_LEVEL_MASK;</span><br></pre></td></tr></table></figure>

<p>将 PGDIR_SHIFT 修改为 PGDIR39_SHIFT (30) 后<br>再进行测试, 发现 host 中启用 xt iommu 进行 dma 的寻址终于正常了.</p>
<p>host 中正常后, 再进行 guest 直通网卡测试<br>发现 guest kvm-mode 下直通的 e1000e 网卡也正常工作了</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/riscv/" rel="tag"># riscv</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/07/18/hxd_new/%E5%AE%89%E5%85%A8/nuclei%20opensbi%20optee%20%E6%96%B9%E6%A1%88/" rel="prev" title="nuclei opensbi optee 方案">
      <i class="fa fa-chevron-left"></i> nuclei opensbi optee 方案
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/08/18/hxd_new/%E5%AE%89%E5%85%A8/riscv%20%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6/" rel="next" title="riscv 硬件安全机制.md">
      riscv 硬件安全机制.md <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#qemu-xmmuv1-%E6%A8%A1%E6%8B%9F%E8%A1%8C%E4%B8%BA"><span class="nav-number">1.</span> <span class="nav-text">qemu xmmuv1 模拟行为</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liguang.zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">146</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">86</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">102</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liguang.zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
