<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW WenKai:300,300italic,400,400italic,700,700italic|LXGW WenKai Mono, Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liguangzhang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":{"valine":{"order":-1}},"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="1. Android 8.11.1. 涉及的文件 StorageStats.java  AppStorageSettings.java  InstalledAppDetails.java  StorageStatsManager.java  StorageStatsService.java  PackageManagerService.java   1.2. 相关代码计算方式:  totalSiz">
<meta property="og:type" content="article">
<meta property="og:title" content="统计app 总使用空间">
<meta property="og:url" content="https://liguangzhang.github.io/2017/10/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/%E7%BB%9F%E8%AE%A1app%E6%80%BB%E4%BD%BF%E7%94%A8%E7%A9%BA%E9%97%B4/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:description" content="1. Android 8.11.1. 涉及的文件 StorageStats.java  AppStorageSettings.java  InstalledAppDetails.java  StorageStatsManager.java  StorageStatsService.java  PackageManagerService.java   1.2. 相关代码计算方式:  totalSiz">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2017-09-30T16:00:00.000Z">
<meta property="article:modified_time" content="2024-04-15T10:49:53.119Z">
<meta property="article:author" content="liguang.zhang">
<meta property="article:tag" content="Android 8.1">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liguangzhang.github.io/2017/10/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/%E7%BB%9F%E8%AE%A1app%E6%80%BB%E4%BD%BF%E7%94%A8%E7%A9%BA%E9%97%B4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'" />

  <title>统计app 总使用空间 | blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2017/10/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/%E7%BB%9F%E8%AE%A1app%E6%80%BB%E4%BD%BF%E7%94%A8%E7%A9%BA%E9%97%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          统计app 总使用空间
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-10-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-10-01T00:00:00+08:00">2017-10-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-15 18:49:53" itemprop="dateModified" datetime="2024-04-15T18:49:53+08:00">2024-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/app-storage/" itemprop="url" rel="index"><span itemprop="name">app storage</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2017/10/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/%E7%BB%9F%E8%AE%A1app%E6%80%BB%E4%BD%BF%E7%94%A8%E7%A9%BA%E9%97%B4/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2017/10/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/%E7%BB%9F%E8%AE%A1app%E6%80%BB%E4%BD%BF%E7%94%A8%E7%A9%BA%E9%97%B4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-Android-8-1"><a href="#1-Android-8-1" class="headerlink" title="1. Android 8.1"></a>1. Android 8.1</h1><h2 id="1-1-涉及的文件"><a href="#1-1-涉及的文件" class="headerlink" title="1.1. 涉及的文件"></a>1.1. 涉及的文件</h2><ul>
<li><p>StorageStats.java</p>
</li>
<li><p>AppStorageSettings.java</p>
</li>
<li><p>InstalledAppDetails.java</p>
</li>
<li><p>StorageStatsManager.java</p>
</li>
<li><p>StorageStatsService.java</p>
</li>
<li><p>PackageManagerService.java</p>
</li>
</ul>
<h2 id="1-2-相关代码"><a href="#1-2-相关代码" class="headerlink" title="1.2. 相关代码"></a>1.2. 相关代码</h2><p>计算方式: </p>
<p>totalSize &#x3D; stats.(codeSize + externalCodeSize + dataSize + externalDataSize + cacheSize +externalCacheSize );</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUi</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (mLastResult == <span class="literal">null</span>) &#123;</span><br><span class="line">   ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">codeSize</span> <span class="operator">=</span> mLastResult.getCodeBytes();</span><br><span class="line">    <span class="type">long</span> <span class="variable">dataSize</span> <span class="operator">=</span></span><br><span class="line">      mDataCleared ? <span class="number">0</span> : mLastResult.getDataBytes() - mLastResult.getCacheBytes();</span><br><span class="line">    <span class="keyword">if</span> (mLastCodeSize != codeSize) &#123;</span><br><span class="line">      mLastCodeSize = codeSize;</span><br><span class="line">      mAppSize.setSummary(getSizeStr(context, codeSize));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mLastDataSize != dataSize) &#123;</span><br><span class="line">      mLastDataSize = dataSize;</span><br><span class="line">      mDataSize.setSummary(getSizeStr(context, dataSize));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">cacheSize</span> <span class="operator">=</span> (mDataCleared || mCachedCleared) ? <span class="number">0</span> : mLastResult.getCacheBytes();</span><br><span class="line">    <span class="keyword">if</span> (mLastCacheSize != cacheSize) &#123;</span><br><span class="line">      mLastCacheSize = cacheSize;</span><br><span class="line">      mCacheSize.setSummary(getSizeStr(context, cacheSize));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// codeBytes + dataBytes + cacheBytes</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">totalSize</span> <span class="operator">=</span> codeSize + dataSize + cacheSize;</span><br><span class="line">    <span class="keyword">if</span> (mLastTotalSize != totalSize) &#123;</span><br><span class="line">      mLastTotalSize = totalSize;</span><br><span class="line">      mTotalSize.setSummary(getSizeStr(context, totalSize));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">updateUiWithSize(mSizeController.getLastResult());</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoadFinished</span><span class="params">(Loader&lt;AppStorageStats&gt; loader, AppStorageStats result)</span> &#123;</span><br><span class="line">  mSizeController.setResult(result);</span><br><span class="line">  updateUiWithSize(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AppStorageStats <span class="title function_">loadInBackground</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">AppStorageStats</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    result = mSource.getStatsForPackage(mInfo.volumeUuid, mInfo.packageName, mUser);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (NameNotFoundException | IOException e) &#123;</span><br><span class="line">    Log.w(TAG, <span class="string">&quot;Package may have been removed during query, failing gracefully&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mInfo = packageManager.getApplicationInfo(mPackageName, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问 StorageStatsService的   queryStatsForPackage</span></span><br><span class="line"><span class="keyword">public</span> StorageStats <span class="title function_">queryStatsForPackage</span><span class="params">(String volumeUuid, String packageName, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">                                         String callingPackage)</span> &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> ApplicationInfo appInfo;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    appInfo = mPackage.getApplicationInfoAsUser(packageName,</span><br><span class="line">                                                PackageManager.MATCH_UNINSTALLED_PACKAGES, userId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 以SharedUserSetting 区分, 查找shareUser, 且ps.getInstalled(userId) = true的, </span></span><br><span class="line">  <span class="keyword">if</span> (defeatNullable(mPackage.getPackagesForUid(appInfo.uid)).length == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 只有一个时, 直接调用 queryStatsForUid函数</span></span><br><span class="line">    <span class="comment">// Only one package inside UID means we can fast-path</span></span><br><span class="line">    <span class="keyword">return</span> queryStatsForUid(volumeUuid, appInfo.uid, callingPackage);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Multiple packages means we need to go manual</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">appId</span> <span class="operator">=</span> UserHandle.getUserId(appInfo.uid);</span><br><span class="line">    <span class="keyword">final</span> String[] packageNames = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; packageName &#125;;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span>[] ceDataInodes = <span class="keyword">new</span> <span class="title class_">long</span>[<span class="number">1</span>];</span><br><span class="line">    String[] codePaths = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (appInfo.isSystemApp() &amp;&amp; !appInfo.isUpdatedSystemApp()) &#123;</span><br><span class="line">      <span class="comment">// We don&#x27;t count code baked into system image</span></span><br><span class="line">      <span class="comment">// 不计算system下的app size</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      codePaths = ArrayUtils.appendElement(String.class, codePaths,                    appInfo.getCodePath());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">PackageStats</span> <span class="variable">stats</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageStats</span>(TAG);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      mInstaller.getAppSize(volumeUuid, packageNames, userId, <span class="number">0</span>,</span><br><span class="line">                            appId, ceDataInodes, codePaths, stats);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> translate(stats);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> StorageStats <span class="title function_">translate</span><span class="params">(PackageStats stats)</span> &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">StorageStats</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StorageStats</span>();</span><br><span class="line">  <span class="comment">// 最终是计算的这三个部分.</span></span><br><span class="line">  res.codeBytes = stats.codeSize + stats.externalCodeSize;</span><br><span class="line">  res.dataBytes = stats.dataSize + stats.externalDataSize;</span><br><span class="line">  res.cacheBytes = stats.cacheSize + stats.externalCacheSize;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> StorageStats <span class="title function_">queryStatsForUid</span><span class="params">(String volumeUuid, <span class="type">int</span> uid, String callingPackage)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> UserHandle.getUserId(uid);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">appId</span> <span class="operator">=</span> UserHandle.getAppId(uid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (userId != UserHandle.getCallingUserId()) &#123;</span><br><span class="line">        mContext.enforceCallingOrSelfPermission(</span><br><span class="line">                android.Manifest.permission.INTERACT_ACROSS_USERS, TAG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingUid() == uid) &#123;</span><br><span class="line">        <span class="comment">// No permissions required when asking about themselves</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        enforcePermission(Binder.getCallingUid(), callingPackage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String[] packageNames = defeatNullable(mPackage.getPackagesForUid(uid));</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span>[] ceDataInodes = <span class="keyword">new</span> <span class="title class_">long</span>[packageNames.length];</span><br><span class="line">    String[] codePaths = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//上面做过检验, defeatNullable(mPackage.getPackagesForUid(appInfo.uid)).length == 1),   即</span></span><br><span class="line">  <span class="comment">//  packageNames.length = 1;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; packageNames.length; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ApplicationInfo</span> <span class="variable">appInfo</span> <span class="operator">=</span> mPackage.getApplicationInfoAsUser(packageNames[i],</span><br><span class="line">                    PackageManager.MATCH_UNINSTALLED_PACKAGES, userId);</span><br><span class="line">            <span class="keyword">if</span> (appInfo.isSystemApp() &amp;&amp; !appInfo.isUpdatedSystemApp()) &#123;</span><br><span class="line">                <span class="comment">// We don&#x27;t count code baked into system image</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                codePaths = ArrayUtils.appendElement(String.class, codePaths,</span><br><span class="line">                        appInfo.getCodePath());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ParcelableException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">PackageStats</span> <span class="variable">stats</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageStats</span>(TAG);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mInstaller.getAppSize(volumeUuid, packageNames, userId, getDefaultFlags(),</span><br><span class="line">                appId, ceDataInodes, codePaths, stats);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ParcelableException</span>(<span class="keyword">new</span> <span class="title class_">IOException</span>(e.getMessage()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> translate(stats);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终执行的代码为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">codePaths = appInfo.getCodePath());</span><br><span class="line">mInstaller.getAppSize(volumeUuid, packageNames, userId, getDefaultFlags(),</span><br><span class="line">            appId, ceDataInodes, codePaths, stats);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getAppSize</span><span class="params">(String uuid, String[] packageNames, <span class="type">int</span> userId, <span class="type">int</span> flags, <span class="type">int</span> appId,</span></span><br><span class="line"><span class="params">                       <span class="type">long</span>[] ceDataInodes, String[] codePaths, PackageStats stats)</span></span><br><span class="line">  <span class="keyword">throws</span> InstallerException &#123;</span><br><span class="line">  <span class="keyword">if</span> (!checkBeforeRemote()) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span>[] res = mInstalld.getAppSize(uuid, packageNames, userId, flags,</span><br><span class="line">                                            appId, ceDataInodes, codePaths);</span><br><span class="line">    stats.codeSize += res[<span class="number">0</span>];</span><br><span class="line">    stats.dataSize += res[<span class="number">1</span>];</span><br><span class="line">    stats.cacheSize += res[<span class="number">2</span>];</span><br><span class="line">    ...</span><br><span class="line">    stats.externalCodeSize += res[<span class="number">3</span>];</span><br><span class="line">    stats.externalDataSize += res[<span class="number">4</span>];</span><br><span class="line">    stats.externalCacheSize += res[<span class="number">5</span>];</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> InstallerException.from(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行进入installd中, 关注 getAppSize的实现.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">stats</span> stats;</span><br><span class="line"><span class="comment">// 是否开启quota</span></span><br><span class="line"><span class="keyword">auto</span> device = <span class="built_in">findQuotaDeviceForUuid</span>(uuid);</span><br><span class="line"><span class="keyword">if</span> (device.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    flags &amp;= ~FLAG_USE_QUOTA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">ATRACE_BEGIN</span>(<span class="string">&quot;obb&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> packageName : packageNames) &#123;</span><br><span class="line">    <span class="comment">// data/media/obb/packageName/ 下的文件大小,计入 extStats.codeSize 中</span></span><br><span class="line">    <span class="keyword">auto</span> obbCodePath = <span class="built_in">create_data_media_obb_path</span>(uuid_, packageName.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="built_in">calculate_tree_size</span>(obbCodePath, &amp;extStats.codeSize);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">ATRACE_END</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (flags &amp; FLAG_USE_QUOTA &amp;&amp; appId &gt;= AID_APP_START) &#123;</span><br><span class="line">    <span class="built_in">ATRACE_BEGIN</span>(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> codePath : codePaths) &#123;</span><br><span class="line">        <span class="comment">// 统计codePath 的大小, 计入codeSize排除gid为 appid - 10000 + 50000的share gid的文件统计</span></span><br><span class="line">        <span class="built_in">calculate_tree_size</span>(codePath, &amp;stats.codeSize, <span class="number">-1</span>,</span><br><span class="line">                <span class="built_in">multiuser_get_shared_gid</span>(<span class="number">0</span>, appId));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ATRACE_END</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ATRACE_BEGIN</span>(<span class="string">&quot;quota&quot;</span>);</span><br><span class="line">   <span class="comment">// current usage for user or group id</span></span><br><span class="line">   <span class="comment">// 查询quota中记录的  user/cachegid/sharedgid 的使用量.</span></span><br><span class="line">    <span class="built_in">collectQuotaStats</span>(device, userId, appId, &amp;stats, &amp;extStats);</span><br><span class="line">    <span class="built_in">ATRACE_END</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 没有开启quota的情况:</span></span><br><span class="line">    <span class="built_in">ATRACE_BEGIN</span>(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">    <span class="comment">// 统计codePaths的大小</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> codePath : codePaths) &#123;</span><br><span class="line">        <span class="built_in">calculate_tree_size</span>(codePath, &amp;stats.codeSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ATRACE_END</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; packageNames.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* pkgname = packageNames[i].<span class="built_in">c_str</span>();</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ATRACE_BEGIN</span>(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">        <span class="comment">// data/user_ce/user_id/packageName</span></span><br><span class="line">        <span class="keyword">auto</span> cePath = <span class="built_in">create_data_user_ce_package_path</span>(uuid_, userId, pkgname, ceDataInodes[i]);</span><br><span class="line">        <span class="built_in">collectManualStats</span>(cePath, &amp;stats);</span><br><span class="line">        <span class="comment">// data/user_de/user_id/packageName</span></span><br><span class="line">        <span class="keyword">auto</span> dePath = <span class="built_in">create_data_user_de_package_path</span>(uuid_, userId, pkgname);</span><br><span class="line">        <span class="comment">// 统计上面两个目录的大小, cache code_cache下的放到 cache_size中,其他的放到data_size中.</span></span><br><span class="line">        <span class="comment">// 如果lib 是链接, 忽略, 不是链接, 计入 code_size中</span></span><br><span class="line">        <span class="built_in">collectManualStats</span>(dePath, &amp;stats);</span><br><span class="line">        <span class="built_in">ATRACE_END</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!uuid) &#123;</span><br><span class="line">            <span class="built_in">ATRACE_BEGIN</span>(<span class="string">&quot;profiles&quot;</span>);</span><br><span class="line">            <span class="comment">// /data/misc/profiles/cur/user_id/packageName</span></span><br><span class="line">            <span class="built_in">calculate_tree_size</span>(</span><br><span class="line">                    <span class="built_in">create_primary_current_profile_package_dir_path</span>(userId, pkgname),</span><br><span class="line">                    &amp;stats.dataSize);</span><br><span class="line">            <span class="comment">//  /data/misc/profiles/ref/packageName</span></span><br><span class="line">            <span class="built_in">calculate_tree_size</span>(</span><br><span class="line">                    <span class="built_in">create_primary_reference_profile_package_dir_path</span>(pkgname),</span><br><span class="line">                    &amp;stats.codeSize);</span><br><span class="line">            <span class="built_in">ATRACE_END</span>();</span><br><span class="line">        &#125;         </span><br><span class="line">        <span class="built_in">ATRACE_BEGIN</span>(<span class="string">&quot;external&quot;</span>);</span><br><span class="line">        <span class="comment">// /data/media/&lt;user_id&gt;/Android/data/PackageName 下的大小, 计入extStats.dataSize中, cache|code_cache下放到extStats.cacheSize</span></span><br><span class="line">        <span class="keyword">auto</span> extPath = <span class="built_in">create_data_media_package_path</span>(uuid_, userId, <span class="string">&quot;data&quot;</span>, pkgname);</span><br><span class="line">        <span class="built_in">collectManualStats</span>(extPath, &amp;extStats);</span><br><span class="line">        <span class="comment">// /data/media/&lt;user_id&gt;/Android/media/PackageName 下的 计入extStats.dataSize中.</span></span><br><span class="line">        <span class="keyword">auto</span> mediaPath = <span class="built_in">create_data_media_package_path</span>(uuid_, userId, <span class="string">&quot;media&quot;</span>, pkgname);</span><br><span class="line">        <span class="built_in">calculate_tree_size</span>(mediaPath, &amp;extStats.dataSize);</span><br><span class="line">        <span class="built_in">ATRACE_END</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!uuid) &#123;</span><br><span class="line">        <span class="built_in">ATRACE_BEGIN</span>(<span class="string">&quot;dalvik&quot;</span>);</span><br><span class="line">        <span class="comment">// appId - 10000  + 50000</span></span><br><span class="line">        <span class="type">int32_t</span> sharedGid = <span class="built_in">multiuser_get_shared_gid</span>(<span class="number">0</span>, appId);</span><br><span class="line">        <span class="keyword">if</span> (sharedGid != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">//  /data/dalvik-cache/  且文件所属用户组 为 appId - 10000  + 50000的,</span></span><br><span class="line">            <span class="built_in">calculate_tree_size</span>(<span class="built_in">create_data_dalvik_cache_path</span>(), &amp;stats.codeSize,</span><br><span class="line">                    sharedGid, <span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">ATRACE_END</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::vector&lt;<span class="type">int64_t</span>&gt; ret;</span><br><span class="line">ret.<span class="built_in">push_back</span>(stats.codeSize);</span><br><span class="line">ret.<span class="built_in">push_back</span>(stats.dataSize);</span><br><span class="line">ret.<span class="built_in">push_back</span>(stats.cacheSize);</span><br><span class="line">ret.<span class="built_in">push_back</span>(extStats.codeSize);</span><br><span class="line">ret.<span class="built_in">push_back</span>(extStats.dataSize);</span><br><span class="line">ret.<span class="built_in">push_back</span>(extStats.cacheSize);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// current usage for user or group id</span></span><br><span class="line"><span class="comment">// 查询quota中记录的  user/cachegid/sharedgid 的使用量. 放入 data_size cache_size data_size</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">collectQuotaStats</span><span class="params">(<span class="type">const</span> std::string&amp; device, <span class="type">int32_t</span> userId,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int32_t</span> appId, <span class="keyword">struct</span> stats* stats, <span class="keyword">struct</span> stats* extStats)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (device.<span class="built_in">empty</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dqblk</span> dq;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stats != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="comment">// userid * 100000 + appid % 100000</span></span><br><span class="line">        <span class="type">uid_t</span> uid = <span class="built_in">multiuser_get_uid</span>(userId, appId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">quotactl</span>(<span class="built_in">QCMD</span>(Q_GETQUOTA, USRQUOTA), device.<span class="built_in">c_str</span>(), uid,</span><br><span class="line">                <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;dq)) != <span class="number">0</span>) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            stats-&gt;dataSize += dq.dqb_curspace;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// userid * 100000 + appid - 10000 + 20000</span></span><br><span class="line">        <span class="comment">// cacheGid 实际指向的目录 还是CE|DE 区的  cache code_cache目录 </span></span><br><span class="line">        <span class="type">int</span> cacheGid = <span class="built_in">multiuser_get_cache_gid</span>(userId, appId);</span><br><span class="line">        <span class="keyword">if</span> (cacheGid != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">quotactl</span>(<span class="built_in">QCMD</span>(Q_GETQUOTA, GRPQUOTA), device.<span class="built_in">c_str</span>(), cacheGid,</span><br><span class="line">                    <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;dq)) != <span class="number">0</span>) &#123;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stats-&gt;cacheSize += dq.dqb_curspace;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//  userid * 100000 + appid - 10000 + 50000</span></span><br><span class="line">        <span class="comment">// sharegid指向 /data/misc/profiles/&lt;packageName&gt;</span></span><br><span class="line">        <span class="type">int</span> sharedGid = <span class="built_in">multiuser_get_shared_gid</span>(<span class="number">0</span>, appId);</span><br><span class="line">        <span class="keyword">if</span> (sharedGid != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">quotactl</span>(<span class="built_in">QCMD</span>(Q_GETQUOTA, GRPQUOTA), device.<span class="built_in">c_str</span>(), sharedGid,</span><br><span class="line">                    <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;dq)) != <span class="number">0</span>) &#123;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stats-&gt;codeSize += dq.dqb_curspace;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">if</span> (extStats != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="comment">// 指向 /storage/emulated/&lt;userid&gt;/Android/obb|data|media/&lt;packageName&gt;, 计入 extStats-&gt;dataSize中, 除去cache目录</span></span><br><span class="line">        <span class="type">int</span> extGid = <span class="built_in">multiuser_get_ext_gid</span>(userId, appId);</span><br><span class="line">        <span class="keyword">if</span> (extGid != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">quotactl</span>(<span class="built_in">QCMD</span>(Q_GETQUOTA, GRPQUOTA), device.<span class="built_in">c_str</span>(), extGid,</span><br><span class="line">                    <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;dq)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (errno != ESRCH) &#123;</span><br><span class="line">                    <span class="built_in">PLOG</span>(ERROR) &lt;&lt; <span class="string">&quot;Failed to quotactl &quot;</span> &lt;&lt; device &lt;&lt; <span class="string">&quot; for GID &quot;</span> &lt;&lt; extGid;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> MEASURE_DEBUG</span></span><br><span class="line">                <span class="built_in">LOG</span>(DEBUG) &lt;&lt; <span class="string">&quot;quotactl() for GID &quot;</span> &lt;&lt; extGid &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; dq.dqb_curspace;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                extStats-&gt;dataSize += dq.dqb_curspace;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 指向 /storage/emulated/&lt;userid&gt;/Android/obb|data|media/&lt;packageName&gt;/cache目录, 计入 extStats-&gt;dataSize 和 cacheSize? 这个地方是不是重复了?</span></span><br><span class="line">        <span class="type">int</span> extCacheGid = <span class="built_in">multiuser_get_ext_cache_gid</span>(userId, appId);</span><br><span class="line">        <span class="keyword">if</span> (extCacheGid != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">quotactl</span>(<span class="built_in">QCMD</span>(Q_GETQUOTA, GRPQUOTA), device.<span class="built_in">c_str</span>(), extCacheGid,</span><br><span class="line">                    <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(&amp;dq)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (errno != ESRCH) &#123;</span><br><span class="line">                    <span class="built_in">PLOG</span>(ERROR) &lt;&lt; <span class="string">&quot;Failed to quotactl &quot;</span> &lt;&lt; device &lt;&lt; <span class="string">&quot; for GID &quot;</span> &lt;&lt; extCacheGid;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> MEASURE_DEBUG</span></span><br><span class="line">                <span class="built_in">LOG</span>(DEBUG) &lt;&lt; <span class="string">&quot;quotactl() for GID &quot;</span> &lt;&lt; extCacheGid &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; dq.dqb_curspace;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                extStats-&gt;dataSize += dq.dqb_curspace;</span><br><span class="line">                extStats-&gt;cacheSize += dq.dqb_curspace;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-1-没有开启quota的情况下"><a href="#1-2-1-没有开启quota的情况下" class="headerlink" title="1.2.1. 没有开启quota的情况下"></a>1.2.1. 没有开启quota的情况下</h3><ul>
<li><p>统计codePaths的大小, 放入<code>codeSize</code>中. 预制在system分区的应用codeSize不统计大小</p>
</li>
<li><p>统计ce区 De区的应用的所占空间大小, 目录为data&#x2F;user_ce|user_de&#x2F;user_id&#x2F;packageName, </p>
<p>cache目录和code_cache放到 <code>cacheSize</code>中, 其他的放到<code>dataSize</code>中.如果lib 是链接, 忽略, 不是链接, 计入<code>dataSize</code>中</p>
</li>
<li><p>&#x2F;data&#x2F;misc&#x2F;profiles&#x2F;cur&#x2F;user_id&#x2F;packageName计入<code>dataSize</code>中, &#x2F;data&#x2F;misc&#x2F;profiles&#x2F;ref&#x2F;packageName计入<code>codeSize</code>中.</p>
</li>
<li><p>&#x2F;data&#x2F;dalvik-cache&#x2F;下且文件所属用户组 为 appId - 10000  + 50000的, 计入<code>codeSize</code>中. appid&gt;&#x3D;0且appid&lt;10000的, 统计所属用户组为appid为文件.</p>
</li>
<li><p>&#x2F;data&#x2F;media&#x2F;obb&#x2F;packageName&#x2F; 下的文件大小,计入 extStats.codeSize 中</p>
</li>
<li><p>&#x2F;data&#x2F;media&#x2F;user_id&#x2F;Android&#x2F;data&#x2F;PackageName 下的大小, 计入extStats.dataSize中, cache|code_cache下放到extStats.cacheSize</p>
</li>
<li><p>&#x2F;data&#x2F;media&#x2F;user_id&#x2F;Android&#x2F;media&#x2F;PackageName 下的 计入extStats.dataSize中.</p>
</li>
</ul>
<h3 id="1-2-2-开启quota的情况"><a href="#1-2-2-开启quota的情况" class="headerlink" title="1.2.2. 开启quota的情况"></a>1.2.2. 开启quota的情况</h3><ul>
<li>data&#x2F;media&#x2F;obb&#x2F;packageName&#x2F; 下的文件大小,计入 extStats.codeSize 中</li>
<li>统计codePath 的大小, 计入codeSize, 排除gid为 appid - 10000 + 50000的share gid的文件统计,appid&gt;&#x3D;0且appid&lt;10000的, 统计所属用户组为appid为文件.</li>
<li>查询quota中记录的  uid&#x2F;cachegid&#x2F;sharedgid 的使用量.</li>
</ul>
<h1 id="2-Android7-0"><a href="#2-Android7-0" class="headerlink" title="2. Android7.0"></a>2. Android7.0</h1><h2 id="2-1-涉及的文件"><a href="#2-1-涉及的文件" class="headerlink" title="2.1. 涉及的文件"></a>2.1. 涉及的文件</h2><ul>
<li>ApplicationState.java</li>
<li>AppStorageSettings.java</li>
<li>PackageManagerService.java</li>
</ul>
<h2 id="2-2-相关代码"><a href="#2-2-相关代码" class="headerlink" title="2.2. 相关代码"></a>2.2. 相关代码</h2><p>AppStorageSettings activity界面负责应用存储信息的展示.</p>
<p>onResume时会对该app的各大小进行统计</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  super.<span class="built_in">onResume</span>();</span><br><span class="line">  mState.<span class="built_in">requestSize</span>(mPackageName, mUserId);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">requestSize</span><span class="params">(String packageName, <span class="type">int</span> userId)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">synchronized</span> (mEntriesMap) &#123;</span><br><span class="line">    AppEntry entry = mEntriesMap.<span class="built_in">get</span>(userId).<span class="built_in">get</span>(packageName);</span><br><span class="line">    <span class="keyword">if</span> (entry != null) &#123;</span><br><span class="line">      <span class="comment">// 调用getPackageSizeInfoAsUser函数进行查询, 查询的结果放在mStatsObserver中进行处理</span></span><br><span class="line">      mPm.<span class="built_in">getPackageSizeInfoAsUser</span>(packageName, userId, mBackgroundHandler.mStatsObserver);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> IPackageStatsObserver.Stub mStatsObserver = <span class="keyword">new</span> IPackageStatsObserver.<span class="built_in">Stub</span>() &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">void</span> <span class="built_in">onGetStatsCompleted</span>(PackageStats stats, boolean succeeded) &#123;</span><br><span class="line">    boolean sizeChanged = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">synchronized</span> (mEntriesMap) &#123;</span><br><span class="line">      <span class="keyword">if</span> (DEBUG_LOCKING) Log.<span class="built_in">v</span>(TAG, <span class="string">&quot;onGetStatsCompleted acquired lock&quot;</span>);</span><br><span class="line">      HashMap&lt;String, AppEntry&gt; userMap = mEntriesMap.<span class="built_in">get</span>(stats.userHandle);</span><br><span class="line">      AppEntry entry = userMap.<span class="built_in">get</span>(stats.packageName);</span><br><span class="line">      <span class="keyword">if</span> (entry != null) &#123;</span><br><span class="line">        <span class="built_in">synchronized</span> (entry) &#123;</span><br><span class="line">          entry.sizeStale = <span class="literal">false</span>;</span><br><span class="line">          entry.sizeLoadStart = <span class="number">0</span>;</span><br><span class="line">          <span class="type">long</span> externalCodeSize = stats.externalCodeSize</span><br><span class="line">            + stats.externalObbSize;</span><br><span class="line">          <span class="type">long</span> externalDataSize = stats.externalDataSize</span><br><span class="line">            + stats.externalMediaSize;</span><br><span class="line">          <span class="comment">// newSize的计算  </span></span><br><span class="line">          <span class="comment">// newSize = stats.(externalCodeSize + externalObbSize + externalDataSize</span></span><br><span class="line">          <span class="comment">//  + externalMediaSize + codeSize + dataSize)</span></span><br><span class="line">          <span class="type">long</span> newSize = externalCodeSize + externalDataSize</span><br><span class="line">            + <span class="built_in">getTotalInternalSize</span>(stats);</span><br><span class="line">          <span class="keyword">if</span> (entry.size != newSize ||</span><br><span class="line">              entry.cacheSize != stats.cacheSize ||</span><br><span class="line">              entry.codeSize != stats.codeSize ||</span><br><span class="line">              entry.dataSize != stats.dataSize ||</span><br><span class="line">              entry.externalCodeSize != externalCodeSize ||</span><br><span class="line">              entry.externalDataSize != externalDataSize ||</span><br><span class="line">              entry.externalCacheSize != stats.externalCacheSize) &#123;</span><br><span class="line">            <span class="comment">// entry对应的 AppEntry</span></span><br><span class="line">            entry.size = newSize;</span><br><span class="line">            entry.cacheSize = stats.cacheSize;</span><br><span class="line">            entry.codeSize = stats.codeSize;</span><br><span class="line">            entry.dataSize = stats.dataSize;</span><br><span class="line">            entry.externalCodeSize = externalCodeSize;</span><br><span class="line">            entry.externalDataSize = externalDataSize;</span><br><span class="line">            entry.externalCacheSize = stats.externalCacheSize;</span><br><span class="line">            entry.sizeStr = <span class="built_in">getSizeStr</span>(entry.size);</span><br><span class="line">            entry.internalSize = <span class="built_in">getTotalInternalSize</span>(stats);</span><br><span class="line">            entry.internalSizeStr = <span class="built_in">getSizeStr</span>(entry.internalSize);</span><br><span class="line">            entry.externalSize = <span class="built_in">getTotalExternalSize</span>(stats);</span><br><span class="line">            entry.externalSizeStr = <span class="built_in">getSizeStr</span>(entry.externalSize);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.<span class="built_in">i</span>(TAG, <span class="string">&quot;Set size of &quot;</span> + entry.label + <span class="string">&quot; &quot;</span> + entry</span><br><span class="line">                             + <span class="string">&quot;: &quot;</span> + entry.sizeStr);</span><br><span class="line">            sizeChanged = <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">refreshSizeInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mAppEntry.size == ApplicationsState.SIZE_INVALID</span><br><span class="line">                || mAppEntry.size == ApplicationsState.SIZE_UNKNOWN) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mHaveSizes = <span class="literal">true</span>;</span><br><span class="line">            <span class="type">long</span> codeSize = mAppEntry.codeSize;</span><br><span class="line">            <span class="type">long</span> dataSize = mAppEntry.dataSize;</span><br><span class="line">            <span class="comment">// 主存储是否是Emulated的, 内卡主卡方案满足条件的</span></span><br><span class="line">            <span class="keyword">if</span> (Environment.<span class="built_in">isExternalStorageEmulated</span>()) &#123;</span><br><span class="line">                codeSize += mAppEntry.externalCodeSize;</span><br><span class="line">                dataSize +=  mAppEntry.externalDataSize;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mLastExternalCodeSize != mAppEntry.externalCodeSize) &#123;</span><br><span class="line">                    mLastExternalCodeSize = mAppEntry.externalCodeSize;</span><br><span class="line">                    mExternalCodeSize.<span class="built_in">setSummary</span>(<span class="built_in">getSizeStr</span>(mAppEntry.externalCodeSize));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mLastExternalDataSize !=  mAppEntry.externalDataSize) &#123;</span><br><span class="line">                    mLastExternalDataSize =  mAppEntry.externalDataSize;</span><br><span class="line">                    mExternalDataSize.<span class="built_in">setSummary</span>(<span class="built_in">getSizeStr</span>( mAppEntry.externalDataSize));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mLastCodeSize != codeSize) &#123;</span><br><span class="line">                mLastCodeSize = codeSize;</span><br><span class="line">                mAppSize.<span class="built_in">setSummary</span>(<span class="built_in">getSizeStr</span>(codeSize));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mLastDataSize != dataSize) &#123;</span><br><span class="line">                mLastDataSize = dataSize;</span><br><span class="line">                mDataSize.<span class="built_in">setSummary</span>(<span class="built_in">getSizeStr</span>(dataSize));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">long</span> cacheSize = mAppEntry.cacheSize + mAppEntry.externalCacheSize;</span><br><span class="line">            <span class="keyword">if</span> (mLastCacheSize != cacheSize) &#123;</span><br><span class="line">                mLastCacheSize = cacheSize;</span><br><span class="line">                mCacheSize.<span class="built_in">setSummary</span>(<span class="built_in">getSizeStr</span>(cacheSize));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mLastTotalSize != mAppEntry.size) &#123;</span><br><span class="line">                mLastTotalSize = mAppEntry.size;</span><br><span class="line">                <span class="comment">// 将TotalSize 设为了 mAppEntry.size. </span></span><br><span class="line">                mTotalSize.<span class="built_in">setSummary</span>(<span class="built_in">getSizeStr</span>(mAppEntry.size));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((mAppEntry.dataSize+ mAppEntry.externalDataSize) &lt;= <span class="number">0</span> || !mCanClearData) &#123;</span><br><span class="line">                mClearDataButton.<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mClearDataButton.<span class="built_in">setEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">                mClearDataButton.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cacheSize &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                mClearCacheButton.<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mClearCacheButton.<span class="built_in">setEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">                mClearCacheButton.<span class="built_in">setOnClickListener</span>(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mAppsControlDisallowedBySystem) &#123;</span><br><span class="line">            mClearCacheButton.<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">            mClearDataButton.<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>7.0 上的 totalSize的计算方式:</p>
<p>stats.(externalCodeSize + externalObbSize + externalDataSize + externalMediaSize + codeSize + dataSize)</p>
<p>回到之前的核心方法:</p>
<ul>
<li>getPackageSizeInfoAsUser(packageName, userId, mBackgroundHandler.mStatsObserver)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getPackageSizeInfo</span><span class="params">(<span class="keyword">final</span> String packageName, <span class="type">int</span> userHandle,</span></span><br><span class="line"><span class="params">            <span class="keyword">final</span> IPackageStatsObserver observer)</span> &#123;</span><br><span class="line">        mContext.enforceCallingOrSelfPermission(</span><br><span class="line">                android.Manifest.permission.GET_PACKAGE_SIZE, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">PackageStats</span> <span class="variable">stats</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageStats</span>(packageName, userHandle);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(INIT_COPY);</span><br><span class="line">        msg.obj = <span class="keyword">new</span> <span class="title class_">MeasureParams</span>(stats, observer);</span><br><span class="line">        mHandler.sendMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">case</span> INIT_COPY:</span><br><span class="line">     mPendingInstalls.add(idx, params);</span><br><span class="line"><span class="comment">//最终执行MeasureParams的 handleStartCopy方法:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                mSuccess = getPackageSizeInfoLI(mStats.packageName, mStats.userHandle, mStats);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mSuccess) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">mounted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">/* SPRD: support double sdcard</span></span><br><span class="line"><span class="comment">                 * chanage interface, getExternalStorageState-&gt;getExternalStoragePathState</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> EnvironmentEx.getExternalStoragePathState();</span><br><span class="line">                    mounted = (Environment.MEDIA_MOUNTED.equals(status)</span><br><span class="line">                            || Environment.MEDIA_MOUNTED_READ_ONLY.equals(status));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果外部存储是挂载状态, 还要接着计算  externalCacheSize  externalDataSize       externalMediaSize  externalObbSize, 在计算方式中, 除externalCacheSize外都用到了</span></span><br><span class="line">                <span class="keyword">if</span> (mounted) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">UserEnvironment</span> <span class="variable">userEnv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserEnvironment</span>(mStats.userHandle);</span><br><span class="line">                    <span class="comment">// 统计所有可写存储的 Android/data/packageName/cache</span></span><br><span class="line">                    mStats.externalCacheSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                            userEnv.buildExternalStorageAppCacheDirs(mStats.packageName));</span><br><span class="line">				   <span class="comment">// 统计所有可写存储的 Android/data/packageName/</span></span><br><span class="line">                    mStats.externalDataSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                            userEnv.buildExternalStorageAppDataDirs(mStats.packageName));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Always subtract cache size, since it&#x27;s a subdirectory</span></span><br><span class="line">                    mStats.externalDataSize -= mStats.externalCacheSize;</span><br><span class="line">				   <span class="comment">// 统计所有可写存储的 Android/media/packageName/</span></span><br><span class="line">                    mStats.externalMediaSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                            userEnv.buildExternalStorageAppMediaDirs(mStats.packageName));</span><br><span class="line">                    <span class="comment">// 统计所有可写存储的 Android/obb/packageName/</span></span><br><span class="line">                    mStats.externalObbSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                            userEnv.buildExternalStorageAppObbDirs(mStats.packageName));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">getPackageSizeInfoLI</span><span class="params">(String packageName, <span class="type">int</span> userId, PackageStats stats)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            ps = mSettings.mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (ps == <span class="literal">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Failed to find settings for &quot;</span> + packageName);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstaller.getAppSize(ps.volumeUuid, packageName, userId,</span><br><span class="line">                    StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE,</span><br><span class="line">                    ps.getCeDataInode(userId), ps.codePathString, stats);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// For now, ignore code size of packages on system partition</span></span><br><span class="line">        <span class="comment">// system下的app 忽略 codeSize</span></span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(ps) &amp;&amp; !isUpdatedSystemApp(ps)) &#123;</span><br><span class="line">            stats.codeSize = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>最终落到Installd统计app的internal 的 codeSize和 dataSize</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">get_app_size</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *uuid, <span class="type">const</span> <span class="type">char</span> *pkgname, <span class="type">int</span> userid, <span class="type">int</span> flags, <span class="type">ino_t</span> ce_data_inode,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> <span class="type">char</span> *code_path, <span class="type">int64_t</span> *codesize, <span class="type">int64_t</span> *datasize, <span class="type">int64_t</span> *cachesize,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int64_t</span>* asecsize)</span> </span>&#123;</span><br><span class="line">    DIR *d;</span><br><span class="line">    <span class="type">int</span> dfd;</span><br><span class="line"></span><br><span class="line">    d = <span class="built_in">opendir</span>(code_path);</span><br><span class="line">    <span class="keyword">if</span> (d != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        dfd = <span class="built_in">dirfd</span>(d);</span><br><span class="line">        <span class="comment">// 计算codeSize  即package的 codePaths 目录大小</span></span><br><span class="line">        *codesize += <span class="built_in">calculate_dir_size</span>(dfd);</span><br><span class="line">        <span class="built_in">closedir</span>(d);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; FLAG_STORAGE_CE) &#123;</span><br><span class="line">        <span class="comment">// 统计CE区的 /data/user_ce/user_id/packageName/下的</span></span><br><span class="line">        <span class="keyword">auto</span> path = <span class="built_in">create_data_user_ce_package_path</span>(uuid, userid, pkgname, ce_data_inode);</span><br><span class="line">        <span class="built_in">add_app_data_size</span>(path, codesize, datasize, cachesize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; FLAG_STORAGE_DE) &#123;</span><br><span class="line">        <span class="comment">// 统计CE区的 /data/user_ce/user_id/packageName/下的</span></span><br><span class="line">        <span class="keyword">auto</span> path = <span class="built_in">create_data_user_de_package_path</span>(uuid, userid, pkgname);</span><br><span class="line">        <span class="built_in">add_app_data_size</span>(path, codesize, datasize, cachesize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *asecsize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">add_app_data_size</span><span class="params">(std::string&amp; path, <span class="type">int64_t</span> *codesize, <span class="type">int64_t</span> *datasize,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int64_t</span> *cachesize)</span> </span>&#123;</span><br><span class="line">    DIR *d;</span><br><span class="line">    <span class="type">int</span> dfd;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dirent</span> *de;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> s;</span><br><span class="line"></span><br><span class="line">    d = <span class="built_in">opendir</span>(path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (d == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">PLOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Failed to open &quot;</span> &lt;&lt; path;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dfd = <span class="built_in">dirfd</span>(d);</span><br><span class="line">    <span class="keyword">while</span> ((de = <span class="built_in">readdir</span>(d))) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *name = de-&gt;d_name;</span><br><span class="line"></span><br><span class="line">        <span class="type">int64_t</span> statsize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">fstatat</span>(dfd, name, &amp;s, AT_SYMLINK_NOFOLLOW) == <span class="number">0</span>) &#123;</span><br><span class="line">            statsize = <span class="built_in">stat_size</span>(&amp;s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (de-&gt;d_type == DT_DIR) &#123;</span><br><span class="line">            <span class="type">int</span> subfd;</span><br><span class="line">            <span class="type">int64_t</span> dirsize = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">/* always skip &quot;.&quot; and &quot;..&quot; */</span></span><br><span class="line">            <span class="keyword">if</span> (name[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (name[<span class="number">1</span>] == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span> ((name[<span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span>) &amp;&amp; (name[<span class="number">2</span>] == <span class="number">0</span>)) <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            subfd = <span class="built_in">openat</span>(dfd, name, O_RDONLY | O_DIRECTORY);</span><br><span class="line">            <span class="keyword">if</span> (subfd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                dirsize = <span class="built_in">calculate_dir_size</span>(subfd);</span><br><span class="line">                <span class="built_in">close</span>(subfd);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> check xattrs!</span></span><br><span class="line">            <span class="comment">// dataSize中不包含  cache  code_cache下 子文件的大小.</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;cache&quot;</span>) || !<span class="built_in">strcmp</span>(name, <span class="string">&quot;code_cache&quot;</span>)) &#123;</span><br><span class="line">                *datasize += statsize;</span><br><span class="line">                *cachesize += dirsize;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                *datasize += dirsize + statsize;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (de-&gt;d_type == DT_LNK &amp;&amp; !<span class="built_in">strcmp</span>(name, <span class="string">&quot;lib&quot;</span>)) &#123;</span><br><span class="line">         <span class="comment">// 如果是lib目录,且为链接的方式, 该目录的大小统计进了 codeSize中,但仅链接的话,statsize很小,可以忽略.</span></span><br><span class="line">            *codesize += statsize;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 普通文件, 统计进dataSize中.</span></span><br><span class="line">            *datasize += statsize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">closedir</span>(d);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>综上, Android7.0的统计app总使用量的大小为:</p>
<p>stats.(externalCodeSize + externalObbSize + externalDataSize + externalMediaSize + codeSize + dataSize)</p>
<ul>
<li>计算codeSize  即package的 codePaths 目录大小</li>
<li>统计CE区的 &#x2F;data&#x2F;user_ce&#x2F;user_id&#x2F;packageName&#x2F;下的,  除cache&#x2F;code_cache目录外的大小. 计入dataSize (codeSize可以忽略)</li>
<li>统计DE区的 &#x2F;data&#x2F;user_de&#x2F;user_id&#x2F;packageName&#x2F;下的,  除cache&#x2F;code_cache目录外的大小. 计入dataSize</li>
<li>统计所有可写存储的 Android&#x2F;data&#x2F;packageName&#x2F;大小, 除cache子目录外, 计入 externalDataSize</li>
<li>统计所有可写存储的 Android&#x2F;media&#x2F;packageName&#x2F;,计入externalMediaSize</li>
<li>统计所有可写存储的 Android&#x2F;obb&#x2F;packageName&#x2F;,计入externalObbSize</li>
</ul>
<p>externalCodeSize没看到有计算的地方</p>
<h1 id="3-Android6-0"><a href="#3-Android6-0" class="headerlink" title="3. Android6.0"></a>3. Android6.0</h1><h2 id="3-1-涉及的文件"><a href="#3-1-涉及的文件" class="headerlink" title="3.1. 涉及的文件"></a>3.1. 涉及的文件</h2><ul>
<li>AppStorageSettings.java</li>
<li>ApplicationState.java</li>
<li>PackageManagerService.java</li>
</ul>
<h2 id="3-2-相关代码"><a href="#3-2-相关代码" class="headerlink" title="3.2. 相关代码"></a>3.2. 相关代码</h2><p>计算方式和7.0相同:</p>
<p>stats.(externalCodeSize + externalObbSize + externalDataSize + externalMediaSize + codeSize + dataSize)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前面的流程与7.0大致相同.   </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestSize</span><span class="params">(String packageName, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_LOCKING) Log.v(TAG, <span class="string">&quot;requestSize about to acquire lock...&quot;</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (mEntriesMap) &#123;</span><br><span class="line">            <span class="type">AppEntry</span> <span class="variable">entry</span> <span class="operator">=</span> mEntriesMap.get(userId).get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">                mPm.getPackageSizeInfo(packageName, userId, mBackgroundHandler.mStatsObserver);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_LOCKING) Log.v(TAG, <span class="string">&quot;...requestSize releasing lock&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> IPackageStatsObserver.<span class="type">Stub</span> <span class="variable">mStatsObserver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IPackageStatsObserver</span>.Stub() &#123;</span><br><span class="line">  ...</span><br><span class="line">    <span class="type">long</span> <span class="variable">newSize</span> <span class="operator">=</span> externalCodeSize + externalDataSize + getTotalInternalSize(stats);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getPackageSizeInfo</span><span class="params">(<span class="keyword">final</span> String packageName, <span class="type">int</span> userHandle,</span></span><br><span class="line"><span class="params">                               <span class="keyword">final</span> IPackageStatsObserver observer)</span> &#123;</span><br><span class="line">  mContext.enforceCallingOrSelfPermission(</span><br><span class="line">    android.Manifest.permission.GET_PACKAGE_SIZE, <span class="literal">null</span>);</span><br><span class="line">  <span class="type">PackageStats</span> <span class="variable">stats</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageStats</span>(packageName, userHandle);</span><br><span class="line">  <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(INIT_COPY);</span><br><span class="line">  msg.obj = <span class="keyword">new</span> <span class="title class_">MeasureParams</span>(stats, observer);</span><br><span class="line">  mHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> Environment.getExternalStoragePathState();</span><br><span class="line">mounted = (Environment.MEDIA_MOUNTED.equals(status)</span><br><span class="line">           || Environment.MEDIA_MOUNTED_READ_ONLY.equals(status));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mounted) &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">UserEnvironment</span> <span class="variable">userEnv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserEnvironment</span>(mStats.userHandle);</span><br><span class="line"></span><br><span class="line">  mStats.externalCacheSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                                                    userEnv.buildExternalStorageAppCacheDirs(mStats.packageName));</span><br><span class="line"></span><br><span class="line">  mStats.externalDataSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                                                   userEnv.buildExternalStorageAppDataDirs(mStats.packageName));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Always subtract cache size, since it&#x27;s a subdirectory</span></span><br><span class="line">  mStats.externalDataSize -= mStats.externalCacheSize;</span><br><span class="line"></span><br><span class="line">  mStats.externalMediaSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                                                    userEnv.buildExternalStorageAppMediaDirs(mStats.packageName));</span><br><span class="line"></span><br><span class="line">  mStats.externalObbSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                                                  userEnv.buildExternalStorageAppObbDirs(mStats.packageName));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上述流程都与7.0的一致, 但getPackageSizeInfoLI 函数和 7.0的不同</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">getPackageSizeInfoLI</span><span class="params">(String packageName, <span class="type">int</span> userHandle,</span></span><br><span class="line"><span class="params">            PackageStats pStats)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (packageName == <span class="literal">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Attempt to get size of null packageName.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageParser.Package p;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">dataOnly</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">libDirRoot</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">asecPath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            p = mPackages.get(packageName);</span><br><span class="line">            ps = mSettings.mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">if</span>(p == <span class="literal">null</span>) &#123;</span><br><span class="line">                dataOnly = <span class="literal">true</span>;</span><br><span class="line">                p = ps.pkg;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// native lib库的路径</span></span><br><span class="line">                libDirRoot = ps.legacyNativeLibraryPathString;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* SPRD: support double sdcard</span></span><br><span class="line"><span class="comment">             * Add support for install apk to internal sdcard @&#123;</span></span><br><span class="line"><span class="comment">             * @orig</span></span><br><span class="line"><span class="comment">             * if (p != null &amp;&amp; (isExternal(p) || p.isForwardLocked())) &#123;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (p != <span class="literal">null</span> &amp;&amp; (isExternal(p) || p.isForwardLocked() || isInternalSd(p))) &#123;</span><br><span class="line">              <span class="comment">/* @&#125; */</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">long</span> <span class="variable">token</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">secureContainerId</span> <span class="operator">=</span> cidFromCodePath(p.applicationInfo.getBaseCodePath());</span><br><span class="line">                    <span class="keyword">if</span> (secureContainerId != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 如应用安装在外部存储上, 记录asecPath</span></span><br><span class="line">                        <span class="comment">// /mnt/secure/asec/&lt;id.asec&gt; 目录</span></span><br><span class="line">                        asecPath = PackageHelper.getSdFilesystem(secureContainerId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">publicSrcDir</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!dataOnly) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ApplicationInfo</span> <span class="variable">applicationInfo</span> <span class="operator">=</span> p.applicationInfo;</span><br><span class="line">            <span class="comment">// isForwardLocked为true时, code和resource分离, 需要拿到resource的路径</span></span><br><span class="line">            <span class="keyword">if</span> (p.isForwardLocked()) &#123;</span><br><span class="line">                publicSrcDir = applicationInfo.getBaseResourcePath();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> extend to measure size of split APKs</span></span><br><span class="line">        String[] dexCodeInstructionSets = getDexCodeInstructionSets(getAppDexInstructionSets(ps));</span><br><span class="line">        <span class="comment">// 传入的路径  baseCodePath  libDirRoot publicSrcDir asecPath dexCodeInstructionSets</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> mInstaller.getSizeInfo(p.volumeUuid, packageName, userHandle, p.baseCodePath,</span><br><span class="line">                libDirRoot, publicSrcDir, asecPath, dexCodeInstructionSets, pStats);</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isExternal(p) &amp;&amp; !isInternalSd(p)) &#123;</span><br><span class="line">        <span class="comment">/* @&#125; */</span></span><br><span class="line">            <span class="comment">// 安装在内部存储上的应用, 将externalCodeSize 计入codeSize中.</span></span><br><span class="line">            pStats.codeSize += pStats.externalCodeSize;</span><br><span class="line">            pStats.externalCodeSize = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  pStats.codeSize = Long.parseLong(res[<span class="number">1</span>]);</span><br><span class="line">  pStats.dataSize = Long.parseLong(res[<span class="number">2</span>]);</span><br><span class="line">  pStats.cacheSize = Long.parseLong(res[<span class="number">3</span>]);</span><br><span class="line">  <span class="comment">// externalCodeSize 指的asecsize</span></span><br><span class="line">  pStats.externalCodeSize = Long.parseLong(res[<span class="number">4</span>]);</span><br><span class="line">  <span class="keyword">return</span> Integer.parseInt(res[<span class="number">0</span>]);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>native层的代码, 在installd中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">get_size</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *uuid, <span class="type">const</span> <span class="type">char</span> *pkgname, <span class="type">int</span> userid, <span class="type">const</span> <span class="type">char</span> *apkpath,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="type">const</span> <span class="type">char</span> *libdirpath, <span class="type">const</span> <span class="type">char</span> *fwdlock_apkpath, <span class="type">const</span> <span class="type">char</span> *asecpath,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="type">const</span> <span class="type">char</span> *instruction_set, <span class="type">int64_t</span> *_codesize, <span class="type">int64_t</span> *_datasize,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="type">int64_t</span> *_cachesize, <span class="type">int64_t</span>* _asecsize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DIR *d;</span><br><span class="line">    <span class="type">int</span> dfd;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dirent</span> *de;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> s;</span><br><span class="line">    <span class="type">char</span> path[PKG_PATH_MAX];</span><br><span class="line"></span><br><span class="line">    <span class="type">int64_t</span> codesize = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int64_t</span> datasize = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int64_t</span> cachesize = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int64_t</span> asecsize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* count the source apk as code -- but only if it&#x27;s not</span></span><br><span class="line"><span class="comment">     * on the /system partition and its not on the sdcard. */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">validate_system_app_path</span>(apkpath) &amp;&amp;</span><br><span class="line">            <span class="built_in">strncmp</span>(apkpath, android_asec_dir.path, android_asec_dir.len) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// apk 没有在外部存储上, 统计codepath的  codesize, 不统计system分区的.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(apkpath, &amp;s) == <span class="number">0</span>) &#123;</span><br><span class="line">            codesize += <span class="built_in">stat_size</span>(&amp;s);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">S_ISDIR</span>(s.st_mode)) &#123;</span><br><span class="line">                d = <span class="built_in">opendir</span>(apkpath);</span><br><span class="line">                <span class="keyword">if</span> (d != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    dfd = <span class="built_in">dirfd</span>(d);</span><br><span class="line">                    codesize += <span class="built_in">calculate_dir_size</span>(dfd);</span><br><span class="line">                    <span class="built_in">closedir</span>(d);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* count the forward locked apk as code if it is given */</span></span><br><span class="line">    <span class="comment">// foward_lock时, codepath 和 respath分开,统计respath大小计入codesize</span></span><br><span class="line">    <span class="keyword">if</span> (fwdlock_apkpath != <span class="literal">NULL</span> &amp;&amp; fwdlock_apkpath[<span class="number">0</span>] != <span class="string">&#x27;!&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(fwdlock_apkpath, &amp;s) == <span class="number">0</span>) &#123;</span><br><span class="line">            codesize += <span class="built_in">stat_size</span>(&amp;s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* count the cached dexfile as code */</span></span><br><span class="line">    <span class="comment">// 统计  /data/dalvik-cache/&lt;instruction_set&gt;/[&lt;codepath&gt;/classes.dex](&quot;[]里的&#x27;/&#x27;被转换为&#x27;@&#x27;&quot;)</span></span><br><span class="line">    <span class="comment">// 计入codesize中.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">create_cache_path</span>(path, apkpath, instruction_set)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(path, &amp;s) == <span class="number">0</span>) &#123;</span><br><span class="line">            codesize += <span class="built_in">stat_size</span>(&amp;s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add in size of any libraries */</span></span><br><span class="line">    <span class="comment">// 将package关联的native lib库的路径下大小计入codesize</span></span><br><span class="line">    <span class="keyword">if</span> (libdirpath != <span class="literal">NULL</span> &amp;&amp; libdirpath[<span class="number">0</span>] != <span class="string">&#x27;!&#x27;</span>) &#123;</span><br><span class="line">        d = <span class="built_in">opendir</span>(libdirpath);</span><br><span class="line">        <span class="keyword">if</span> (d != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            dfd = <span class="built_in">dirfd</span>(d);</span><br><span class="line">            codesize += <span class="built_in">calculate_dir_size</span>(dfd);</span><br><span class="line">            <span class="built_in">closedir</span>(d);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* compute asec size if it is given */</span></span><br><span class="line">    <span class="comment">// 如果apk安装在外部存储上, 统计asecsize</span></span><br><span class="line">    <span class="keyword">if</span> (asecpath != <span class="literal">NULL</span> &amp;&amp; asecpath[<span class="number">0</span>] != <span class="string">&#x27;!&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(asecpath, &amp;s) == <span class="number">0</span>) &#123;</span><br><span class="line">            asecsize += <span class="built_in">stat_size</span>(&amp;s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;<span class="type">userid_t</span>&gt; users;</span><br><span class="line">    <span class="keyword">if</span> (userid == <span class="number">-1</span>) &#123;</span><br><span class="line">        users = <span class="built_in">get_known_users</span>(uuid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        users.<span class="built_in">push_back</span>(userid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 统计/data/user/&lt;userid&gt;/&lt;packageName&gt;下的文件大小, 计入codesize/cachesize/datasize</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> user : users) &#123;</span><br><span class="line">        std::string _pkgdir(<span class="built_in">create_data_user_package_path</span>(uuid, user, pkgname));</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* pkgdir = _pkgdir.<span class="built_in">c_str</span>();</span><br><span class="line"></span><br><span class="line">        d = <span class="built_in">opendir</span>(pkgdir);</span><br><span class="line">        <span class="keyword">if</span> (d == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">PLOG</span>(WARNING) &lt;&lt; <span class="string">&quot;Failed to open &quot;</span> &lt;&lt; pkgdir;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        dfd = <span class="built_in">dirfd</span>(d);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* most stuff in the pkgdir is data, except for the &quot;cache&quot;</span></span><br><span class="line"><span class="comment">         * directory and below, which is cache, and the &quot;lib&quot; directory</span></span><br><span class="line"><span class="comment">         * and below, which is code...</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">while</span> ((de = <span class="built_in">readdir</span>(d))) &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">char</span> *name = de-&gt;d_name;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (de-&gt;d_type == DT_DIR) &#123;</span><br><span class="line">                <span class="type">int</span> subfd;</span><br><span class="line">                <span class="type">int64_t</span> statsize = <span class="number">0</span>;</span><br><span class="line">                <span class="type">int64_t</span> dirsize = <span class="number">0</span>;</span><br><span class="line">                    <span class="comment">/* always skip &quot;.&quot; and &quot;..&quot; */</span></span><br><span class="line">                <span class="keyword">if</span> (name[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (name[<span class="number">1</span>] == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">if</span> ((name[<span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span>) &amp;&amp; (name[<span class="number">2</span>] == <span class="number">0</span>)) <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">fstatat</span>(dfd, name, &amp;s, AT_SYMLINK_NOFOLLOW) == <span class="number">0</span>) &#123;</span><br><span class="line">                    statsize = <span class="built_in">stat_size</span>(&amp;s);</span><br><span class="line">                &#125;</span><br><span class="line">                subfd = <span class="built_in">openat</span>(dfd, name, O_RDONLY | O_DIRECTORY);</span><br><span class="line">                <span class="keyword">if</span> (subfd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    dirsize = <span class="built_in">calculate_dir_size</span>(subfd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如为lib目录,统计目录大小, 计入codesize</span></span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(name,<span class="string">&quot;lib&quot;</span>)) &#123;</span><br><span class="line">                    codesize += dirsize + statsize;</span><br><span class="line">                <span class="comment">// 如为cache目录,统计目录大小, 计入cachesize</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(name,<span class="string">&quot;cache&quot;</span>)) &#123;</span><br><span class="line">                    cachesize += dirsize + statsize;</span><br><span class="line">                <span class="comment">// 如为其他目录,统计目录大小, 计入datasize</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    datasize += dirsize + statsize;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// lib目录且为链接, 这部分很小, 可以忽略不计</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (de-&gt;d_type == DT_LNK &amp;&amp; !<span class="built_in">strcmp</span>(name,<span class="string">&quot;lib&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// This is the symbolic link to the application&#x27;s library</span></span><br><span class="line">                <span class="comment">// code.  We&#x27;ll count this as code instead of data, since</span></span><br><span class="line">                <span class="comment">// it is not something that the app creates.</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">fstatat</span>(dfd, name, &amp;s, AT_SYMLINK_NOFOLLOW) == <span class="number">0</span>) &#123;</span><br><span class="line">                    codesize += <span class="built_in">stat_size</span>(&amp;s);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 非目录, 普通文件, 计入datasize</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">fstatat</span>(dfd, name, &amp;s, AT_SYMLINK_NOFOLLOW) == <span class="number">0</span>) &#123;</span><br><span class="line">                    datasize += <span class="built_in">stat_size</span>(&amp;s);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">closedir</span>(d);</span><br><span class="line">    &#125;</span><br><span class="line">    *_codesize = codesize;</span><br><span class="line">    *_datasize = datasize;</span><br><span class="line">    *_cachesize = cachesize;</span><br><span class="line">    *_asecsize = asecsize;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>综上, Android6.0 上统计app totalsize方式:</p>
<p>stats.(externalCodeSize + externalObbSize + externalDataSize + externalMediaSize + codeSize + dataSize)</p>
<ul>
<li>apk 没有在外部存储上, 统计codepath的  codesize</li>
<li>foward_lock时, codepath 和 respath分开,统计respath大小计入codesize</li>
<li>统计  &#x2F;data&#x2F;dalvik-cache&#x2F;<instruction_set>&#x2F;{<codepath>&#x2F;classes.dex}(“{}里的’&#x2F;‘被转换为‘@’”),  计入codesize中.</li>
<li>如果apk安装在外部存储上, 统计asecsize, 最后计为 externalCodeSize</li>
<li>统计&#x2F;data&#x2F;user&#x2F;<userid>&#x2F;<packageName>下的文件大小, 计入codesize&#x2F;cachesize&#x2F;datasize<ul>
<li>如为lib目录非链接,统计目录大小, 计入codesize</li>
<li>如为cache目录,统计目录大小, 计入cachesize</li>
<li>如为其他目录,统计目录大小, 计入datasize</li>
<li>lib目录且为链接, 这部分很小, 可以忽略不计, 但还是计入codesize</li>
<li>非目录, 普通文件, 计入datasize</li>
</ul>
</li>
<li>统计所有可写存储的 Android&#x2F;data&#x2F;packageName&#x2F;大小, 除cache子目录外, 计入 externalDataSize</li>
<li>统计所有可写存储的 Android&#x2F;media&#x2F;packageName&#x2F;,计入externalMediaSize</li>
<li>统计所有可写存储的 Android&#x2F;obb&#x2F;packageName&#x2F;,计入externalObbSize</li>
</ul>
<h1 id="4-Android5-1"><a href="#4-Android5-1" class="headerlink" title="4. Android5.1"></a>4. Android5.1</h1><h2 id="4-1-涉及的文件"><a href="#4-1-涉及的文件" class="headerlink" title="4.1. 涉及的文件"></a>4.1. 涉及的文件</h2><ul>
<li>InstalledAppDetails.java</li>
<li>PackageManagerService.java</li>
</ul>
<h2 id="4-2-相关代码"><a href="#4-2-相关代码" class="headerlink" title="4.2. 相关代码"></a>4.2. 相关代码</h2><p>计算方式:</p>
<p>stats.(externalCodeSize + externalObbSize +  externalDataSize + externalMediaSize + codesize + datasize)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshSizeInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAppEntry.size == ApplicationsState.SIZE_INVALID</span><br><span class="line">                || mAppEntry.size == ApplicationsState.SIZE_UNKNOWN) &#123;</span><br><span class="line">         ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mHaveSizes = <span class="literal">true</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">codeSize</span> <span class="operator">=</span> mAppEntry.codeSize;</span><br><span class="line">            <span class="type">long</span> <span class="variable">dataSize</span> <span class="operator">=</span> mAppEntry.dataSize;</span><br><span class="line">            <span class="comment">// 内卡作主卡, codeSize dataSize +  externalCodeSize   + externalDataSize</span></span><br><span class="line">            <span class="keyword">if</span> (Environment.isExternalStorageEmulated()) &#123;</span><br><span class="line">                codeSize += mAppEntry.externalCodeSize;</span><br><span class="line">                dataSize +=  mAppEntry.externalDataSize;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mLastExternalCodeSize != mAppEntry.externalCodeSize) &#123;</span><br><span class="line">                    mLastExternalCodeSize = mAppEntry.externalCodeSize;</span><br><span class="line">                    mExternalCodeSize.setText(getSizeStr(mAppEntry.externalCodeSize));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mLastExternalDataSize !=  mAppEntry.externalDataSize) &#123;</span><br><span class="line">                    mLastExternalDataSize =  mAppEntry.externalDataSize;</span><br><span class="line">                    mExternalDataSize.setText(getSizeStr( mAppEntry.externalDataSize));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mLastCodeSize != codeSize) &#123;</span><br><span class="line">                mLastCodeSize = codeSize;</span><br><span class="line">                <span class="comment">/* SPRD:438010 Monkey test NullPointerException@&#123;*/</span></span><br><span class="line">                <span class="keyword">if</span> (mAppSize != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mAppSize.setText(getSizeStr(codeSize));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* @&#125;*/</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mLastDataSize != dataSize) &#123;</span><br><span class="line">                mLastDataSize = dataSize;</span><br><span class="line">                mDataSize.setText(getSizeStr(dataSize));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">long</span> <span class="variable">cacheSize</span> <span class="operator">=</span> mAppEntry.cacheSize + mAppEntry.externalCacheSize;</span><br><span class="line">            <span class="comment">/* SPRD:fix bug 393783 , &quot;let 12.00 KB does not dispaly @&#123;*/</span></span><br><span class="line">            <span class="keyword">if</span> (cacheSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                cacheSize = cacheSize - <span class="number">12</span> * <span class="number">1024</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* @&#125; */</span></span><br><span class="line">            <span class="keyword">if</span> (mLastCacheSize != cacheSize) &#123;</span><br><span class="line">                mLastCacheSize = cacheSize;</span><br><span class="line">                mCacheSize.setText(getSizeStr(cacheSize));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mLastTotalSize != mAppEntry.size) &#123;</span><br><span class="line">                mLastTotalSize = mAppEntry.size;</span><br><span class="line">                <span class="comment">// mTotalSize 的大小.</span></span><br><span class="line">                mTotalSize.setText(getSizeStr(mAppEntry.size));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 上述逻辑与6.0 7.0相同.</span></span><br><span class="line"></span><br><span class="line">mCurComputingSizePkg = entry.info.packageName;</span><br><span class="line">mPm.getPackageSizeInfo(mCurComputingSizePkg, mStatsObserver);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">requestSize</span><span class="params">(String packageName)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_LOCKING) Log.v(TAG, <span class="string">&quot;requestSize about to acquire lock...&quot;</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (mEntriesMap) &#123;</span><br><span class="line">            <span class="type">AppEntry</span> <span class="variable">entry</span> <span class="operator">=</span> mEntriesMap.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">                mPm.getPackageSizeInfo(packageName, mBackgroundHandler.mStatsObserver);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_LOCKING) Log.v(TAG, <span class="string">&quot;...requestSize releasing lock&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> IPackageStatsObserver.<span class="type">Stub</span> <span class="variable">mStatsObserver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IPackageStatsObserver</span>.Stub() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onGetStatsCompleted</span><span class="params">(PackageStats stats, <span class="type">boolean</span> succeeded)</span> &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mEntriesMap) &#123;                   </span><br><span class="line">                    <span class="type">AppEntry</span> <span class="variable">entry</span> <span class="operator">=</span> mEntriesMap.get(stats.packageName);</span><br><span class="line">                    <span class="keyword">if</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span> (entry) &#123;</span><br><span class="line">                            entry.sizeStale = <span class="literal">false</span>;</span><br><span class="line">                            entry.sizeLoadStart = <span class="number">0</span>;</span><br><span class="line">                            <span class="type">long</span> <span class="variable">externalCodeSize</span> <span class="operator">=</span> stats.externalCodeSize</span><br><span class="line">                                    + stats.externalObbSize;</span><br><span class="line">                            <span class="type">long</span> <span class="variable">externalDataSize</span> <span class="operator">=</span> stats.externalDataSize</span><br><span class="line">                                    + stats.externalMediaSize;</span><br><span class="line">                            <span class="type">long</span> <span class="variable">newSize</span> <span class="operator">=</span> externalCodeSize + externalDataSize</span><br><span class="line">                                    + getTotalInternalSize(stats);</span><br><span class="line">                            <span class="keyword">if</span> (entry.size != newSize ||</span><br><span class="line">                                    entry.cacheSize != stats.cacheSize ||</span><br><span class="line">                                    entry.codeSize != stats.codeSize ||</span><br><span class="line">                                    entry.dataSize != stats.dataSize ||</span><br><span class="line">                                    entry.externalCodeSize != externalCodeSize ||</span><br><span class="line">                                    entry.externalDataSize != externalDataSize ||</span><br><span class="line">                                    entry.externalCacheSize != stats.externalCacheSize) &#123;</span><br><span class="line">                                <span class="comment">// stats.(externalCodeSize + externalObbSize +  externalDataSize + externalMediaSize + codesize + datasize)</span></span><br><span class="line">                                entry.size = newSize;</span><br><span class="line">                                entry.cacheSize = stats.cacheSize;</span><br><span class="line">                                entry.codeSize = stats.codeSize;</span><br><span class="line">                                entry.dataSize = stats.dataSize;</span><br><span class="line">                                entry.externalCodeSize = externalCodeSize;</span><br><span class="line">                                entry.externalDataSize = externalDataSize;</span><br><span class="line">                                entry.externalCacheSize = stats.externalCacheSize;</span><br><span class="line">                                entry.sizeStr = getSizeStr(entry.size);</span><br><span class="line">                                entry.internalSize = getTotalInternalSize(stats);</span><br><span class="line">                                entry.internalSizeStr = getSizeStr(entry.internalSize);</span><br><span class="line">                                entry.externalSize = getTotalExternalSize(stats);</span><br><span class="line">                                entry.externalSizeStr = getSizeStr(entry.externalSize);</span><br><span class="line">                                <span class="keyword">if</span> (DEBUG) Log.i(TAG, <span class="string">&quot;Set size of &quot;</span> + entry.label + <span class="string">&quot; &quot;</span> + entry</span><br><span class="line">                                        + <span class="string">&quot;: &quot;</span> + entry.sizeStr);</span><br><span class="line">                                sizeChanged = <span class="literal">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"><span class="comment">// 调用函数仍然为   getPackageSizeInfo.</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// 下面的流程也与 6.0 7.0相同.           </span></span><br><span class="line">           <span class="keyword">void</span> <span class="title function_">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                mSuccess = getPackageSizeInfoLI(mStats.packageName, mStats.userHandle, mStats);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mSuccess) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> mounted;</span><br><span class="line">                <span class="keyword">if</span> (Environment.isExternalStorageEmulated()) &#123;</span><br><span class="line">                    mounted = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* SPRD: support double sdcard</span></span><br><span class="line"><span class="comment">                 * chanage interface, getExternalStorageState-&gt;getExternalStoragePathState</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> Environment.getExternalStoragePathState();</span><br><span class="line">                    mounted = (Environment.MEDIA_MOUNTED.equals(status)</span><br><span class="line">                            || Environment.MEDIA_MOUNTED_READ_ONLY.equals(status));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mounted) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">UserEnvironment</span> <span class="variable">userEnv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserEnvironment</span>(mStats.userHandle);</span><br><span class="line"></span><br><span class="line">                    mStats.externalCacheSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                            userEnv.buildExternalStorageAppCacheDirs(mStats.packageName));</span><br><span class="line"></span><br><span class="line">                    mStats.externalDataSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                            userEnv.buildExternalStorageAppDataDirs(mStats.packageName));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Always subtract cache size, since it&#x27;s a subdirectory</span></span><br><span class="line">                    mStats.externalDataSize -= mStats.externalCacheSize;</span><br><span class="line"></span><br><span class="line">                    mStats.externalMediaSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                            userEnv.buildExternalStorageAppMediaDirs(mStats.packageName));</span><br><span class="line"></span><br><span class="line">                    mStats.externalObbSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                            userEnv.buildExternalStorageAppObbDirs(mStats.packageName));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">             </span><br><span class="line">    <span class="comment">// 展开 PackageManager的 getPackageSizeInfoLI 函数:</span></span><br><span class="line">            <span class="comment">// 该函数与6.0的一致/</span></span><br><span class="line">      <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">getPackageSizeInfoLI</span><span class="params">(String packageName, <span class="type">int</span> userHandle,</span></span><br><span class="line"><span class="params">            PackageStats pStats)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (packageName == <span class="literal">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Attempt to get size of null packageName.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageParser.Package p;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">dataOnly</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">libDirRoot</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">asecPath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            p = mPackages.get(packageName);</span><br><span class="line">            ps = mSettings.mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">if</span>(p == <span class="literal">null</span>) &#123;</span><br><span class="line">                dataOnly = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span>((ps == <span class="literal">null</span>) || (ps.pkg == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Package named &#x27;&quot;</span> + packageName +<span class="string">&quot;&#x27; doesn&#x27;t exist.&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                p = ps.pkg;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="literal">null</span>) &#123;</span><br><span class="line">                libDirRoot = ps.legacyNativeLibraryPathString;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* SPRD: support double sdcard</span></span><br><span class="line"><span class="comment">             * Add support for install apk to internal sdcard @&#123;</span></span><br><span class="line"><span class="comment">             * @orig</span></span><br><span class="line"><span class="comment">             * if (p != null &amp;&amp; (isExternal(p) || isForwardLocked(p))) &#123;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (p != <span class="literal">null</span> &amp;&amp; (isExternal(p) || isForwardLocked(p) || isInternalSd(p))) &#123;</span><br><span class="line">            <span class="comment">/* @&#125; */</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">secureContainerId</span> <span class="operator">=</span> cidFromCodePath(p.applicationInfo.getBaseCodePath());</span><br><span class="line">                <span class="keyword">if</span> (secureContainerId != <span class="literal">null</span>) &#123;</span><br><span class="line">                    asecPath = PackageHelper.getSdFilesystem(secureContainerId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">publicSrcDir</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!dataOnly) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ApplicationInfo</span> <span class="variable">applicationInfo</span> <span class="operator">=</span> p.applicationInfo;</span><br><span class="line">            <span class="keyword">if</span> (applicationInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Package &quot;</span> + packageName + <span class="string">&quot; has no applicationInfo.&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isForwardLocked(p)) &#123;</span><br><span class="line">                publicSrcDir = applicationInfo.getBaseResourcePath();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> extend to measure size of split APKs</span></span><br><span class="line">        String[] dexCodeInstructionSets = getDexCodeInstructionSets(getAppDexInstructionSets(ps));</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> mInstaller.getSizeInfo(packageName, userHandle, p.baseCodePath, libDirRoot,</span><br><span class="line">                publicSrcDir, asecPath, dexCodeInstructionSets, pStats);</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fix-up for forward-locked applications in ASEC containers.</span></span><br><span class="line">        <span class="keyword">if</span> (!isExternal(p) &amp;&amp; !isInternalSd(p)) &#123;</span><br><span class="line">        <span class="comment">/* @&#125; */</span></span><br><span class="line">            pStats.codeSize += pStats.externalCodeSize;</span><br><span class="line">            pStats.externalCodeSize = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;           </span><br><span class="line">  <span class="comment">// 查看installd的get_size代码也与6.0的相同, 下面不再写了.</span></span><br></pre></td></tr></table></figure>

<p>综上, Android5.1 上 total_size 的计算方式和 Android6.0的完全相同. 此处不再赘述.</p>
<h1 id="5-Android4-4"><a href="#5-Android4-4" class="headerlink" title="5. Android4.4"></a>5. Android4.4</h1><h2 id="5-1-涉及的文件"><a href="#5-1-涉及的文件" class="headerlink" title="5.1. 涉及的文件"></a>5.1. 涉及的文件</h2><ul>
<li>InstalledAppDetails.java</li>
<li>ApplicationState.java</li>
</ul>
<h2 id="5-2-相关代码"><a href="#5-2-相关代码" class="headerlink" title="5.2. 相关代码"></a>5.2. 相关代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">mTotalSize.setText(getSizeStr(mAppEntry.size));</span><br><span class="line">        <span class="keyword">final</span> IPackageStatsObserver.<span class="type">Stub</span> <span class="variable">mStatsObserver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IPackageStatsObserver</span>.Stub() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onGetStatsCompleted</span><span class="params">(PackageStats stats, <span class="type">boolean</span> succeeded)</span> &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">sizeChanged</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">synchronized</span> (mEntriesMap) &#123;</span><br><span class="line">                    <span class="type">AppEntry</span> <span class="variable">entry</span> <span class="operator">=</span> mEntriesMap.get(stats.packageName);</span><br><span class="line">                    <span class="keyword">if</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span> (entry) &#123;</span><br><span class="line">                            entry.sizeStale = <span class="literal">false</span>;</span><br><span class="line">                            entry.sizeLoadStart = <span class="number">0</span>;</span><br><span class="line">                            <span class="type">long</span> <span class="variable">externalCodeSize</span> <span class="operator">=</span> stats.externalCodeSize</span><br><span class="line">                                    + stats.externalObbSize;</span><br><span class="line">                            <span class="type">long</span> <span class="variable">externalDataSize</span> <span class="operator">=</span> stats.externalDataSize</span><br><span class="line">                                    + stats.externalMediaSize;</span><br><span class="line">                            <span class="type">long</span> <span class="variable">newSize</span> <span class="operator">=</span> externalCodeSize + externalDataSize</span><br><span class="line">                                    + getTotalInternalSize(stats);</span><br><span class="line">                            <span class="keyword">if</span> (entry.size != newSize ||</span><br><span class="line">                                    entry.cacheSize != stats.cacheSize ||</span><br><span class="line">                                    entry.codeSize != stats.codeSize ||</span><br><span class="line">                                    entry.dataSize != stats.dataSize ||</span><br><span class="line">                                    entry.externalCodeSize != externalCodeSize ||</span><br><span class="line">                                    entry.externalDataSize != externalDataSize ||</span><br><span class="line">                                    entry.externalCacheSize != stats.externalCacheSize) &#123;</span><br><span class="line">                                entry.size = newSize;</span><br><span class="line">                                entry.cacheSize = stats.cacheSize;</span><br><span class="line">                                entry.codeSize = stats.codeSize;</span><br><span class="line">                                entry.dataSize = stats.dataSize;</span><br><span class="line">                                entry.externalCodeSize = externalCodeSize;</span><br><span class="line">                                entry.externalDataSize = externalDataSize;</span><br><span class="line">                                entry.externalCacheSize = stats.externalCacheSize;</span><br><span class="line">                                entry.sizeStr = getSizeStr(entry.size);</span><br><span class="line">                                entry.internalSize = getTotalInternalSize(stats);</span><br><span class="line">                                entry.internalSizeStr = getSizeStr(entry.internalSize);</span><br><span class="line">                                entry.externalSize = getTotalExternalSize(stats);</span><br><span class="line">                                entry.externalSizeStr = getSizeStr(entry.externalSize);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">         <span class="keyword">void</span> <span class="title function_">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                mSuccess = getPackageSizeInfoLI(mStats.packageName, mStats.userHandle, mStats);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> mounted;</span><br><span class="line">            <span class="keyword">if</span> (Environment.isExternalStorageEmulated()) &#123;</span><br><span class="line">                mounted = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> Environment.getExternalStoragePathState(); <span class="comment">// SPRD: chanage interface</span></span><br><span class="line">                mounted = (Environment.MEDIA_MOUNTED.equals(status)</span><br><span class="line">                        || Environment.MEDIA_MOUNTED_READ_ONLY.equals(status));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mounted) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">UserEnvironment</span> <span class="variable">userEnv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserEnvironment</span>(mStats.userHandle);</span><br><span class="line"></span><br><span class="line">                mStats.externalCacheSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                        userEnv.buildExternalStorageAppCacheDirs(mStats.packageName));</span><br><span class="line"></span><br><span class="line">                mStats.externalDataSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                        userEnv.buildExternalStorageAppDataDirs(mStats.packageName));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Always subtract cache size, since it&#x27;s a subdirectory</span></span><br><span class="line">                mStats.externalDataSize -= mStats.externalCacheSize;</span><br><span class="line"></span><br><span class="line">                mStats.externalMediaSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                        userEnv.buildExternalStorageAppMediaDirs(mStats.packageName));</span><br><span class="line"></span><br><span class="line">                mStats.externalObbSize = calculateDirectorySize(mContainerService,</span><br><span class="line">                        userEnv.buildExternalStorageAppObbDirs(mStats.packageName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;             </span><br><span class="line">   </span><br><span class="line">      <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">getPackageSizeInfoLI</span><span class="params">(String packageName, <span class="type">int</span> userHandle,</span></span><br><span class="line"><span class="params">            PackageStats pStats)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (packageName == <span class="literal">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Attempt to get size of null packageName.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageParser.Package p;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">dataOnly</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">libDirPath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">asecPath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            p = mPackages.get(packageName);</span><br><span class="line">            <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> mSettings.mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">if</span>(p == <span class="literal">null</span>) &#123;</span><br><span class="line">                dataOnly = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span>((ps == <span class="literal">null</span>) || (ps.pkg == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">&quot;Package named &#x27;&quot;</span> + packageName +<span class="string">&quot;&#x27; doesn&#x27;t exist.&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                p = ps.pkg;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="literal">null</span>) &#123;</span><br><span class="line">                libDirPath = ps.nativeLibraryPathString;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* SPRD: Add support for install apk to internal sdcard @&#123; */</span></span><br><span class="line">            <span class="keyword">if</span> (p != <span class="literal">null</span> &amp;&amp; (isExternal(p) || isForwardLocked(p) || isInternalSd(p))) &#123;</span><br><span class="line">            <span class="comment">/* @&#125; */</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">secureContainerId</span> <span class="operator">=</span> cidFromCodePath(p.applicationInfo.sourceDir);</span><br><span class="line">                <span class="keyword">if</span> (secureContainerId != <span class="literal">null</span>) &#123;</span><br><span class="line">                    asecPath = PackageHelper.getSdFilesystem(secureContainerId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">publicSrcDir</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!dataOnly) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ApplicationInfo</span> <span class="variable">applicationInfo</span> <span class="operator">=</span> p.applicationInfo;</span><br><span class="line">            <span class="keyword">if</span> (applicationInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Package &quot;</span> + packageName + <span class="string">&quot; has no applicationInfo.&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isForwardLocked(p)) &#123;</span><br><span class="line">                publicSrcDir = applicationInfo.publicSourceDir;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> mInstaller.getSizeInfo(packageName, userHandle, p.mPath, libDirPath,</span><br><span class="line">                publicSrcDir, asecPath, pStats);</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fix-up for forward-locked applications in ASEC containers.</span></span><br><span class="line">        <span class="comment">/* SPRD: Add support for install apk to internal sdcard @&#123; */</span></span><br><span class="line">        <span class="keyword">if</span> (!isExternal(p) &amp;&amp; !isInternalSd(p)) &#123;</span><br><span class="line">        <span class="comment">/* @&#125; */</span></span><br><span class="line">            pStats.codeSize += pStats.externalCodeSize;</span><br><span class="line">            pStats.externalCodeSize = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">// installd中的统计方式与5.0相同</span></span><br></pre></td></tr></table></figure>

<p>综上, Android4.4 与 Android5.0 &#x2F; Android6.0的统计方式是一致的, 不再赘述.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android-8-1/" rel="tag"># Android 8.1</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/08/02/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/Print%E6%A1%86%E6%9E%B6%E6%95%B4%E7%90%86/" rel="prev" title="Print框架整理">
      <i class="fa fa-chevron-left"></i> Print框架整理
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/11/12/OTA%E7%9B%B8%E5%85%B3/repart%E8%87%AA%E9%80%82%E5%BA%94%E8%B0%83%E6%95%B4%E7%89%A9%E7%90%86%E5%88%86%E5%8C%BA/" rel="next" title="repart自适应调整物理分区">
      repart自适应调整物理分区 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-Android-8-1"><span class="nav-number">1.</span> <span class="nav-text">1. Android 8.1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E6%B6%89%E5%8F%8A%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">1.1.</span> <span class="nav-text">1.1. 涉及的文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="nav-number">1.2.</span> <span class="nav-text">1.2. 相关代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-%E6%B2%A1%E6%9C%89%E5%BC%80%E5%90%AFquota%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1. 没有开启quota的情况下</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-%E5%BC%80%E5%90%AFquota%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2.2. 开启quota的情况</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Android7-0"><span class="nav-number">2.</span> <span class="nav-text">2. Android7.0</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E6%B6%89%E5%8F%8A%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text">2.1. 涉及的文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="nav-number">2.2.</span> <span class="nav-text">2.2. 相关代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Android6-0"><span class="nav-number">3.</span> <span class="nav-text">3. Android6.0</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E6%B6%89%E5%8F%8A%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">3.1.</span> <span class="nav-text">3.1. 涉及的文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="nav-number">3.2.</span> <span class="nav-text">3.2. 相关代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-Android5-1"><span class="nav-number">4.</span> <span class="nav-text">4. Android5.1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E6%B6%89%E5%8F%8A%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">4.1.</span> <span class="nav-text">4.1. 涉及的文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="nav-number">4.2.</span> <span class="nav-text">4.2. 相关代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-Android4-4"><span class="nav-number">5.</span> <span class="nav-text">5. Android4.4</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E6%B6%89%E5%8F%8A%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-number">5.1.</span> <span class="nav-text">5.1. 涉及的文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="nav-number">5.2.</span> <span class="nav-text">5.2. 相关代码</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liguang.zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">159</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">131</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liguang.zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'dark',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'VrGRp2q7WwXjxsCNmlDIZYbC-gzGzoHsz',
      appKey     : 'JgMXmmB7yKQf2zm80TaBp3JT',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
