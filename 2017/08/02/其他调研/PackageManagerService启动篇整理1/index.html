<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW WenKai:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liguangzhang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-2}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="1. PackageManagerService的启动过程   本篇主要介绍pkms的构造函数所做的工作.  1.1. BOOT_PROGRESS_PMS_START 阶段1.1.1. 初始化Settings类初始化Settings类对象并添加6个ShareUserId 12345678910111213mSettings &#x3D; new Settings(mPackages);mSettings.a">
<meta property="og:type" content="article">
<meta property="og:title" content="PackageManagerService启动篇整理1">
<meta property="og:url" content="https://liguangzhang.github.io/2017/08/02/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/PackageManagerService%E5%90%AF%E5%8A%A8%E7%AF%87%E6%95%B4%E7%90%861/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:description" content="1. PackageManagerService的启动过程   本篇主要介绍pkms的构造函数所做的工作.  1.1. BOOT_PROGRESS_PMS_START 阶段1.1.1. 初始化Settings类初始化Settings类对象并添加6个ShareUserId 12345678910111213mSettings &#x3D; new Settings(mPackages);mSettings.a">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://liguangzhang.github.io/images/runtime-permission.png">
<meta property="og:image" content="https://liguangzhang.github.io/images/20160929092228476.jpg">
<meta property="og:image" content="https://liguangzhang.github.io/images/DefContainerSercice.png">
<meta property="article:published_time" content="2017-08-02T05:47:23.000Z">
<meta property="article:modified_time" content="2024-04-16T02:29:32.941Z">
<meta property="article:author" content="liguang.zhang">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="AndroidN">
<meta property="article:tag" content="PackageManagerService">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liguangzhang.github.io/images/runtime-permission.png">

<link rel="canonical" href="https://liguangzhang.github.io/2017/08/02/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/PackageManagerService%E5%90%AF%E5%8A%A8%E7%AF%87%E6%95%B4%E7%90%861/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'" />

  <title>PackageManagerService启动篇整理1 | blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2017/08/02/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/PackageManagerService%E5%90%AF%E5%8A%A8%E7%AF%87%E6%95%B4%E7%90%861/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PackageManagerService启动篇整理1
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-08-02 13:47:23" itemprop="dateCreated datePublished" datetime="2017-08-02T13:47:23+08:00">2017-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-16 10:29:32" itemprop="dateModified" datetime="2024-04-16T10:29:32+08:00">2024-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PackageManagerService/" itemprop="url" rel="index"><span itemprop="name">PackageManagerService</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-PackageManagerService的启动过程"><a href="#1-PackageManagerService的启动过程" class="headerlink" title="1. PackageManagerService的启动过程"></a>1. PackageManagerService的启动过程</h1><blockquote>
<p>  本篇主要介绍<code>pkms</code>的构造函数所做的工作.</p>
</blockquote>
<h2 id="1-1-BOOT-PROGRESS-PMS-START-阶段"><a href="#1-1-BOOT-PROGRESS-PMS-START-阶段" class="headerlink" title="1.1. BOOT_PROGRESS_PMS_START 阶段"></a>1.1. BOOT_PROGRESS_PMS_START 阶段</h2><h3 id="1-1-1-初始化Settings类"><a href="#1-1-1-初始化Settings类" class="headerlink" title="1.1.1. 初始化Settings类"></a>1.1.1. 初始化Settings类</h3><p>初始化Settings类对象并添加6个ShareUserId</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mSettings = <span class="keyword">new</span> <span class="title class_">Settings</span>(mPackages);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.system&quot;</span>, Process.SYSTEM_UID,</span><br><span class="line">                           ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.phone&quot;</span>, RADIO_UID,</span><br><span class="line">                           ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.log&quot;</span>, LOG_UID,</span><br><span class="line">                           ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.nfc&quot;</span>, NFC_UID,</span><br><span class="line">                           ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.bluetooth&quot;</span>, BLUETOOTH_UID,</span><br><span class="line">                           ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">&quot;android.uid.shell&quot;</span>, SHELL_UID,</span><br><span class="line">                           ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br></pre></td></tr></table></figure>

<p>SharedUserSettings将“android：sharedUserId”属性的名称和对应的uid关联起来，同时持有所有声明相同sharedUserId的APK的PackageSettings，因此PKMS可以为同一类APK设置相同的权限。</p>
<h4 id="1-1-1-1-Settings类的作用"><a href="#1-1-1-1-Settings类的作用" class="headerlink" title="1.1.1.1. Settings类的作用"></a>1.1.1.1. Settings类的作用</h4><p>首先可以看下Settings的构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Settings(File dataDir, Object lock) &#123;</span><br><span class="line">    <span class="comment">//该 lock 为mPackages 的ArrayMap</span></span><br><span class="line">    mLock = lock;</span><br><span class="line"></span><br><span class="line">    mRuntimePermissionsPersistence = <span class="keyword">new</span> <span class="title class_">RuntimePermissionPersistence</span>(mLock);</span><br><span class="line"></span><br><span class="line">    mSystemDir = <span class="keyword">new</span> <span class="title class_">File</span>(dataDir, <span class="string">&quot;system&quot;</span>);</span><br><span class="line">    mSystemDir.mkdirs();</span><br><span class="line">    FileUtils.setPermissions(mSystemDir.toString(),</span><br><span class="line">            FileUtils.S_IRWXU|FileUtils.S_IRWXG</span><br><span class="line">            |FileUtils.S_IROTH|FileUtils.S_IXOTH,</span><br><span class="line">            -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// Settings 工具类， 初始化/data/system下的几个目录</span></span><br><span class="line">    mSettingsFilename = <span class="keyword">new</span> <span class="title class_">File</span>(mSystemDir, <span class="string">&quot;packages.xml&quot;</span>);</span><br><span class="line">    mBackupSettingsFilename = <span class="keyword">new</span> <span class="title class_">File</span>(mSystemDir, <span class="string">&quot;packages-backup.xml&quot;</span>);</span><br><span class="line">    mPackageListFilename = <span class="keyword">new</span> <span class="title class_">File</span>(mSystemDir, <span class="string">&quot;packages.list&quot;</span>);</span><br><span class="line">    FileUtils.setPermissions(mPackageListFilename, <span class="number">0640</span>, SYSTEM_UID, PACKAGE_INFO_GID);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">File</span> <span class="variable">kernelDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/config/sdcardfs&quot;</span>);</span><br><span class="line">    mKernelMappingFilename = kernelDir.exists() ? kernelDir : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Deprecated: Needed for migration</span></span><br><span class="line">    mStoppedPackagesFilename = <span class="keyword">new</span> <span class="title class_">File</span>(mSystemDir, <span class="string">&quot;packages-stopped.xml&quot;</span>);</span><br><span class="line">    mBackupStoppedPackagesFilename = <span class="keyword">new</span> <span class="title class_">File</span>(mSystemDir, <span class="string">&quot;packages-stopped-backup.xml&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Settings为工具类,与权限分配和Package的信息持久化有关.</p>
<p>创建&#x2F;data&#x2F;system下几个与Package包信息相关的几个文件:</p>
<ul>
<li>&#x2F;data&#x2F;system&#x2F;packages.xml - 记录系统中已安装的APK的运行信息；</li>
<li>&#x2F;data&#x2F;system&#x2F;packages-backup.xml - 是packages.xml的备份文件，当packages.xml更新完毕时删除；</li>
<li>&#x2F;data&#x2F;system&#x2F;packages.list - 初始化为&#x2F;data&#x2F;system&#x2F;packages.list，记录所有已安装APK的简略信息;</li>
<li>&#x2F;data&#x2F;system&#x2F;packages-stopped.xml - 记录强制stop的应用程序信息(非系统级应用默认为stopped状态)</li>
<li>&#x2F;data&#x2F;system&#x2F;packages-stopped-backup.xml - 初始化为&#x2F;data&#x2F;system&#x2F;packages-stopped-backup.xml，是packages-stopped.xml的备份文件，二者在Jelly Bean中已标记为废弃。</li>
</ul>
<p><img src="/images/runtime-permission.png" alt="Setting工具类图"></p>
<p>&#x2F;data&#x2F;system&#x2F;packages.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">packages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">volumeUuid</span>=<span class="string">&quot;f3127468-e382-4328-9d82-40d6ba08c31d&quot;</span> <span class="attr">sdkVersion</span>=<span class="string">&quot;26&quot;</span> <span class="attr">databaseVersion</span>=<span class="string">&quot;3&quot;</span> <span class="attr">fingerprint</span>=<span class="string">&quot;SPRD/sp9850ka_1h10_native:8.0.0/OPR1.170623.013/W17.31:userdebug/test-keys&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">sdkVersion</span>=<span class="string">&quot;26&quot;</span> <span class="attr">databaseVersion</span>=<span class="string">&quot;3&quot;</span> <span class="attr">fingerprint</span>=<span class="string">&quot;SPRD/sp9850ka_1h10_native:8.0.0/OPR1.170623.013/W17.31:userdebug/test-keys&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">volumeUuid</span>=<span class="string">&quot;primary_physical&quot;</span> <span class="attr">sdkVersion</span>=<span class="string">&quot;26&quot;</span> <span class="attr">databaseVersion</span>=<span class="string">&quot;26&quot;</span> <span class="attr">fingerprint</span>=<span class="string">&quot;SPRD/sp9850ka_1h10_native:8.0.0/OPR1.170623.013/W17.31:userdebug/test-keys&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission-trees</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.REAL_GET_TASKS&quot;</span> <span class="attr">package</span>=<span class="string">&quot;android&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;18&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_CACHE_FILESYSTEM&quot;</span> <span class="attr">package</span>=<span class="string">&quot;android&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;18&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.REMOTE_AUDIO_PLAYBACK&quot;</span> <span class="attr">package</span>=<span class="string">&quot;android&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.DOWNLOAD_WITHOUT_NOTIFICATION&quot;</span> <span class="attr">package</span>=<span class="string">&quot;com.android.providers.downloads&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.REGISTER_WINDOW_MANAGER_LISTENERS&quot;</span> <span class="attr">package</span>=<span class="string">&quot;android&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.INTENT_FILTER_VERIFICATION_AGENT&quot;</span> <span class="attr">package</span>=<span class="string">&quot;android&quot;</span> <span class="attr">protection</span>=<span class="string">&quot;18&quot;</span> /&gt;</span></span><br><span class="line">      ...此处省略n个权限信息...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.android.fmradio&quot;</span> <span class="attr">codePath</span>=<span class="string">&quot;/system/priv-app/DreamFMRadio&quot;</span> <span class="attr">nativeLibraryPath</span>=<span class="string">&quot;/system/priv-app/DreamFMRadio/lib&quot;</span> <span class="attr">primaryCpuAbi</span>=<span class="string">&quot;armeabi-v7a&quot;</span> <span class="attr">publicFlags</span>=<span class="string">&quot;944291397&quot;</span> <span class="attr">privateFlags</span>=<span class="string">&quot;8&quot;</span> <span class="attr">ft</span>=<span class="string">&quot;15d9d796930&quot;</span> <span class="attr">it</span>=<span class="string">&quot;15d9d796930&quot;</span> <span class="attr">ut</span>=<span class="string">&quot;15d9d796930&quot;</span> <span class="attr">version</span>=<span class="string">&quot;2&quot;</span> <span class="attr">userId</span>=<span class="string">&quot;10006&quot;</span> <span class="attr">isOrphaned</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">key</span>=<span class="string">&quot;308204a830820390a003020102020900b3998086d056cffa300d06092a864886f70d0101040500308194310b3009060355040613025553311330110603550408130a43616c69666f726e6961311630140603550407130d4d6f756e7461696e20566965773110300e060355040a1307416e64726f69643110300e060355040b1307416e64726f69643110300e06035504031307416e64726f69643122302006092a864886f70d0109011613616e64726f696440616e64726f69642e636f6d301e170d3038303431353232343035305a170d3335303930313232343035305a308194310b3009060355040613025553311330110603550408130a43616c69666f726e6961311630140603550407130d4d6f756e7461696e20566965773110300e060355040a1307416e64726f69643110300e060355040b1307416e64726f69643110300e06035504031307416e64726f69643122302006092a864886f70d0109011613616e64726f696440616e64726f69642e636f6d30820120300d06092a864886f70d01010105000382010d003082010802820101009c780592ac0d5d381cdeaa65ecc8a6006e36480c6d7207b12011be50863aabe2b55d009adf7146d6f2202280c7cd4d7bdb26243b8a806c26b34b137523a49268224904dc01493e7c0acf1a05c874f69b037b60309d9074d24280e16bad2a8734361951eaf72a482d09b204b1875e12ac98c1aa773d6800b9eafde56d58bed8e8da16f9a360099c37a834a6dfedb7b6b44a049e07a269fccf2c5496f2cf36d64df90a3b8d8f34a3baab4cf53371ab27719b3ba58754ad0c53fc14e1db45d51e234fbbe93c9ba4edf9ce54261350ec535607bf69a2ff4aa07db5f7ea200d09a6c1b49e21402f89ed1190893aab5a9180f152e82f85a45753cf5fc19071c5eec827020103a381fc3081f9301d0603551d0e041604144fe4a0b3dd9cba29f71d7287c4e7c38f2086c2993081c90603551d230481c13081be80144fe4a0b3dd9cba29f71d7287c4e7c38f2086c299a1819aa48197308194310b3009060355040613025553311330110603550408130a43616c69666f726e6961311630140603550407130d4d6f756e7461696e20566965773110300e060355040a1307416e64726f69643110300e060355040b1307416e64726f69643110300e06035504031307416e64726f69643122302006092a864886f70d0109011613616e64726f696440616e64726f69642e636f6d820900b3998086d056cffa300c0603551d13040530030101ff300d06092a864886f70d01010405000382010100572551b8d93a1f73de0f6d469f86dad6701400293c88a0cd7cd778b73dafcc197fab76e6212e56c1c761cfc42fd733de52c50ae08814cefc0a3b5a1a4346054d829f1d82b42b2048bf88b5d14929ef85f60edd12d72d55657e22e3e85d04c831d613d19938bb8982247fa321256ba12d1d6a8f92ea1db1c373317ba0c037f0d1aff645aef224979fba6e7a14bc025c71b98138cef3ddfc059617cf24845cf7b40d6382f7275ed738495ab6e5931b9421765c491b72fb68e080dbdb58c2029d347c8b328ce43ef6a8b15533edfbe989bd6a48dd4b202eda94c6ab8dd5b8399203daae2ed446232e4fe9bd961394c6300e5138e3cfd285e6e4e483538cb8b1b357&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MODIFY_AUDIO_SETTINGS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MODIFY_AUDIO_ROUTING&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_MOCK_LOCATION&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_FM_RADIO&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_MEDIA_STORAGE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MOUNT_UNMOUNT_FILESYSTEMS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_SECURE_SETTINGS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WAKE_LOCK&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line">    ....此处省略n个package信息..</span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.android.providers.telephony&quot;</span> <span class="attr">codePath</span>=<span class="string">&quot;/system/priv-app/TelephonyProvider&quot;</span> <span class="attr">nativeLibraryPath</span>=<span class="string">&quot;/system/priv-app/TelephonyProvider/lib&quot;</span> <span class="attr">publicFlags</span>=<span class="string">&quot;1007402501&quot;</span> <span class="attr">privateFlags</span>=<span class="string">&quot;8&quot;</span> <span class="attr">ft</span>=<span class="string">&quot;15d9d7707d0&quot;</span> <span class="attr">it</span>=<span class="string">&quot;15d9d7707d0&quot;</span> <span class="attr">ut</span>=<span class="string">&quot;15d9d7707d0&quot;</span> <span class="attr">version</span>=<span class="string">&quot;26&quot;</span> <span class="attr">sharedUserId</span>=<span class="string">&quot;1001&quot;</span> <span class="attr">isOrphaned</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_SETTINGS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MODIFY_AUDIO_SETTINGS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MANAGE_ACCOUNTS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.SYSTEM_ALERT_WINDOW&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BIND_CARRIER_SERVICES&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.SEND_RESPOND_VIA_MESSAGE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.SHUTDOWN&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.CHANGE_COMPONENT_ENABLED_STATE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.INTERNAL_SYSTEM_WINDOW&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.PROCESS_PHONE_ACCOUNT_REGISTRATION&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BROADCAST_SMS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.CALL_PRIVILEGED&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.CHANGE_NETWORK_STATE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_SYNC_SETTINGS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">			...</span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line">  	....此处省略n个package信息..</span><br><span class="line">  	<span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">&quot;android.uid.phone&quot;</span> <span class="attr">userId</span>=<span class="string">&quot;1001&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_SETTINGS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MODIFY_AUDIO_SETTINGS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MANAGE_ACCOUNTS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.SYSTEM_ALERT_WINDOW&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BIND_CARRIER_SERVICES&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.SEND_RESPOND_VIA_MESSAGE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.SHUTDOWN&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.CHANGE_COMPONENT_ENABLED_STATE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.INTERNAL_SYSTEM_WINDOW&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.PROCESS_PHONE_ACCOUNT_REGISTRATION&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BROADCAST_SMS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.CALL_PRIVILEGED&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.CHANGE_NETWORK_STATE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_SYNC_SETTINGS&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.DEVICE_POWER&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.SET_TIME_ZONE&quot;</span> <span class="attr">granted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line">			...</span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shared-user</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">keyset-settings</span> <span class="attr">version</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keys</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">public-key</span> <span class="attr">identifier</span>=<span class="string">&quot;1&quot;</span> <span class="attr">value</span>=<span class="string">&quot;MIIBIDANBgkqhkiG9w0BAQEFAAOCAQ0AMIIBCAKCAQEAnHgFkqwNXTgc3qpl7MimAG42SAxtcgexIBG+UIY6q+K1XQCa33FG1vIgIoDHzU172yYkO4qAbCazSxN1I6SSaCJJBNwBST58Cs8aBch09psDe2AwnZB00kKA4WutKoc0NhlR6vcqSC0JsgSxh14SrJjBqnc9aAC56v3lbVi+2OjaFvmjYAmcN6g0pt/tt7a0SgSeB6Jp/M8sVJbyzzbWTfkKO42PNKO6q0z1M3GrJ3GbO6WHVK0MU/wU4dtF1R4jT7vpPJuk7fnOVCYTUOxTVge/aaL/SqB9tffqIA0JpsG0niFAL4ntEZCJOqtakYDxUugvhaRXU89fwZBxxe7IJwIBAw==&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">public-key</span> <span class="attr">identifier</span>=<span class="string">&quot;2&quot;</span> <span class="attr">value</span>=<span class="string">&quot;MIIBIDANBgkqhkiG9w0BAQEFAAOCAQ0AMIIBCAKCAQEAyMLb/QlKLfRcP/GjLtIYBexy/FjQF5cb0Pa1LCYtcIGdGRln4Vjf06LH8bPg6AzlRdedKEgiAhHrhvD9gxLTe0IMETdQzJRhiuhy9IhkY73EYnyqDASDyGST41FVcRcDOL/cxM1q3dHAovNfXPJO0+QEOj5Y4rBeZkzN4SvLZ3Nf1t8SScNp5iVCvApHKeU5F/XDj/pS0Xtzycc3mN2xjtSBWQh1VH5mv8XaykwlpuuWDtlpI3CdowK6ZGy0lrMl6Gxciy56M3eyu+THzzMlQpEWP2iRUqwIhVDIPFCPS/Wt8K7VotygWD+asK0XZQ237qSyP9tFiFVH0P6rchg4iQIBAw==&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">public-key</span> <span class="attr">identifier</span>=<span class="string">&quot;3&quot;</span> <span class="attr">value</span>=<span class="string">&quot;MIIBIDANBgkqhkiG9w0BAQEFAAOCAQ0AMIIBCAKCAQEA1pMZBN7GCySx7cdi4NnYJT4+zWzrHeL/Boyo6LyozWvTeG6nCqds5g67D5k1Wf/ZPnepQ+foPUtkuOT+otPmVvHiZ6gbv7IwtXjCBEO+THIYuEb1IRWG8DihTonCvjh/jr7Pj8rD2h7jMMnqk9Cnw9xK81AiDVAIBzLggJcX7moFM1nmppTsLLPyhKCkZsh6lNg7MQk6ZzcuL2QSwG5tQvFYGN/+A4HMDNRE2mzdw7gkWBlIAbMlZBNPv96YySh3SNv1Z2pUDYFUyLvKB7niR1UzEcRrmvdv3uzMjmnnyKLQjngmIJQ/mXJ9PAT+cpkdmd+brjigshd/ox1bav7pHwIBAw==&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">public-key</span> <span class="attr">identifier</span>=<span class="string">&quot;4&quot;</span> <span class="attr">value</span>=<span class="string">&quot;MIIBIDANBgkqhkiG9w0BAQEFAAOCAQ0AMIIBCAKCAQEAriUMWhbvl/woaaxlGzIXzDa6DoaWQWjVigSfQM6FhnEjo/+09tlJwzzy2joFwj6sqlfYA4ibF1m89Z58byGJCuJQhbftVqpibAmJ75zNNjYsoOjRuWA/1Ngyh2eSbMwJDGi3da5/8wk0zDae8oVaJmffDGZ/0MfPXY66ZVgGc3MDu2JHJuq67fty8H7Xp2qzy5o4HEt9zYCbFA2JHwAhO+QB9Y1qBqYercOpwvHGVnKFsJrgk0Kmb6Qh6vk633VzoCjDMdcGAas698yEAz7OfHcqOluGsNvp13fDpIqpgB7c7ieBWJ9E2eQROXlgBXaplBC6gQkSWdrZjGxo/3hLjwIBAw==&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">keys</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keysets</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">keyset</span> <span class="attr">identifier</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key-id</span> <span class="attr">identifier</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">keyset</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">keyset</span> <span class="attr">identifier</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key-id</span> <span class="attr">identifier</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">keyset</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">keyset</span> <span class="attr">identifier</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key-id</span> <span class="attr">identifier</span>=<span class="string">&quot;3&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">keyset</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">keyset</span> <span class="attr">identifier</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key-id</span> <span class="attr">identifier</span>=<span class="string">&quot;4&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">keyset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">keysets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lastIssuedKeyId</span> <span class="attr">value</span>=<span class="string">&quot;4&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lastIssuedKeySetId</span> <span class="attr">value</span>=<span class="string">&quot;4&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">keyset-settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">packages</span>&gt;</span> </span><br></pre></td></tr></table></figure>

<blockquote>
<p>  该文件记录的信息包括:</p>
</blockquote>
<ul>
<li>所有包公布的权限信息:</li>
</ul>
<table>
<thead>
<tr>
<th align="center">权限名称</th>
<th align="center">公布该权限的包名</th>
<th align="center">权限的保护级别(ProtectLevel)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">android.permission.DOWNLOAD_WITHOUT_NOTIFICATION</td>
<td align="center">com.android.providers.downloads</td>
<td align="center">none</td>
</tr>
<tr>
<td align="center">android.permission.REAL_GET_TASKS</td>
<td align="center">android</td>
<td align="center">18</td>
</tr>
<tr>
<td align="center">sprd.permission.SPRD_MODIFY_PHONE_STATE</td>
<td align="center">android</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">android.permission.WRITE_EXTERNAL_STORAGE</td>
<td align="center">android</td>
<td align="center">1</td>
</tr>
</tbody></table>
<p><strong>具体的权限保护级别请查看<code>PermissionInfo.java</code>文件</strong></p>
<ul>
<li>安装包的信息: &lt;package标签&gt;</li>
</ul>
<table>
<thead>
<tr>
<th align="center">item</th>
<th align="center">作用</th>
<th align="center">例子</th>
</tr>
</thead>
<tbody><tr>
<td align="center">name</td>
<td align="center">包名</td>
<td align="center">com.android.fmradio</td>
</tr>
<tr>
<td align="center">codePath</td>
<td align="center">apk位置</td>
<td align="center">&#x2F;system&#x2F;priv-app&#x2F;DreamFMRadio</td>
</tr>
<tr>
<td align="center">nativeLibraryPath</td>
<td align="center">native依赖库</td>
<td align="center">&#x2F;system&#x2F;priv-app&#x2F;DreamFMRadio&#x2F;lib</td>
</tr>
<tr>
<td align="center">primaryCpuAbi</td>
<td align="center">首要的abi指令集</td>
<td align="center">armeabi-v7a</td>
</tr>
<tr>
<td align="center">publicFlags</td>
<td align="center">pkg的flag, 解析相关.<a target="_blank" rel="noopener" href="http://tool.oschina.net/hexconvert">将十进制转换为二进制后</a>,通过比对ApplicationInfo.java中的标志位查看带有哪些flag</td>
<td align="center">944291397</td>
</tr>
<tr>
<td align="center">privateFlags</td>
<td align="center">安装\解析 相关的flag, 比如 PRIVATE_FLAG_DIRECT_BOOT_AWARE,  android:directBootAware&#x3D;”true”, 同上,需要<a target="_blank" rel="noopener" href="http://tool.oschina.net/hexconvert">将十进制转换为二进制后</a>,通过比对ApplicationInfo.java中的标志位查看带有哪些flag</td>
<td align="center">8</td>
</tr>
<tr>
<td align="center">ft</td>
<td align="center"><span id="unix">apk文件的最后一次修改时间(时间采用UNIX时间戳格式,需要先将16进制转换为10进制,再将数字转换unix时间戳)<a target="_blank" rel="noopener" href="http://cn.calcuworld.com/%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E8%AE%A1%E7%AE%97%E5%99%A8">十六进制转换十进制</a> <a target="_blank" rel="noopener" href="http://tool.chinaz.com/Tools/unixtime.aspx">UNIX时间戳转换,注意切换为ms</a></td>
<td align="center">15d9d796930</td>
</tr>
<tr>
<td align="center"><span id="firstInstallTime">it</td>
<td align="center">第一次安装时间</td>
<td align="center">15d9d796930</td>
</tr>
<tr>
<td align="center"><span id="lastUpdateTime">ut</td>
<td align="center">最后一次应用升级的时间</td>
<td align="center">15d9d796930</td>
</tr>
<tr>
<td align="center">version</td>
<td align="center">软件版本, 来自于android:versionCode&#x2F;AndroidManifest</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">userId</td>
<td align="center">appid</td>
<td align="center">10006</td>
</tr>
<tr>
<td align="center">isOrphaned</td>
<td align="center">与PackageInstaller相关. FLAG_SYSTEM的 app都为true,这个值来自与解析时的PARSE_IS_SYSTEM,目前看到的所有非data目录外的app都携带该标志; 另外用户自己安装的app,如果安装该apk的installer安装器销毁,该apk的此标志位也会变为true. 该标志为默认为false. 与应用卸载的逻辑有关.</td>
<td align="center">true</td>
</tr>
<tr>
<td align="center">sigs</td>
<td align="center">签名信息, count为签名的数目,签名可以有多个.注意修改apk签名后,或者更改shareUserId后,最好删除packages.xml文件,否则可能是读取的文件中的签名的信息</td>
<td align="center">count&#x3D;”1”   <cert index="0" key=****/></td>
</tr>
<tr>
<td align="center">perms</td>
<td align="center">申请的所有权限信息</td>
<td align="center">MODIFY_AUDIO_SETTINGS</td>
</tr>
<tr>
<td align="center">granted</td>
<td align="center">是否授予</td>
<td align="center">true</td>
</tr>
<tr>
<td align="center">flags</td>
<td align="center">授予的标志位</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">proper-signing-keyset</td>
<td align="center">可能的密钥集?&#x2F;与内置的签名集合有关.比如platform的签名其值都是1.而media的签名都是4.与最后的keyset-settings项是关联的.</td>
<td align="center">1</td>
</tr>
</tbody></table>
<ul>
<li>version标签信息:</li>
</ul>
<table>
<thead>
<tr>
<th>item</th>
<th>作用</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td><span id="sdkv"/>sdkVersion</td>
<td>标明sdk的版本</td>
<td>24</td>
</tr>
<tr>
<td>databaseVersion</td>
<td>package database 的版本</td>
<td>24, 对应与绑定volumeUuid的项与sdkVersion相同</td>
</tr>
<tr>
<td>fingerprint</td>
<td>版本信息</td>
<td>SPRD&#x2F;sp9853i_1h10_vmm_tos&#x2F;sp9853i_1h10:7.0&#x2F;NRD90M&#x2F;W17.31.1N00:userdebug&#x2F;test-keys</td>
</tr>
<tr>
<td>volumeUuid</td>
<td>通过volumeUuid创建VersionInfo信息. 对应内部存储还是外部存储</td>
<td>da2a94f3-d7f6-489f-b293-5bdb44b8dcc5</td>
</tr>
</tbody></table>
<p>&#x2F;data&#x2F;system&#x2F;packages.list</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">com.android.fmradio <span class="number">10023</span> <span class="number">0</span> /<span class="keyword">data</span>/user/<span class="number">0</span>/com.android.fmradio platform:privapp <span class="number">1013</span>,<span class="number">3002</span>,<span class="number">1023</span>,<span class="number">1015</span>,<span class="number">3003</span></span><br><span class="line">plugin.sprd.sosForEmergency <span class="number">10052</span> <span class="number">0</span> /<span class="keyword">data</span>/user/<span class="number">0</span>/plugin.sprd.sosForEmergency default none</span><br><span class="line">com.android.cts.priv.ctsshim <span class="number">10005</span> <span class="number">0</span> /<span class="keyword">data</span>/user/<span class="number">0</span>/com.android.cts.priv.ctsshim default:privapp none</span><br><span class="line">com.android.providers.telephony <span class="number">1001</span> <span class="number">0</span> /<span class="keyword">data</span>/user_de/<span class="number">0</span>/com.android.providers.telephony platform:privapp <span class="number">3002</span>,<span class="number">3003</span>,<span class="number">3001</span></span><br><span class="line">com.sprd.engineermode <span class="number">1000</span> <span class="number">0</span> /<span class="keyword">data</span>/user/<span class="number">0</span>/com.sprd.engineermode platform <span class="number">1013</span>,<span class="number">3002</span>,<span class="number">1023</span>,<span class="number">1015</span>,<span class="number">3003</span>,<span class="number">3001</span></span><br><span class="line">com.android.providers.calendar <span class="number">10011</span> <span class="number">0</span> /<span class="keyword">data</span>/user/<span class="number">0</span>/com.android.providers.calendar default:privapp <span class="number">3003</span></span><br><span class="line">com.android.providers.media <span class="number">10017</span> <span class="number">0</span> /<span class="keyword">data</span>/user/<span class="number">0</span>/com.android.providers.media default:privapp <span class="number">2001</span>,<span class="number">1023</span>,<span class="number">1015</span>,<span class="number">3003</span>,<span class="number">1024</span>,<span class="number">3007</span></span><br><span class="line">com.android.wallpapercropper <span class="number">10025</span> <span class="number">0</span> /<span class="keyword">data</span>/user/<span class="number">0</span>/com.android.wallpapercropper platform:privapp none</span><br></pre></td></tr></table></figure>

<blockquote>
<p>  该文件记录了所有已安装apk的简略信息</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">包名</th>
<th align="center">appid</th>
<th align="center">用户</th>
<th align="center">数据目录</th>
<th align="center">包所属的性质(签名+app性质)</th>
<th align="center">gids</th>
</tr>
</thead>
<tbody><tr>
<td align="center">com.android.fmradio</td>
<td align="center">10023</td>
<td align="center">0</td>
<td align="center">&#x2F;data&#x2F;user&#x2F;0&#x2F;com.android.fmradio</td>
<td align="center">platform:privapp</td>
<td align="center">1013,3002,1023,1015,3003</td>
</tr>
</tbody></table>
<h3 id="1-1-2-解析属性"><a href="#1-1-2-解析属性" class="headerlink" title="1.1.2. 解析属性"></a>1.1.2. 解析属性</h3><p>获取系统默认配置主要包括两方面：属性系统配置和默认显示参数。</p>
<p><em><strong>debug.separate_processes</strong></em></p>
<p>用于标记是否在独立进程中运行某个程序。根据其值设置两个全局变量的值，后续ScanDirLI扫描安装APK时需要用到这两个变量，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">        <span class="type">String</span> <span class="variable">separateProcesses</span> <span class="operator">=</span> SystemProperties.get(<span class="string">&quot;debug.separate_processes&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (separateProcesses != <span class="literal">null</span> &amp;&amp; separateProcesses.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;*&quot;</span>.equals(separateProcesses)) &#123;</span><br><span class="line">                <span class="comment">// debug.separate_processes 为*时，解析AndroidManifest时忽略process， 即所有进程都运行在它自己的进程中</span></span><br><span class="line">                mDefParseFlags = PackageParser.PARSE_IGNORE_PROCESSES;</span><br><span class="line">                mSeparateProcesses = <span class="literal">null</span>;</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Running with debug.separate_processes: * (ALL)&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 不为*时，指定的组件运行在自己进程中</span></span><br><span class="line">                mSeparateProcesses = separateProcesses.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                Slog.w(TAG, <span class="string">&quot;Running with debug.separate_processes: &quot;</span></span><br><span class="line">                        + separateProcesses);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">            mSeparateProcesses = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">      <span class="comment">// separateProcesses = mSeparateProcesses </span></span><br><span class="line">      <span class="comment">// flags = mDefParseFlags </span></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">buildProcessName</span><span class="params">(String pkg, String defProc,</span></span><br><span class="line"><span class="params">            CharSequence procSeq, <span class="type">int</span> flags, String[] separateProcesses,</span></span><br><span class="line"><span class="params">            String[] outError)</span> &#123;</span><br><span class="line">        <span class="comment">// procSeq 为从AndroidManifest中解析出来的 android:process的名称</span></span><br><span class="line">        <span class="keyword">if</span> ((flags&amp;PARSE_IGNORE_PROCESSES) != <span class="number">0</span> &amp;&amp; !<span class="string">&quot;system&quot;</span>.equals(procSeq)) &#123;</span><br><span class="line">            <span class="keyword">return</span> defProc != <span class="literal">null</span> ? defProc : pkg;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (separateProcesses != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=separateProcesses.length-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">sp</span> <span class="operator">=</span> separateProcesses[i];</span><br><span class="line">                <span class="keyword">if</span> (sp.equals(pkg) || sp.equals(defProc) || sp.equals(procSeq)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> pkg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (procSeq == <span class="literal">null</span> || procSeq.length() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> defProc;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buildCompoundName(pkg, procSeq, <span class="string">&quot;process&quot;</span>, outError);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>获取系统默认显示参数</p>
<p>通过WindowManager获取屏幕默认显示参数，存入一个DiaplayMetrics类型的全局变量PackageManagerService.mMetric中,后续扫描安装时使用该值匹配APK的asset和resource。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mMetrics是一个描述界面显示，尺寸，分辨率，密度的类。</span></span><br><span class="line">getDefaultDisplayMetrics(context, mMetrics);</span><br></pre></td></tr></table></figure>

<h3 id="1-1-3-dex优化相关"><a href="#1-1-3-dex优化相关" class="headerlink" title="1.1.3. dex优化相关"></a>1.1.3. dex优化相关</h3><p>创建dex优化类的实例, mPackageDexOptimizer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mInstaller = installer;</span><br><span class="line">mPackageDexOptimizer = <span class="keyword">new</span> <span class="title class_">PackageDexOptimizer</span>(installer, mInstallLock, context,</span><br><span class="line">        <span class="string">&quot;*dexopt*&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-1-4-SysConfig类构造并初始化"><a href="#1-1-4-SysConfig类构造并初始化" class="headerlink" title="1.1.4. SysConfig类构造并初始化"></a>1.1.4. SysConfig类构造并初始化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行systemConfig初始化， 权限、feature sharedLibarys相关，解析一些配置文件，解析后的结果放在  SystemConfig</span></span><br><span class="line"><span class="comment">// 的 mGlobalGids  mSystemPermissions mAvailableFeatures 列表中</span></span><br><span class="line"><span class="type">SystemConfig</span> <span class="variable">systemConfig</span> <span class="operator">=</span> SystemConfig.getInstance();</span><br><span class="line">mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line">mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line">mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br></pre></td></tr></table></figure>

<p>初始化SysConfig对象, 主要调用了SysConfig的构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SystemConfig() &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    解析</span></span><br><span class="line"><span class="comment">    /system/etc/</span></span><br><span class="line"><span class="comment">    /odm/etc/</span></span><br><span class="line"><span class="comment">    /oem/etc/</span></span><br><span class="line"><span class="comment">    sysconfig  permissions 下的xml文件</span></span><br><span class="line"><span class="comment">    权限 features 相关</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// Read configuration from system</span></span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getRootDirectory(), <span class="string">&quot;etc&quot;</span>, <span class="string">&quot;sysconfig&quot;</span>), ALLOW_ALL);</span><br><span class="line">    <span class="comment">// Read configuration from the old permissions dir</span></span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getRootDirectory(), <span class="string">&quot;etc&quot;</span>, <span class="string">&quot;permissions&quot;</span>), ALLOW_ALL);</span><br><span class="line">    <span class="comment">// Allow ODM to customize system configs around libs, features and apps</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">odmPermissionFlag</span> <span class="operator">=</span> ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS;</span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOdmDirectory(), <span class="string">&quot;etc&quot;</span>, <span class="string">&quot;sysconfig&quot;</span>), odmPermissionFlag);</span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOdmDirectory(), <span class="string">&quot;etc&quot;</span>, <span class="string">&quot;permissions&quot;</span>), odmPermissionFlag);</span><br><span class="line">    <span class="comment">// Only allow OEM to customize features</span></span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOemDirectory(), <span class="string">&quot;etc&quot;</span>, <span class="string">&quot;sysconfig&quot;</span>), ALLOW_FEATURES);</span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOemDirectory(), <span class="string">&quot;etc&quot;</span>, <span class="string">&quot;permissions&quot;</span>), ALLOW_FEATURES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但往往只存在一个目录 <strong>&#x2F;system&#x2F;etc&#x2F;permissions</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sp9832a_2h11:/system/etc/permissions <span class="comment"># ls -l</span></span><br><span class="line">total <span class="number">224</span></span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">820</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.bluetooth.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">830</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.bluetooth_le.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">931</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.camera.autofocus.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root <span class="number">1052</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.camera.flash<span class="literal">-autofocus</span>.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">877</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.camera.front.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">942</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.location.gps.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">824</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.sensor.accelerometer.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">816</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.sensor.light.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">815</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.sensor.proximity.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">881</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.telephony.gsm.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root <span class="number">1035</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.touchscreen.multitouch.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">909</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.touchscreen.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">975</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.usb.accessory.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">868</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.usb.host.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">843</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.wifi.direct.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">829</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.hardware.wifi.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root <span class="number">1050</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">11</span> android.software.live_wallpaper.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">860</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.software.managed_users.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">745</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.software.midi.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">748</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> android.software.webview.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">828</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">14</span> com.android.location.provider.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">828</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">14</span> com.android.media.remotedisplay.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root  <span class="number">820</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">14</span> com.android.mediadrm.signer.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root <span class="number">4188</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">16</span> handheld_core_hardware.xml</span><br><span class="line"><span class="literal">-rw-r--r--</span> <span class="number">1</span> root root <span class="number">8467</span> <span class="number">2017</span><span class="literal">-07-12</span> <span class="number">00</span>:<span class="number">14</span> platform.xml</span><br></pre></td></tr></table></figure>

<p>其中比较重要的文件是 **platform.xml **</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Copyright (C) 2008 The Android Open Source Project</span></span><br><span class="line"><span class="comment"> Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- The following tags are associating low-level group IDs with</span></span><br><span class="line"><span class="comment">     permission names.  By specifying such a mapping, you are saying</span></span><br><span class="line"><span class="comment">     that any application process granted the given permission will</span></span><br><span class="line"><span class="comment">     also be running with the given group ID attached to its process,</span></span><br><span class="line"><span class="comment">     so it can perform any filesystem (read, write, execute) operations</span></span><br><span class="line"><span class="comment">     allowed for that group. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;net_bt_admin&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;net_bt&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_MEDIA_STORAGE&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;media_rw&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;sdcard_rw&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_MTP&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;mtp&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.NET_ADMIN&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;net_admin&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- The group that /cache belongs to, linked to the permission</span></span><br><span class="line"><span class="comment">     set on the applications that can access /cache --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_CACHE_FILESYSTEM&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;cache&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- RW permissions to any system resources owned by group &#x27;diag&#x27;.</span></span><br><span class="line"><span class="comment">     This is for carrier and manufacture diagnostics tools that must be</span></span><br><span class="line"><span class="comment">     installable from the framework. Be careful. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.DIAGNOSTIC&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;input&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;diag&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Group that can read detailed network usage statistics --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.READ_NETWORK_USAGE_HISTORY&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;net_bw_stats&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Group that can modify how network statistics are accounted --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MODIFY_NETWORK_ACCOUNTING&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;net_bw_acct&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.LOOP_RADIO&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;loop_radio&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Hotword training apps sometimes need a GID to talk with low-level</span></span><br><span class="line"><span class="comment">     hardware; give them audio for now until full HAL support is added. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MANAGE_VOICE_KEYPHRASES&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;audio&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_FM_RADIO&quot;</span> &gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /dev/fm is gid media, not audio --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- These are permissions that were mapped to gids but we need</span></span><br><span class="line"><span class="comment">     to keep them here until an upgrade from L to the current</span></span><br><span class="line"><span class="comment">     version is to be supported. These permissions are built-in</span></span><br><span class="line"><span class="comment">     and in L were not stored in packages.xml as a result if they</span></span><br><span class="line"><span class="comment">     are not defined here while parsing packages.xml we would</span></span><br><span class="line"><span class="comment">     ignore these permissions being granted to apps and not</span></span><br><span class="line"><span class="comment">     propagate the granted state. From N we are storing the</span></span><br><span class="line"><span class="comment">     built-in permissions in packages.xml as the saved storage</span></span><br><span class="line"><span class="comment">     is negligible (one tag with the permission) compared to</span></span><br><span class="line"><span class="comment">     the fragility as one can remove a built-in permission which</span></span><br><span class="line"><span class="comment">     no longer needs to be mapped to gids and break grant propagation. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ================================================================== --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ================================================================== --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ================================================================== --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- The following tags are assigning high-level permissions to specific</span></span><br><span class="line"><span class="comment">     user IDs.  These are used to allow specific core system users to</span></span><br><span class="line"><span class="comment">     perform the given operations with the higher-level framework.  For</span></span><br><span class="line"><span class="comment">     example, we give a wide variety of permissions to the shell user</span></span><br><span class="line"><span class="comment">     since that is the user the adb shell runs under and developers and</span></span><br><span class="line"><span class="comment">     others should have a fairly open environment in which to</span></span><br><span class="line"><span class="comment">     interact with the system. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MODIFY_AUDIO_SETTINGS&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_SURFACE_FLINGER&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WAKE_LOCK&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.UPDATE_DEVICE_STATS&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.UPDATE_APP_OPS_STATS&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.GET_PROCESS_STATE_AND_OOM_SCORE&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;media&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.MODIFY_AUDIO_SETTINGS&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;cameraserver&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_SURFACE_FLINGER&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;cameraserver&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.WAKE_LOCK&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;cameraserver&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.UPDATE_DEVICE_STATS&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;cameraserver&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.UPDATE_APP_OPS_STATS&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;cameraserver&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">&quot;android.permission.ACCESS_SURFACE_FLINGER&quot;</span> <span class="attr">uid</span>=<span class="string">&quot;graphics&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- This is a list of all the libraries available for application</span></span><br><span class="line"><span class="comment">     code to link against. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">&quot;android.test.runner&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">file</span>=<span class="string">&quot;/system/framework/android.test.runner.jar&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">&quot;javax.obex&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">file</span>=<span class="string">&quot;/system/framework/javax.obex.jar&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">&quot;org.apache.http.legacy&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">file</span>=<span class="string">&quot;/system/framework/org.apache.http.legacy.jar&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- These are the standard packages that are white-listed to always have internet</span></span><br><span class="line"><span class="comment">     access while in power save mode, even if they aren&#x27;t in the foreground. --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 白名单中的应用始终可以访问网络,即使是在省电模式下,且并不在前台也可以 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">allow-in-power-save</span> <span class="attr">package</span>=<span class="string">&quot;com.android.providers.downloads&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- These are the standard packages that are white-listed to always have internet</span></span><br><span class="line"><span class="comment">     access while in data mode, even if they aren&#x27;t in the foreground. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 白名单中的应用始终可以访问网络,即使是节省流量模式下，仍可访问网络,且并不在前台也可以 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">allow-in-data-usage-save</span> <span class="attr">package</span>=<span class="string">&quot;com.android.providers.downloads&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- These are the packages that are white-listed to be able to run as system user --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">system-user-whitelisted-app</span> <span class="attr">package</span>=<span class="string">&quot;com.android.settings&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- These are the packages that shouldn&#x27;t run as system user --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">system-user-blacklisted-app</span> <span class="attr">package</span>=<span class="string">&quot;com.android.wallpaper.livepicker&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>每一个XML文件必须要有一个顶级标签<code>&lt;permissions&gt;</code>，至于子标签，可以支持这么几种：</p>
<table>
<thead>
<tr>
<th>标签</th>
<th>作用</th>
<th>关联的数据结构</th>
</tr>
</thead>
<tbody><tr>
<td><span id="perm"></span>permission标签</td>
<td>指定permission所属的gid,通过gid实现native层的权限控制;可以指定一个权限与几个组id对应,当一个apk被授予这个权限时,它也同时属于这几个组,拥有这几个组id了</td>
<td>perm.gids</td>
</tr>
<tr>
<td>group标签</td>
<td>安装到系统中的apk都具有的组id</td>
<td>mGlobalGids</td>
</tr>
<tr>
<td>assign-permission</td>
<td>把一个权限赋予一个UID，当进程使用这个UID运行时，就具备了这个权限</td>
<td>mSystemPermissions</td>
</tr>
<tr>
<td><span id="lib"></span>                                     library</td>
<td>为系统添加一些扩展库用的。对应的.jar文件放在&#x2F;system&#x2F;framework&#x2F;目录下。</td>
<td>mSharedLibraries</td>
</tr>
<tr>
<td>feature</td>
<td>每添加一个硬件，都要增加对应的feature</td>
<td>mAvailableFeatures</td>
</tr>
<tr>
<td>unavailable-feature</td>
<td>保存不支持的feature</td>
<td>mUnavailableFeatures</td>
</tr>
<tr>
<td>allow-in-power-save</td>
<td>白名单中的应用始终可以访问网络,即使是在省电模式下,且并不在前台也可以</td>
<td>mAllowInPowerSave</td>
</tr>
<tr>
<td>allow-in-power-save-except-idle</td>
<td>保存省电模式下(非Idle)，可上网的应用</td>
<td>mAllowInPowerSaveExceptIdle</td>
</tr>
<tr>
<td>allow-in-data-usage-save</td>
<td>白名单中的应用始终可以访问网络,即使是节省流量模式下，仍可访问网络,且并不在前台也可以</td>
<td>mAllowInDataUsageSave</td>
</tr>
<tr>
<td>system-user-whitelisted-app</td>
<td>指定以system user权限运行的app</td>
<td>mSystemUserWhitelistedApps</td>
</tr>
<tr>
<td>system-user-blacklisted-app</td>
<td>指定在system user权限下，不应该运行的app</td>
<td>mSystemUserBlacklistedApp</td>
</tr>
<tr>
<td>default-enabled-vr-app</td>
<td>指定默认运行在VR模式下的components</td>
<td>mDefaultVrComponents</td>
</tr>
<tr>
<td>backup-transport-whitelisted-service</td>
<td>保存能够传输备份数据的服务</td>
<td>mBackupTransportWhitelist</td>
</tr>
</tbody></table>
<p>对这些XML文件的解析是由&#x2F;framework&#x2F;base&#x2F;services&#x2F;java&#x2F;com&#x2F;android&#x2F;server&#x2F;PackageManagerService.java中的**readPermissions()**负责的。解析时会先解析其它XML文件，最后解析platform.xml。</p>
<p>解析结果放入<code>mSystemPermissions</code>,<code>mSharedLibraries</code>,<code>mPermissions</code>,<code>mAvailableFeatures</code>等几个集合中供系统查询和权限配置使用。</p>
<p>像重力加速、多点触摸、WIFI等，只要系统支持，就要往**&#x2F;system&#x2F;etc&#x2F;permissions&#x2F;<strong>下面添加对应的XML配置文件。因为APK使用这些功能之前很有可能先调用</strong>PackageManager.hasSystemFeature**查询是否支持这个某个硬件模块。</p>
<p>&#x2F;framework&#x2F;base&#x2F;data&#x2F;etc&#x2F;<code>handheld_core_hardware.xml</code>里面包含了一些系统的核心硬件模块配置文件。&#x2F;framework&#x2F;base&#x2F;data&#x2F;etc&#x2F;Android.mk中会把这一块儿在编译时复制到&#x2F;system&#x2F;etc&#x2F;permissions&#x2F;目录下。这部分代码默认是关闭的，需要打开。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readPermissionsFromXml</span><span class="params">(File permFile, <span class="type">int</span> permissionFlag)</span> &#123;</span><br><span class="line">  <span class="type">FileReader</span> <span class="variable">permReader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//利用file构造fileReader</span></span><br><span class="line">    permReader = <span class="keyword">new</span> <span class="title class_">FileReader</span>(permFile);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">    .......</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//读取系统属性&quot;ro.config.low_ram&quot;，如果该属性为true，不会加载指定notLowRam的feature属性</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">lowRam</span> <span class="operator">=</span> ActivityManager.isLowRamDeviceStatic();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">XmlPullParser</span> <span class="variable">parser</span> <span class="operator">=</span> Xml.newPullParser();</span><br><span class="line">    <span class="comment">//Xml解析器的输入为fileReader读取的内容</span></span><br><span class="line">    parser.setInput(permReader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//找到解析的起点</span></span><br><span class="line">    .........</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据传入的flag，决定当前目录下，从xml文件中解析内容的范围</span></span><br><span class="line">    <span class="comment">//对于system目录，allowAll</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">allowAll</span> <span class="operator">=</span> permissionFlag == ALLOW_ALL;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">allowLibs</span> <span class="operator">=</span> (permissionFlag &amp; ALLOW_LIBS) != <span class="number">0</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">allowFeatures</span> <span class="operator">=</span> (permissionFlag &amp; ALLOW_FEATURES) != <span class="number">0</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">allowPermissions</span> <span class="operator">=</span> (permissionFlag &amp; ALLOW_PERMISSIONS) != <span class="number">0</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">allowAppConfigs</span> <span class="operator">=</span> (permissionFlag &amp; ALLOW_APP_CONFIGS) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      XmlUtils.nextElement(parser);</span><br><span class="line">      <span class="keyword">if</span> (parser.getEventType() == XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> parser.getName();</span><br><span class="line">      <span class="comment">//解析group标签，前面介绍的xml文件中没有单独使用该标签的地方</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;group&quot;</span>.equals(name) &amp;&amp; allowAll) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">gidStr</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;gid&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (gidStr != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">//将Gid字符串转化成整形，保存到mGlobalGids中</span></span><br><span class="line">          <span class="type">int</span> <span class="variable">gid</span> <span class="operator">=</span> android.os.Process.getGidForName(gidStr);</span><br><span class="line">          mGlobalGids = appendInt(mGlobalGids, gid);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          .........</span><br><span class="line">        &#125;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;permission&quot;</span>.equals(name) &amp;&amp; allowPermissions) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">perm</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        .......</span><br><span class="line">          perm = perm.intern();</span><br><span class="line">        <span class="comment">//调用readPermission解析permission标签</span></span><br><span class="line">        readPermission(parser, perm);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;assign-permission&quot;</span>.equals(name) &amp;&amp; allowPermissions) &#123;</span><br><span class="line">        <span class="comment">//得到权限名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">perm</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        ........</span><br><span class="line">          <span class="comment">//得到uid字符串</span></span><br><span class="line">          <span class="type">String</span> <span class="variable">uidStr</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;uid&quot;</span>);</span><br><span class="line">        ......</span><br><span class="line">          <span class="comment">//将uid字符串转变为整形</span></span><br><span class="line">          <span class="type">int</span> <span class="variable">uid</span> <span class="operator">=</span> Process.getUidForName(uidStr);</span><br><span class="line">        .......</span><br><span class="line">          perm = perm.intern();</span><br><span class="line">        <span class="comment">//得到保存uid当前已有的所有权限的ArraySet</span></span><br><span class="line">        ArraySet&lt;string&gt; perms = mSystemPermissions.get(uid);</span><br><span class="line">        <span class="keyword">if</span> (perms == <span class="literal">null</span>) &#123;</span><br><span class="line">          perms = <span class="keyword">new</span> <span class="title class_">ArraySet</span>&lt;string&gt;();</span><br><span class="line">          mSystemPermissions.put(uid, perms);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将uid新增的权限，加入到它的ArraySet</span></span><br><span class="line">        perms.add(perm);</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;library&quot;</span>.equals(name) &amp;&amp; allowLibs) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lname</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">lfile</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;file&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (lname == <span class="literal">null</span>) &#123;</span><br><span class="line">          ......</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lfile == <span class="literal">null</span>) &#123;</span><br><span class="line">          .....</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//保存library标签对应的内容</span></span><br><span class="line">          mSharedLibraries.put(lname, lfile);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;feature&quot;</span>.equals(name) &amp;&amp; allowFeatures) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fname</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">fversion</span> <span class="operator">=</span> XmlUtils.readIntAttribute(parser, <span class="string">&quot;version&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!lowRam) &#123;</span><br><span class="line">          allowed = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//内存不足时，指定notLowRam的feature不再加载</span></span><br><span class="line">          <span class="type">String</span> <span class="variable">notLowRam</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;notLowRam&quot;</span>);</span><br><span class="line">          allowed = !<span class="string">&quot;true&quot;</span>.equals(notLowRam);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fname == <span class="literal">null</span>) &#123;</span><br><span class="line">          .....</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">          <span class="comment">//将feature构造成featureInfo，加入到mAvailableFeatures对象中</span></span><br><span class="line">          addFeature(fname, fversion);</span><br><span class="line">        &#125;</span><br><span class="line">        .......</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;unavailable-feature&quot;</span>.equals(name) &amp;&amp; allowFeatures) &#123;</span><br><span class="line">        <span class="comment">//mUnavailableFeatures保存不支持的feature</span></span><br><span class="line">        .........</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;allow-in-power-save-except-idle&quot;</span>.equals(name) &amp;&amp; allowAll) &#123;</span><br><span class="line">        <span class="comment">// These are the packages that are white-listed to be able to run in the</span></span><br><span class="line">        <span class="comment">// background while in power save mode (but not whitelisted from device idle modes),</span></span><br><span class="line">        <span class="comment">// as read from the configuration files.</span></span><br><span class="line">        <span class="comment">//mAllowInPowerSaveExceptIdle中保存省电模式下(非Idle)，可上网的应用</span></span><br><span class="line">        .........</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;allow-in-power-save&quot;</span>.equals(name) &amp;&amp; allowAll) &#123;</span><br><span class="line">        <span class="comment">// These are the packages that are white-listed to be able to run in the</span></span><br><span class="line">        <span class="comment">// background while in power save mode, as read from the configuration files.</span></span><br><span class="line">        <span class="comment">//mAllowInPowerSave与mAllowInPowerSaveExceptIdle类似，权限更高</span></span><br><span class="line">        <span class="comment">//这与Android M新特性Doze and App Standby模式有关</span></span><br><span class="line">        <span class="comment">//DeviceIdleController用于判断设备是否进入Idle状态，进入Idle状态时，mAllowInPowerSaveExceptIdle中的应用要被禁掉</span></span><br><span class="line">        <span class="comment">//但mAllowInPowerSave中的应用仍可运行</span></span><br><span class="line">        ............</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;allow-in-data-usage-save&quot;</span>.equals(name) &amp;&amp; allowAll) &#123;</span><br><span class="line">        <span class="comment">// These are the packages that are white-listed to be able to run in the</span></span><br><span class="line">        <span class="comment">// background while in data-usage save mode, as read from the configuration files.</span></span><br><span class="line">        <span class="comment">//mAllowInDataUsageSave保存此标签对应的packageName</span></span><br><span class="line">        <span class="comment">//貌似android 7新增了一个节省数据流量的能力，有此标签的应用在节省数据流量时，仍可访问网络</span></span><br><span class="line">        ............</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;app-link&quot;</span>.equals(name) &amp;&amp; allowAppConfigs) &#123;</span><br><span class="line">        <span class="comment">// These are the package names of apps which should be in the &#x27;always&#x27;</span></span><br><span class="line">        <span class="comment">// URL-handling state upon factory reset.</span></span><br><span class="line">        <span class="comment">//mLinkedApps保存此标签对应的packageName</span></span><br><span class="line">        <span class="comment">//这个不太明白，好像是指定可以一直处于URL-handling state的app</span></span><br><span class="line">        .......</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;system-user-whitelisted-app&quot;</span>.equals(name) &amp;&amp; allowAppConfigs) &#123;</span><br><span class="line">        <span class="comment">// These are the packages that are whitelisted to be able to run as system user</span></span><br><span class="line">        <span class="comment">//mSystemUserWhitelistedApps保存此标签对应的packageName</span></span><br><span class="line">        <span class="comment">//指定以system user权限运行的app</span></span><br><span class="line">        .......</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;system-user-blacklisted-app&quot;</span>.equals(name) &amp;&amp; allowAppConfigs) &#123;</span><br><span class="line">        <span class="comment">// These are the packages that should not run under system user</span></span><br><span class="line">        <span class="comment">//mSystemUserBlacklistedApp保存此标签对应的packageName</span></span><br><span class="line">        <span class="comment">//指定在system user权限下，不应该运行的app</span></span><br><span class="line">        .........</span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;default-enabled-vr-app&quot;</span>.equals(name) &amp;&amp; allowAppConfigs) &#123;</span><br><span class="line">        <span class="comment">// These are the components that are enabled by default as VR mode listener services.</span></span><br><span class="line">        <span class="comment">//mDefaultVrComponents保存此标签对应的packageName</span></span><br><span class="line">        <span class="comment">//指定默认运行在VR模式下的components</span></span><br><span class="line">        .......</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;backup-transport-whitelisted-service&quot;</span>.equals(name) &amp;&amp; allowFeatures) &#123;</span><br><span class="line">        <span class="comment">// These are the permitted backup transport service components</span></span><br><span class="line">        <span class="comment">//mBackupTransportWhitelist保存此标签对应的packageName</span></span><br><span class="line">        <span class="comment">//保存能够传输备份数据的服务</span></span><br><span class="line">        ........</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        .......</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;PullParserException e) &#123;</span><br><span class="line">    .......</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    .......</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    IoUtils.closeQuietly(permReader);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Some devices can be field-converted to FBE, so offer to splice in</span></span><br><span class="line">  <span class="comment">// those features if not already defined by the static config</span></span><br><span class="line">  <span class="comment">//加密相关的feature</span></span><br><span class="line">  <span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOnly()) &#123;</span><br><span class="line">    addFeature(PackageManager.FEATURE_FILE_BASED_ENCRYPTION, <span class="number">0</span>);</span><br><span class="line">    addFeature(PackageManager.FEATURE_SECURELY_REMOVES_USERS, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (String featureName : mUnavailableFeatures) &#123;</span><br><span class="line">    <span class="comment">//从mAvailableFeatures移除不支持的feature</span></span><br><span class="line">    removeFeature(featureName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看出<code>readPermissions</code>函数就是将xml文件中的标签转换成对应的数据结构，此处重要的是理解各种标签的作用。<br>对于<strong>”permission”</strong>标签，还调用了<code>readPermission</code>函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">readPermission</span><span class="params">(XmlPullParser parser, String name)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, XmlPullParserException &#123;</span><br><span class="line">    <span class="keyword">if</span> (mPermissions.containsKey(name)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Duplicate permission definition for &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">perUser</span> <span class="operator">=</span> XmlUtils.readBooleanAttribute(parser, <span class="string">&quot;perUser&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">PermissionEntry</span> <span class="variable">perm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PermissionEntry</span>(name, perUser);</span><br><span class="line">    <span class="comment">//将permission name和permissionEntry结合起来</span></span><br><span class="line">    mPermissions.put(name, perm);</span><br><span class="line">    ........</span><br><span class="line">    <span class="keyword">while</span>(.....) &#123;</span><br><span class="line">        .......</span><br><span class="line">        <span class="type">String</span> <span class="variable">tagName</span> <span class="operator">=</span> parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;group&quot;</span>.equals(tagName)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">gidStr</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, <span class="string">&quot;gid&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (gidStr != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">gid</span> <span class="operator">=</span> Process.getGidForName(gidStr);</span><br><span class="line">                <span class="comment">//对应gid存入permissionEntry结构体中，于是permission name与gid对应起来</span></span><br><span class="line">                perm.gids = appendInt(perm.gids, gid);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        .......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../images/20160929092228476.jpg" alt="20160929092228476"></p>
<h3 id="1-1-5-初始化PackageHandler"><a href="#1-1-5-初始化PackageHandler" class="headerlink" title="1.1.5. 初始化PackageHandler"></a>1.1.5. 初始化PackageHandler</h3><p><strong>PackageHandler</strong>是PackageManagerService的内部类，它是Handler的子类。PackageManagerService启动时开启了Looper线程HandlerThread，使用HandlerThread的Looper对象与PackageHandler建立联系，负责轮询和分发处理消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新建一个Thread,用来和PackageHandler绑定</span></span><br><span class="line">mHandlerThread = <span class="keyword">new</span> <span class="title class_">ServiceThread</span>(TAG,</span><br><span class="line">        Process.THREAD_PRIORITY_BACKGROUND, <span class="literal">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">mHandlerThread.start();</span><br><span class="line">mHandler = <span class="keyword">new</span> <span class="title class_">PackageHandler</span>(mHandlerThread.getLooper());</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过PackageHandler处理的消息</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">INIT_COPY</span><br><span class="line">MCS_BOUND</span><br><span class="line">MCS_RECONNECT</span><br><span class="line">MCS_UNBIND</span><br><span class="line">MCS_GIVE_UP</span><br><span class="line">SEND_PENDING_BROADCAST</span><br><span class="line">START_CLEANING_PACKAGE</span><br><span class="line">POST_INSTALL</span><br><span class="line">UPDATED_MEDIA_STATUS</span><br><span class="line">WRITE_SETTINGS</span><br><span class="line">WRITE_PACKAGE_RESTRICTIONS</span><br><span class="line">WRITE_PACKAGE_LIST</span><br><span class="line">CHECK_PENDING_VERIFICATION</span><br><span class="line">PACKAGE_VERIFIED</span><br><span class="line">START_INTENT_FILTER_VERIFICATIONS</span><br><span class="line">INTENT_FILTER_VERIFIED</span><br></pre></td></tr></table></figure>
<p>PackageHandler主要负责处理APK的复制和更名等相关的消息，但具体的处理则通过<strong>connectToService</strong>方法连接到<strong>DefaulyContainerService</strong>.apk，由它提供的<strong>MCS</strong>服务完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">private</span> <span class="type">DefaultContainerConnection</span> <span class="variable">mDefContainerConn</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DefaultContainerConnection</span>();</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DefaultContainerConnection</span> <span class="keyword">implements</span> <span class="title class_">ServiceConnection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">&quot;onServiceConnected&quot;</span>);</span><br><span class="line">        <span class="type">IMediaContainerService</span> <span class="variable">imcs</span> <span class="operator">=</span></span><br><span class="line">            IMediaContainerService.Stub.asInterface(service);</span><br><span class="line">        mHandler.sendMessage(mHandler.obtainMessage(MCS_BOUND, imcs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">&quot;onServiceDisconnected&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">connectToService</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">&quot;Trying to bind to&quot;</span> +</span><br><span class="line">                              <span class="string">&quot; DefaultContainerService&quot;</span>);</span><br><span class="line">  <span class="type">Intent</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>().setComponent(DEFAULT_CONTAINER_COMPONENT);</span><br><span class="line">  Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">  <span class="comment">// bind DefaultContainerService</span></span><br><span class="line">  <span class="keyword">if</span> (mContext.bindServiceAsUser(service, mDefContainerConn,</span><br><span class="line">                                 Context.BIND_AUTO_CREATE, UserHandle.SYSTEM)) &#123;</span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">    mBound = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/DefContainerSercice.png" alt="DefContainerSercice"></p>
<h3 id="1-1-6-初始化UserManagerService-并创建用户目录"><a href="#1-1-6-初始化UserManagerService-并创建用户目录" class="headerlink" title="1.1.6. 初始化UserManagerService, 并创建用户目录"></a>1.1.6. 初始化UserManagerService, 并创建用户目录</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">dataDir</span> <span class="operator">=</span> Environment.getDataDirectory();</span><br><span class="line">mAppInstallDir = <span class="keyword">new</span> <span class="title class_">File</span>(dataDir, <span class="string">&quot;app&quot;</span>);</span><br><span class="line">mAppLib32InstallDir = <span class="keyword">new</span> <span class="title class_">File</span>(dataDir, <span class="string">&quot;app-lib&quot;</span>);</span><br><span class="line">mEphemeralInstallDir = <span class="keyword">new</span> <span class="title class_">File</span>(dataDir, <span class="string">&quot;app-ephemeral&quot;</span>);</span><br><span class="line">mAsecInternalPath = <span class="keyword">new</span> <span class="title class_">File</span>(dataDir, <span class="string">&quot;app-asec&quot;</span>).getPath();</span><br><span class="line">mDrmAppPrivateInstallDir = <span class="keyword">new</span> <span class="title class_">File</span>(dataDir, <span class="string">&quot;app-private&quot;</span>);</span><br><span class="line">sUserManager = <span class="keyword">new</span> <span class="title class_">UserManagerServiceEx</span>(context, <span class="built_in">this</span>, mPackages);</span><br></pre></td></tr></table></figure>

<p>Ø mAppDataDir：初始化为&#x2F;data&#x2F;data</p>
<p>Ø mAppInstallDir：初始化为&#x2F;data&#x2F;app</p>
<p>Ø mAppLibInstallDir：初始化为&#x2F;data&#x2F;app-lib</p>
<p>Ø mAsecInternalPath：初始化为&#x2F;data&#x2F;app-asec的路径信息</p>
<p>Ø mDrmAppPrivateInstallDir：初始化为&#x2F;data&#x2F;app-private</p>
<p>Ø mUserAppDataDir：初始化为&#x2F;data&#x2F;user</p>
<p>Ø mDeletedRecord：初始化为&#x2F;data&#x2F;app&#x2F;.delrecord</p>
<h4 id="1-1-6-1-UserManagerService初始化"><a href="#1-1-6-1-UserManagerService初始化" class="headerlink" title="1.1.6.1. UserManagerService初始化"></a>1.1.6.1. UserManagerService初始化</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">UserManagerService</span><span class="params">(Context context, PackageManagerService pm,</span></span><br><span class="line"><span class="params">        Object packagesLock, File dataDir)</span> &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mPm = pm;</span><br><span class="line">    mPackagesLock = packagesLock;</span><br><span class="line">    mHandler = <span class="keyword">new</span> <span class="title class_">MainHandler</span>();</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackagesLock) &#123;</span><br><span class="line">        <span class="comment">// 创建/data/system/users</span></span><br><span class="line">        mUsersDir = <span class="keyword">new</span> <span class="title class_">File</span>(dataDir, USER_INFO_DIR);</span><br><span class="line">        mUsersDir.mkdirs();</span><br><span class="line">        <span class="comment">// Make zeroth user directory, for services to migrate their files to that location</span></span><br><span class="line">        <span class="comment">// 创建/data/system/users/0</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">userZeroDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(mUsersDir, String.valueOf(UserHandle.USER_SYSTEM));</span><br><span class="line">        userZeroDir.mkdirs();</span><br><span class="line">        FileUtils.setPermissions(mUsersDir.toString(),</span><br><span class="line">                FileUtils.S_IRWXU | FileUtils.S_IRWXG | FileUtils.S_IROTH | FileUtils.S_IXOTH,</span><br><span class="line">                -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// /data/system/users/userlist.xml</span></span><br><span class="line">        mUserListFile = <span class="keyword">new</span> <span class="title class_">File</span>(mUsersDir, USER_LIST_FILENAME);</span><br><span class="line">        initDefaultGuestRestrictions();</span><br><span class="line">        <span class="comment">// 该函数比较重要,解析userlist.xml和&lt;id&gt;.xml文件；并清理不完整用户</span></span><br><span class="line">        readUserListLP();</span><br><span class="line">        sInstance = <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mLocalService = <span class="keyword">new</span> <span class="title class_">LocalService</span>();</span><br><span class="line">    LocalServices.addService(UserManagerInternal.class, mLocalService);</span><br><span class="line">    <span class="comment">// 锁屏相关服务初始化</span></span><br><span class="line">    mLockPatternUtils = <span class="keyword">new</span> <span class="title class_">LockPatternUtils</span>(mContext);</span><br><span class="line">    <span class="comment">// 机主用户初始状态为STATE_BOOTING</span></span><br><span class="line">    mUserStates.put(UserHandle.USER_SYSTEM, UserState.STATE_BOOTING);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过readUserListLP函数创建或解析 &#x2F;data&#x2F;system&#x2F;users&#x2F;0.xml 和 userlist.xml</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp9832a_2h11:/<span class="keyword">data</span>/system/users <span class="comment"># cat userlist.xml                    </span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">users</span> <span class="attr">nextSerialNumber</span>=<span class="string">&quot;10&quot;</span> <span class="attr">version</span>=<span class="string">&quot;6&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">guestRestrictions</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--访客限制--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">restrictions</span> <span class="attr">no_sms</span>=<span class="string">&quot;true&quot;</span> <span class="attr">no_install_unknown_sources</span>=<span class="string">&quot;true&quot;</span> <span class="attr">no_config_wifi</span>=<span class="string">&quot;true&quot;</span> <span class="attr">no_outgoing_calls</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">guestRestrictions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">globalRestrictionOwnerUserId</span> <span class="attr">id</span>=<span class="string">&quot;-10000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span> <span class="attr">id</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp9832a_2h11:/<span class="keyword">data</span>/system/users <span class="comment"># cat 0.xml</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">id</span>=<span class="string">&quot;0&quot;</span> <span class="attr">serialNumber</span>=<span class="string">&quot;0&quot;</span> <span class="attr">flags</span>=<span class="string">&quot;19&quot;</span> <span class="attr">created</span>=<span class="string">&quot;0&quot;</span> <span class="attr">lastLoggedIn</span>=<span class="string">&quot;1325377476475&quot;</span> <span class="attr">lastLoggedInFingerprint</span>=<span class="string">&quot;SPRD/sp9832a_2h11_4mvoltesea_tee/sp9832a_2h11:7.0/NRD90M/W17.28.3N00:userdebug/test-keys&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">restrictions</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">device_policy_restrictions</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readUserListLP</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 如果/data/system/users/userlist.xml  文件不存在, 调用fallbackToSingleUserLP函数创建单用户</span></span><br><span class="line">    <span class="keyword">if</span> (!mUserListFile.exists()) &#123;</span><br><span class="line">        fallbackToSingleUserLP();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">AtomicFile</span> <span class="variable">userListFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicFile</span>(mUserListFile);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fis = userListFile.openRead();</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// xml 文件损坏, 也回滚调用fallbackToSingleUserLP函数创建单用户</span></span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            Slog.e(LOG_TAG, <span class="string">&quot;Unable to read user list&quot;</span>);</span><br><span class="line">            fallbackToSingleUserLP();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mNextSerialNumber = -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// users标签</span></span><br><span class="line">        <span class="keyword">if</span> (parser.getName().equals(TAG_USERS)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">lastSerialNumber</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_NEXT_SERIAL_NO);</span><br><span class="line">            <span class="keyword">if</span> (lastSerialNumber != <span class="literal">null</span>) &#123;</span><br><span class="line">                mNextSerialNumber = Integer.parseInt(lastSerialNumber);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">versionNumber</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_USER_VERSION);</span><br><span class="line">            <span class="keyword">if</span> (versionNumber != <span class="literal">null</span>) &#123;</span><br><span class="line">                mUserVersion = Integer.parseInt(versionNumber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">newDevicePolicyGlobalUserRestrictions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.START_TAG) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> parser.getName();</span><br><span class="line">                <span class="comment">// user标签</span></span><br><span class="line">                <span class="keyword">if</span> (name.equals(TAG_USER)) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_ID);</span><br><span class="line">					<span class="comment">// 根据其user id值,嵌套读取对应的/data/system/users/&lt;id&gt;.xml文件,返回UserData对象</span></span><br><span class="line">                    <span class="type">UserData</span> <span class="variable">userData</span> <span class="operator">=</span> readUserLP(Integer.parseInt(id));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (userData != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span> (mUsersLock) &#123;</span><br><span class="line">                           <span class="comment">// 将UserData对象放入mUsers SparseArray中</span></span><br><span class="line">                            mUsers.put(userData.info.id, userData);</span><br><span class="line">                            <span class="keyword">if</span> (mNextSerialNumber &lt; <span class="number">0</span></span><br><span class="line">                                    || mNextSerialNumber &lt;= userData.info.id) &#123;</span><br><span class="line">                                mNextSerialNumber = userData.info.id + <span class="number">1</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(TAG_GUEST_RESTRICTIONS)) &#123;</span><br><span class="line">                    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                            &amp;&amp; type != XmlPullParser.END_TAG) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (type == XmlPullParser.START_TAG) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (parser.getName().equals(TAG_RESTRICTIONS)) &#123;</span><br><span class="line">                                <span class="keyword">synchronized</span> (mGuestRestrictions) &#123;</span><br><span class="line">                                    <span class="comment">// 访客限制</span></span><br><span class="line">                                    UserRestrictionsUtils</span><br><span class="line">                                            .readRestrictions(parser, mGuestRestrictions);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(TAG_DEVICE_POLICY_RESTRICTIONS)</span><br><span class="line">                                    ) &#123;</span><br><span class="line">                                UserRestrictionsUtils.readRestrictions(parser,</span><br><span class="line">                                        newDevicePolicyGlobalUserRestrictions);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(TAG_GLOBAL_RESTRICTION_OWNER_ID)) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">ownerUserId</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_ID);</span><br><span class="line">                    <span class="keyword">if</span> (ownerUserId != <span class="literal">null</span>) &#123;</span><br><span class="line">                        mGlobalRestrictionOwnerUserId = Integer.parseInt(ownerUserId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (mRestrictionsLock) &#123;</span><br><span class="line">            mDevicePolicyGlobalUserRestrictions = newDevicePolicyGlobalUserRestrictions;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据UserData.info.partial信息确定用户信息是否完整, 只有完整的才放入mUserIds的数组中</span></span><br><span class="line">        updateUserIds();</span><br><span class="line">        upgradeIfNecessaryLP();</span><br><span class="line">        <span class="comment">//SPRD: add protection mechanism for power-test @&#123;</span></span><br><span class="line">        <span class="comment">// 机主用户找不到, 回滚创建单用户</span></span><br><span class="line">        <span class="keyword">if</span>(mUsers.get(UserHandle.USER_SYSTEM) == <span class="literal">null</span>)&#123;</span><br><span class="line">            fallbackToSingleUserLP();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// @&#125;</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException | XmlPullParserException e) &#123;</span><br><span class="line">        fallbackToSingleUserLP();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(fis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在解析过程中用到了UserData  UserInfo info类，它用于保存用户信息，包含用户id、用户名name以及用户类型标记三部分，其中用户类型分为私有用户、管理员用户和guest用户。</p>
<blockquote>
<p>  通过readUserLP函数从id.xml文件中创建出UserData数据</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> UserData <span class="title function_">readUserLP</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">serialNumber</span> <span class="operator">=</span> id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">account</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">iconPath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">creationTime</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">lastLoggedInTime</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lastLoggedInFingerprint</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">profileGroupId</span> <span class="operator">=</span> UserInfo.NO_PROFILE_GROUP_ID;</span><br><span class="line">    <span class="type">int</span> <span class="variable">restrictedProfileParentId</span> <span class="operator">=</span> UserInfo.NO_PROFILE_GROUP_ID;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">partial</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">guestToRemove</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">persistSeedData</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">seedAccountName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">seedAccountType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">PersistableBundle</span> <span class="variable">seedAccountOptions</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Bundle</span> <span class="variable">baseRestrictions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">    <span class="type">Bundle</span> <span class="variable">localRestrictions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// /data/system/users/&lt;id&gt;.xml文件</span></span><br><span class="line">        <span class="type">AtomicFile</span> <span class="variable">userFile</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AtomicFile</span>(<span class="keyword">new</span> <span class="title class_">File</span>(mUsersDir, Integer.toString(id) + XML_SUFFIX));</span><br><span class="line">        fis = userFile.openRead();</span><br><span class="line">        <span class="type">XmlPullParser</span> <span class="variable">parser</span> <span class="operator">=</span> Xml.newPullParser();</span><br><span class="line">        parser.setInput(fis, StandardCharsets.UTF_8.name());</span><br><span class="line">        <span class="type">int</span> type;</span><br><span class="line">...</span><br><span class="line">        <span class="comment">// user id标签</span></span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.START_TAG &amp;&amp; parser.getName().equals(TAG_USER)) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">storedId</span> <span class="operator">=</span> readIntAttribute(parser, ATTR_ID, -<span class="number">1</span>);</span><br><span class="line">            <span class="comment">// id 与传入的id不对应,直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (storedId != id) &#123;</span><br><span class="line">                Slog.e(LOG_TAG, <span class="string">&quot;User id does not match the file name&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            serialNumber = readIntAttribute(parser, ATTR_SERIAL_NO, id);</span><br><span class="line">            flags = readIntAttribute(parser, ATTR_FLAGS, <span class="number">0</span>);</span><br><span class="line">            iconPath = parser.getAttributeValue(<span class="literal">null</span>, ATTR_ICON_PATH);</span><br><span class="line">            creationTime = readLongAttribute(parser, ATTR_CREATION_TIME, <span class="number">0</span>);</span><br><span class="line">            lastLoggedInTime = readLongAttribute(parser, ATTR_LAST_LOGGED_IN_TIME, <span class="number">0</span>);</span><br><span class="line">            lastLoggedInFingerprint = parser.getAttributeValue(<span class="literal">null</span>,</span><br><span class="line">                    ATTR_LAST_LOGGED_IN_FINGERPRINT);</span><br><span class="line">            profileGroupId = readIntAttribute(parser, ATTR_PROFILE_GROUP_ID,</span><br><span class="line">                    UserInfo.NO_PROFILE_GROUP_ID);</span><br><span class="line">            restrictedProfileParentId = readIntAttribute(parser,</span><br><span class="line">                    ATTR_RESTRICTED_PROFILE_PARENT_ID, UserInfo.NO_PROFILE_GROUP_ID);</span><br><span class="line">            <span class="type">String</span> <span class="variable">valueString</span> <span class="operator">=</span> parser.getAttributeValue(<span class="literal">null</span>, ATTR_PARTIAL);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(valueString)) &#123;</span><br><span class="line">                partial = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            valueString = parser.getAttributeValue(<span class="literal">null</span>, ATTR_GUEST_TO_REMOVE);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(valueString)) &#123;</span><br><span class="line">                guestToRemove = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            seedAccountName = parser.getAttributeValue(<span class="literal">null</span>, ATTR_SEED_ACCOUNT_NAME);</span><br><span class="line">            seedAccountType = parser.getAttributeValue(<span class="literal">null</span>, ATTR_SEED_ACCOUNT_TYPE);</span><br><span class="line">            <span class="keyword">if</span> (seedAccountName != <span class="literal">null</span> || seedAccountType != <span class="literal">null</span>) &#123;</span><br><span class="line">                persistSeedData = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">outerDepth</span> <span class="operator">=</span> parser.getDepth();</span><br><span class="line">            <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                   &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">tag</span> <span class="operator">=</span> parser.getName();</span><br><span class="line">                <span class="keyword">if</span> (TAG_NAME.equals(tag)) &#123;</span><br><span class="line">                    type = parser.next();</span><br><span class="line">                    <span class="keyword">if</span> (type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                        name = parser.getText();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_RESTRICTIONS.equals(tag)) &#123;</span><br><span class="line">                    UserRestrictionsUtils.readRestrictions(parser, baseRestrictions);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_DEVICE_POLICY_RESTRICTIONS.equals(tag)) &#123;</span><br><span class="line">                    UserRestrictionsUtils.readRestrictions(parser, localRestrictions);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_ACCOUNT.equals(tag)) &#123;</span><br><span class="line">                    type = parser.next();</span><br><span class="line">                    <span class="keyword">if</span> (type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                        account = parser.getText();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_SEED_ACCOUNT_OPTIONS.equals(tag)) &#123;</span><br><span class="line">                    seedAccountOptions = PersistableBundle.restoreFromXml(parser);</span><br><span class="line">                    persistSeedData = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the UserInfo object that gets passed around</span></span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfo</span>(id, name, iconPath, flags);</span><br><span class="line">        userInfo.serialNumber = serialNumber;</span><br><span class="line">        userInfo.creationTime = creationTime;</span><br><span class="line">        userInfo.lastLoggedInTime = lastLoggedInTime;</span><br><span class="line">        userInfo.lastLoggedInFingerprint = lastLoggedInFingerprint;</span><br><span class="line">        userInfo.partial = partial;</span><br><span class="line">        userInfo.guestToRemove = guestToRemove;</span><br><span class="line">        userInfo.profileGroupId = profileGroupId;</span><br><span class="line">        userInfo.restrictedProfileParentId = restrictedProfileParentId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create the UserData object that&#x27;s internal to this class</span></span><br><span class="line">        <span class="type">UserData</span> <span class="variable">userData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserData</span>();</span><br><span class="line">        userData.info = userInfo;</span><br><span class="line">        userData.account = account;</span><br><span class="line">        userData.seedAccountName = seedAccountName;</span><br><span class="line">        userData.seedAccountType = seedAccountType;</span><br><span class="line">        userData.persistSeedData = persistSeedData;</span><br><span class="line">        userData.seedAccountOptions = seedAccountOptions;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mRestrictionsLock) &#123;</span><br><span class="line">            mBaseUserRestrictions.put(id, baseRestrictions);</span><br><span class="line">            mDevicePolicyLocalUserRestrictions.put(id, localRestrictions);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userData;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException pe) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fis != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fis.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>  fallbackToSingleUserLP 函数初始化用户信息,并创建id.xml文件和userlist.xml文件</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fallbackToSingleUserLP</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> UserInfo.FLAG_INITIALIZED;</span><br><span class="line">    <span class="comment">// In split system user mode, the admin and primary flags are assigned to the first human</span></span><br><span class="line">    <span class="comment">// user.</span></span><br><span class="line">    <span class="keyword">if</span> (!UserManager.isSplitSystemUser()) &#123;</span><br><span class="line">        flags |= UserInfo.FLAG_ADMIN | UserInfo.FLAG_PRIMARY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Create the system user</span></span><br><span class="line">    <span class="type">UserInfo</span> <span class="variable">system</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfo</span>(UserHandle.USER_SYSTEM, <span class="literal">null</span>, <span class="literal">null</span>, flags);</span><br><span class="line">    <span class="type">UserData</span> <span class="variable">userData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserData</span>();</span><br><span class="line">    userData.info = system;</span><br><span class="line">    <span class="comment">// 将创建的机主用户加入到mUsers中</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mUsersLock) &#123;</span><br><span class="line">        mUsers.put(system.id, userData);</span><br><span class="line">    &#125;</span><br><span class="line">    mNextSerialNumber = MIN_USER_ID;</span><br><span class="line">    mUserVersion = USER_VERSION;</span><br><span class="line"></span><br><span class="line">    <span class="type">Bundle</span> <span class="variable">restrictions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">    <span class="keyword">synchronized</span> (mRestrictionsLock) &#123;</span><br><span class="line">        mBaseUserRestrictions.append(UserHandle.USER_SYSTEM, restrictions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    updateUserIds();</span><br><span class="line">    initDefaultGuestRestrictions();</span><br><span class="line">    <span class="comment">// 创建 /data/system/users/0.xml</span></span><br><span class="line">    writeUserLP(userData);</span><br><span class="line">    <span class="comment">// 创建 /data/system/users/userlist.xml文件</span></span><br><span class="line">    writeUserListLP();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-1-6-2-清理部分创建-删除的用户"><a href="#1-1-6-2-清理部分创建-删除的用户" class="headerlink" title="1.1.6.2. 清理部分创建&#x2F;删除的用户"></a>1.1.6.2. <strong>清理部分创建&#x2F;删除的用户</strong></h4><p>根据UserInfo.<strong>partial</strong>属性的值，将不完整的用户信息放入UserManagerService.partials成员变量中，然后调用<strong>cleanupPartialUsers</strong>方法执行清理动作。</p>
<p>onBootPhase阶段清理不完整的用户信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">cleanupPartialUsers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Prune out any partially created, partially removed and ephemeral users.</span></span><br><span class="line">    ArrayList&lt;UserInfo&gt; partials = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">synchronized</span> (mUsersLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">userSize</span> <span class="operator">=</span> mUsers.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; userSize; i++) &#123;</span><br><span class="line">            <span class="type">UserInfo</span> <span class="variable">ui</span> <span class="operator">=</span> mUsers.valueAt(i).info;</span><br><span class="line">            <span class="keyword">if</span> ((ui.partial || ui.guestToRemove || ui.isEphemeral()) &amp;&amp; i != <span class="number">0</span>) &#123;</span><br><span class="line">                partials.add(ui);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">partialsSize</span> <span class="operator">=</span> partials.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; partialsSize; i++) &#123;</span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">ui</span> <span class="operator">=</span> partials.get(i);</span><br><span class="line">        Slog.w(LOG_TAG, <span class="string">&quot;Removing partially created user &quot;</span> + ui.id</span><br><span class="line">                + <span class="string">&quot; (name=&quot;</span> + ui.name + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        <span class="comment">// 调用removeUserState清除不完整的用户信息</span></span><br><span class="line">        removeUserState(ui.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接看removeUserState函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">removeUserState</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> userHandle)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 加密相关. 清除用户的锁屏密码</span></span><br><span class="line">        mContext.getSystemService(StorageManager.class).destroyUserKey(userHandle);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">        <span class="comment">// This may be simply because the user was partially created.</span></span><br><span class="line">        Slog.i(LOG_TAG,</span><br><span class="line">            <span class="string">&quot;Destroying key for user &quot;</span> + userHandle + <span class="string">&quot; failed, continuing anyway&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cleanup gatekeeper secure user id</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">IGateKeeperService</span> <span class="variable">gk</span> <span class="operator">=</span> GateKeeper.getService();</span><br><span class="line">        <span class="keyword">if</span> (gk != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// gatekeeper中清除该用户的信息</span></span><br><span class="line">            gk.clearSecureUserId(userHandle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        Slog.w(LOG_TAG, <span class="string">&quot;unable to clear GK secure user id&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cleanup package manager settings</span></span><br><span class="line">    <span class="comment">// 清除用户相关的信息.包括该用户下安装的apk信息, 申请的权限信息, 更新packages.xml文件, 与用户相关的packages的文件如</span></span><br><span class="line">    <span class="comment">// /data/system/users/&lt;id&gt;/package-restrictions.xml   mPendingBroadcasts中去除等等</span></span><br><span class="line">    mPm.cleanUpUser(<span class="built_in">this</span>, userHandle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up all data before removing metadata</span></span><br><span class="line">    <span class="comment">// 清除用户的数据目录 /data/user_de/&lt;id&gt;   /data/user/&lt;id&gt;</span></span><br><span class="line">    mPm.destroyUserData(userHandle,</span><br><span class="line">            StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove this user from the list</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mUsersLock) &#123;</span><br><span class="line">        mUsers.remove(userHandle);</span><br><span class="line">        mIsUserManaged.delete(userHandle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mUserStates) &#123;</span><br><span class="line">        mUserStates.delete(userHandle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mRestrictionsLock) &#123;</span><br><span class="line">        mBaseUserRestrictions.remove(userHandle);</span><br><span class="line">        mAppliedUserRestrictions.remove(userHandle);</span><br><span class="line">        mCachedEffectiveUserRestrictions.remove(userHandle);</span><br><span class="line">        mDevicePolicyLocalUserRestrictions.remove(userHandle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update the user list</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackagesLock) &#123;</span><br><span class="line">        <span class="comment">// 更新 /data/system/users/userlist.xml文件</span></span><br><span class="line">        writeUserListLP();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Remove user file</span></span><br><span class="line">    <span class="type">AtomicFile</span> <span class="variable">userFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicFile</span>(<span class="keyword">new</span> <span class="title class_">File</span>(mUsersDir, userHandle + XML_SUFFIX));</span><br><span class="line">    <span class="comment">// 最后删除 /data/system/users/&lt;id&gt;.xml</span></span><br><span class="line">    userFile.delete();</span><br><span class="line">    <span class="comment">// 更新mUserIds 数组</span></span><br><span class="line">    updateUserIds();</span><br><span class="line">    Slog.i(LOG_TAG, <span class="string">&quot;removeUserState finished! &quot;</span> + userHandle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-7-同步SysConfig中的-Permission到Setting-mPermissions中"><a href="#1-1-7-同步SysConfig中的-Permission到Setting-mPermissions中" class="headerlink" title="1.1.7. 同步SysConfig中的 Permission到Setting.mPermissions中"></a>1.1.7. 同步SysConfig中的 <a href="#perm">Permission</a>到Setting.mPermissions中</h3><p><a href="#perm">Permission</a>转化SystemConfig.PermissionEntry-&gt;<strong>BasePermission</strong></p>
<blockquote>
<p>  注意转化到BasePermission的包名为<em>andriod</em>，且对应的权限type 为  <em>PROTECTION_SIGNATURE</em></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Propagate permission configuration in to package manager.</span></span><br><span class="line"><span class="comment">// SystemConfig  解析的 Permission 放进 mSettings.mPermissions 中。</span></span><br><span class="line"><span class="comment">// 注意包名为andriod，且对应的权限type 为  PROTECTION_SIGNATURE</span></span><br><span class="line">ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</span><br><span class="line">        = systemConfig.getPermissions();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;permConfig.size(); i++) &#123;</span><br><span class="line">    SystemConfig.<span class="type">PermissionEntry</span> <span class="variable">perm</span> <span class="operator">=</span> permConfig.valueAt(i);</span><br><span class="line">    <span class="type">BasePermission</span> <span class="variable">bp</span> <span class="operator">=</span> mSettings.mPermissions.get(perm.name);</span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="literal">null</span>) &#123;</span><br><span class="line">        bp = <span class="keyword">new</span> <span class="title class_">BasePermission</span>(perm.name, <span class="string">&quot;android&quot;</span>, BasePermission.TYPE_BUILTIN);</span><br><span class="line">        mSettings.mPermissions.put(perm.name, bp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (perm.gids != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 填充global gid</span></span><br><span class="line">        bp.setGids(perm.gids, perm.perUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-8-获取共享库，将其加入到mSharedLibraries并加入到优化集合中"><a href="#1-1-8-获取共享库，将其加入到mSharedLibraries并加入到优化集合中" class="headerlink" title="1.1.8. 获取共享库，将其加入到mSharedLibraries并加入到优化集合中"></a>1.1.8. 获取共享库，将其加入到mSharedLibraries并加入到优化集合中</h3><span id="shareperm"/>

<p>将sysConfig.<a href="#lib">getSharedLibraries</a> 放入 mSharedLibraries中.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取共享库，将其加入到mSharedLibraries 加入到优化集合中。</span></span><br><span class="line">ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;libConfig.size(); i++) &#123;</span><br><span class="line">    mSharedLibraries.put(libConfig.keyAt(i),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SharedLibraryEntry</span>(libConfig.valueAt(i), <span class="literal">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-BOOT-PROGRESS-PMS-SYSTEM-SCAN-START-阶段"><a href="#1-2-BOOT-PROGRESS-PMS-SYSTEM-SCAN-START-阶段" class="headerlink" title="1.2. BOOT_PROGRESS_PMS_SYSTEM_SCAN_START 阶段"></a>1.2. BOOT_PROGRESS_PMS_SYSTEM_SCAN_START 阶段</h2><h3 id="1-2-1-dex优化判定"><a href="#1-2-1-dex优化判定" class="headerlink" title="1.2.1. dex优化判定"></a>1.2.1. dex优化判定</h3><blockquote>
<p>  zygote启动时,已经将 SYSTEMSERVERCLASSPATH 里的资源做过dex优化,此处不需要再次执行</p>
</blockquote>
<p>首先通过InstructionSets.getAllInstructionSets 获取 abi集,需要读取Build.SUPPORTED_ABIS属性.</p>
<blockquote>
<p>  Returns the runtime instruction set corresponding to a given ABI. Multiple<br>  compatible ABIs might map to the same instruction set. For example<br>  armeabi-v7a and armeabi might map to the instruction set arm.<br>  它描述了应用程序与OS之间的底层接口。ABI涉及了程序的各个方面，比如：目标文件格式、数据类型、数据对齐、函数调用约定以及函数如何传递参数、如何返回值、系统调用号、如何实现系统调用等。   </p>
</blockquote>
<p>遍历支持的abi集合后, 对<a href="#lib">mSharedLibraries</a> 进行dex优化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shared libraries do not have profiles so we perform a full</span></span><br><span class="line"><span class="comment">// AOT compilation (if needed).</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 没有做过dex优化，或者该文件变更了，需要重新做dex优化</span></span><br><span class="line"><span class="type">int</span> <span class="variable">dexoptNeeded</span> <span class="operator">=</span> DexFile.getDexOptNeeded(</span><br><span class="line">        lib, dexCodeInstructionSet,</span><br><span class="line">        getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">        <span class="literal">false</span> <span class="comment">/* newProfile */</span>);</span><br><span class="line"><span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">    mInstaller.dexopt(lib, Process.SYSTEM_UID, dexCodeInstructionSet,</span><br><span class="line">            dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>,</span><br><span class="line">            getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">            StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">            SKIP_SHARED_LIBRARY_CHECK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-2-pre-M版本apk升级权限install-runtime判断"><a href="#1-2-2-pre-M版本apk升级权限install-runtime判断" class="headerlink" title="1.2.2. pre-M版本apk升级权限install-&gt;runtime判断"></a>1.2.2. pre-M版本apk升级权限install-&gt;runtime判断</h3><p><a href="#sdkv">sdkVersion</a></p>
<p>其中VersionInfo中存放了</p>
<ul>
<li>sdkVersion</li>
<li>databaseVersion</li>
<li>fingerprint</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ATTR_SDK_VERSION</span> <span class="operator">=</span> <span class="string">&quot;sdkVersion&quot;</span>;</span><br><span class="line">readLPw()&#123;</span><br><span class="line"> ver.sdkVersion = XmlUtils.readIntAttribute(parser, ATTR_SDK_VERSION); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 升级前的版本信息是从Settings中读取的,读取VersionInfo</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">VersionInfo</span> <span class="variable">ver</span> <span class="operator">=</span> mSettings.getInternalVersion();</span><br><span class="line">mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);</span><br><span class="line"></span><br><span class="line"><span class="comment">// when upgrading from pre-M, promote system app permissions from install to runtime</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从Android5.1 及之前的版本 升级上来时，将 system app 的权限从install 变更为 runtime权限,</span></span><br><span class="line"><span class="comment">// 默认赋予runtime权限。</span></span><br><span class="line">mPromoteSystemApps =</span><br><span class="line">        mIsUpgrade &amp;&amp; ver.sdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// When upgrading from pre-N, we need to handle package extraction like first boot,</span></span><br><span class="line"><span class="comment">// as there is no profiling data available.</span></span><br><span class="line"></span><br><span class="line">mIsPreNUpgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N;</span><br><span class="line"></span><br><span class="line"><span class="comment">// save off the names of pre-existing system packages prior to scanning; we don&#x27;t</span></span><br><span class="line"><span class="comment">// want to automatically grant runtime permissions for new system apps</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存到 mExistingSystemPackages 中，用于install-&gt; runtime</span></span><br><span class="line"><span class="keyword">if</span> (mPromoteSystemApps) &#123;</span><br><span class="line">    Iterator&lt;PackageSetting&gt; pkgSettingIter = mSettings.mPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (pkgSettingIter.hasNext()) &#123;</span><br><span class="line">        <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> pkgSettingIter.next();</span><br><span class="line">        <span class="comment">// 此处为非用户安装的应用</span></span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">            mExistingSystemPackages.add(ps.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处涉及到权限授予的流程,先摘一小段:</p>
<p>当同时满足三个条件,会进行install-&gt;runtime权限的转换:</p>
<ul>
<li>从5.1及5.1之前升级上来的版本</li>
<li>非用户安装的应用</li>
<li>应用还在,没有被删除</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">grantPermissionsLPw</span><span class="params">(PackageParser.Package pkg, <span class="type">boolean</span> replace,</span></span><br><span class="line"><span class="params">        String packageOfInterest)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> bp.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE;</span><br><span class="line">        <span class="keyword">switch</span> (level) &#123;</span><br><span class="line">          ...</span><br><span class="line">           <span class="comment">// DANGEROUS权限</span></span><br><span class="line">           <span class="keyword">case</span> PermissionInfo.PROTECTION_DANGEROUS: &#123;</span><br><span class="line">           <span class="comment">// </span></span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (mPromoteSystemApps</span><br><span class="line">                    &amp;&amp; isSystemApp(ps)</span><br><span class="line">                    &amp;&amp; mExistingSystemPackages.contains(ps.name)) &#123;</span><br><span class="line">                        <span class="comment">// For legacy system apps, install becomes runtime.</span></span><br><span class="line">                        <span class="comment">// We cannot check hasInstallPermission() for system apps since those</span></span><br><span class="line">                        <span class="comment">// permissions were granted implicitly and not persisted pre-M.</span></span><br><span class="line">                        grant = GRANT_UPGRADE;</span><br><span class="line">                    &#125;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>

<h3 id="1-2-3-开始扫描apk"><a href="#1-2-3-开始扫描apk" class="headerlink" title="1.2.3. 开始扫描apk"></a>1.2.3. 开始扫描apk</h3><h4 id="1-2-3-1-先扫描这两个目录"><a href="#1-2-3-1-先扫描这两个目录" class="headerlink" title="1.2.3.1. 先扫描这两个目录"></a>1.2.3.1. 先扫描这两个目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/vendor/overlay</span><br><span class="line">/system/framework</span><br></pre></td></tr></table></figure>

<h4 id="1-2-3-2-再扫描这几个目录下面-system-app"><a href="#1-2-3-2-再扫描这几个目录下面-system-app" class="headerlink" title="1.2.3.2. 再扫描这几个目录下面(system app):"></a>1.2.3.2. 再扫描这几个目录下面(system app):</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/system/priv-app</span><br><span class="line">/system/app</span><br><span class="line">/vendor/app</span><br><span class="line">/oem/app</span><br></pre></td></tr></table></figure>

<p>具体的扫描流程可参考<a target="_blank" rel="noopener" href="https://cototem.github.io/2017/08/02/pkms2/">扫描apk的流程</a></p>
<h5 id="1-2-3-2-1-扫描system-app-后的处理"><a href="#1-2-3-2-1-扫描system-app-后的处理" class="headerlink" title="1.2.3.2.1. 扫描system app 后的处理"></a>1.2.3.2.1. 扫描system app 后的处理</h5><p>这几个目录下面的都是system app, 扫描完成后 , 在扫描到data app之前,需要对扫描后的结果做一下处理:</p>
<p>首先删除禁用的system app</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 现在mPackages中查找是否有该包</span></span><br><span class="line"><span class="keyword">final</span> PackageParser.<span class="type">Package</span> <span class="variable">scannedPkg</span> <span class="operator">=</span> mPackages.get(ps.name);</span><br><span class="line"><span class="keyword">if</span> (scannedPkg != <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// 遍历所有扫描到的apk（packages.xml文件中以及现在扫描到的都有），</span></span><br><span class="line">  <span class="comment">// 如果该apk FLAG_SYSTEM 生效，是 system app 且 在 disabled packages list 中时，去除该apk，不再进行解析。</span></span><br><span class="line">  <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">      logCriticalInfo(Log.WARN, <span class="string">&quot;Expecting better updated system app for &quot;</span></span><br><span class="line">              + ps.name + <span class="string">&quot;; removing system app.  Last known codePath=&quot;</span></span><br><span class="line">              + ps.codePathString + <span class="string">&quot;, installStatus=&quot;</span> + ps.installStatus</span><br><span class="line">              + <span class="string">&quot;, versionCode=&quot;</span> + ps.versionCode + <span class="string">&quot;; scanned versionCode=&quot;</span></span><br><span class="line">              + scannedPkg.mVersionCode);</span><br><span class="line">      removePackageLI(scannedPkg, <span class="literal">true</span>);</span><br><span class="line">      mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果未在mPackages中查找到,但在mSettings.mPackages中有, 但未在禁用列表中，需要将该项从mSettings.mPackages中删除</span></span><br><span class="line"><span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">  psit.remove();</span><br><span class="line">  logCriticalInfo(Log.WARN, <span class="string">&quot;System package &quot;</span> + ps.name</span><br><span class="line">                  + <span class="string">&quot; no longer exists; it&#x27;s data will be wiped&quot;</span>);</span><br><span class="line">  <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">  <span class="comment">// reconciliation step</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 如果未在mPackages中查找到,但在mSettings.mPackages中有,且在禁用列表中，且数据目录为空时，加到 possiblyDeletedUpdatedSystemApps中</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">PackageSetting</span> <span class="variable">disabledPs</span> <span class="operator">=</span> mSettings.getDisabledSystemPkgLPr(ps.name);</span><br><span class="line">  <span class="keyword">if</span> (disabledPs.codePath == <span class="literal">null</span> || !disabledPs.codePath.exists()) &#123;</span><br><span class="line">    possiblyDeletedUpdatedSystemApps.add(ps.name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="mExpectingBetter">
-   查找该Package是否在PackageManagerService.mPackages和mSettings.mPackages中.如果都在,且在禁用列表中,则直接删除该apk,不再进行解析.同时将该package加到`mExpectingBetter`中


<ul>
<li><p>如果未在mPackages中查找到,但在mSettings.mPackages中有, 但未在禁用列表中，需要将该项从mSettings.mPackages中删除 </p>
<span id="possiblyDeletedUpdatedSystemApps">
</li>
<li><p>如果未在mPackages中查找到,但在mSettings.mPackages中有,且在禁用列表中，且数据目录为空时，加到 <code>possiblyDeletedUpdatedSystemApps</code>中</p>
</li>
</ul>
<h4 id="1-2-3-3-处理未安装完成的app"><a href="#1-2-3-3-处理未安装完成的app" class="headerlink" title="1.2.3.3. 处理未安装完成的app"></a>1.2.3.3. 处理未安装完成的app</h4><p>遍历mPackages的packageSetting,如果其installStatus为PKG_INSTALL_INCOMPLETE,则调用mSettings.removePackageLPw对该包进行处理</p>
<ul>
<li>从mSettings.mPackages中删除</li>
<li>从mSettings.mInstallerPackages中删除</li>
<li>从其shareUser中删除该包</li>
<li>从mUserIds或mOtherUserIds中删除</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</span><br><span class="line">    <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">    <span class="comment">// reconciliation step</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> deletePkgsList.get(i).name;</span><br><span class="line">    logCriticalInfo(Log.WARN, <span class="string">&quot;Cleaning up incompletely installed app: &quot;</span> + packageName);</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mSettings.removePackageLPw(packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-2-3-4-删除临时文件以及删除没有关联的package包的shareUser"><a href="#1-2-3-4-删除临时文件以及删除没有关联的package包的shareUser" class="headerlink" title="1.2.3.4. 删除临时文件以及删除没有关联的package包的shareUser"></a>1.2.3.4. 删除临时文件以及删除没有关联的package包的shareUser</h4><p>在对shareUser进行处理时,即遍历Settingss.mShareUsers, 查找其中的项有没有关联shareUserSetting,没有的话,需要将该单项从mShareUser中删除.</p>
<p>另外需要查看该shareuserSetting中关联的packageSetting有没有安装,并进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除安装过程中产生的临时文件, vmdl***.tmp文件</span></span><br><span class="line">deleteTempPackageFiles();</span><br><span class="line"><span class="comment">// Remove any shared userIDs that have no associated packages</span></span><br><span class="line">mSettings.pruneSharedUsersLPw();</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">pruneSharedUsersLPw</span><span class="params">()</span> &#123;</span><br><span class="line">  ArrayList&lt;String&gt; removeStage = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;String,SharedUserSetting&gt; entry : mSharedUsers.entrySet()) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">SharedUserSetting</span> <span class="variable">sus</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">    <span class="comment">// mSharedUsers 绑定的 SharedUserSetting 为 null, 直接把该shareUser项从mSharedUsers中删除</span></span><br><span class="line">    <span class="keyword">if</span> (sus == <span class="literal">null</span>) &#123;</span><br><span class="line">      removeStage.add(entry.getKey());</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// remove packages that are no longer installed</span></span><br><span class="line">    <span class="comment">// 如果当前安装的包中没有 ShareUser关联的包,则删除该关联项.</span></span><br><span class="line">    <span class="comment">// shareUser可以关联多个包, 单包没有安装,则从shareUser中删除这个关联的单包</span></span><br><span class="line">    <span class="keyword">for</span> (Iterator&lt;PackageSetting&gt; iter = sus.packages.iterator(); iter.hasNext();) &#123;</span><br><span class="line">      <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> iter.next();</span><br><span class="line">      <span class="keyword">if</span> (mPackages.get(ps.name) == <span class="literal">null</span>) &#123;</span><br><span class="line">        iter.remove();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果某个shareUser关联的包列表中的所有项都没有安装,则直接将该shareuser 从mSharedUsers中去除.</span></span><br><span class="line">    <span class="keyword">if</span> (sus.packages.size() == <span class="number">0</span>) &#123;</span><br><span class="line">      removeStage.add(entry.getKey());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; removeStage.size(); i++) &#123;</span><br><span class="line">    mSharedUsers.remove(removeStage.get(i));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-3-BOOT-PROGRESS-PMS-DATA-SCAN-START阶段"><a href="#1-3-BOOT-PROGRESS-PMS-DATA-SCAN-START阶段" class="headerlink" title="1.3. BOOT_PROGRESS_PMS_DATA_SCAN_START阶段"></a>1.3. BOOT_PROGRESS_PMS_DATA_SCAN_START阶段</h2><h4 id="1-3-1-1-最后扫描这几个目录下面-data-app"><a href="#1-3-1-1-最后扫描这几个目录下面-data-app" class="headerlink" title="1.3.1.1. 最后扫描这几个目录下面(data app):"></a>1.3.1.1. 最后扫描这几个目录下面(data app):</h4><span id="扫描data">

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/data/app</span><br><span class="line">/data/app-private</span><br><span class="line">/system/preloadapp</span><br><span class="line">/system/app-ephemeral</span><br></pre></td></tr></table></figure>

<h4 id="1-3-1-2-possiblyDeletedUpdatedSystemApps包的处理"><a href="#1-3-1-2-possiblyDeletedUpdatedSystemApps包的处理" class="headerlink" title="1.3.1.2. possiblyDeletedUpdatedSystemApps包的处理"></a>1.3.1.2. possiblyDeletedUpdatedSystemApps包的处理</h4><blockquote>
<p>Remove disable package settings for any updated system<br>apps that were removed via an OTA. If they’re not a<br>previously-updated app, remove them completely.<br>Otherwise, just revoke their system-level permissions.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (String deletedAppName : possiblyDeletedUpdatedSystemApps) &#123;</span><br><span class="line">  <span class="comment">// 需要在 mPackages中查找</span></span><br><span class="line">    PackageParser.<span class="type">Package</span> <span class="variable">deletedPkg</span> <span class="operator">=</span> mPackages.get(deletedAppName);</span><br><span class="line">  <span class="comment">// 从禁用列表中删除</span></span><br><span class="line">    mSettings.removeDisabledSystemPackageLPw(deletedAppName);</span><br><span class="line"></span><br><span class="line">    String msg;</span><br><span class="line">    <span class="keyword">if</span> (deletedPkg == <span class="literal">null</span>) &#123;</span><br><span class="line">        msg = <span class="string">&quot;Updated system package &quot;</span> + deletedAppName</span><br><span class="line">                + <span class="string">&quot; no longer exists; it&#x27;s data will be wiped&quot;</span>;</span><br><span class="line">        <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">        <span class="comment">// reconciliation step</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 在mPakcages中查到了</span></span><br><span class="line">        msg = <span class="string">&quot;Updated system app + &quot;</span> + deletedAppName</span><br><span class="line">                + <span class="string">&quot; no longer present; removing system privileges for &quot;</span></span><br><span class="line">                + deletedAppName;</span><br><span class="line"></span><br><span class="line">        deletedPkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line"></span><br><span class="line">        <span class="type">PackageSetting</span> <span class="variable">deletedPs</span> <span class="operator">=</span> mSettings.mPackages.get(deletedAppName);</span><br><span class="line">        <span class="comment">//removing system privileges</span></span><br><span class="line">      <span class="comment">// 删除系统权限</span></span><br><span class="line">        deletedPs.pkgFlags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">    &#125;</span><br><span class="line">    logCriticalInfo(Log.WARN, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应<a href="#possiblyDeletedUpdatedSystemApps">possiblyDeletedUpdatedSystemApps</a>, 在这个地方该包是没在mPackages,如果此处能在mPackages查到,说明中间经过了其他的扫描. 而这中间是通过<a href="#%E6%89%AB%E6%8F%8Fdata">扫描dataapp</a>的,这说明该包是data app的升级包,所以此处仅撤销掉FLAG_SYSTEM的flag,标明其为data app.</p>
<h4 id="1-3-1-3-mExpectingBetter的处理"><a href="#1-3-1-3-mExpectingBetter的处理" class="headerlink" title="1.3.1.3. mExpectingBetter的处理"></a>1.3.1.3. mExpectingBetter的处理</h4><p>对于之前<a href="#mExpectingBetter">监测到的禁用的apk</a>,在删除该apk相关的信息后,  重新对这些包进行扫描安装.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> mExpectingBetter.keyAt(i);</span><br><span class="line">        <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">File</span> <span class="variable">scanFile</span> <span class="operator">=</span> mExpectingBetter.valueAt(i);</span><br><span class="line"></span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">&quot;Expected better &quot;</span> + packageName</span><br><span class="line">                    + <span class="string">&quot; but never showed up; reverting to system&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">reparseFlags</span> <span class="operator">=</span> mDefParseFlags;</span><br><span class="line">            <span class="keyword">if</span> (FileUtils.contains(privilegedAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                        | PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(systemAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(vendorAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(oemAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">&quot;Ignoring unexpected fallback path &quot;</span> + scanFile);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 重新启用这些package</span></span><br><span class="line">            mSettings.enableSystemPackageLPw(packageName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 重新使用新的解析参数进行解析</span></span><br><span class="line">                scanPackageTracedLI(scanFile, reparseFlags, scanFlags, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">&quot;Failed to parse original system package: &quot;</span></span><br><span class="line">                        + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mExpectingBetter.clear();</span><br></pre></td></tr></table></figure>
<h4 id="1-3-1-4-解析受保护的action-filter-setupWizard相关"><a href="#1-3-1-4-解析受保护的action-filter-setupWizard相关" class="headerlink" title="1.3.1.4. 解析受保护的action filter(setupWizard相关)"></a>1.3.1.4. 解析受保护的action filter(setupWizard相关)</h4><blockquote>
<p>Only the setup wizard is allowed to have a high priority filter for these actions.</p>
</blockquote>
<p>首先看下受保护的action filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; PROTECTED_ACTIONS = <span class="keyword">new</span> <span class="title class_">ArraySet</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    PROTECTED_ACTIONS.add(Intent.ACTION_SEND);</span><br><span class="line">    PROTECTED_ACTIONS.add(Intent.ACTION_SENDTO);</span><br><span class="line">    PROTECTED_ACTIONS.add(Intent.ACTION_SEND_MULTIPLE);</span><br><span class="line">    PROTECTED_ACTIONS.add(Intent.ACTION_VIEW);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mProtectedFilters是在parseActivity和解析BroadcastReceiver时根据intentfilter匹配添加的.</p>
<p>将开机向导处理这些mProtectedFilters的优先级设置为最高</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从之前解析的所有包中查找setupwizard应用</span></span><br><span class="line">mSetupWizardPackage = getSetupWizardPackageName();</span><br><span class="line"><span class="keyword">if</span> (mProtectedFilters.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_FILTERS &amp;&amp; mSetupWizardPackage == <span class="literal">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">&quot;No setup wizard;&quot;</span></span><br><span class="line">            + <span class="string">&quot; All protected intents capped to priority 0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (ActivityIntentInfo filter : mProtectedFilters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (filter.activity.info.packageName.equals(mSetupWizardPackage)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_FILTERS) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">&quot;Found setup wizard;&quot;</span></span><br><span class="line">                    + <span class="string">&quot; allow priority &quot;</span> + filter.getPriority() + <span class="string">&quot;;&quot;</span></span><br><span class="line">                    + <span class="string">&quot; package: &quot;</span> + filter.activity.info.packageName</span><br><span class="line">                    + <span class="string">&quot; activity: &quot;</span> + filter.activity.className</span><br><span class="line">                    + <span class="string">&quot; priority: &quot;</span> + filter.getPriority());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// skip setup wizard; allow it to keep the high priority filter</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//拥有mProtectedFilters的其他的包的优先级降为0,降为最低,只有开机向导的优先级比较高</span></span><br><span class="line">        Slog.w(TAG, <span class="string">&quot;Protected action; cap priority to 0;&quot;</span></span><br><span class="line">                + <span class="string">&quot; package: &quot;</span> + filter.activity.info.packageName</span><br><span class="line">                + <span class="string">&quot; activity: &quot;</span> + filter.activity.className</span><br><span class="line">                + <span class="string">&quot; origPrio: &quot;</span> + filter.getPriority());</span><br><span class="line">        filter.setPriority(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-3-1-5-扫描结束后-更新所有的共享库-以及为所有的shareUser更新Abi架构集"><a href="#1-3-1-5-扫描结束后-更新所有的共享库-以及为所有的shareUser更新Abi架构集" class="headerlink" title="1.3.1.5. 扫描结束后,更新所有的共享库,以及为所有的shareUser更新Abi架构集"></a>1.3.1.5. 扫描结束后,更新所有的共享库,以及为所有的shareUser更新Abi架构集</h4><p>这个地方与<a target="_blank" rel="noopener" href="https://cototem.github.io/2017/08/02/pkms2/#%E7%B3%BB%E7%BB%9F%E7%BA%A7%E5%BA%94%E7%94%A8%E5%90%91%E5%85%B1%E4%BA%AB%E5%BA%93%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%BA%93">添加共享库后,为应用更新共享库信息</a>呼应, 而更新指令集的部分与<a target="_blank" rel="noopener" href="https://cototem.github.io/2017/08/02/pkms2/#%E4%B8%BAshareuser%E7%BB%9F%E4%B8%80%E8%B0%83%E6%95%B4%E6%8C%87%E4%BB%A4%E9%9B%86">为shareUser统一调整指令集</a>呼应</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//检测pkg的 usesLibraries 和 usesOptionalLibraries 项, 如果其中有lib项,则从mSharedLibraries查找该项,如果没有找到报异常.如果能找到,则将该项的path找到,聚合应用的话,则添加包括 basecodepath splitcodepath ,将这些path更新到 pkg.usesLibraryFiles字段中</span></span><br><span class="line">updateAllSharedLibrariesLPw();</span><br><span class="line"><span class="keyword">for</span> (SharedUserSetting setting : mSettings.getAllSharedUsersLPw()) &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> We ignore potential failures here during a system scan (like</span></span><br><span class="line">  <span class="comment">// the rest of the commands above) because there&#x27;s precious little we</span></span><br><span class="line">  <span class="comment">// can do about it. A settings error is reported, though.</span></span><br><span class="line">  adjustCpuAbisForSharedUserLPw(setting.packages, <span class="literal">null</span> <span class="comment">/* scanned package */</span>,</span><br><span class="line">                                <span class="literal">false</span> <span class="comment">/* boot complete */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-3-1-6-读取PackageUsage文件更新pkg的mLastPackageUsageTimeInMills字段"><a href="#1-3-1-6-读取PackageUsage文件更新pkg的mLastPackageUsageTimeInMills字段" class="headerlink" title="1.3.1.6. 读取PackageUsage文件更新pkg的mLastPackageUsageTimeInMills字段"></a>1.3.1.6. 读取PackageUsage文件更新pkg的mLastPackageUsageTimeInMills字段</h4><blockquote>
<p>Now that we know all the packages we are keeping,read and update their last usage time</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取data/system/package-usage.list</span></span><br><span class="line">mPackageUsage.readLP();</span><br></pre></td></tr></table></figure>

<p>data&#x2F;system&#x2F;package-usage.list</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PACKAGE_USAGE_VERSION1</span><br><span class="line">com.android.providers.telephony <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1420072084352</span> <span class="number">0</span> <span class="number">1420072084443</span> <span class="number">0</span></span><br><span class="line">com.sprd.engineermode <span class="number">1420072113355</span> <span class="number">1420072113459</span> <span class="number">0</span> <span class="number">1420072405475</span> <span class="number">1420072101365</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">com.android.providers.calendar <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1420072105482</span> <span class="number">1420072100291</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>mLastPackageUsageTimeInMills保存了下面这几项(8项 <a href="#unix">UNIX时间,转换见这里</a>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Used when starting a process for an Activity.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NOTIFY_PACKAGE_USE_ACTIVITY</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">//Used when starting a process for a Service.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NOTIFY_PACKAGE_USE_SERVICE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">//Used when moving a Service to the foreground.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NOTIFY_PACKAGE_USE_FOREGROUND_SERVICE</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">//Used when starting a process for a BroadcastReceiver.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NOTIFY_PACKAGE_USE_BROADCAST_RECEIVER</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="comment">//Used when starting a process for a ContentProvider.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NOTIFY_PACKAGE_USE_CONTENT_PROVIDER</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"><span class="comment">//Used when starting a process for a BroadcastReceiver.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NOTIFY_PACKAGE_USE_BACKUP</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">//Used with Context.getClassLoader() across Android packages.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NOTIFY_PACKAGE_USE_CROSS_PACKAGE</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line"><span class="comment">//Used when starting a package within a process for Instrumentation.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NOTIFY_PACKAGE_USE_INSTRUMENTATION</span> <span class="operator">=</span> <span class="number">7</span>;</span><br></pre></td></tr></table></figure>

<h2 id="1-4-BOOT-PROGRESS-PMS-SCAN-END"><a href="#1-4-BOOT-PROGRESS-PMS-SCAN-END" class="headerlink" title="1.4. BOOT_PROGRESS_PMS_SCAN_END"></a>1.4. BOOT_PROGRESS_PMS_SCAN_END</h2><p>上面的system扫描和data扫描结束</p>
<h4 id="1-4-1-1-更新赋予权限-updatePermissionsLPw"><a href="#1-4-1-1-更新赋予权限-updatePermissionsLPw" class="headerlink" title="1.4.1.1. 更新赋予权限 updatePermissionsLPw"></a>1.4.1.1. 更新赋予权限 updatePermissionsLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ver.sdkVersion != mSdkVersion</span><br></pre></td></tr></table></figure>

<p>mSdkVersion取的是<code>ro.build.version.sdk</code>,这个值是编版本时指定的,指的是framework的sdk</p>
<p>而ver.sdkVersion是<a href="#sdkv">记录在packages.xml中</a>的</p>
<p>对于OTA升级的场景,这个值一上来就是有的.</p>
<p>而对于首次开机的场景,即上来packages.xml文件不存在,这个值会在mSettings.readLPw方法中创建,并将ver.sdkVersion的值设置为mSdkVersion</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 升级的场景</span></span><br><span class="line"><span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">&quot;Platform changed from &quot;</span> + ver.sdkVersion + <span class="string">&quot; to &quot;</span></span><br><span class="line">            + mSdkVersion + <span class="string">&quot;; regranting permissions for internal storage&quot;</span>);</span><br><span class="line">    <span class="comment">// 指定重新赋予 regrant权限</span></span><br><span class="line">    updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">    <span class="comment">// Make sure there are no dangling permission trees.</span></span><br><span class="line">    updatePermissionsLPw(<span class="literal">null</span>, <span class="literal">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</span><br><span class="line">&#125;</span><br><span class="line">ver.sdkVersion = mSdkVersion;</span><br></pre></td></tr></table></figure>
<h5 id="1-4-1-1-1-更新权限流程图"><a href="#1-4-1-1-1-更新权限流程图" class="headerlink" title="1.4.1.1.1. 更新权限流程图"></a>1.4.1.1.1. 更新权限流程图</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">PackageManagerServcice -&gt; PackageManagerServcice:updatePermissionsLPw</span><br><span class="line">opt UPDATE_PERMISSIONS_ALL</span><br><span class="line">PackageManagerServcice -&gt; PackageManagerServcice: getVolumeUuidForPackage(pkg)</span><br><span class="line">PackageManagerServcice -&gt; PackageManagerServcice: grantPermissionsLPw(pkg, replace, changingPkg);</span><br><span class="line">PackageManagerServcice -&gt;PackageSetting: getPermissionsState</span><br><span class="line">PackageSetting -&gt;&gt; SettingBase: getPermissionsState</span><br><span class="line">PackageSetting --&gt;&gt;  PackageManagerServcice: return PermissionsState</span><br><span class="line">PackageManagerServcice -&gt; PermissionsState: setGlobalGids</span><br><span class="line">PackageManagerServcice -&gt; PackageParser.Package:pkg.requestedPermissions.get</span><br><span class="line">PackageParser.Package -&gt;  PackageManagerServcice: return requestedPermission name</span><br><span class="line">PackageManagerServcice -&gt; PackageManagerServcice: BasePermission bp = mSettings.mPermissions.get(name)</span><br><span class="line">PackageManagerServcice -&gt; BasePermission: bp.protectionLevel</span><br><span class="line">opt GRANT_INSTALL</span><br><span class="line">PackageManagerServcice -&gt; PermissionsState:grantInstallPermission(bp)</span><br><span class="line">else</span><br><span class="line">end</span><br><span class="line">opt GRANT_RUNTIME</span><br><span class="line">PackageManagerServcice -&gt;&gt; PermissionsState:grantRuntimePermission(bp, userId)</span><br><span class="line">PackageManagerServcice -&gt;&gt; PermissionsState:updatePermissionFlags(bp, userId,flags, flags)</span><br><span class="line">else</span><br><span class="line">end</span><br><span class="line">opt GRANT_UPGRADE</span><br><span class="line">PackageManagerServcice -&gt;&gt; PermissionsState:revokeInstallPermission(bp)</span><br><span class="line">PackageManagerServcice -&gt;&gt; PermissionsState:updatePermissionFlags(bp, ...)</span><br><span class="line">PackageManagerServcice -&gt;&gt; PermissionsState:grantRuntimePermission(bp, userId)</span><br><span class="line">PackageManagerServcice -&gt;&gt; PermissionsState:updatePermissionFlags(bp, userId,flags, flags)</span><br><span class="line">else</span><br><span class="line">opt</span><br><span class="line">alt GRANT_DENIED</span><br><span class="line">PackageManagerServcice -&gt;&gt; PermissionsState:revokeInstallPermission(bp)</span><br><span class="line">PackageManagerServcice -&gt;&gt; PermissionsState:updatePermissionFlags(bp, userId,flags, flags)</span><br><span class="line">else</span><br><span class="line">opt</span><br><span class="line">PackageManagerServcice -&gt;&gt; Settings:writeRuntimePermissionsForUserLPr(userId, sync)</span><br><span class="line">else </span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">opt pkginfo is not null</span><br><span class="line">PackageManagerServcice -&gt;&gt; PackageManagerServcice: getVolumeUuidForPackage(pkg)</span><br><span class="line">PackageManagerServcice -&gt;&gt; PackageManagerServcice: 	grantPermissionsLPw</span><br><span class="line">else</span><br><span class="line">end</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>


<h5 id="1-4-1-1-2-具体流程"><a href="#1-4-1-1-2-具体流程" class="headerlink" title="1.4.1.1.2. 具体流程"></a>1.4.1.1.2. 具体流程</h5><h6 id="1-4-1-1-2-1-updatePermissionsLPw函数更新数据在内部存储上的包"><a href="#1-4-1-1-2-1-updatePermissionsLPw函数更新数据在内部存储上的包" class="headerlink" title="1.4.1.1.2.1. updatePermissionsLPw函数更新数据在内部存储上的包"></a>1.4.1.1.2.1. updatePermissionsLPw函数更新数据在内部存储上的包</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</span><br><span class="line">  Slog.i(TAG, <span class="string">&quot;Platform changed from &quot;</span> + ver.sdkVersion + <span class="string">&quot; to &quot;</span></span><br><span class="line">         + mSdkVersion + <span class="string">&quot;; regranting permissions for internal storage&quot;</span>);</span><br><span class="line">  <span class="comment">// 为升级场景时,携带UPDATE_PERMISSIONS_REPLACE_ALL标记</span></span><br><span class="line">  updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</span><br><span class="line">&#125;</span><br><span class="line">updatePermissionsLPw(<span class="literal">null</span>, <span class="literal">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</span><br></pre></td></tr></table></figure>

<p>首先读取mSettings.mPermissionTrees上的item,如果其item对应的packageSetting为空,则从该tree上删除该item</p>
<p>其次读取mSettings.mPermissions上的项目, 如果权限为TYPE_DYNAMIC, bp.packageSetting 为空,则从其对应的tree 继承构造.</p>
<p>如果 bp.packageSetting还为空的话,需要从 mSettings.mPermissions 中删除该权限,进行下一步</p>
<p>最后监测是否携带了UPDATE_PERMISSIONS_ALL标记,携带此标记,说明是为<strong>所有包</strong>更新权限,  如果携带UPDATE_PERMISSIONS_REPLACE_ALL标记,将replace设置为true</p>
<p>调用grantPermissionsLPw(pkg, replace, changingPkg) 更新授予权限</p>
<p>同样检测pkgInfo是否为空,此参数表明为<strong>单个指定的包</strong>更新授予权限.如果携带UPDATE_PERMISSIONS_REPLACE_ALL标记,则将replace设置为true,调用调用grantPermissionsLPw(pkg, replace, changingPkg) 更新授予权限.</p>
<h6 id="1-4-1-1-2-2-grantPermissionsLPw函数进行权限更新授予"><a href="#1-4-1-1-2-2-grantPermissionsLPw函数进行权限更新授予" class="headerlink" title="1.4.1.1.2.2. grantPermissionsLPw函数进行权限更新授予"></a>1.4.1.1.2.2. grantPermissionsLPw函数进行权限更新授予</h6><p>权限类型为PROTECTION_SIGNATURE和PROTECTION_NORMAL时,为安装时权限.</p>
<p>但在<code>PROTECTION_SIGNATURE</code>的情况下,需要对签名进行校验(并不只是签名的比对),校验未通过,则grant类型为GRANT_DENIED</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">appSupportsRuntimePermissions</span> <span class="operator">=</span> pkg.applicationInfo.targetSdkVersion</span><br><span class="line">        &gt;= Build.VERSION_CODES.M;</span><br><span class="line"><span class="keyword">switch</span> (level) &#123;</span><br><span class="line">    <span class="keyword">case</span> PermissionInfo.PROTECTION_NORMAL: &#123;</span><br><span class="line">        <span class="comment">// For all apps normal permissions are install time ones.</span></span><br><span class="line">        grant = GRANT_INSTALL;</span><br><span class="line">    &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PermissionInfo.PROTECTION_DANGEROUS: &#123;</span><br><span class="line">        <span class="comment">// If a permission review is required for legacy apps we represent</span></span><br><span class="line">        <span class="comment">// their permissions as always granted runtime ones since we need</span></span><br><span class="line">        <span class="comment">// to keep the review required permission flag per user while an</span></span><br><span class="line">        <span class="comment">// install permission&#x27;s state is shared across all users.</span></span><br><span class="line">        <span class="comment">// 如果Build.PERMISSIONS_REVIEW_REQUIRED为true,则肯定不为GRANT_INSTALL类型</span></span><br><span class="line">        <span class="comment">// 一般情况下,PERMISSIONS_REVIEW_REQUIRED 不进行设置, 即为false</span></span><br><span class="line">        <span class="comment">// legacy app ,即 sdk小于M的apk, 在这种情况下,对应dangerous的权限, 授予为安装时权限</span></span><br><span class="line">        <span class="keyword">if</span> (!appSupportsRuntimePermissions &amp;&amp; !Build.PERMISSIONS_REVIEW_REQUIRED) &#123;</span><br><span class="line">            <span class="comment">// For legacy apps dangerous permissions are install time ones.</span></span><br><span class="line">            grant = GRANT_INSTALL;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origPermissions.hasInstallPermission(bp.name)) &#123;</span><br><span class="line">            <span class="comment">// 如果权限已经被赋予了,对应于legacy app 升级为sdk&gt;=M的情况,  类型变为GRANT_UPGRADE</span></span><br><span class="line">            <span class="comment">// For legacy apps that became modern, install becomes runtime.</span></span><br><span class="line">            grant = GRANT_UPGRADE;</span><br><span class="line">            <span class="comment">// 对于从pre-M升级上来的 system app,即使权限没有被赋予, install-&gt;runtime</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPromoteSystemApps</span><br><span class="line">                &amp;&amp; isSystemApp(ps)</span><br><span class="line">                &amp;&amp; mExistingSystemPackages.contains(ps.name)) &#123;</span><br><span class="line">            <span class="comment">// For legacy system apps, install becomes runtime.</span></span><br><span class="line">            <span class="comment">// We cannot check hasInstallPermission() for system apps since those</span></span><br><span class="line">            <span class="comment">// permissions were granted implicitly and not persisted pre-M.</span></span><br><span class="line">            grant = GRANT_UPGRADE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// For modern apps keep runtime permissions unchanged.</span></span><br><span class="line">            grant = GRANT_RUNTIME;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> PermissionInfo.PROTECTION_SIGNATURE: &#123;</span><br><span class="line">        <span class="comment">// For all apps signature permissions are install time ones.</span></span><br><span class="line">        <span class="comment">// 进行签名校验,并不只是签名的比对</span></span><br><span class="line">        allowedSig = grantSignaturePermission(perm, pkg, bp, origPermissions);</span><br><span class="line">        <span class="keyword">if</span> (allowedSig) &#123;</span><br><span class="line">            grant = GRANT_INSTALL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>授予权限时,对应安装时权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (grant) &#123;</span><br><span class="line">    <span class="keyword">case</span> GRANT_INSTALL: &#123;</span><br><span class="line">        <span class="comment">// Revoke this as runtime permission to handle the case of</span></span><br><span class="line">        <span class="comment">// a runtime permission being downgraded to an install one.</span></span><br><span class="line">        <span class="comment">// Also in permission review mode we keep dangerous permissions</span></span><br><span class="line">        <span class="comment">// for legacy apps</span></span><br><span class="line">      <span class="comment">// runtime权限降级为install权限,需要将runtime权限撤销</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (origPermissions.getRuntimePermissionState(</span><br><span class="line">                    bp.name, userId) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Revoke the runtime permission and clear the flags.</span></span><br><span class="line">                origPermissions.revokeRuntimePermission(bp, userId);</span><br><span class="line">                origPermissions.updatePermissionFlags(bp, userId,</span><br><span class="line">                      PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// If we revoked a permission permission, we have to write.</span></span><br><span class="line">                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Grant an install permission.</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) !=</span><br><span class="line">                PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">            changedInstallPermission = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>对应runtime权限的授予</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> GRANT_RUNTIME: &#123;</span><br><span class="line">    <span class="comment">// Grant previously granted runtime permissions.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">        <span class="type">PermissionState</span> <span class="variable">permissionState</span> <span class="operator">=</span> origPermissions</span><br><span class="line">                .getRuntimePermissionState(bp.name, userId);</span><br><span class="line">        <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> permissionState != <span class="literal">null</span></span><br><span class="line">                ? permissionState.getFlags() : <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// 原来的包中已经由该权限项,不论该权限项是否被授予</span></span><br><span class="line">        <span class="keyword">if</span> (origPermissions.hasRuntimePermission(bp.name, userId)) &#123;</span><br><span class="line">           <span class="comment">//进行授予权限</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId) ==</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                <span class="comment">// If we cannot put the permission as it was, we have to write.</span></span><br><span class="line">              <span class="comment">// 权限未授予成功,才对权限对应xml文件进行更新</span></span><br><span class="line">                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If the app supports runtime permissions no need for a review.</span></span><br><span class="line">          <span class="comment">// permission Review时,需要更新权限对应xml文件</span></span><br><span class="line">            <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                    &amp;&amp; appSupportsRuntimePermissions</span><br><span class="line">                    &amp;&amp; (flags &amp; PackageManager</span><br><span class="line">                            .FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span>) &#123;</span><br><span class="line">                flags &amp;= ~PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED;</span><br><span class="line">                <span class="comment">// Since we changed the flags, we have to write.</span></span><br><span class="line">                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="comment">// REVIEW permission Review 且 app版本小于M版本时, 授予运行时权限</span></span><br><span class="line">          <span class="comment">// 一般情况下,不在permission review模式下,即该字段不存在</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                &amp;&amp; !appSupportsRuntimePermissions) &#123;</span><br><span class="line">            <span class="comment">// For legacy apps that need a permission review, every new</span></span><br><span class="line">            <span class="comment">// runtime permission is granted but it is pending a review.</span></span><br><span class="line">            <span class="comment">// We also need to review only platform defined runtime</span></span><br><span class="line">            <span class="comment">// permissions as these are the only ones the platform knows</span></span><br><span class="line">            <span class="comment">// how to disable the API to simulate revocation as legacy</span></span><br><span class="line">            <span class="comment">// apps don&#x27;t expect to run with revoked permissions.</span></span><br><span class="line">            <span class="keyword">if</span> (PLATFORM_PACKAGE_NAME.equals(bp.sourcePackage)) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((flags &amp; FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span>) &#123;</span><br><span class="line">                    flags |= FLAG_PERMISSION_REVIEW_REQUIRED;</span><br><span class="line">                    <span class="comment">// We changed the flags, hence have to write.</span></span><br><span class="line">                    changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                            changedRuntimePermissionUserIds, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId)</span><br><span class="line">                    != PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                <span class="comment">// We changed the permission, hence have to write.</span></span><br><span class="line">                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Propagate the permission flags.</span></span><br><span class="line">        permissionsState.updatePermissionFlags(bp, userId, flags, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>对应GRANT_UPGRADE的权限进行授予:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> GRANT_UPGRADE: &#123;</span><br><span class="line">    <span class="comment">// Grant runtime permissions for a previously held install permission.</span></span><br><span class="line">    <span class="type">PermissionState</span> <span class="variable">permissionState</span> <span class="operator">=</span> origPermissions</span><br><span class="line">            .getInstallPermissionState(bp.name);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> permissionState != <span class="literal">null</span> ? permissionState.getFlags() : <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 撤销安装时权限</span></span><br><span class="line">    <span class="keyword">if</span> (origPermissions.revokeInstallPermission(bp)</span><br><span class="line">            != PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">        <span class="comment">// We will be transferring the permission flags, so clear them.</span></span><br><span class="line">        origPermissions.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">        changedInstallPermission = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the permission is not to be promoted to runtime we ignore it and</span></span><br><span class="line">    <span class="comment">// also its other flags as they are not applicable to install permissions.</span></span><br><span class="line">    <span class="comment">// install-&gt;runtime 的权限在被撤销后会携带FLAG_PERMISSION_REVOKE_ON_UPGRADE的标志, 应用下次升级时,就不会赋予该权限了</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> userId : currentUserIds) &#123;</span><br><span class="line">          <span class="comment">// 授予运行时权限</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId) !=</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                <span class="comment">// Transfer the permission flags.</span></span><br><span class="line">                permissionsState.updatePermissionFlags(bp, userId,</span><br><span class="line">                        flags, flags);</span><br><span class="line">                <span class="comment">// If we granted the permission, we have to write.</span></span><br><span class="line">                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>GRANT_DENIED类型,需要撤销安装时权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) !=</span><br><span class="line">        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">    <span class="comment">// Also drop the permission flags.</span></span><br><span class="line">    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">            PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">    changedInstallPermission = <span class="literal">true</span>;</span><br><span class="line">    Slog.i(TAG, <span class="string">&quot;Un-granting permission &quot;</span> + perm</span><br><span class="line">            + <span class="string">&quot; from package &quot;</span> + pkg.packageName</span><br><span class="line">            + <span class="string">&quot; (protectionLevel=&quot;</span> + bp.protectionLevel</span><br><span class="line">            + <span class="string">&quot; flags=0x&quot;</span> + Integer.toHexString(pkg.applicationInfo.flags)</span><br><span class="line">            + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后根据变更权限的user更新权限对应的xml文件</p>
<p>&#x2F;data&#x2F;system&#x2F;users&#x2F;<userid>&#x2F;runtime-permissions.xml</p>
<h4 id="1-4-1-2-第一次开机或者从pre-M版本升级上来-重设偏好应用"><a href="#1-4-1-2-第一次开机或者从pre-M版本升级上来-重设偏好应用" class="headerlink" title="1.4.1.2. 第一次开机或者从pre-M版本升级上来,重设偏好应用"></a>1.4.1.2. 第一次开机或者从pre-M版本升级上来,重设偏好应用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If this is the first boot or an update from pre-M, and it is a normal</span></span><br><span class="line"><span class="comment">// boot, then we need to initialize the default preferred apps across</span></span><br><span class="line"><span class="comment">// all defined users.</span></span><br><span class="line"><span class="comment">// mPromoteSystemApps 标志pre-M版本升级上来</span></span><br><span class="line"><span class="comment">// mRestoredSettings为false 表明首次开机</span></span><br><span class="line"><span class="keyword">if</span> (!onlyCore &amp;&amp; (mPromoteSystemApps || !mRestoredSettings)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : sUserManager.getUsers(<span class="literal">true</span>)) &#123;</span><br><span class="line">        mSettings.applyDefaultPreferredAppsLPw(<span class="built_in">this</span>, user.id);</span><br><span class="line">        applyFactoryDefaultBrowserLPw(user.id);</span><br><span class="line">        primeDomainVerificationsLPw(user.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-4-1-3-调整应用的数据目录"><a href="#1-4-1-3-调整应用的数据目录" class="headerlink" title="1.4.1.3. 调整应用的数据目录"></a>1.4.1.3. 调整应用的数据目录</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> storageFlags;</span><br><span class="line"><span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()) &#123;</span><br><span class="line">    <span class="comment">// 文件加密模式,只设置DE区</span></span><br><span class="line">    storageFlags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 非文件加密模式, 同时设置DE区和CE区</span></span><br><span class="line">    storageFlags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Destroys app data that isn&#x27;t expected, either due to uninstallation or reinstallation on another volume.</span></span><br><span class="line"><span class="comment">// 然后,为已安装该应用的用户准备数据目录,包括设置权限及设置selinux标签</span></span><br><span class="line"><span class="comment">// /data/user_de/&lt;userid&gt;/**</span></span><br><span class="line"><span class="comment">// /data/user/&lt;userid&gt;/**</span></span><br><span class="line">reconcileAppsDataLI(StorageManager.UUID_PRIVATE_INTERNAL, UserHandle.USER_SYSTEM,</span><br><span class="line">        storageFlags);</span><br></pre></td></tr></table></figure>

<h4 id="1-4-1-4-当监测到为升级场景时-需要删除原来包的code-cache"><a href="#1-4-1-4-当监测到为升级场景时-需要删除原来包的code-cache" class="headerlink" title="1.4.1.4. 当监测到为升级场景时,需要删除原来包的code_cache"></a>1.4.1.4. 当监测到为升级场景时,需要删除原来包的code_cache</h4><p>携带了Installer.FLAG_CLEAR_CODE_CACHE_ONLY的flag</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mIsUpgrade &amp;&amp; !onlyCore) &#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">&quot;Build fingerprint changed; clearing code caches&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mSettings.mPackages.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> mSettings.mPackages.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(StorageManager.UUID_PRIVATE_INTERNAL, ps.volumeUuid)) &#123;</span><br><span class="line">            <span class="comment">// No apps are running this early, so no need to freeze</span></span><br><span class="line">            clearAppDataLIF(ps.pkg, UserHandle.USER_ALL,</span><br><span class="line">                    StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE</span><br><span class="line">                            <span class="comment">// 只清除codecache目录</span></span><br><span class="line">                            | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ver.fingerprint = Build.FINGERPRINT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-4-1-5-更新完应用权限-且偏好应用更新完时-重置某些字段并写入packages-xml"><a href="#1-4-1-5-更新完应用权限-且偏好应用更新完时-重置某些字段并写入packages-xml" class="headerlink" title="1.4.1.5. 更新完应用权限,且偏好应用更新完时,重置某些字段并写入packages.xml"></a>1.4.1.5. 更新完应用权限,且偏好应用更新完时,重置某些字段并写入packages.xml</h4><p>在这个地方会对packages.xml文件进行写入更新</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clear only after permissions and other defaults have been updated</span></span><br><span class="line"><span class="comment">// 该字段用于保存install-&gt;runtime的权限</span></span><br><span class="line">mExistingSystemPackages.clear();</span><br><span class="line">mPromoteSystemApps = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// All the changes are done during package scanning.</span></span><br><span class="line">ver.databaseVersion = Settings.CURRENT_DATABASE_VERSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// can downgrade to reader</span></span><br><span class="line">将上述扫描的结果写入packages.xml</span><br><span class="line">mSettings.writeLPr();</span><br></pre></td></tr></table></figure>

<h4 id="1-4-1-6-对core-app执行dex优化"><a href="#1-4-1-6-对core-app执行dex优化" class="headerlink" title="1.4.1.6. 对core app执行dex优化"></a>1.4.1.6. 对core app执行dex优化</h4><p>首次开机或者升级场景或者DalvikCache被删除时,需要对core app 执行dex优化</p>
<p>core app来自 pkg.coreApp, 从AndroidManifest中解析的.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:androidprv</span>=<span class="string">&quot;http://schemas.android.com/apk/prv/res/android&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">package</span>=<span class="string">&quot;com.android.proxyhandler&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">coreApp</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="1-5-BOOT-PROGRESS-PMS-READY阶段"><a href="#1-5-BOOT-PROGRESS-PMS-READY阶段" class="headerlink" title="1.5. BOOT_PROGRESS_PMS_READY阶段"></a>1.5. BOOT_PROGRESS_PMS_READY阶段</h2><h3 id="1-5-1-初始化PackageInstallerService"><a href="#1-5-1-初始化PackageInstallerService" class="headerlink" title="1.5.1. 初始化PackageInstallerService"></a>1.5.1. 初始化PackageInstallerService</h3><p>该服务主要处理来自应用安装器的安装请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">mInstallerService = <span class="keyword">new</span> <span class="title class_">PackageInstallerService</span>(context, <span class="built_in">this</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">PackageInstallerService</span><span class="params">(Context context, PackageManagerService pm)</span> &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mPm = pm;</span><br><span class="line">    mInstallThread = <span class="keyword">new</span> <span class="title class_">HandlerThread</span>(TAG);</span><br><span class="line">    mInstallThread.start();</span><br><span class="line">    mInstallHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>(mInstallThread.getLooper());</span><br><span class="line">    mCallbacks = <span class="keyword">new</span> <span class="title class_">Callbacks</span>(mInstallThread.getLooper());</span><br><span class="line"></span><br><span class="line">    mSessionsFile = <span class="keyword">new</span> <span class="title class_">AtomicFile</span>(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">File</span>(Environment.getDataSystemDirectory(), <span class="string">&quot;install_sessions.xml&quot;</span>));</span><br><span class="line">    mSessionsDir = <span class="keyword">new</span> <span class="title class_">File</span>(Environment.getDataSystemDirectory(), <span class="string">&quot;install_sessions&quot;</span>);</span><br><span class="line">    mSessionsDir.mkdirs();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        readSessionsLocked();</span><br><span class="line"></span><br><span class="line">        reconcileStagesLocked(StorageManager.UUID_PRIVATE_INTERNAL, <span class="literal">false</span> <span class="comment">/*isEphemeral*/</span>);</span><br><span class="line">        reconcileStagesLocked(StorageManager.UUID_PRIVATE_INTERNAL, <span class="literal">true</span> <span class="comment">/*isEphemeral*/</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ArraySet&lt;File&gt; unclaimedIcons = newArraySet(</span><br><span class="line">                mSessionsDir.listFiles());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Ignore stages and icons claimed by active sessions</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mSessions.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">PackageInstallerSession</span> <span class="variable">session</span> <span class="operator">=</span> mSessions.valueAt(i);</span><br><span class="line">            unclaimedIcons.remove(buildAppIconFile(session.sessionId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clean up orphaned icons</span></span><br><span class="line">        <span class="keyword">for</span> (File icon : unclaimedIcons) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Deleting orphan icon &quot;</span> + icon);</span><br><span class="line">            icon.delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-5-2-为几个变量赋值"><a href="#1-5-2-为几个变量赋值" class="headerlink" title="1.5.2. 为几个变量赋值"></a>1.5.2. 为几个变量赋值</h3><span id="bianliang">

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">   <span class="comment">// 默认校验器,来自android.intent.action.PACKAGE_NEEDS_VERIFICATION</span></span><br><span class="line">    mRequiredVerifierPackage = getRequiredButNotReallyRequiredVerifierLPr();</span><br><span class="line">    <span class="comment">// 默认的安装器,来自android.intent.action.INSTALL_PACKAGE</span></span><br><span class="line">    mRequiredInstallerPackage = getRequiredInstallerLPr();</span><br><span class="line">    <span class="comment">// 默认的校验器对应的component</span></span><br><span class="line">    mIntentFilterVerifierComponent = getIntentFilterVerifierComponentNameLPr();</span><br><span class="line">    <span class="comment">// 校验代理</span></span><br><span class="line">    mIntentFilterVerifier = <span class="keyword">new</span> <span class="title class_">IntentVerifierProxy</span>(mContext,</span><br><span class="line">            mIntentFilterVerifierComponent);</span><br><span class="line">    <span class="comment">// 使用&quot;android.ext.services&quot; 共享库的 client apk 的名字</span></span><br><span class="line">    mServicesSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">            PackageManager.SYSTEM_SHARED_LIBRARY_SERVICES);</span><br><span class="line">   <span class="comment">// 使用&quot;android.ext.shared&quot; 共享库的 client apk的名字</span></span><br><span class="line">    mSharedSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">            PackageManager.SYSTEM_SHARED_LIBRARY_SHARED);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="1-5-3-ephemeral-app-安装准备"><a href="#1-5-3-ephemeral-app-安装准备" class="headerlink" title="1.5.3. ephemeral app 安装准备"></a>1.5.3. ephemeral app 安装准备</h3><ul>
<li>获取解析ephemeral app 的组件</li>
<li>获取安装ephemeral app 的组件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">ComponentName</span> <span class="variable">ephemeralResolverComponent</span> <span class="operator">=</span> getEphemeralResolverLPr();</span><br><span class="line"><span class="keyword">final</span> <span class="type">ComponentName</span> <span class="variable">ephemeralInstallerComponent</span> <span class="operator">=</span> getEphemeralInstallerLPr();</span><br><span class="line"><span class="comment">// both the installer and resolver must be present to enable ephemeral</span></span><br><span class="line"><span class="keyword">if</span> (ephemeralInstallerComponent != <span class="literal">null</span> &amp;&amp; ephemeralResolverComponent != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">&quot;Ephemeral activated; resolver: &quot;</span> + ephemeralResolverComponent</span><br><span class="line">                + <span class="string">&quot; installer:&quot;</span> + ephemeralInstallerComponent);</span><br><span class="line">    &#125;</span><br><span class="line">    mEphemeralResolverComponent = ephemeralResolverComponent;</span><br><span class="line">    mEphemeralInstallerComponent = ephemeralInstallerComponent;</span><br><span class="line">    <span class="comment">// 初始化mEphemeralInstallerActivity 对应 ActivityInfo数据的基础信息</span></span><br><span class="line">    setUpEphemeralInstallerActivityLP(mEphemeralInstallerComponent);</span><br><span class="line">    mEphemeralResolverConnection =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">EphemeralResolverConnection</span>(mContext, mEphemeralResolverComponent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-5-4-注册PackageManagerInternal-私有LOCAL-service服务"><a href="#1-5-4-注册PackageManagerInternal-私有LOCAL-service服务" class="headerlink" title="1.5.4. 注册PackageManagerInternal 私有LOCAL service服务"></a>1.5.4. 注册PackageManagerInternal 私有LOCAL service服务</h3><p>通过该local service, server进程内的所有服务可以通过其公布的接口拿到或设置一些组件的信息</p>
<p>具体可以查看 PackageManagerInternalImpl类</p>
<p>如使用<code>getHomeActivitiesAsUser</code> 查询 home activity的component name</p>
<p>至此, pkms的构造函数执行完毕.</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/AndroidN/" rel="tag"># AndroidN</a>
              <a href="/tags/PackageManagerService/" rel="tag"># PackageManagerService</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2017/08/02/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/PackageManagerService%E5%90%AF%E5%8A%A8%E7%AF%87%E6%95%B4%E7%90%862/" rel="prev" title="PackageManagerService启动篇整理2">
      <i class="fa fa-chevron-left"></i> PackageManagerService启动篇整理2
    </a></div>
      <div class="post-nav-item">
    <a href="/2017/08/02/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/%E9%80%9A%E8%BF%87adb%20install%20%E5%AE%89%E8%A3%85apk/" rel="next" title="通过adb install 安装apk">
      通过adb install 安装apk <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-PackageManagerService%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">1. PackageManagerService的启动过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-BOOT-PROGRESS-PMS-START-%E9%98%B6%E6%AE%B5"><span class="nav-number">1.1.</span> <span class="nav-text">1.1. BOOT_PROGRESS_PMS_START 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1-%E5%88%9D%E5%A7%8B%E5%8C%96Settings%E7%B1%BB"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1.1. 初始化Settings类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-1-1-Settings%E7%B1%BB%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">1.1.1.1. Settings类的作用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-2-%E8%A7%A3%E6%9E%90%E5%B1%9E%E6%80%A7"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.1.2. 解析属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-3-dex%E4%BC%98%E5%8C%96%E7%9B%B8%E5%85%B3"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.1.3. dex优化相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-4-SysConfig%E7%B1%BB%E6%9E%84%E9%80%A0%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.1.4. SysConfig类构造并初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-5-%E5%88%9D%E5%A7%8B%E5%8C%96PackageHandler"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.1.5. 初始化PackageHandler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-6-%E5%88%9D%E5%A7%8B%E5%8C%96UserManagerService-%E5%B9%B6%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7%E7%9B%AE%E5%BD%95"><span class="nav-number">1.1.6.</span> <span class="nav-text">1.1.6. 初始化UserManagerService, 并创建用户目录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-6-1-UserManagerService%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.1.6.1.</span> <span class="nav-text">1.1.6.1. UserManagerService初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-6-2-%E6%B8%85%E7%90%86%E9%83%A8%E5%88%86%E5%88%9B%E5%BB%BA-%E5%88%A0%E9%99%A4%E7%9A%84%E7%94%A8%E6%88%B7"><span class="nav-number">1.1.6.2.</span> <span class="nav-text">1.1.6.2. 清理部分创建&#x2F;删除的用户</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-7-%E5%90%8C%E6%AD%A5SysConfig%E4%B8%AD%E7%9A%84-Permission%E5%88%B0Setting-mPermissions%E4%B8%AD"><span class="nav-number">1.1.7.</span> <span class="nav-text">1.1.7. 同步SysConfig中的 Permission到Setting.mPermissions中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-8-%E8%8E%B7%E5%8F%96%E5%85%B1%E4%BA%AB%E5%BA%93%EF%BC%8C%E5%B0%86%E5%85%B6%E5%8A%A0%E5%85%A5%E5%88%B0mSharedLibraries%E5%B9%B6%E5%8A%A0%E5%85%A5%E5%88%B0%E4%BC%98%E5%8C%96%E9%9B%86%E5%90%88%E4%B8%AD"><span class="nav-number">1.1.8.</span> <span class="nav-text">1.1.8. 获取共享库，将其加入到mSharedLibraries并加入到优化集合中</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-BOOT-PROGRESS-PMS-SYSTEM-SCAN-START-%E9%98%B6%E6%AE%B5"><span class="nav-number">1.2.</span> <span class="nav-text">1.2. BOOT_PROGRESS_PMS_SYSTEM_SCAN_START 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-dex%E4%BC%98%E5%8C%96%E5%88%A4%E5%AE%9A"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1. dex优化判定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-pre-M%E7%89%88%E6%9C%ACapk%E5%8D%87%E7%BA%A7%E6%9D%83%E9%99%90install-runtime%E5%88%A4%E6%96%AD"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2.2. pre-M版本apk升级权限install-&gt;runtime判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-%E5%BC%80%E5%A7%8B%E6%89%AB%E6%8F%8Fapk"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.2.3. 开始扫描apk</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-3-1-%E5%85%88%E6%89%AB%E6%8F%8F%E8%BF%99%E4%B8%A4%E4%B8%AA%E7%9B%AE%E5%BD%95"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">1.2.3.1. 先扫描这两个目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-3-2-%E5%86%8D%E6%89%AB%E6%8F%8F%E8%BF%99%E5%87%A0%E4%B8%AA%E7%9B%AE%E5%BD%95%E4%B8%8B%E9%9D%A2-system-app"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">1.2.3.2. 再扫描这几个目录下面(system app):</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-2-3-2-1-%E6%89%AB%E6%8F%8Fsystem-app-%E5%90%8E%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-number">1.2.3.2.1.</span> <span class="nav-text">1.2.3.2.1. 扫描system app 后的处理</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-3-3-%E5%A4%84%E7%90%86%E6%9C%AA%E5%AE%89%E8%A3%85%E5%AE%8C%E6%88%90%E7%9A%84app"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">1.2.3.3. 处理未安装完成的app</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-3-4-%E5%88%A0%E9%99%A4%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E4%BB%A5%E5%8F%8A%E5%88%A0%E9%99%A4%E6%B2%A1%E6%9C%89%E5%85%B3%E8%81%94%E7%9A%84package%E5%8C%85%E7%9A%84shareUser"><span class="nav-number">1.2.3.4.</span> <span class="nav-text">1.2.3.4. 删除临时文件以及删除没有关联的package包的shareUser</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-BOOT-PROGRESS-PMS-DATA-SCAN-START%E9%98%B6%E6%AE%B5"><span class="nav-number">1.3.</span> <span class="nav-text">1.3. BOOT_PROGRESS_PMS_DATA_SCAN_START阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-1-%E6%9C%80%E5%90%8E%E6%89%AB%E6%8F%8F%E8%BF%99%E5%87%A0%E4%B8%AA%E7%9B%AE%E5%BD%95%E4%B8%8B%E9%9D%A2-data-app"><span class="nav-number">1.3.0.1.</span> <span class="nav-text">1.3.1.1. 最后扫描这几个目录下面(data app):</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-2-possiblyDeletedUpdatedSystemApps%E5%8C%85%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-number">1.3.0.2.</span> <span class="nav-text">1.3.1.2. possiblyDeletedUpdatedSystemApps包的处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-3-mExpectingBetter%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-number">1.3.0.3.</span> <span class="nav-text">1.3.1.3. mExpectingBetter的处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-4-%E8%A7%A3%E6%9E%90%E5%8F%97%E4%BF%9D%E6%8A%A4%E7%9A%84action-filter-setupWizard%E7%9B%B8%E5%85%B3"><span class="nav-number">1.3.0.4.</span> <span class="nav-text">1.3.1.4. 解析受保护的action filter(setupWizard相关)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-5-%E6%89%AB%E6%8F%8F%E7%BB%93%E6%9D%9F%E5%90%8E-%E6%9B%B4%E6%96%B0%E6%89%80%E6%9C%89%E7%9A%84%E5%85%B1%E4%BA%AB%E5%BA%93-%E4%BB%A5%E5%8F%8A%E4%B8%BA%E6%89%80%E6%9C%89%E7%9A%84shareUser%E6%9B%B4%E6%96%B0Abi%E6%9E%B6%E6%9E%84%E9%9B%86"><span class="nav-number">1.3.0.5.</span> <span class="nav-text">1.3.1.5. 扫描结束后,更新所有的共享库,以及为所有的shareUser更新Abi架构集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-6-%E8%AF%BB%E5%8F%96PackageUsage%E6%96%87%E4%BB%B6%E6%9B%B4%E6%96%B0pkg%E7%9A%84mLastPackageUsageTimeInMills%E5%AD%97%E6%AE%B5"><span class="nav-number">1.3.0.6.</span> <span class="nav-text">1.3.1.6. 读取PackageUsage文件更新pkg的mLastPackageUsageTimeInMills字段</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-BOOT-PROGRESS-PMS-SCAN-END"><span class="nav-number">1.4.</span> <span class="nav-text">1.4. BOOT_PROGRESS_PMS_SCAN_END</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-1-1-%E6%9B%B4%E6%96%B0%E8%B5%8B%E4%BA%88%E6%9D%83%E9%99%90-updatePermissionsLPw"><span class="nav-number">1.4.0.1.</span> <span class="nav-text">1.4.1.1. 更新赋予权限 updatePermissionsLPw</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-1-1-1-%E6%9B%B4%E6%96%B0%E6%9D%83%E9%99%90%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.4.0.1.1.</span> <span class="nav-text">1.4.1.1.1. 更新权限流程图</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-1-1-2-%E5%85%B7%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="nav-number">1.4.0.1.2.</span> <span class="nav-text">1.4.1.1.2. 具体流程</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-4-1-1-2-1-updatePermissionsLPw%E5%87%BD%E6%95%B0%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%9C%A8%E5%86%85%E9%83%A8%E5%AD%98%E5%82%A8%E4%B8%8A%E7%9A%84%E5%8C%85"><span class="nav-number">1.4.0.1.2.1.</span> <span class="nav-text">1.4.1.1.2.1. updatePermissionsLPw函数更新数据在内部存储上的包</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-4-1-1-2-2-grantPermissionsLPw%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E6%9D%83%E9%99%90%E6%9B%B4%E6%96%B0%E6%8E%88%E4%BA%88"><span class="nav-number">1.4.0.1.2.2.</span> <span class="nav-text">1.4.1.1.2.2. grantPermissionsLPw函数进行权限更新授予</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-1-2-%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%BC%80%E6%9C%BA%E6%88%96%E8%80%85%E4%BB%8Epre-M%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7%E4%B8%8A%E6%9D%A5-%E9%87%8D%E8%AE%BE%E5%81%8F%E5%A5%BD%E5%BA%94%E7%94%A8"><span class="nav-number">1.4.0.2.</span> <span class="nav-text">1.4.1.2. 第一次开机或者从pre-M版本升级上来,重设偏好应用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-1-3-%E8%B0%83%E6%95%B4%E5%BA%94%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95"><span class="nav-number">1.4.0.3.</span> <span class="nav-text">1.4.1.3. 调整应用的数据目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-1-4-%E5%BD%93%E7%9B%91%E6%B5%8B%E5%88%B0%E4%B8%BA%E5%8D%87%E7%BA%A7%E5%9C%BA%E6%99%AF%E6%97%B6-%E9%9C%80%E8%A6%81%E5%88%A0%E9%99%A4%E5%8E%9F%E6%9D%A5%E5%8C%85%E7%9A%84code-cache"><span class="nav-number">1.4.0.4.</span> <span class="nav-text">1.4.1.4. 当监测到为升级场景时,需要删除原来包的code_cache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-1-5-%E6%9B%B4%E6%96%B0%E5%AE%8C%E5%BA%94%E7%94%A8%E6%9D%83%E9%99%90-%E4%B8%94%E5%81%8F%E5%A5%BD%E5%BA%94%E7%94%A8%E6%9B%B4%E6%96%B0%E5%AE%8C%E6%97%B6-%E9%87%8D%E7%BD%AE%E6%9F%90%E4%BA%9B%E5%AD%97%E6%AE%B5%E5%B9%B6%E5%86%99%E5%85%A5packages-xml"><span class="nav-number">1.4.0.5.</span> <span class="nav-text">1.4.1.5. 更新完应用权限,且偏好应用更新完时,重置某些字段并写入packages.xml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-1-6-%E5%AF%B9core-app%E6%89%A7%E8%A1%8Cdex%E4%BC%98%E5%8C%96"><span class="nav-number">1.4.0.6.</span> <span class="nav-text">1.4.1.6. 对core app执行dex优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-BOOT-PROGRESS-PMS-READY%E9%98%B6%E6%AE%B5"><span class="nav-number">1.5.</span> <span class="nav-text">1.5. BOOT_PROGRESS_PMS_READY阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-1-%E5%88%9D%E5%A7%8B%E5%8C%96PackageInstallerService"><span class="nav-number">1.5.1.</span> <span class="nav-text">1.5.1. 初始化PackageInstallerService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-2-%E4%B8%BA%E5%87%A0%E4%B8%AA%E5%8F%98%E9%87%8F%E8%B5%8B%E5%80%BC"><span class="nav-number">1.5.2.</span> <span class="nav-text">1.5.2. 为几个变量赋值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-3-ephemeral-app-%E5%AE%89%E8%A3%85%E5%87%86%E5%A4%87"><span class="nav-number">1.5.3.</span> <span class="nav-text">1.5.3. ephemeral app 安装准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-4-%E6%B3%A8%E5%86%8CPackageManagerInternal-%E7%A7%81%E6%9C%89LOCAL-service%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.5.4.</span> <span class="nav-text">1.5.4. 注册PackageManagerInternal 私有LOCAL service服务</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liguang.zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">147</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">90</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">102</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liguang.zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'Iv1.b2d7d95e69f1bcd6',
      clientSecret: '7cfd4d9a0c01f1f4399ddfb410db655e9ef7e3b5',
      repo        : 'liguangzhang.github.io',
      owner       : 'LiguangZhang',
      admin       : ['LiguangZhang'],
      id          : 'aad631d74adce6805586f60a2fa8c3b7',
        language: 'zh-CN',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
