<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW WenKai:300,300italic,400,400italic,700,700italic|LXGW WenKai Mono, Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liguangzhang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":{"valine":{"order":-1}},"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="Android 4.4（API 级别 19）引入了存储访问框架 (SAF)。它可以让用户方便的浏览、打开文档、图片和其它的文件。用户可以通过标准的用户界面来浏览文件、打开最近访问的文件。 SAF框架包含下面三个部分:  Document provider:  一种ContentProvider，DocumentsProvider的子类。Android平台内置了多个，例如Downloads，Imag">
<meta property="og:type" content="article">
<meta property="og:title" content="SAF框架">
<meta property="og:url" content="https://liguangzhang.github.io/2018/07/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/SAF%E6%A1%86%E6%9E%B6/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:description" content="Android 4.4（API 级别 19）引入了存储访问框架 (SAF)。它可以让用户方便的浏览、打开文档、图片和其它的文件。用户可以通过标准的用户界面来浏览文件、打开最近访问的文件。 SAF框架包含下面三个部分:  Document provider:  一种ContentProvider，DocumentsProvider的子类。Android平台内置了多个，例如Downloads，Imag">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://liguangzhang.github.io/images/Adapter.jpg">
<meta property="og:image" content="https://liguangzhang.github.io/images/DocumentUI.png">
<meta property="article:published_time" content="2018-06-30T16:00:00.000Z">
<meta property="article:modified_time" content="2024-04-15T09:59:59.471Z">
<meta property="article:author" content="liguang.zhang">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="AndroidP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liguangzhang.github.io/images/Adapter.jpg">

<link rel="canonical" href="https://liguangzhang.github.io/2018/07/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/SAF%E6%A1%86%E6%9E%B6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'" />

  <title>SAF框架 | blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2018/07/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/SAF%E6%A1%86%E6%9E%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SAF框架
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-01 00:00:00" itemprop="dateCreated datePublished" datetime="2018-07-01T00:00:00+08:00">2018-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-15 17:59:59" itemprop="dateModified" datetime="2024-04-15T17:59:59+08:00">2024-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SAF/" itemprop="url" rel="index"><span itemprop="name">SAF</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SAF/DocumentUI/" itemprop="url" rel="index"><span itemprop="name">DocumentUI</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SAF/DocumentUI/ExternalStorageProvider/" itemprop="url" rel="index"><span itemprop="name">ExternalStorageProvider</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/07/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/SAF%E6%A1%86%E6%9E%B6/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/07/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/SAF%E6%A1%86%E6%9E%B6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Android 4.4（API 级别 19）引入了存储访问框架 (SAF)。它可以让用户方便的浏览、打开文档、图片和其它<br>的文件。用户可以通过标准的用户界面来浏览文件、打开最近访问的文件。</p>
<p>SAF框架包含下面三个部分:</p>
<ul>
<li><code>Document provider</code>:<br>  一种ContentProvider，DocumentsProvider的子类。Android平台内置了多个，例如Downloads，Images，Videos</li>
<li><code>Client App</code>:<br>  应用端，调用<code>ACTION_OPEN_DOCUMENT</code>&#x2F;<code>ACTION_CREATE_DOCUMENT</code>，并且接收provider返回的文件</li>
<li><code>Picker</code>:<br>  系统界面，允许用户访问所有满足应用端搜索条件的provider提供的文档。例如平台的<code>DocumentsUI</code></li>
</ul>
<p>SAF 提供的部分功能如下：</p>
<ul>
<li>允许用户浏览所有文档提供程序而不仅仅是单个应用中的内容；</li>
<li>让应用获得对provider所拥有文档的长期、持久性访问权限。 用户可以通过此访问权限添加、编辑、保存<br>和删除提供程序上的文件；</li>
<li>支持多个用户帐户和临时根目录，如只有在插入驱动器后才会出现的 USB 存储提供程序。<br>注意：<br>在SAF中，客户端并不会直接与provider交互。客户端请求与文件交互(即读、编辑、创建、删除)的权限。</li>
</ul>
<h1 id="1-应用端代码示例"><a href="#1-应用端代码示例" class="headerlink" title="1. 应用端代码示例"></a>1. 应用端代码示例</h1><h2 id="1-1-授予目录访问权限"><a href="#1-1-授予目录访问权限" class="headerlink" title="1.1. 授予目录访问权限"></a>1.1. 授予目录访问权限</h2><h3 id="1-1-1-通过ACTION-OPEN-DOCUMENT-TREE授予应用访问特定目录的权限"><a href="#1-1-1-通过ACTION-OPEN-DOCUMENT-TREE授予应用访问特定目录的权限" class="headerlink" title="1.1.1. 通过ACTION_OPEN_DOCUMENT_TREE授予应用访问特定目录的权限"></a>1.1.1. 通过<code>ACTION_OPEN_DOCUMENT_TREE</code>授予应用访问特定目录的权限</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performGrantSdWriteAcess</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_OPEN_DOCUMENT_TREE);</span><br><span class="line">	intent.addCategory(Intent.CATEGORY_DEFAULT);</span><br><span class="line">	startActivityForResult(intent, TREE_REQUEST_CODE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>DocumentsUi</code> picker 选择好目录后，可以在<code>onActivityResult</code>中对返回的URI进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode, <span class="type">int</span> resultCode, Intent resultData)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span>(requestCode == TREE_REQUEST_CODE &amp;&amp; resultData == Activity.RESULT_OK) &#123;</span><br><span class="line">		<span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span>(resultData != <span class="literal">null</span>) &#123;</span><br><span class="line">			uri = resultData.getData();</span><br><span class="line">			<span class="keyword">final</span> <span class="type">int</span> <span class="variable">takeFlags</span> <span class="operator">=</span> resultData.getFlags() &amp;</span><br><span class="line">				(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line">			<span class="comment">//授予权限</span></span><br><span class="line">			getContentResolver().takePersistableUriPermission(uri, takeFlags);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在选择好的目录中新建文件或目录:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTree</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">Uri</span> <span class="variable">doc</span> <span class="operator">=</span> DocumentsContract.buildDocumentUriUsingTree(uri, DocumentsContract.getTreeDocumentId(uri));</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="type">Uri</span> <span class="variable">pic</span> <span class="operator">=</span> DocumentsContract.createDocument(getContentResolver(), doc, <span class="string">&quot;image/png&quot;</span>, <span class="string">&quot;test.png&quot;</span>);</span><br><span class="line">		<span class="type">Uri</span> <span class="variable">dir</span> <span class="operator">=</span> DocumentsContract.createDocument(getContentResolver(), doc, DocumentsContract.Document.MIME_TYPE_DIR, <span class="string">&quot;testDir&quot;</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-2-通过ACTION-OPEN-EXTERNAL-DIRECTORY授予应用目录访问权限"><a href="#1-1-2-通过ACTION-OPEN-EXTERNAL-DIRECTORY授予应用目录访问权限" class="headerlink" title="1.1.2. 通过ACTION_OPEN_EXTERNAL_DIRECTORY授予应用目录访问权限"></a>1.1.2. 通过<code>ACTION_OPEN_EXTERNAL_DIRECTORY</code>授予应用目录访问权限</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onScopedDirectoryTest</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="type">StorgeManager</span> <span class="variable">sm</span> <span class="operator">=</span> (StorageManager) getApplicationContext().getSystemService(Context.STORAGE_SERVICE);</span><br><span class="line">	<span class="keyword">final</span> List&lt;StorageVolume&gt; volumes = sm.getStorageVolumes();</span><br><span class="line">	<span class="keyword">for</span>(StorageVolume volume: volumes) &#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> volume.createAccessIntent();</span><br><span class="line">           <span class="type">String</span> <span class="variable">volumePath</span> <span class="operator">=</span> volume.getPath();</span><br><span class="line">		<span class="keyword">if</span>(Environment.getExterStorageState(volumePath).equals(Environment.MEDIA_MOUNTED) &amp;&amp; </span><br><span class="line">			volumePath.equals(EnvironmentEx.getExternalStoragePath())) &#123;</span><br><span class="line">			<span class="comment">// for sdcard</span></span><br><span class="line">			<span class="keyword">if</span>(intent != <span class="literal">null</span>) &#123;</span><br><span class="line">				startActivityForResult(intent, SCOPED_REQUEST_CODE);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="meta">@Nullable</span> Intent <span class="title function_">createAccessIntent</span><span class="params">(String directoryName)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> ((isPrimary() &amp;&amp; directoryName == <span class="literal">null</span>) ||</span><br><span class="line">               (directoryName != <span class="literal">null</span> &amp;&amp; !Environment.isStandardDirectory(directoryName))) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(ACTION_OPEN_EXTERNAL_DIRECTORY);</span><br><span class="line">       intent.putExtra(EXTRA_STORAGE_VOLUME, <span class="built_in">this</span>);</span><br><span class="line">       intent.putExtra(EXTRA_DIRECTORY_NAME, directoryName);</span><br><span class="line">       <span class="keyword">return</span> intent;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>弹出DocumentUI的请求授予该存储的对话框</p>
<h2 id="1-2-文档搜索"><a href="#1-2-文档搜索" class="headerlink" title="1.2. 文档搜索"></a>1.2. 文档搜索</h2><h3 id="1-2-1-通过ACTION-OPEN-DOCUMENT实现搜索文件"><a href="#1-2-1-通过ACTION-OPEN-DOCUMENT实现搜索文件" class="headerlink" title="1.2.1. 通过ACTION_OPEN_DOCUMENT实现搜索文件"></a>1.2.1. 通过<code>ACTION_OPEN_DOCUMENT</code>实现搜索文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performFileSearch</span><span class="params">(String type)</span> &#123;</span><br><span class="line">	<span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_OPEN_DOCUMENT);</span><br><span class="line">	intent.addCategory(Intent.CATEGORY_OPENABLE);</span><br><span class="line">	<span class="comment">// 设置搜索类型</span></span><br><span class="line">	intent.setType(type);</span><br><span class="line">	startActivityForResult(intent, READ_REQUEST_CODE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在选中目标后，可以在onActivityResult中对返回的URI根据自身的业务逻辑进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode, <span class="type">int</span> resultCode, Intent resultData)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span>(requestCode == TREE_REQUEST_CODE &amp;&amp; resultData == Activity.RESULT_OK) &#123;</span><br><span class="line">		<span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span>(resultData != <span class="literal">null</span>) &#123;</span><br><span class="line">			uri = resultData.getData();</span><br><span class="line">            <span class="comment">//如搜索到的是图片时,显示图片</span></span><br><span class="line">            getBitmapFromUri(uri);</span><br><span class="line">            <span class="comment">//搜索到的是文本时,读取其中内容</span></span><br><span class="line">            readTextFromUri(uri);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Bitmap <span class="title function_">getBitmapFromUri</span><span class="params">(Uri uri)</span> <span class="keyword">throws</span> IoException &#123;</span><br><span class="line">	<span class="type">ParcelFileDescriptor</span> <span class="variable">pfd</span> <span class="operator">=</span> getContentResolver().openFileDescriptor(uri, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="type">FileDescriptor</span> <span class="variable">fd</span> <span class="operator">=</span> pfd.getFileDescriptor();</span><br><span class="line">	<span class="type">Bitmap</span> <span class="variable">image</span> <span class="operator">=</span> BitmapFactory.decodeFileDescriptor(fd);</span><br><span class="line">	pfd.close();</span><br><span class="line">	<span class="keyword">return</span> image;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">readTextFromUri</span><span class="params">(Uri uri)</span> <span class="keyword">throws</span> IoException&#123;</span><br><span class="line">	<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> getContentResolver().openInputStream(uri);</span><br><span class="line">	<span class="type">BufferReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(is));</span><br><span class="line">	String line;</span><br><span class="line">	<span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>()</span><br><span class="line">	<span class="keyword">while</span>((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">		sb.append(line);</span><br><span class="line">	&#125;</span><br><span class="line">	is.close();</span><br><span class="line">	<span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-3-文档创建"><a href="#1-3-文档创建" class="headerlink" title="1.3. 文档创建"></a>1.3. 文档创建</h2><h3 id="1-3-1-通过ACTION-CREATE-DOCUMENT-创建文档"><a href="#1-3-1-通过ACTION-CREATE-DOCUMENT-创建文档" class="headerlink" title="1.3.1. 通过ACTION_CREATE_DOCUMENT 创建文档"></a>1.3.1. 通过<code>ACTION_CREATE_DOCUMENT</code> 创建文档</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// performCreateFile(&quot;image/png&quot;, &quot;test.png&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performCreateFile</span><span class="params">(String type, String fileName)</span> &#123;</span><br><span class="line">	<span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_CREATE_DOCUMENT);</span><br><span class="line">	intent.addCategory(Intent.CATEGORY_OPENABLE);</span><br><span class="line">	intent.setType(type);</span><br><span class="line">	intent.putExtra(Intent.EXTRA_TITLE, fileName);</span><br><span class="line">	startActivityForResult(intent, WRITE_REQUEST_CODE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过pickerUi, 可以选择新建文件的位置以及文件名, 可以在返回结果中对新返回的文档的uri进行处理.</p>
<h2 id="1-4-文档编辑"><a href="#1-4-文档编辑" class="headerlink" title="1.4. 文档编辑"></a>1.4. 文档编辑</h2><h3 id="1-4-1-通过ACTION-OPEN-DOCUMENT-编辑文档"><a href="#1-4-1-通过ACTION-OPEN-DOCUMENT-编辑文档" class="headerlink" title="1.4.1. 通过ACTION_OPEN_DOCUMENT 编辑文档"></a>1.4.1. 通过<code>ACTION_OPEN_DOCUMENT</code> 编辑文档</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">editFile</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_OPEN_DOCUMENT);</span><br><span class="line">	intent.addCategory(Intent.CATEGORY_OPENABLE);</span><br><span class="line">	intent.setType(<span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">	startActivityForResult(intent, EDIT_REQUEST_CODE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过pickerUi 选择要编辑的文档, 选择完成后, 在返回结果中对文档进行编辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode, <span class="type">int</span> resultCode, Intent resultData)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span>(requestCode == TREE_REQUEST_CODE &amp;&amp; resultData == Activity.RESULT_OK) &#123;</span><br><span class="line">		<span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span>(resultData != <span class="literal">null</span>) &#123;</span><br><span class="line">			uri = resultData.getData();</span><br><span class="line">			writeDocument(uri);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">writeDocument</span><span class="params">(Uri uri)</span> &#123;</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		<span class="type">ParcelFileDescriptor</span> <span class="variable">pfd</span> <span class="operator">=</span> getContentResolver().openFileDescriptor(uri, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">		<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(pfd.getFileDescriptor());</span><br><span class="line">		fos.write(<span class="string">&quot;write test code&quot;</span>);</span><br><span class="line">		fos.close();</span><br><span class="line">		pfd.close();</span><br><span class="line">	&#125; <span class="keyword">catch</span>(FileNotFoundException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125; <span class="keyword">catch</span>(IOException) &#123;</span><br><span class="line">		<span class="comment">//to do</span></span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-5-删除文档"><a href="#1-5-删除文档" class="headerlink" title="1.5. 删除文档"></a>1.5. 删除文档</h2><p>如果获得了文档的uri, 且文档的 Document.COLUMN_FLAGS 包含 <code>SUPPORTS_DELETE</code>，便可以删除该文档</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DocumentsContract.deleteDocument(getContentResolver(), uri);</span><br></pre></td></tr></table></figure>

<p>在设置-存储-sd卡进入DocumentsUI，任意选中一个文档查看信息, 可以看到文档是否包含<code>SUPPORTS_DELETE</code></p>
<h2 id="1-6-保留权限"><a href="#1-6-保留权限" class="headerlink" title="1.6. 保留权限"></a>1.6. 保留权限</h2><p>当您的应用打开文件进行读取或写入时，系统会为您的应用提供针对该文件的 URI 授权。 该授权将一直持续到用户设备<code>重启</code>时。但假定您的应用是图像编辑应用，而且您希望用户能够直接从应用中访问他们编辑的最后5 张图像。 如果用户的设备已经重启，您就需要将用户转回系统选取器以查找这些文件，这显然不是理想的做法。<br>为防止出现这种情况，您可以<em>保留系统为您的应用授予的权限</em>。 您的应用实际上是<code>获取</code>了系统提供的持<br>久 URI 授权。 这使用户能够通过您的应用持续访问文件，即使设备已重启也不受影响：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">takeFlags</span> <span class="operator">=</span> intent.getFlags()</span><br><span class="line">	&amp; (Intent.FLAG_GRANT_READ_URI_PERMISSION</span><br><span class="line">    | Intent.FLAG_GRANT_WRITE_URI_PERMISSION); </span><br><span class="line"></span><br><span class="line"><span class="comment">// Check for the freshest data.</span></span><br><span class="line">getContentResolver().takePersistableUriPermission(uri, takeFlags);</span><br></pre></td></tr></table></figure>

<h1 id="2-DocumentUi-相关调用解析"><a href="#2-DocumentUi-相关调用解析" class="headerlink" title="2. DocumentUi 相关调用解析"></a>2. DocumentUi 相关调用解析</h1><p>对应上述客户端的调用, startActivity解析出来跳转的分别是<code>PickActivity</code>和<code>ScopedAccessActivity</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.picker.PickActivity&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@style/DocumentsTheme&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:visibleToInstantApps</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.OPEN_DOCUMENT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.OPENABLE&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">&quot;*/*&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.CREATE_DOCUMENT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.OPENABLE&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">&quot;*/*&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.GET_CONTENT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.OPENABLE&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">&quot;*/*&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.OPEN_DOCUMENT_TREE&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.ScopedAccessActivity&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@android:style/Theme.Translucent.NoTitleBar&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.os.storage.action.OPEN_EXTERNAL_DIRECTORY&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-1-ACTION-OPEN-EXTERNAL-DIRECTORY-授权外部存储权限流程解析"><a href="#2-1-ACTION-OPEN-EXTERNAL-DIRECTORY-授权外部存储权限流程解析" class="headerlink" title="2.1. ACTION_OPEN_EXTERNAL_DIRECTORY 授权外部存储权限流程解析"></a>2.1. <code>ACTION_OPEN_EXTERNAL_DIRECTORY</code> 授权外部存储权限流程解析</h2><p>在应用端调用startActivity后跳转到<code>ScopedAccessActivity</code><br>看下provider&#x2F;activity&#x2F;client app 三者的调用关系</p>
<ul>
<li>ExternalStorageProvider</li>
<li>ScopedAccessActivity</li>
<li>client app</li>
</ul>
<ol>
<li>client app 发起 startActivity请求</li>
<li>跳转到ScopedAccessActivity的onCreate函数中<br>  a.先从保存的sharePreference中检查key为userId + “|” + packageName + “|” + uuid + “|” + directory的是否指定了<br>  <code>   PERMISSION_NEVER_ASK</code>, 该动作是在弹出对话框点击不允许时勾选的,如果是这种情况,直接退出,返回给clientapp的结果为cancel.<br>  b. 调用showFragment弹出对话框提示用户是否给予给定的volume+directory权限.<br>  c. 判断目录是否是<code>STANDARD_DIRECTORIES</code>, 不是返回deny</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] STANDARD_DIRECTORIES = &#123;</span><br><span class="line">        DIRECTORY_MUSIC,</span><br><span class="line">        DIRECTORY_PODCASTS,</span><br><span class="line">        DIRECTORY_RINGTONES,</span><br><span class="line">        DIRECTORY_ALARMS,</span><br><span class="line">        DIRECTORY_NOTIFICATIONS,</span><br><span class="line">        DIRECTORY_PICTURES,</span><br><span class="line">        DIRECTORY_MOVIES,</span><br><span class="line">        DIRECTORY_DOWNLOADS,</span><br><span class="line">        DIRECTORY_DCIM,</span><br><span class="line">        DIRECTORY_DOCUMENTS</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<pre><code>   d. 对当前存储卷进行遍历, 查找给定volume directory匹配的卷和目录   
</code></pre>
<p>​	查找到卷, 对于外部存储, 通过<code>getInternalPathForUser</code>方法转换了路径</p>
<blockquote>
<p>return new File(path.replace(“&#x2F;storage&#x2F;“, “&#x2F;mnt&#x2F;media_rw&#x2F;“));</p>
</blockquote>
<pre><code>  e. 调用getUriPermission返回requestedUri, 通过检索AUTHORITY名获得对应的provider实例, 调用provider的		getDocIdForFileCreateNewDir方法
   最终调用到ExternalStorageProvider的 `getDocIdForFileMaybeCreate`方法,返回对应volume的 rootId + &#39;:&#39; + path; 最终返回通过buildTreeDocumentUri构造完的uri
</code></pre>
<blockquote>
<p> rootid为fsuuid</p>
<p> requestedUri格式  content:&#x2F;&#x2F;com.android.externalstorage.documents&#x2F;tree&#x2F;fsuuid:path ,path为相对volume root的路径.</p>
<p> 构造requestedUri和rootUri, 请求uri和rooturi</p>
</blockquote>
<p>​	g. 回调callback, 此处开始真正检查是否有权限, 没有权限需要弹出对话框让用户选择授予还是拒绝, <code>getIntentForExistingPermission</code>检查权限, 最终是通过<code>AMS</code>的<code>getGrantedUriPermissions</code>检查是否对package授予了该uri权限,遍历ams的<code>mGrantedUriPermissions</code>map ArrayMap&lt;GrantUri, UriPermission&gt;.<br> 检查是否匹配requestedUri或rootUri,如果匹配返回<code>createGrantedUriPermissionsIntent(requestedUri)</code>的intent, intent的data字段保存uri, flag中保存权限信息. 最终将该intent返回给clientapp.<br>如果没有授权, 即没在map中, 弹出对话框ScopedAccessDialogFragment, <strong>点击允许按钮</strong>, 调用<code>createGrantedUriPermissionsIntent</code>, 最终还是跟上面的步骤一样返回<code>createGrantedUriPermissionsIntent(requestedUri)</code>的intent, intent的data字段保存uri, flag中保存权限信息. 最终将该intent返回给clientapp.<br><em><strong>点击拒绝</strong></em>, 如果勾选never ask, 以userId + “|” + packageName + “|” + uuid + “|” + directory为key保存<code>PERMISSION_NEVER_ASK</code>的sharePref</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">synchronized</span> ContentProviderClient <span class="title function_">getExternalStorageClient</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mExternalStorageClient == <span class="literal">null</span>) &#123;</span><br><span class="line">        mExternalStorageClient =</span><br><span class="line">                getContentResolver().acquireContentProviderClient(Providers.AUTHORITY_STORAGE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mExternalStorageClient;</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  bundle = storageProvider.call(<span class="string">&quot;getDocIdForFileCreateNewDir&quot;</span>, file.getPath(), <span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">String</span> <span class="variable">docId</span> <span class="operator">=</span> bundle == <span class="literal">null</span> ? <span class="literal">null</span> : bundle.getString(<span class="string">&quot;DOC_ID&quot;</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> DocumentsContract.buildTreeDocumentUri(Providers.AUTHORITY_STORAGE, docId);</span><br><span class="line">  <span class="keyword">return</span> uri;</span><br><span class="line">  ...</span><br><span class="line">  requestedUri = uri;</span><br><span class="line">  <span class="comment">// 请求目录和根目录的uri.</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">Uri</span> <span class="variable">rootUri</span> <span class="operator">=</span> internalRoot.equals(file) ? requestedUri</span><br><span class="line">            : getUriPermission(context, storageClient, internalRoot);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 上述流程走完, 回调该callback</span></span><br><span class="line">  (file, volumeLabel, isRoot, isPrimary, grantedUri, rootUri) -&gt; &#123;</span><br><span class="line">                <span class="comment">// Checks if the user has granted the permission already.</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntentForExistingPermission(activity,</span><br><span class="line">                        activity.getCallingPackage(), grantedUri, rootUri);</span><br><span class="line">                <span class="keyword">if</span> (intent != <span class="literal">null</span>) &#123;</span><br><span class="line">                    activity.setResult(RESULT_OK, intent);</span><br><span class="line">                    activity.finish();</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Gets the package label.</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">appLabel</span> <span class="operator">=</span> getAppLabel(activity);</span><br><span class="line">                <span class="keyword">if</span> (appLabel == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Error already logged.</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Sets args that will be retrieve on onCreate()</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">args</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">                args.putString(EXTRA_FILE, file.getAbsolutePath());</span><br><span class="line">                args.putString(EXTRA_VOLUME_LABEL, volumeLabel);</span><br><span class="line">                args.putString(EXTRA_VOLUME_UUID, storageVolume.getUuid());</span><br><span class="line">                args.putString(EXTRA_APP_LABEL, appLabel);</span><br><span class="line">                args.putBoolean(EXTRA_IS_ROOT, isRoot);</span><br><span class="line">                args.putBoolean(EXTRA_IS_PRIMARY, isPrimary);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="type">FragmentManager</span> <span class="variable">fm</span> <span class="operator">=</span> activity.getFragmentManager();</span><br><span class="line">                <span class="keyword">final</span> <span class="type">FragmentTransaction</span> <span class="variable">ft</span> <span class="operator">=</span> fm.beginTransaction();</span><br><span class="line">                <span class="keyword">final</span> <span class="type">ScopedAccessDialogFragment</span> <span class="variable">fragment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScopedAccessDialogFragment</span>();</span><br><span class="line">                fragment.setArguments(args);</span><br><span class="line">                ft.add(fragment, FM_TAG);</span><br><span class="line">                ft.commitAllowingStateLoss();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="comment">//如果上面没有检查到授权, 没在map中弹出ScopedAccessDialogFragment对话框</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> &#123;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (which == DialogInterface.BUTTON_POSITIVE) &#123;</span><br><span class="line">                	<span class="comment">// 点击允许</span></span><br><span class="line">                    intent = createGrantedUriPermissionsIntent(mActivity,</span><br><span class="line">                            mActivity.getExternalStorageClient(), mFile);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 点击拒绝</span></span><br><span class="line">                <span class="keyword">if</span> (which == DialogInterface.BUTTON_NEGATIVE || intent == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">checked</span> <span class="operator">=</span> mDontAskAgain.isChecked();</span><br><span class="line">                    <span class="keyword">if</span> (checked) &#123;</span><br><span class="line">                        logValidScopedAccessRequest(mActivity, directory,</span><br><span class="line">                                SCOPED_DIRECTORY_ACCESS_DENIED_AND_PERSIST);</span><br><span class="line">                        setScopedAccessPermissionStatus(context, mActivity.getCallingPackage(),</span><br><span class="line">                                mVolumeUuid, directoryName, PERMISSION_NEVER_ASK);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        setScopedAccessPermissionStatus(context, mActivity.getCallingPackage(),</span><br><span class="line">                                mVolumeUuid, directoryName, PERMISSION_ASK_AGAIN);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mActivity.setResult(RESULT_CANCELED);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logValidScopedAccessRequest(mActivity, directory,</span><br><span class="line">                            SCOPED_DIRECTORY_ACCESS_GRANTED);</span><br><span class="line">                    mActivity.setResult(RESULT_OK, intent);</span><br><span class="line">                &#125;</span><br><span class="line">                mActivity.finish();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>跳转到clientApp的onActivityResult中, 需要调用<code>takePersistableUriPermission</code>来持久化权限. 该函数最终会调用到ams中.最终保存到&#x2F;data&#x2F;system&#x2F;urigrants.xml文件中.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (resultCode == Activity.RESULT_OK) &#123;</span><br><span class="line">    <span class="keyword">if</span>(requestCode == REQUEST_CODE)&#123;</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (data != <span class="literal">null</span>) &#123;</span><br><span class="line">            uri = data.getData();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ContentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> getContentResolver();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">modeFlags</span> <span class="operator">=</span> data.getFlags() &amp; (Intent.FLAG_GRANT_READ_URI_PERMISSION</span><br><span class="line">                                    | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);<span class="number">32</span></span><br><span class="line">            resolver.takePersistableUriPermission(uri, modeFlags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-通过ACTION-CREATE-DOCUMENT-创建文档调用流程分析"><a href="#2-2-通过ACTION-CREATE-DOCUMENT-创建文档调用流程分析" class="headerlink" title="2.2. 通过ACTION_CREATE_DOCUMENT 创建文档调用流程分析"></a>2.2. 通过<code>ACTION_CREATE_DOCUMENT</code> 创建文档调用流程分析</h2><p>跳转到pickui, 因为在AndroidManifest中的声明.<br>先跳转到pickActivitity的<code>onCreate</code>函数中. </p>
<ol>
<li>onCreate函数中首先初始化一些特性属性manager等, 绑定到Injector上.</li>
<li>调用super.onCreate(icicle); 初始化一些属性, 如action. 跳转到BaseActivity的onCreate </li>
<li>通过setupLayout 设置布局</li>
<li>initLocation初始化当前位置.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册器, 保存了相关的特性, 后面都由该类访问</span></span><br><span class="line">mInjector = <span class="keyword">new</span> <span class="title class_">Injector</span>&lt;&gt;(</span><br><span class="line">                features,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Config</span>(),</span><br><span class="line">                prefs,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">MessageBuilder</span>(<span class="built_in">this</span>),</span><br><span class="line">                DialogController.create(features, <span class="built_in">this</span>, <span class="literal">null</span>),</span><br><span class="line">                DocumentsApplication.getFileTypeLookup(<span class="built_in">this</span>),</span><br><span class="line">                (Collection&lt;RootInfo&gt; roots) -&gt; &#123;&#125;);</span><br><span class="line"><span class="comment">//如selectionMgr/menuManager/focusManager/actionModeController/searchManager 管理文档的各种特性, </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//注意这几个</span></span><br><span class="line"><span class="comment">// 跳转到BaseActivity的onCreate</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化state</span></span><br><span class="line">mState = getState(icicle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> State <span class="title function_">getState</span><span class="params">(<span class="meta">@Nullable</span> Bundle icicle)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">State</span> <span class="variable">state</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">State</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line"></span><br><span class="line">        state.sortModel = SortModel.createModel();</span><br><span class="line">        state.localOnly = intent.getBooleanExtra(Intent.EXTRA_LOCAL_ONLY, <span class="literal">false</span>);</span><br><span class="line">        state.excludedAuthorities = getExcludedAuthorities();</span><br><span class="line">        <span class="comment">// 对state的action进行赋值, 根据传进来的action</span></span><br><span class="line">        includeState(state);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 跳到子类pickActivity的 includeState函数中 对应ACTION_CREATE_DOCUMENT类型</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_CREATE_DOCUMENT.equals(action)) &#123;</span><br><span class="line">            state.action = ACTION_CREATE;</span><br><span class="line">        <span class="comment">///////</span></span><br><span class="line"></span><br><span class="line">        state.showAdvanced = Shared.mustShowDeviceRoot(intent)</span><br><span class="line">                || mInjector.prefs.getShowDeviceRoot();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Only show the toggle if advanced isn&#x27;t forced enabled.</span></span><br><span class="line">        state.showDeviceStorageOption = !Shared.mustShowDeviceRoot(intent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">mProviders = DocumentsApplication.getProvidersCache(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//下面有几个布局相关的</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PickActivity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(R.layout.documents_activity, TAG);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 相关布局情况请看 DocumentsUI/res/layout/drawer_layout.xml文件</span></span><br><span class="line">    mLayoutId = R.layout.documents_activity</span><br><span class="line"><span class="title function_">setContentView</span><span class="params">(mLayoutId)</span>;</span><br><span class="line">mNavigator = <span class="keyword">new</span> <span class="title class_">NavigationViewManager</span>(mDrawer, toolbar, mState, <span class="built_in">this</span>, breadcrumb);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DocumentsApplication.getFileTypeLookup(<span class="built_in">this</span>),</span><br><span class="line">        mInjector.actions = <span class="keyword">new</span> <span class="title class_">ActionHandler</span>&lt;&gt;(</span><br><span class="line">                <span class="built_in">this</span>,</span><br><span class="line">                mState,</span><br><span class="line">                mProviders,</span><br><span class="line">                mDocs,</span><br><span class="line">                mSearchManager,</span><br><span class="line">                ProviderExecutor::forAuthority,</span><br><span class="line">                mInjector,</span><br><span class="line">                mLastAccessed);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">//setupLayout 根据action跳转到不同的布局fragment中</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupLayout</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mState.action == ACTION_CREATE) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> intent.getType();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> intent.getStringExtra(Intent.EXTRA_TITLE);</span><br><span class="line">            SaveFragment.show(getFragmentManager(), mimeType, title);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mState.action == ACTION_OPEN_TREE ||</span><br><span class="line">                   mState.action == ACTION_PICK_COPY_DESTINATION) &#123;</span><br><span class="line">            PickFragment.show(getFragmentManager());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mState.action == ACTION_GET_CONTENT) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">moreApps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(intent);</span><br><span class="line">            moreApps.setComponent(<span class="literal">null</span>);</span><br><span class="line">            moreApps.setPackage(<span class="literal">null</span>);</span><br><span class="line">            RootsFragment.show(getFragmentManager(), moreApps);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mState.action == ACTION_OPEN ||</span><br><span class="line">                   mState.action == ACTION_CREATE ||</span><br><span class="line">                   mState.action == ACTION_OPEN_TREE ||</span><br><span class="line">                   mState.action == ACTION_PICK_COPY_DESTINATION) &#123;</span><br><span class="line">            RootsFragment.show(getFragmentManager(), (Intent) <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>initLocation当前位置, 主要与startActivity后初始打开的document位置有关, 下面的参数都是clientapp调用时带的, 如下面指定<code>EXTRA_INITIAL_URI</code>的方式</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    intent.setAction(Intent.ACTION_CREATE_DOCUMENT);</span><br><span class="line">    intent.setType(<span class="string">&quot;plain/text&quot;</span>);</span><br><span class="line">    intent.putExtra(DocumentsContract.EXTRA_INITIAL_URI, docUri);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initLocation</span><span class="params">(Intent intent)</span> &#123;   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// stack is initialized if it&#x27;s restored from bundle, which means we&#x27;re restoring a</span></span><br><span class="line">    <span class="comment">// previously stored state.</span></span><br><span class="line">    <span class="keyword">if</span> (mState.stack.isInitialized()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Stack already resolved for uri: &quot;</span> + intent.getData());</span><br><span class="line">        restoreRootAndDirectory();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (launchHomeForCopyDestination(intent)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Launching directly into Home directory for copy destination.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFeatures.isLaunchToDocumentEnabled() &amp;&amp; launchToDocument(intent)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Launched to a document.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Load last accessed stack.&quot;</span>);</span><br><span class="line">    loadLastAccessedStack();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>我们这里从最普遍的场景进行分析, 进来后跳转到 <code>SaveFragment</code></p>
<h3 id="2-2-1-SaveFragment"><a href="#2-2-1-SaveFragment" class="headerlink" title="2.2.1. SaveFragment"></a>2.2.1. SaveFragment</h3><p>SaveFragment.show(getFragmentManager(), mimeType, title);</p>
<p>&#x2F;&#x2F; clientapp传入的type filename</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 布局置换, 在前面介绍的drawer_layout.xml布局文件中包含该布局</span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">&quot;@layout/directory_cluster&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">(FragmentManager fm, String mimeType, String displayName)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">args</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">    args.putString(EXTRA_MIME_TYPE, mimeType);   <span class="comment">// clientapp</span></span><br><span class="line">    args.putString(EXTRA_DISPLAY_NAME, displayName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">SaveFragment</span> <span class="variable">fragment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SaveFragment</span>();</span><br><span class="line">    fragment.setArguments(args);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">FragmentTransaction</span> <span class="variable">ft</span> <span class="operator">=</span> fm.beginTransaction();</span><br><span class="line">    <span class="comment">// saveframent填入该布局</span></span><br><span class="line">    ft.replace(R.id.container_save, fragment, TAG);</span><br><span class="line">    ft.commitAllowingStateLoss();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-1-fragment生命周期"><a href="#2-2-1-1-fragment生命周期" class="headerlink" title="2.2.1.1. fragment生命周期"></a>2.2.1.1. fragment生命周期</h4><p>Fragment is added<br> |<br>onAttach<br>onCreate<br>onCreateView<br>onActivityCreated<br>onStart<br>onResume<br> ||<br>Fragment is active<br> ||<br>onPause<br>onStop<br>onDestroyView<br>onDestroy<br>onDetach<br>|||<br>Fragment is destroyed</p>
<h5 id="2-2-1-1-1-生命周期分析"><a href="#2-2-1-1-1-生命周期分析" class="headerlink" title="2.2.1.1.1. 生命周期分析"></a>2.2.1.1.1. 生命周期分析</h5><ol>
<li>当一个fragment被创建的时候，它会经历以下状态.</li>
</ol>
<p>onAttach()<br>onCreate()<br>onCreateView()<br>onActivityCreated()</p>
<ol start="2">
<li>当这个fragment对用户可见的时候，它会经历以下状态。</li>
</ol>
<p>onStart()<br>onResume()</p>
<ol start="3">
<li>当这个fragment进入“后台模式”的时候，它会经历以下状态。</li>
</ol>
<p>onPause()<br>onStop()</p>
<ol start="4">
<li>当这个fragment被销毁了（或者持有它的activity被销毁了），它会经历以下状态。</li>
</ol>
<p>onPause()<br>onStop()<br>onDestroyView()<br>onDestroy() &#x2F;&#x2F; 本来漏掉类这个回调，感谢xiangxue336提出。<br>onDetach()</p>
<ol start="5">
<li>就像activities一样，在以下的状态中，可以使用Bundle对象保存一个fragment的对象。</li>
</ol>
<p>onCreate()<br>onCreateView()<br>onActivityCreated()</p>
<ol start="6">
<li>fragments的大部分状态都和activitie很相似，但fragment有一些新的状态。</li>
</ol>
<p><code>onAttached()</code> —— 当fragment被加入到activity时调用（在这个方法中可以获得所在的activity）。<br><code>onCreateView()</code> —— 当activity要得到fragment的layout时，调用此方法，fragment在其中创建自己的layout(界面)。<br><code>onActivityCreated()</code> —— 当activity的onCreated()方法返回后调用此方法<br><code>onDestroyView()</code> —— 当fragment中的视图被移除的时候，调用这个方法。<br><code>onDetach() </code>—— 当fragment和activity分离的时候，调用这个方法。</p>
<blockquote>
<p>一旦activity进入resumed状态（也就是running状态），你就可以自由地添加和删除fragment了。因此，只有当activity在resumed状态时，fragment的生命周期才能独立的运转，其它时候是依赖于activity的生命周期变化的。</p>
</blockquote>
<h4 id="2-2-1-2-saveFragment-onCreateView-填充布局"><a href="#2-2-1-2-saveFragment-onCreateView-填充布局" class="headerlink" title="2.2.1.2. saveFragment onCreateView 填充布局"></a>2.2.1.2. saveFragment onCreateView 填充布局</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(</span></span><br><span class="line"><span class="params">        LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> inflater.getContext();</span><br><span class="line">    <span class="comment">// 真正的布局文件在这里   fragment_save  DocumentsUI/res/layout/fragment_save.xml</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> inflater.inflate(R.layout.fragment_save, container, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化相关控件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ImageView</span> <span class="variable">icon</span> <span class="operator">=</span> (ImageView) view.findViewById(android.R.id.icon);</span><br><span class="line">    icon.setImageDrawable(</span><br><span class="line">            IconUtils.loadMimeIcon(context, getArguments().getString(EXTRA_MIME_TYPE)));</span><br><span class="line"></span><br><span class="line">    mDisplayName = (EditText) view.findViewById(android.R.id.title);</span><br><span class="line">    mDisplayName.addTextChangedListener(mDisplayNameWatcher);</span><br><span class="line">    mDisplayName.setText(getArguments().getString(EXTRA_DISPLAY_NAME));</span><br><span class="line">    mDisplayName.setOnKeyListener(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">View</span>.OnKeyListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKey</span><span class="params">(View v, <span class="type">int</span> keyCode, KeyEvent event)</span> &#123;</span><br><span class="line">                    ....</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_ENTER &amp;&amp; mSave.isEnabled()) &#123;</span><br><span class="line">                        <span class="comment">// 按键处理</span></span><br><span class="line">                        performSave();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">performSave</span><span class="params">()</span> &#123;</span><br><span class="line">                            <span class="comment">// 如果在上面选中了某文件, 表示要覆盖某文件, 这里直接替换对应的目标</span></span><br><span class="line">                            <span class="keyword">if</span> (mReplaceTarget != <span class="literal">null</span>) &#123;</span><br><span class="line">                                mInjector.actions.saveDocument(getChildFragmentManager(), mReplaceTarget);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// 这里代表新建文件</span></span><br><span class="line">                                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> getArguments().getString(EXTRA_MIME_TYPE);</span><br><span class="line">                                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">displayName</span> <span class="operator">=</span> mDisplayName.getText().toString();</span><br><span class="line">                                <span class="comment">// 最终调用到mInjector.actions.saveDocument方法保存文档</span></span><br><span class="line">                                mInjector.actions.saveDocument(mimeType, displayName, mInProgressStateListener);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    mSave = (TextView) view.findViewById(android.R.id.button1);</span><br><span class="line">    mSave.setOnClickListener(mSaveListener);</span><br><span class="line">    mSave.setEnabled(<span class="literal">false</span>);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> view;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-3-saveFragment-保存文件"><a href="#2-2-1-3-saveFragment-保存文件" class="headerlink" title="2.2.1.3. saveFragment 保存文件"></a>2.2.1.3. saveFragment 保存文件</h4><p>在点击save时, 最终调用到 mInjector.actions.saveDocument, 新建一个 CreatePickedDocumentTask (继承AsyncTask)<br>通过AsyncTask机制, 异步执行getExecutorForCurrentDirectory方法, 执行完成后回调主线程的<code>onPickFinished</code>方法<br>pickActivity关联的初始executor为前面初始ActionHandler时的 ProviderExecutor::forAuthority</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">void</span> <span class="title function_">saveDocument</span><span class="params">(</span></span><br><span class="line"><span class="params">            String mimeType, String displayName, BooleanConsumer inProgressStateListener)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span>(mState.action == ACTION_CREATE);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">CreatePickedDocumentTask</span>(</span><br><span class="line">                mActivity,</span><br><span class="line">                mDocs,</span><br><span class="line">                mLastAccessed,</span><br><span class="line">                mState.stack,</span><br><span class="line">                mimeType,</span><br><span class="line">                displayName,</span><br><span class="line">                inProgressStateListener,</span><br><span class="line">                <span class="comment">// 创建完成后会回调 onPickFinished 方法</span></span><br><span class="line">                <span class="built_in">this</span>::onPickFinished)</span><br><span class="line">                .executeOnExecutor(getExecutorForCurrentDirectory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找线程池, 找到线程池后执行对应线程池的executeOnExecutor方法.</span></span><br><span class="line">    <span class="keyword">private</span> Executor <span class="title function_">getExecutorForCurrentDirectory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">DocumentInfo</span> <span class="variable">cwd</span> <span class="operator">=</span> mState.stack.peek();</span><br><span class="line">        <span class="keyword">if</span> (cwd != <span class="literal">null</span> &amp;&amp; cwd.authority != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// executor为前面初始ActionHandler时的 ProviderExecutor::forAuthority</span></span><br><span class="line">            <span class="comment">// 这里涉及到java8的一种特性, 实际lookup函数会转向forAuthority函数里执行.</span></span><br><span class="line">            <span class="comment">// 类似范型labda表达式的用法. 函数式接口, 方法映射 @FunctionalInterface</span></span><br><span class="line">            <span class="keyword">return</span> mExecutors.lookup(cwd.authority);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> AsyncTask.THREAD_POOL_EXECUTOR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里最终执行CreatePickedDocumentTask的run方法, 至于具体的调用流程, 有待深究,借助AsyncTask的机制, 在其父类的</span></span><br><span class="line"><span class="comment">// doInBackground  方法中调用了run方法.</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Uri <span class="title function_">run</span><span class="params">(Void... params)</span> &#123;</span><br><span class="line">        <span class="type">DocumentInfo</span> <span class="variable">cwd</span> <span class="operator">=</span> mStack.peek();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 此处的mDocs对象为Injector初始化时传入的,在BaseActivity onCreate时创建的</span></span><br><span class="line">        <span class="comment">//  mDocs = DocumentsAccess.create(this); 对应 RuntimeDocumentAccess对象</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Uri</span> <span class="variable">childUri</span> <span class="operator">=</span> mDocs.createDocument(cwd, mMimeType, mDisplayName);</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Uri <span class="title function_">createDocument</span><span class="params">(DocumentInfo parentDoc, String mimeType, String displayName)</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">ContentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> mContext.getContentResolver();</span><br><span class="line">                <span class="comment">// client 对应与getAuthority对应的provider, 这里文档对象如果是外部存储的, 则对应ExternalStorageProvider</span></span><br><span class="line">                <span class="keyword">try</span> (<span class="type">ContentProviderClient</span> <span class="variable">client</span> <span class="operator">=</span> DocumentsApplication.acquireUnstableProviderOrThrow(</span><br><span class="line">                            resolver, parentDoc.derivedUri.getAuthority())) &#123;</span><br><span class="line">                    <span class="number">1.</span> <span class="keyword">return</span> DocumentsContract.createDocument(</span><br><span class="line">                            client, parentDoc.derivedUri, mimeType, displayName);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">&quot;Failed to create document&quot;</span>, e);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (childUri != <span class="literal">null</span>) &#123;</span><br><span class="line">            mLastAccessed.setLastAccessed(mOwner, mStack);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> childUri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终执行的方法是:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                <span class="keyword">return</span> DocumentsContract.createDocument(</span><br><span class="line">                        client, parentDoc.derivedUri, mimeType, displayName);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Uri <span class="title function_">createDocument</span><span class="params">(ContentProviderClient client, Uri parentDocumentUri,</span></span><br><span class="line"><span class="params">        String mimeType, String displayName)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">    in.putParcelable(DocumentsContract.EXTRA_URI, parentDocumentUri);</span><br><span class="line">    in.putString(Document.COLUMN_MIME_TYPE, mimeType);</span><br><span class="line">    in.putString(Document.COLUMN_DISPLAY_NAME, displayName);</span><br><span class="line">    <span class="comment">// 如果是ExternalStorageProvider会调到其对应的call方法中</span></span><br><span class="line">    &gt; <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">out</span> <span class="operator">=</span> client.call(METHOD_CREATE_DOCUMENT, <span class="literal">null</span>, in);</span><br><span class="line">    <span class="comment">// 将provider创建完成的文件的完整uri取出来</span></span><br><span class="line">    <span class="keyword">return</span> out.getParcelable(DocumentsContract.EXTRA_URI);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应client对象, 该对象是通过 DocumentsApplication 的 静态函数acquireUnstableProviderOrThrow<br>拿到的, 再往下追, 最终发现是ContextImpl的 内部类ApplicationContentResolver<br>最终是通过调用ams对端的 getContentProvider( getApplicationThread(), auth, userId, stable);<br>保存了一份客户端. 还要通过installProvider增加引用计数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    DocumentsApplication.acquireUnstableProviderOrThrow(</span><br><span class="line">                            resolver, parentDoc.derivedUri.getAuthority())</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ContentProviderClient <span class="title function_">acquireUnstableProviderOrThrow</span><span class="params">(</span></span><br><span class="line"><span class="params">            ContentResolver resolver, String authority)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ContentProviderClient</span> <span class="variable">client</span> <span class="operator">=</span> resolver.acquireUnstableContentProviderClient(</span><br><span class="line">                authority);</span><br><span class="line">        <span class="keyword">if</span> (client == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RemoteException</span>(<span class="string">&quot;Failed to acquire provider for &quot;</span> + authority);</span><br><span class="line">        &#125;</span><br><span class="line">        client.setDetectNotResponding(PROVIDER_ANR_TIMEOUT);</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="meta">@Nullable</span> ContentProviderClient <span class="title function_">acquireUnstableContentProviderClient</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@NonNull</span> String name)</span> &#123;</span><br><span class="line">        Preconditions.checkNotNull(name, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">IContentProvider</span> <span class="variable">provider</span> <span class="operator">=</span> acquireUnstableProvider(name);</span><br><span class="line">        <span class="keyword">if</span> (provider != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ContentProviderClient</span>(<span class="built_in">this</span>, provider, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> IContentProvider <span class="title function_">acquireUnstableProvider</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> acquireUnstableProvider(mContext, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对应ContextImpl的内部类ApplicationContentResolver</span></span><br><span class="line">    <span class="comment">// Activity内部的ContentResolver的初始化</span></span><br><span class="line">    mContentResolver = <span class="keyword">new</span> <span class="title class_">ApplicationContentResolver</span>(<span class="built_in">this</span>, mainThread);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ApplicationContentResolver</span> <span class="keyword">extends</span> <span class="title class_">ContentResolver</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> IContentProvider <span class="title function_">acquireUnstableProvider</span><span class="params">(Context c, String auth)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mMainThread.acquireProvider(c,</span><br><span class="line">                    ContentProvider.getAuthorityWithoutUserId(auth),</span><br><span class="line">                    resolveUserIdFromAuthority(auth), <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> IContentProvider <span class="title function_">acquireProvider</span><span class="params">(</span></span><br><span class="line"><span class="params">            Context c, String auth, <span class="type">int</span> userId, <span class="type">boolean</span> stable)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">IContentProvider</span> <span class="variable">provider</span> <span class="operator">=</span> acquireExistingProvider(c, auth, userId, stable);</span><br><span class="line">        <span class="keyword">if</span> (provider != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> provider;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ContentProviderHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            holder = ActivityManager.getService().getContentProvider(</span><br><span class="line">                    getApplicationThread(), auth, userId, stable);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Install provider will increment the reference count for us, and break</span></span><br><span class="line">        <span class="comment">// any ties in the race.</span></span><br><span class="line">        holder = installProvider(c, holder, holder.info,</span><br><span class="line">                <span class="literal">true</span> <span class="comment">/*noisy*/</span>, holder.noReleaseNeeded, stable);</span><br><span class="line">        <span class="keyword">return</span> holder.provider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-4-provider端调用"><a href="#2-2-1-4-provider端调用" class="headerlink" title="2.2.1.4. provider端调用"></a>2.2.1.4. provider端调用</h4><p>上面讲到了最终会执行到ams的getContentProvider拿到provider的ContentProviderHolder对象. 最终返回provider<br>Ams的 mProviderMap 以provider name(Authority)为key保存了provider的实例 ContentProviderRecord.</p>
<p>找到ExternalStorageProvider后, 首先调用基类的call方法, 上面调用的是 <code>METHOD_CREATE_DOCUMENT</code></p>
<p>ExternalStorageProvider -|&gt; FileSystemProvider -|&gt; DocumentsProvider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">METHOD_CREATE_DOCUMENT</span> <span class="operator">=</span> <span class="string">&quot;android:createDocument&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Bundle <span class="title function_">call</span><span class="params">(String method, String arg, Bundle extras)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!method.startsWith(<span class="string">&quot;android:&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// Ignore non-platform methods</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.call(method, arg, extras);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> callUnchecked(method, arg, extras);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ParcelableException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Bundle <span class="title function_">callUnchecked</span><span class="params">(String method, String arg, Bundle extras)</span> &#123;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (METHOD_CREATE_DOCUMENT.equals(method)) &#123;</span><br><span class="line">        enforceWritePermissionInner(documentUri, getCallingPackage(), <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> extras.getString(Document.COLUMN_MIME_TYPE);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">displayName</span> <span class="operator">=</span> extras.getString(Document.COLUMN_DISPLAY_NAME);</span><br><span class="line">        <span class="comment">// createDocument是子类FileSystemProvider实现的</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">newDocumentId</span> <span class="operator">=</span> createDocument(documentId, mimeType, displayName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// No need to issue new grants here, since caller either has</span></span><br><span class="line">        <span class="comment">// manage permission or a prefix grant. We might generate a</span></span><br><span class="line">        <span class="comment">// tree style URI if that&#x27;s how they called us.</span></span><br><span class="line">        <span class="comment">// 最后构造完整的uri</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Uri</span> <span class="variable">newDocumentUri</span> <span class="operator">=</span> buildDocumentUriMaybeUsingTree(documentUri,</span><br><span class="line">                newDocumentId);</span><br><span class="line">        <span class="comment">// 将完整Uri 放在 DocumentsContract.EXTRA_URI中</span></span><br><span class="line">        out.putParcelable(DocumentsContract.EXTRA_URI, newDocumentUri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里直接走的DocumentProvider的call<code>方法</code>, 并没有在子类ExternalStorageProvider处理.</p>
<p>createDocument创建流程都是在provider进程中, provider进程会持有其管理目录的(读写访问等的)权限.<br>创建完文件后, 通过buildDocumentUriMaybeUsingTree方法返回完整的<code>uri</code>. 由对端即发起方<code>client.call</code>取出uri.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">createDocument</span><span class="params">(String docId, String mimeType, String displayName)</span></span><br><span class="line">        <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">    displayName = FileUtils.buildValidFatFilename(displayName);</span><br><span class="line">    <span class="comment">// 子类的getFileForDocId方法 查找或创建parent文件</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">File</span> <span class="variable">parent</span> <span class="operator">=</span> getFileForDocId(docId);</span><br><span class="line">    <span class="keyword">if</span> (!parent.isDirectory()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Parent document isn&#x27;t a directory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建文件</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> FileUtils.buildUniqueFile(parent, mimeType, displayName);</span><br><span class="line">    <span class="keyword">final</span> String childId;</span><br><span class="line">    <span class="keyword">if</span> (Document.MIME_TYPE_DIR.equals(mimeType)) &#123;</span><br><span class="line">        <span class="comment">// 如果是创建目录</span></span><br><span class="line">        <span class="keyword">if</span> (!file.mkdir()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Failed to mkdir &quot;</span> + file);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 最终返回的是docid, 即卷的rootid: + 相对path</span></span><br><span class="line">        childId = getDocIdForFile(file);</span><br><span class="line">        <span class="comment">// 还要往MediaProvider中同步</span></span><br><span class="line">        addFolderToMediaStore(getFileForDocId(childId, <span class="literal">true</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!file.createNewFile()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Failed to touch &quot;</span> + file);</span><br><span class="line">            &#125;</span><br><span class="line">            childId = getDocIdForFile(file);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Failed to touch &quot;</span> + file + <span class="string">&quot;: &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> childId;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ExtenalStorageProvider的buildFile创建 parent 文件</span></span><br><span class="line"><span class="keyword">protected</span> File <span class="title function_">getFileForDocId</span><span class="params">(String docId, <span class="type">boolean</span> visible)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">    <span class="type">RootInfo</span> <span class="variable">root</span> <span class="operator">=</span> getRootFromDocId(docId);</span><br><span class="line">    <span class="keyword">return</span> buildFile(root, docId, visible);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-2-application-分析"><a href="#2-2-2-application-分析" class="headerlink" title="2.2.2. application 分析"></a>2.2.2. application 分析</h3><p>上面看到了<code>DocumentsApplication</code>的相关调用, 这里说下相关的生命周期问题.<br>应用可以自定义application, DocumentUi进程对应的<strong>application</strong>为自定义的DocumentApplication</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.DocumentsApplication&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">&quot;@string/app_label&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/app_icon&quot;</span>   </span></span><br><span class="line"><span class="tag">    <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br></pre></td></tr></table></figure>

<p>继承自Application, 复写<code>onCreate</code> <code>onTrimMemory</code>方法, 监听<code>package</code>变化. 如ACTION_PACKAGE_ADDED, 初始化</p>
<p> mProviders &#x3D; new ProvidersCache(this);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ProvidersCache</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mObserver = <span class="keyword">new</span> <span class="title class_">RootsChangedObserver</span>();</span><br><span class="line">    <span class="comment">// Create a new anonymous &quot;Recents&quot; RootInfo. It&#x27;s a faker.</span></span><br><span class="line">    mRecentsRoot = <span class="keyword">new</span> <span class="title class_">RootInfo</span>() &#123;&#123;</span><br><span class="line">            <span class="comment">// Special root for recents</span></span><br><span class="line">            derivedIcon = R.drawable.ic_root_recent;</span><br><span class="line">            derivedType = RootInfo.TYPE_RECENTS;</span><br><span class="line">            flags = Root.FLAG_LOCAL_ONLY | Root.FLAG_SUPPORTS_IS_CHILD;</span><br><span class="line">            title = mContext.getString(R.string.root_recent);</span><br><span class="line">            availableBytes = -<span class="number">1</span>;</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里涉及到onTrimMemory的地方:</p>
<p>内存资源紧张时释放内存<br>在应用生命周期的任何阶段 onTrimMemory() 回调方法都可以告诉你设备的内存越来越低的情况, 你可以根据该方法推送的内存紧张级别来释放资源.</p>
<p>优先级从高到低, 需要释放资源的严重性由低到高</p>
<ul>
<li><p><code>TRIM_MEMORY_RUNNING_MODERATE</code><br>表示应用程序正常运行，并且不会被杀掉。但是目前手机的内存已经有点低了，系统可能会开始根据LRU缓存规则来去杀死进程了。</p>
</li>
<li><p><code>TRIM_MEMORY_RUNNING_LOW</code><br>应用处于运行状态并且不会被杀掉, 设备可以使用的内存非常低, 可以把不用的资源释放一些提高性能(会直接影响程序的性能)</p>
</li>
<li><p><code>TRIM_MEMORY_RUNNING_CRITICAL</code><br>应用处于运行状态但是系统已经把大多数缓存应用杀掉了, 你必须释放掉不是非常关键的资源, 如果系统不能回收足够的运行内存, 系统会清除所有缓存应用并且会把正在活动的应用杀掉.<br>还有, 当你的应用被系统正缓存时, 通过 onTrimMemory() 回调方法可以收到以下几个内存级别:</p>
</li>
<li><p><code>TRIM_MEMORY_UI_HIDDEN</code><br>表示应用程序的所有UI界面被隐藏了，即用户点击了Home键或者Back键导致应用的UI界面不可见．这时候应该释放一些资源</p>
</li>
<li><p><code>TRIM_MEMORY_BACKGROUND</code><br>系统处于低内存的运行状态中并且你的应用处于缓存应用列表的初级阶段.  虽然你的应用不会处于被杀的高风险中, 但是系统已经开始清除缓存列表中的其它应用, 所以你必须释放资源使你的应用继续存留在列表中以便用户再次回到你的应用时能快速恢复进行使用.</p>
</li>
<li><p><code>TRIM_MEMORY_MODERATE</code><br>系统处于低内存的运行状态中并且你的应用处于缓存应用列表的中级阶段. 如果系运行内存收到限制, 你的应用有被杀掉的风险.</p>
</li>
<li><p><code>TRIM_MEMORY_COMPLETE</code><br>系统处于低内存的运行状态中如果系统现在没有内存回收你的应用将会第一个被杀掉. 你必须释放掉所有非关键的资源从而恢复应用的状态.</p>
</li>
</ul>
<h2 id="2-3-ACTION-OPEN-DOCUMENT-编辑文档相关调用分析"><a href="#2-3-ACTION-OPEN-DOCUMENT-编辑文档相关调用分析" class="headerlink" title="2.3. ACTION_OPEN_DOCUMENT 编辑文档相关调用分析"></a>2.3. <code>ACTION_OPEN_DOCUMENT</code> 编辑文档相关调用分析</h2><p>在Picker ui的includeState对于ACTION_OPEN_DOCUMENT转化为action的ACTION_OPEN, setupLayout函数中, 对于ACTION_OPEN, 转到<code>RootsFragment</code>中.</p>
<p>RootsFragment为DocumentUI的侧边栏, sidebar</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">       <span class="keyword">if</span> (Intent.ACTION_OPEN_DOCUMENT.equals(action)) &#123;</span><br><span class="line">           state.action = ACTION_OPEN;</span><br><span class="line">       &#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (mState.action == ACTION_OPEN ||</span><br><span class="line">                  mState.action == ACTION_CREATE ||</span><br><span class="line">                  mState.action == ACTION_OPEN_TREE ||</span><br><span class="line">                  mState.action == ACTION_PICK_COPY_DESTINATION) &#123;</span><br><span class="line">           RootsFragment.show(getFragmentManager(), (Intent) <span class="literal">null</span>);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里还是用到了<a href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%88%86%E6%9E%90">fragment的生命周期分析</a>,  在<code>onCreateView</code>函数中, 主要为布局相关的设置, 用到了ListView, 这里对该ListView添加了右键行为.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> inflater.inflate(R.layout.fragment_roots, container, <span class="literal">false</span>);</span><br><span class="line">mList = (ListView) view.findViewById(R.id.roots_list);</span><br><span class="line">mList.setOnItemClickListener(mItemListener);</span><br></pre></td></tr></table></figure>

<p>在<code>onActivityCreated</code>函数中, 添加了拖拽处理. 并初始化了Loader, 对应为<code>RootsLoader</code>, 复写其<code>onCreateLoader</code>&#x2F;<code>onLoadFinished</code>&#x2F;<code>onLoaderReset</code>方法, 跟RootsLoader关联的是<code>RootsAdapter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> LoaderCallbacks&lt;Collection&lt;RootInfo&gt;&gt; mCallbacks;</span><br></pre></td></tr></table></figure>

<p>这里需要重新回顾一下Loader机制</p>
<h3 id="2-3-1-Loader机制"><a href="#2-3-1-Loader机制" class="headerlink" title="2.3.1. Loader机制"></a>2.3.1. Loader机制</h3><p>在RootFragmenti中有进行Loader的相关调用,   作为客户端</p>
<blockquote>
<p>客户端触发Loader, 需调用LoaderManager的<code>initLoader</code>()或<code>restartLoader</code>(), 向这两个方法中传入一个LoaderCallbacks的实例。LoaderCallbacks有三个回调方法需要实现：<code>onCreateLoader</code>()、<code>onLoadFinished</code>()以及<code>onLoaderReset</code>()</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fragment对用户可见的时候，它会经历 onStart onResume</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onResume();</span><br><span class="line">    onDisplayStateChanged();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDisplayStateChanged</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> getActivity();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">State</span> <span class="variable">state</span> <span class="operator">=</span> ((BaseActivity) context).getDisplayState();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state.action == State.ACTION_GET_CONTENT) &#123;</span><br><span class="line">            mList.setOnItemLongClickListener(mItemLongClickListener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mList.setOnItemLongClickListener(<span class="literal">null</span>);</span><br><span class="line">            mList.setLongClickable(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 触发Loader  执行</span></span><br><span class="line">        getLoaderManager().restartLoader(<span class="number">2</span>, <span class="literal">null</span>, mCallbacks);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-2-restartLoader调用"><a href="#2-3-2-restartLoader调用" class="headerlink" title="2.3.2. restartLoader调用"></a>2.3.2. <code>restartLoader</code>调用</h3><p>调用这个方法，将会重新创建一个指定ID的Loader，如果当前已经有一个和这个ID关联的Loader，那么会对它进行canceled&#x2F;stopped&#x2F;destroyed等操作，之后，使用新传入的Bundle参数来创建一个新的Loader，并在数据加载完毕后递交给调用者。并且，在调用完这个函数之后，所有<code>之前和这个ID关联的Loader</code>都会失效，我们将不会收到它们传递过来的任何数据。</p>
<p>即使之前的loader关联的失效, 并构建新的loader. 先不考虑使之前loader失效的情况, 只考虑创建新loader的情况:</p>
<p>调用过程:</p>
<p>LoaderManager.createLoader() -&gt;<br><code>LoaderCallbacks.onCreateLoader()</code> -&gt;<br>得到loader之后创建LoaderInfo -&gt;<br>LoaderManager.installLoader() -&gt;<br>将其放入LoaderManager内部维护的mLoaders数组中 -&gt;<br>LoaderInfo.start() -&gt;<br>Loader处于<code>started</code>状态 -&gt;<br><code>Loader.startLoading() -&gt;Loader.onStartLoading()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Loader&lt;Collection&lt;RootInfo&gt;&gt; <span class="title function_">onCreateLoader</span><span class="params">(<span class="type">int</span> id, Bundle args)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RootsLoader</span>(activity, providers, state);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">BROADCAST_ACTION</span> <span class="operator">=</span> <span class="string">&quot;com.android.documentsui.action.ROOT_CHANGED&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RootsLoader</span><span class="params">(Context context, ProvidersCache providers, State state)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">        mProviders = providers;</span><br><span class="line">        mState = state;</span><br><span class="line">  <span class="comment">// BROADCAST_ACTION是在ProviderCache的doInBackground中发送的, 这个更新是由前面介绍的 DocumentApplication的监听package变化触发的.</span></span><br><span class="line">        LocalBroadcastManager.getInstance(context).registerReceiver(</span><br><span class="line">                mReceiver, <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(ProvidersAccess.BROADCAST_ACTION));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BroadcastReceiver</span> <span class="variable">mReceiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            onContentChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onContentChanged</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mStarted) &#123;</span><br><span class="line">            forceLoad();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mContentChanged = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onStartLoading</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mResult != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 通知loader更新, 触发LoaderCallback 的onLoadFinished.</span></span><br><span class="line">            deliverResult(mResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 查询mContentChanged的状态</span></span><br><span class="line">        <span class="keyword">if</span> (takeContentChanged() || mResult == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 在mContentChanged为true时, 需要forceLoad, 该forceLoad会异步加载数据</span></span><br><span class="line">            forceLoad();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deliverResult</span><span class="params">(Collection&lt;RootInfo&gt; result)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isReset()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mResult = result;</span><br><span class="line">        <span class="comment">// 通知loader更新, 触发LoaderCallback 的onLoadFinished.</span></span><br><span class="line">        <span class="keyword">if</span> (isStarted()) &#123;</span><br><span class="line">            <span class="built_in">super</span>.deliverResult(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Loader在<code>started</code>状态下，Loader应该监控数据源的变化，并将新数据发送给客户端</p>
<blockquote>
<p>具体来说就是当监控到新数据后，调用Loader.deliverResult()方法，触发LoadCallbacks.onLoadFinished()回调的执行，从而客户端可以从该回调中轻松获取数据。</p>
</blockquote>
<p>上面在<code>onStartLoading</code>中, 一般用法是先调用Loader.deliverResult()方法，触发LoadCallbacks.<code>onLoadFinished</code>()回调的执行, 另一方面异步执行load数据. </p>
<p>在该处, 调用forceLoad: , 注意RootsLoader继承AsyncTaskLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">forceLoad</span><span class="params">()</span> &#123;</span><br><span class="line">        onForceLoad();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// AsyncTaskLoader</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onForceLoad</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onForceLoad();</span><br><span class="line">        cancelLoad();</span><br><span class="line">        mTask = <span class="keyword">new</span> <span class="title class_">LoadTask</span>();</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;Preparing load: mTask=&quot;</span> + mTask);</span><br><span class="line">        executePendingTask();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LoadTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Void, Void, D&gt; <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">mDone</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> D <span class="title function_">doInBackground</span><span class="params">(Void... params)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="built_in">this</span> + <span class="string">&quot; &gt;&gt;&gt; doInBackground&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 跑到子类中, 即RootsLoader中</span></span><br><span class="line">       <span class="number">1.</span>         <span class="type">D</span> <span class="variable">data</span> <span class="operator">=</span> AsyncTaskLoader.<span class="built_in">this</span>.onLoadInBackground();</span><br><span class="line">                <span class="keyword">return</span> data;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> D <span class="title function_">onLoadInBackground</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="number">1.2</span>    <span class="keyword">return</span> loadInBackground();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.3</span>  <span class="comment">//执行到RootsLoader中, 返回Collection&lt;RootInfo&gt;数据.</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Collection&lt;RootInfo&gt; <span class="title function_">loadInBackground</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mProviders.getMatchingRootsBlocking(mState);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>AsyncTask执行完成后, 会在主线程中执行<code>onPostExecute</code>方法, 正常情况下又会调用LoaderCallback的<code>onLoadFinished</code>, 即load完数据后,  通知数据更新的机制.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPostExecute</span><span class="params">(D data)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="built_in">this</span> + <span class="string">&quot; onPostExecute&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="number">1.</span> AsyncTaskLoader.<span class="built_in">this</span>.dispatchOnLoadComplete(<span class="built_in">this</span>, data);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mDone.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">dispatchOnLoadComplete</span><span class="params">(LoadTask task, D data)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mTask != task) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;Load complete of old task, trying to cancel&quot;</span>);</span><br><span class="line">        dispatchOnCancelled(task, data);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isAbandoned()) &#123;</span><br><span class="line">            <span class="comment">// This cursor has been abandoned; just cancel the new data.</span></span><br><span class="line">            onCanceled(data);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commitContentChanged();</span><br><span class="line">            mLastLoadCompleteTime = SystemClock.uptimeMillis();</span><br><span class="line">            mTask = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">&quot;Delivering result&quot;</span>);</span><br><span class="line">            <span class="comment">// 这个地方再次走到子类的deliverResult, 由会调用LoaderCallback的onLoadFinished回调</span></span><br><span class="line">            <span class="number">2.</span> deliverResult(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面重点看下RootsLoader 对应的LoaderCallback的<code>onLoadFinished</code>方法, 数据的来源是<code>mProviders.getMatchingRootsBlocking(mState);</code> 查看下相关流程:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;RootInfo&gt; <span class="title function_">getMatchingRootsBlocking</span><span class="params">(State state)</span> &#123;</span><br><span class="line">        waitForFirstLoad();</span><br><span class="line">        loadStoppedAuthorities();</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">return</span> ProvidersAccess.getMatchingRoots(mRoots.values(), state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;RootInfo&gt; <span class="title function_">getMatchingRoots</span><span class="params">(Collection&lt;RootInfo&gt; roots, State state)</span> &#123;</span><br><span class="line">    <span class="comment">// ... 前面有一堆的判断条件, 根据state和root的状态判断是否要忽略一些root</span></span><br><span class="line">    matching.add(root);</span><br><span class="line">    <span class="keyword">return</span> matching;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 前面root的来源需要看下, state是RootFragment初始化时传入的*/</span></span><br><span class="line"><span class="comment">// 还是来源于DocumentApplication 监听package变化, 导致的UpdateTask</span></span><br><span class="line"><span class="comment">// mRoot = mTaskRoots</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Void... params)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> SystemClock.elapsedRealtime();</span><br><span class="line">            <span class="comment">// 先加入RecentRoot  </span></span><br><span class="line">            mTaskRoots.put(mRecentsRoot.authority, mRecentsRoot);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> mContext.getPackageManager();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Pick up provider with action string</span></span><br><span class="line">            <span class="comment">// 查询 PROVIDER_INTERFACE &quot;android.content.action.DOCUMENTS_PROVIDER&quot; 的action , Manifest中定义, provider定义, 存活的provider, 比如ExternalStorageProvider, 通过pm查询.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(DocumentsContract.PROVIDER_INTERFACE);</span><br><span class="line">            <span class="keyword">final</span> List&lt;ResolveInfo&gt; providers = pm.queryIntentContentProviders(intent, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">for</span> (ResolveInfo info : providers) &#123;</span><br><span class="line">                <span class="type">ProviderInfo</span> <span class="variable">providerInfo</span> <span class="operator">=</span> info.providerInfo;</span><br><span class="line">                <span class="keyword">if</span> (providerInfo.authority != <span class="literal">null</span>) &#123;</span><br><span class="line">                   <span class="number">1.</span>  handleDocumentsProvider(providerInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 发送ContentChanged, 前面说过, 会影响一个标志位</span></span><br><span class="line">            LocalBroadcastManager.getInstance(mContext).sendBroadcast(<span class="keyword">new</span> <span class="title class_">Intent</span>(BROADCAST_ACTION));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.1</span>     </span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleDocumentsProvider</span><span class="params">(ProviderInfo info)</span> &#123;</span><br><span class="line">            <span class="comment">// Ignore stopped packages for now; we might query them</span></span><br><span class="line">            <span class="comment">// later during UI interaction.</span></span><br><span class="line">    <span class="comment">//忽略Stopped的provider</span></span><br><span class="line">            <span class="keyword">if</span> ((info.applicationInfo.flags &amp; ApplicationInfo.FLAG_STOPPED) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (VERBOSE) Log.v(TAG, <span class="string">&quot;Ignoring stopped authority &quot;</span> + info.authority);</span><br><span class="line">                mTaskStoppedAuthorities.add(info.authority);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">// 这里有个需要注意的地方   loadRootsForAuthority, 后面需要再深入/</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">forceRefresh</span> <span class="operator">=</span> mForceRefreshAll</span><br><span class="line">                    || Objects.equals(info.packageName, mForceRefreshPackage);</span><br><span class="line">            mTaskRoots.putAll(info.authority, loadRootsForAuthority(mContext.getContentResolver(),</span><br><span class="line">                    info.authority, forceRefresh));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 加载完roots信息后, 通知客户端RootsFragment更新.</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoadFinished</span><span class="params">(</span></span><br><span class="line"><span class="params">                    Loader&lt;Collection&lt;RootInfo&gt;&gt; loader, Collection&lt;RootInfo&gt; roots)</span> &#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">                List&lt;Item&gt; sortedItems =</span><br><span class="line">                        sortLoadResult(roots, excludePackage, handlerAppIntent);</span><br><span class="line">    <span class="comment">// 指定关联的Adapter, RootsAdapter 绑定到 mList ListView中, MVC模式</span></span><br><span class="line">                mAdapter = <span class="keyword">new</span> <span class="title class_">RootsAdapter</span>(activity, sortedItems, mDragListener);</span><br><span class="line">                mList.setAdapter(mAdapter);</span><br><span class="line"></span><br><span class="line">                mInjector.shortcutsUpdater.accept(roots);</span><br><span class="line">                onCurrentRootChanged();</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>RootFragment的更新都是通过<code>restartLoader</code>调用触发<code>forceLoad</code>过程更新数据随后更新视图. 如点击menu的 “Show Internal Storage”进行的更新动作.</p>
<h3 id="2-3-3-RootsLoader-关联的-RootsAdapter"><a href="#2-3-3-RootsLoader-关联的-RootsAdapter" class="headerlink" title="2.3.3. RootsLoader 关联的 RootsAdapter"></a>2.3.3. RootsLoader 关联的 RootsAdapter</h3><h4 id="2-3-3-1-mvc框架"><a href="#2-3-3-1-mvc框架" class="headerlink" title="2.3.3.1. mvc框架"></a>2.3.3.1. mvc框架</h4><p>根据MVC模式(model-view-Controller), Adapter处理视图上的数据显示, 处于Controller层</p>
<ul>
<li><p>model(模型层)</p>
<p>保持程序的数据状态, 如数据存储, 网络请求等. 与相应的view有一定的耦合, 通过某种事件机制通知view的状态更新, 还会接收Controller的事件</p>
<p>此例子中  RootsLoader 管理的 RootItem数据为model.</p>
</li>
<li><p>view(视图层)</p>
<p>GUI组件, 响应用户的交互行为并触发Controller的逻辑, 还可能通过在Model中注册事件监听model的改变, 以此刷新并展示给用户.  </p>
<p>此例子中为ListView</p>
</li>
<li><p>Controller(控制器)</p>
<p>控制器由View根据用户行为触发并响应View的用户交互, 通过修改model并由model的事件机制来触发view更新.</p>
<p>此例子中为RootsAdapter</p>
</li>
</ul>
<p><img src="/images/Adapter.jpg" alt="Adapter"></p>
<p>Adapter是连接后端数据和前端显示的适配器接口，是数据和UI（View）之间一个重要的纽带。在常见的View(ListView,GridView)等地方都需要用到Adapter。</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/widget/Adapter">Adapter官方文档</a></p>
<p>RootsAdapter –|&gt;  ArrayAdapter –&gt;BaseAdapter</p>
<p>此处数据是一次性添加的, 每次RootsItem数据变化时, 最后都是调用OnloadFinished方法重新初始化RootsAdapter的.</p>
<p>这里只用到了getView方法, 这里的Apdater是比较简单的</p>
<h4 id="2-3-3-2-需要关注-RootItem"><a href="#2-3-3-2-需要关注-RootItem" class="headerlink" title="2.3.3.2. 需要关注 RootItem"></a>2.3.3.2. 需要关注 RootItem</h4><p>RootItem作为model层, 通过bindView 关联到 item view层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="title function_">RootItem</span><span class="params">(RootInfo root, ActionHandler actionHandler)</span> &#123;</span><br><span class="line">        <span class="comment">// 通过构造函数传入布局id</span></span><br><span class="line">        <span class="built_in">super</span>(R.layout.item_root, getStringId(root));</span><br><span class="line">        <span class="built_in">this</span>.root = root;</span><br><span class="line">        mActionHandler = actionHandler;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// bindView 的参数 convertView 来自于构造函数中的mLayoutId 即 R.layout.item_root</span></span><br><span class="line">            convertView = LayoutInflater.from(parent.getContext())</span><br><span class="line">                    .inflate(mLayoutId, parent, <span class="literal">false</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bindView</span><span class="params">(View convertView)</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个Item 最终组成List 填充到RootAdapter中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">final</span> List&lt;RootItem&gt; libraries = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">final</span> List&lt;RootItem&gt; others = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> RootInfo root : roots) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">RootItem</span> <span class="variable">item</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootItem</span>(root, mActionHandler);</span><br><span class="line"></span><br><span class="line">            <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> getActivity();</span><br><span class="line">            <span class="keyword">if</span> (root.isHome() &amp;&amp; !Shared.shouldShowDocumentsRoot(activity)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (root.isLibrary()) &#123;</span><br><span class="line">                libraries.add(item);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                others.add(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       List&lt;Item&gt; sortedItems =</span><br><span class="line">                        sortLoadResult(roots, excludePackage, handlerAppIntent);</span><br><span class="line">       mAdapter = <span class="keyword">new</span> <span class="title class_">RootsAdapter</span>(activity, sortedItems, mDragListener);</span><br><span class="line">mList.setAdapter(mAdapter);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于item的访问可以见下面</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCurrentRootChanged</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAdapter == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">RootInfo</span> <span class="variable">root</span> <span class="operator">=</span> ((BaseActivity) getActivity()).getCurrentRoot();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mAdapter.getCount(); i++) &#123;</span><br><span class="line">            <span class="comment">// getItem</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">item</span> <span class="operator">=</span> mAdapter.getItem(i);</span><br><span class="line">            <span class="keyword">if</span> (item <span class="keyword">instanceof</span> RootItem) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">RootInfo</span> <span class="variable">testRoot</span> <span class="operator">=</span> ((RootItem) item).root;</span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(testRoot, root)) &#123;</span><br><span class="line">                    <span class="comment">// 比对item的root信息跟当前的需要展示的root信息是否一致, 一致则指定选中状态.</span></span><br><span class="line">                    mList.setItemChecked(i, <span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4-DirectoryFragment"><a href="#2-4-DirectoryFragment" class="headerlink" title="2.4. DirectoryFragment"></a>2.4. DirectoryFragment</h2><p>前面讲完了RootFragment和SaveFragment, 对应侧边栏和下边栏, 但Document最主要的部分还是中间的内容部分, 即DirectoryFragment.</p>
<p>此处通过RootsFragment的item的点击事件往下追.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">OnItemClickListener</span> <span class="variable">mItemListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OnItemClickListener</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onItemClick</span><span class="params">(AdapterView&lt;?&gt; parent, View view, <span class="type">int</span> position, <span class="type">long</span> id)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Item</span> <span class="variable">item</span> <span class="operator">=</span> mAdapter.getItem(position);</span><br><span class="line">            item.open();</span><br><span class="line"></span><br><span class="line">            getBaseActivity().setRootsDrawerOpen(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//RootItem</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">open</span><span class="params">()</span> &#123;</span><br><span class="line">        mActionHandler.openRoot(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">RootItem</span> <span class="variable">item</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RootItem</span>(root, mActionHandler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        mActionHandler = mInjector.actions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RootFragment 存活在Activity中,  如果是通过PickActivity进来的, mInjector就是PickActivity的.</span></span><br><span class="line">mInjector = getBaseActivity().getInjector();</span><br><span class="line"></span><br><span class="line"><span class="comment">// picker/ActionHandler.java</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">openRoot</span><span class="params">(RootInfo root)</span> &#123;</span><br><span class="line">        Metrics.logRootVisited(mActivity, Metrics.PICKER_SCOPE, root);</span><br><span class="line">        mActivity.onRootPicked(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mActivity 指向 pickActivity, 第一个参数</span></span><br><span class="line">        mInjector.actions = <span class="keyword">new</span> <span class="title class_">ActionHandler</span>&lt;&gt;(</span><br><span class="line">                <span class="built_in">this</span>,</span><br><span class="line">                mState,</span><br><span class="line">                mProviders,</span><br><span class="line">                mDocs,</span><br><span class="line">                mSearchManager,</span><br><span class="line">                ProviderExecutor::forAuthority,</span><br><span class="line">                mInjector,</span><br><span class="line">                mLastAccessed);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PickActivity</span> <span class="keyword">extends</span> <span class="title class_">BaseActivity</span> <span class="keyword">implements</span> <span class="title class_">ActionHandler</span>.Addons</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> <span class="keyword">implements</span> <span class="title class_">CommonAddons</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// onRootPicked是CommonAddons的接口, 在BaseActivity中实现</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRootPicked</span><span class="params">(RootInfo root)</span> &#123;</span><br><span class="line">        <span class="comment">// Clicking on the current root removes search</span></span><br><span class="line">        mSearchManager.cancelSearch();</span><br><span class="line"></span><br><span class="line">        mInjector.actionModeController.finishActionMode();</span><br><span class="line">        mSortController.onViewModeChanged(mState.derivedMode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set summary header&#x27;s visibility. Only recents and downloads root may have summary in</span></span><br><span class="line">        <span class="comment">// their docs.</span></span><br><span class="line">        mState.sortModel.setDimensionVisibility(</span><br><span class="line">                SortModel.SORT_DIMENSION_ID_SUMMARY,</span><br><span class="line">                root.isRecents() || root.isDownloads() ? View.VISIBLE : View.INVISIBLE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clear entire backstack and start in new root</span></span><br><span class="line">        mState.stack.changeRoot(root);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Recents is always in memory, so we just load it directly.</span></span><br><span class="line">        <span class="comment">// Otherwise we delegate loading data from disk to a task</span></span><br><span class="line">        <span class="comment">// to ensure a responsive ui.</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// recents在内存中, 直接显示. 最近项</span></span><br><span class="line">        <span class="keyword">if</span> (mProviders.isRecentsRoot(root)) &#123;</span><br><span class="line">            refreshCurrentRootAndDirectory(AnimationView.ANIM_NONE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1.</span>        <span class="comment">// 一般是下面这项, 走getRootDocument</span></span><br><span class="line">            mInjector.actions.getRootDocument(</span><br><span class="line">                    root,</span><br><span class="line">                    TimeoutTask.DEFAULT_TIMEOUT,</span><br><span class="line"><span class="number">2.</span>                    doc -&gt; mInjector.actions.openRootDocument(doc));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="number">1.</span> -&gt;  <span class="comment">// 进到了AbstractActionHandler中</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getRootDocument</span><span class="params">(RootInfo root, <span class="type">int</span> timeout, Consumer&lt;DocumentInfo&gt; callback)</span> &#123;</span><br><span class="line">        <span class="type">GetRootDocumentTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRootDocumentTask</span>(</span><br><span class="line">                root,</span><br><span class="line">                mActivity,</span><br><span class="line">                timeout,</span><br><span class="line">                mDocs,</span><br><span class="line">                callback);</span><br><span class="line"></span><br><span class="line">        task.executeOnExecutor(mExecutors.lookup(root.authority));</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">2.</span> -&gt; <span class="comment">// 在找到docmentinfo后, 执行mInjector.actions.openRootDocument(doc)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1 和 2中间的步骤是构建了一个GetRootDocumentTask, 通过authority 找到excutor, 请查看前面的ProviderExecutor::forAuthority</span></span><br><span class="line">      </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> ProviderExecutor <span class="title function_">forAuthority</span><span class="params">(String authority)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sExecutors) &#123;</span><br><span class="line">            <span class="type">ProviderExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> sExecutors.get(authority);</span><br><span class="line">            <span class="keyword">if</span> (executor == <span class="literal">null</span>) &#123;</span><br><span class="line">                executor = <span class="keyword">new</span> <span class="title class_">ProviderExecutor</span>();</span><br><span class="line">                executor.setName(<span class="string">&quot;ProviderExecutor: &quot;</span> + authority);</span><br><span class="line">                <span class="comment">// 执行start方法.</span></span><br><span class="line">                executor.start();</span><br><span class="line">                <span class="comment">// 以authority为key, 保存了一个executor实例到sExecutors池中.</span></span><br><span class="line">                sExecutors.put(authority, executor);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> executor;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 GetRootDocumentTask的run方法</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@Nullable</span> DocumentInfo <span class="title function_">run</span><span class="params">(Void... args)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mDocs.getRootDocument(mRootInfo);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// mDoc为DocumentsAccess的接口, 实现在RuntimeDocumentAccess类中</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="meta">@Nullable</span> DocumentInfo <span class="title function_">getRootDocument</span><span class="params">(RootInfo root)</span> &#123;</span><br><span class="line">            <span class="comment">// 构建root的完整uri </span></span><br><span class="line">            <span class="keyword">return</span> getDocument(</span><br><span class="line">                    DocumentsContract.buildDocumentUri(root.authority, root.documentId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="meta">@Nullable</span> DocumentInfo <span class="title function_">getDocument</span><span class="params">(Uri uri)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">3.</span>                <span class="keyword">return</span> DocumentInfo.fromUri(mContext.getContentResolver(), uri);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line"><span class="number">3.</span> -&gt; <span class="comment">// 进入 DocumentInfo类中, 构建DocumentInfo</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> DocumentInfo <span class="title function_">fromUri</span><span class="params">(ContentResolver resolver, Uri uri)</span></span><br><span class="line">            <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">DocumentInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DocumentInfo</span>();</span><br><span class="line">        info.updateFromUri(resolver, uri);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateFromUri</span><span class="params">(ContentResolver resolver, Uri uri)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">ContentProviderClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 找到对端provider实例</span></span><br><span class="line">            client = DocumentsApplication.acquireUnstableProviderOrThrow(</span><br><span class="line">                    resolver, uri.getAuthority());</span><br><span class="line">            <span class="comment">// 查询root下的内容,保存到cursor中</span></span><br><span class="line">            cursor = client.query(uri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (!cursor.moveToFirst()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;Missing details for &quot;</span> + uri);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="number">3.1</span>            updateFromCursor(cursor, uri.getAuthority());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">throw</span> asFileNotFoundException(t);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IoUtils.closeQuietly(cursor);</span><br><span class="line">            ContentProviderClient.releaseQuietly(client);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3.1</span> -&gt; <span class="comment">// updateFromCursor根据provider查到的内容填充DocumentInfo</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateFromCursor</span><span class="params">(Cursor cursor, String authority)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authority = authority;</span><br><span class="line">        <span class="built_in">this</span>.documentId = getCursorString(cursor, Document.COLUMN_DOCUMENT_ID);</span><br><span class="line">        <span class="built_in">this</span>.mimeType = getCursorString(cursor, Document.COLUMN_MIME_TYPE);</span><br><span class="line">        <span class="built_in">this</span>.displayName = getCursorString(cursor, Document.COLUMN_DISPLAY_NAME);</span><br><span class="line">        <span class="built_in">this</span>.lastModified = getCursorLong(cursor, Document.COLUMN_LAST_MODIFIED);</span><br><span class="line">        <span class="built_in">this</span>.flags = getCursorInt(cursor, Document.COLUMN_FLAGS);</span><br><span class="line">        <span class="built_in">this</span>.summary = getCursorString(cursor, Document.COLUMN_SUMMARY);</span><br><span class="line">        <span class="built_in">this</span>.size = getCursorLong(cursor, Document.COLUMN_SIZE);</span><br><span class="line">        <span class="built_in">this</span>.icon = getCursorInt(cursor, Document.COLUMN_ICON);</span><br><span class="line">        <span class="built_in">this</span>.deriveFields();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> -&gt; <span class="comment">// 在有了DocumentInfo数据后, 最终执行mInjector.actions.openRootDocument(doc)</span></span><br><span class="line">   在AbstractHandler中执行</span><br><span class="line">   </span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">openRootDocument</span><span class="params">(<span class="meta">@Nullable</span> DocumentInfo rootDoc)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (rootDoc == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// There are 2 cases where rootDoc is null -- 1) loading recents; 2) failed to load root</span></span><br><span class="line">            <span class="comment">// document. Either case we should call refreshCurrentRootAndDirectory() to let</span></span><br><span class="line">            <span class="comment">// DirectoryFragment update UI.</span></span><br><span class="line">            mActivity.refreshCurrentRootAndDirectory(AnimationView.ANIM_NONE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不为空, 打开rootdoc.</span></span><br><span class="line">      <span class="number">4.</span>      openContainerDocument(rootDoc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="number">4.</span> -&gt;  <span class="comment">// 打开rootdoc</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">openContainerDocument</span><span class="params">(DocumentInfo doc)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span>(doc.isContainer());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mSearchMgr.isSearching()) &#123;</span><br><span class="line">            loadDocument(</span><br><span class="line">                    doc.derivedUri,</span><br><span class="line">                    (<span class="meta">@Nullable</span> DocumentStack stack) -&gt; openFolderInSearchResult(stack, doc));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 一般进行下面这项</span></span><br><span class="line">            openChildContainer(doc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">openChildContainer</span><span class="params">(DocumentInfo doc)</span> &#123;</span><br><span class="line">        <span class="type">DocumentInfo</span> <span class="variable">currentDoc</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 一般情况下为目录</span></span><br><span class="line">        <span class="keyword">if</span> (doc.isDirectory()) &#123;</span><br><span class="line">            <span class="comment">// Regular directory.</span></span><br><span class="line">            currentDoc = doc;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (doc.isArchive()) &#123;</span><br><span class="line">            <span class="comment">// Archive.</span></span><br><span class="line">            currentDoc = mDocs.getArchiveDocument(doc.derivedUri);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span>(currentDoc != <span class="literal">null</span>);</span><br><span class="line">        mActivity.notifyDirectoryNavigated(currentDoc.derivedUri);</span><br><span class="line"></span><br><span class="line">        mState.stack.push(currentDoc);</span><br><span class="line">        <span class="comment">// Show an opening animation only if pressing &quot;back&quot; would get us back to the</span></span><br><span class="line">        <span class="comment">// previous directory. Especially after opening a root document, pressing</span></span><br><span class="line">        <span class="comment">// back, wouldn&#x27;t go to the previous root, but close the activity.</span></span><br><span class="line">        <span class="comment">// 在前面的stack push后, locationChanged, AnimationView.ANIM_ENTER</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">anim</span> <span class="operator">=</span> (mState.stack.hasLocationChanged() &amp;&amp; mState.stack.size() &gt; <span class="number">1</span>)</span><br><span class="line">                ? AnimationView.ANIM_ENTER : AnimationView.ANIM_NONE;</span><br><span class="line">        <span class="comment">// 最终执行 refreshCurrentRootAndDirectory(AnimationView.ANIM_ENTER)</span></span><br><span class="line">       <span class="number">5.</span> mActivity.refreshCurrentRootAndDirectory(anim);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> -&gt; <span class="comment">// 刷新页面, refreshCurrentRootAndDirectory为CommonAddons的回调, 进到BaseActivity下</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">refreshCurrentRootAndDirectory</span><span class="params">(<span class="type">int</span> anim)</span> &#123;</span><br><span class="line">        mSearchManager.cancelSearch();</span><br><span class="line">        <span class="comment">// 根据工具栏的设置是显示列表还是表格</span></span><br><span class="line">        mState.derivedMode = LocalPreferences.getViewMode(<span class="built_in">this</span>, mState.stack.getRoot(), MODE_GRID);</span><br><span class="line"></span><br><span class="line">        <span class="number">6.</span> <span class="comment">//  最主要的木的是刷新目录</span></span><br><span class="line">        refreshDirectory(anim);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">RootsFragment</span> <span class="variable">roots</span> <span class="operator">=</span> RootsFragment.get(getFragmentManager());</span><br><span class="line">        <span class="keyword">if</span> (roots != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 设置RootFragment的item的选中状态</span></span><br><span class="line">            roots.onCurrentRootChanged();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 导航栏更新</span></span><br><span class="line">        mNavigator.update();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Causes talkback to announce the activity&#x27;s new title</span></span><br><span class="line">    <span class="comment">// 标题栏表更</span></span><br><span class="line">        setTitle(mState.stack.getTitle());</span><br><span class="line">        <span class="comment">// 菜单项更新.</span></span><br><span class="line">        invalidateOptionsMenu();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line"><span class="number">6.</span> -&gt; <span class="comment">// refreshDirectory 为具体的实现类, 如果是通过pickActivity进来的, 则是他的.</span></span><br><span class="line">    </span><br><span class="line">     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">refreshDirectory</span><span class="params">(<span class="type">int</span> anim)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FragmentManager</span> <span class="variable">fm</span> <span class="operator">=</span> getFragmentManager();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">RootInfo</span> <span class="variable">root</span> <span class="operator">=</span> getCurrentRoot();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">DocumentInfo</span> <span class="variable">cwd</span> <span class="operator">=</span> getCurrentDirectory();</span><br><span class="line">        <span class="comment">// 如果是最近 item, 展示</span></span><br><span class="line">        <span class="keyword">if</span> (mState.stack.isRecents()) &#123;</span><br><span class="line">            DirectoryFragment.showRecentsOpen(fm, anim);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// In recents we pick layout mode based on the mimetype,</span></span><br><span class="line">            <span class="comment">// picking GRID for visual types. We intentionally don&#x27;t</span></span><br><span class="line">            <span class="comment">// consult a user&#x27;s saved preferences here since they are</span></span><br><span class="line">            <span class="comment">// set per root (not per root and per mimetype).</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">visualMimes</span> <span class="operator">=</span> MimeTypes.mimeMatches(</span><br><span class="line">                    MimeTypes.VISUAL_MIMES, mState.acceptMimes);</span><br><span class="line">            mState.derivedMode = visualMimes ? State.MODE_GRID : State.MODE_LIST;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Normal boring directory</span></span><br><span class="line">            <span class="comment">// 一般是这项, 需要展示root 的内容</span></span><br><span class="line"> <span class="number">7.</span>               DirectoryFragment.showDirectory(fm, root, cwd, anim);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Forget any replacement target</span></span><br><span class="line">        <span class="keyword">if</span> (mState.action == ACTION_CREATE) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">SaveFragment</span> <span class="variable">save</span> <span class="operator">=</span> SaveFragment.get(fm);</span><br><span class="line">            <span class="keyword">if</span> (save != <span class="literal">null</span>) &#123;</span><br><span class="line">                save.setReplaceTarget(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mState.action == ACTION_OPEN_TREE ||</span><br><span class="line">            mState.action == ACTION_PICK_COPY_DESTINATION) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">PickFragment</span> <span class="variable">pick</span> <span class="operator">=</span> PickFragment.get(fm);</span><br><span class="line">            <span class="keyword">if</span> (pick != <span class="literal">null</span>) &#123;</span><br><span class="line">                pick.setPickTarget(mState.action, mState.copyOperationSubType, cwd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在上述流程中, 最终走到了DirectoryFragment里.</p>
<p>这里总结下相关的接口类的情况, 见下图</p>
<p><img src="/images/DocumentUI.png" alt="DocumentUI"></p>
<h3 id="2-4-1-DirectoryFragment-展示root内容"><a href="#2-4-1-DirectoryFragment-展示root内容" class="headerlink" title="2.4.1. DirectoryFragment 展示root内容"></a>2.4.1. DirectoryFragment 展示root内容</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">showDirectory</span><span class="params">(</span></span><br><span class="line"><span class="params">        FragmentManager fm, RootInfo root, DocumentInfo doc, <span class="type">int</span> anim)</span> &#123;</span><br><span class="line">    create(fm, root, doc, anim);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里创建了DirectoryFragment,  会进入DirectoryFragment的生命周期, <a href="#fragment%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">参考生命周期</a>, 会接着进入下面几个回调中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(</span></span><br><span class="line"><span class="params">        LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> &#123;</span><br><span class="line"></span><br><span class="line">    mActivity = (BaseActivity) getActivity();</span><br><span class="line">    <span class="comment">// 使用RecyclerView的布局</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> inflater.inflate(R.layout.fragment_directory, container, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    mProgressBar = view.findViewById(R.id.progressbar);</span><br><span class="line">    <span class="keyword">assert</span> mProgressBar != <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    mRecView = (RecyclerView) view.findViewById(R.id.dir_list);</span><br><span class="line">    mRecView.setRecyclerListener(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RecyclerListener</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="comment">// 当item被回收的时候回调</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onViewRecycled</span><span class="params">(ViewHolder holder)</span> &#123;</span><br><span class="line">                    cancelThumbnailTask(holder.itemView);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// RecyclerView的父布局</span></span><br><span class="line">    mRefreshLayout = (SwipeRefreshLayout) view.findViewById(R.id.refresh_layout);</span><br><span class="line">    mRefreshLayout.setOnRefreshListener(<span class="built_in">this</span>);</span><br><span class="line">    mRecView.setItemAnimator(<span class="keyword">new</span> <span class="title class_">DirectoryItemAnimator</span>(mActivity));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pickActivity的 mInjector</span></span><br><span class="line">    mInjector = mActivity.getInjector();</span><br><span class="line">    mModel = mInjector.getModel();</span><br><span class="line">    <span class="comment">// model初始化</span></span><br><span class="line">    mModel.reset();</span><br><span class="line">    <span class="comment">// 显示内容变更时, 回调mOnDisplayStateChanged</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">mOnDisplayStateChanged</span> <span class="operator">=</span> <span class="built_in">this</span>::onDisplayStateChanged;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onDisplayStateChanged</span><span class="params">()</span> &#123;</span><br><span class="line">        updateLayout(mState.derivedMode);</span><br><span class="line">        <span class="comment">// 重新绑定adapter</span></span><br><span class="line">        mRecView.setAdapter(mAdapter);</span><br><span class="line">    &#125;</span><br><span class="line">    mInjector.actions.registerDisplayStateChangedListener(mOnDisplayStateChanged);</span><br><span class="line">    <span class="comment">// 剪贴板</span></span><br><span class="line">    mClipper = DocumentsApplication.getDocumentClipper(getContext());</span><br><span class="line">    <span class="comment">// 拖拽相关</span></span><br><span class="line">    <span class="keyword">if</span> (mInjector.config.dragAndDropEnabled()) &#123;</span><br><span class="line">        <span class="type">DirectoryDragListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DirectoryDragListener</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DragHost</span>&lt;&gt;(</span><br><span class="line">                        mActivity,</span><br><span class="line">                        DocumentsApplication.getDragAndDropManager(mActivity),</span><br><span class="line">                        mInjector.selectionMgr,</span><br><span class="line">                        mInjector.actions,</span><br><span class="line">                        mActivity.getDisplayState(),</span><br><span class="line">                        mInjector.dialogs,</span><br><span class="line">                        (View v) -&gt; &#123;</span><br><span class="line">                            <span class="keyword">return</span> getModelId(v) != <span class="literal">null</span>;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="built_in">this</span>::getDocumentHolder,</span><br><span class="line">                        <span class="built_in">this</span>::getDestination</span><br><span class="line">                ));</span><br><span class="line">        mDragHoverListener = DragHoverListener.create(listener, mRecView);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Make the recycler and the empty views responsive to drop events when allowed.</span></span><br><span class="line">    mRecView.setOnDragListener(mDragHoverListener);</span><br><span class="line">    <span class="keyword">return</span> view;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>绑定了model对象,  可以把model理解为<code>DirectoryFragment</code>对象的model数;据对象,  恰恰是mvc框架中的 <a href="#mvc%E6%A1%86%E6%9E%B6">model</a> 模型层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The data model for the current loaded directory.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>接着进到onActivityCreated中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> &#123; </span><br><span class="line"><span class="comment">// 判断调用状态, 前面的includeState</span></span><br><span class="line">	mState = mActivity.getDisplayState();</span><br><span class="line">    <span class="comment">// 初始化DirectoryFragment传入参数</span></span><br><span class="line">    mLocalState.restore(args);</span><br><span class="line">    <span class="comment">// RecyclerView绑定的Adapter, 这个地方使用了代理模式, 真正干活的是ModelBackedDocumentsAdapter</span></span><br><span class="line">    mAdapter = <span class="keyword">new</span> <span class="title class_">DirectoryAddonsAdapter</span>(</span><br><span class="line">                mAdapterEnv,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ModelBackedDocumentsAdapter</span>(mAdapterEnv, mIconHelper, mInjector.fileTypeLookup)</span><br><span class="line">        );</span><br><span class="line">    <span class="comment">// 绑定到RecyclerView</span></span><br><span class="line">    mRecView.setAdapter(mAdapter);</span><br><span class="line">    <span class="comment">// 布局相关的管理</span></span><br><span class="line">    mLayout = <span class="keyword">new</span> <span class="title class_">GridLayoutManager</span>(getContext(), mColumnCount) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLayoutCompleted</span><span class="params">(RecyclerView.State state)</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.onLayoutCompleted(state);</span><br><span class="line">                mFocusManager.onLayoutCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">     &#125;;</span><br><span class="line">    mRecView.setLayoutManager(mLayout);</span><br><span class="line">    <span class="comment">// 添加两个回调, 在调用model的notifyUpdateListeners方法时, 会回调这两个监听的accept方法, 对应model数据更新时的动作</span></span><br><span class="line">    </span><br><span class="line">    mModel.addUpdateListener(mAdapter.getModelUpdateListener());</span><br><span class="line">    mModel.addUpdateListener(mModelUpdateListener);</span><br><span class="line">    mActions = mInjector.getActionHandler(mContentLock);</span><br><span class="line">    <span class="comment">// 选择管理器</span></span><br><span class="line">    mSelectionMgr = mInjector.getSelectionManager(mAdapter, selectionPredicate);</span><br><span class="line">    <span class="comment">// 选择数据</span></span><br><span class="line">    mSelectionMetadata = <span class="keyword">new</span> <span class="title class_">SelectionMetadata</span>(mModel::getItem);</span><br><span class="line">    <span class="comment">// 继承SelectionObserver抽象类, 订阅, 回调相应的方法, 回调在DefaultSelectionHelper 中, 工厂模式, mSelectionMetadata继承SelectionObserver,此处继承的方法为onItemStateChanged</span></span><br><span class="line">    mSelectionMgr.addObserver(mSelectionMetadata);</span><br><span class="line">    <span class="comment">// item详情页面查找</span></span><br><span class="line">    mDetailsLookup = <span class="keyword">new</span> <span class="title class_">DocsItemDetailsLookup</span>(mRecView);</span><br><span class="line">    <span class="comment">// 回调onActionItemClicked时, menu click 会执行handleMenuItemClick方法. java8 函数式接口</span></span><br><span class="line">    mActionModeController = mInjector.getActionModeController(</span><br><span class="line">        mSelectionMetadata,</span><br><span class="line">        <span class="built_in">this</span>::handleMenuItemClick);</span><br><span class="line">    <span class="comment">//又添加了监听, item动作回调</span></span><br><span class="line">    mSelectionMgr.addObserver(mActionModeController);</span><br><span class="line">            <span class="comment">// Kick off loader at least once, 调用AbstractActionHandler中的</span></span><br><span class="line">    <span class="number">1.</span> mActions.loadDocumentsForCurrentStack();    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> -&gt; <span class="comment">// </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadDocumentsForCurrentStack</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DocumentStack</span> <span class="variable">stack</span> <span class="operator">=</span> mState.stack;</span><br><span class="line">        <span class="keyword">if</span> (!stack.isRecents() &amp;&amp; stack.isEmpty()) &#123;</span><br><span class="line">              .... <span class="comment">//非正常情况</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mActivity.getLoaderManager().restartLoader(LOADER_ID, <span class="literal">null</span>, mBindings);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用restartLoader后进入了Loader的流程</p>
<p>mBindings绑定的Loader为DirectoryLoader, 正是在onCreateLoader返回的.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> Loader&lt;DirectoryResult&gt; <span class="title function_">onCreateLoader</span><span class="params">(<span class="type">int</span> id, Bundle args)</span> &#123;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> mActivity;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mState.stack.isRecents()) &#123;</span><br><span class="line">                <span class="comment">// 对应最近item</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Creating new loader recents.&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RecentsLoader</span>(</span><br><span class="line">                        context,</span><br><span class="line">                        mProviders,</span><br><span class="line">                        mState,</span><br><span class="line">                        mInjector.features,</span><br><span class="line">                        mExecutors,</span><br><span class="line">                        mInjector.fileTypeLookup);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">Uri</span> <span class="variable">contentsUri</span> <span class="operator">=</span> mSearchMgr.isSearching()</span><br><span class="line">                        ? DocumentsContract.buildSearchDocumentsUri(</span><br><span class="line">                            mState.stack.getRoot().authority,</span><br><span class="line">                            mState.stack.getRoot().rootId,</span><br><span class="line">                            mSearchMgr.getCurrentSearch())</span><br><span class="line">                    <span class="comment">// 未搜索情况下, </span></span><br><span class="line">                        : DocumentsContract.buildChildDocumentsUri(</span><br><span class="line">                                mState.stack.peek().authority,</span><br><span class="line">                                mState.stack.peek().documentId);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (mInjector.config.managedModeEnabled(mState.stack)) &#123;</span><br><span class="line">                    contentsUri = DocumentsContract.setManageMode(contentsUri);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG,</span><br><span class="line">                        <span class="string">&quot;Creating new directory loader for: &quot;</span></span><br><span class="line">                                + DocumentInfo.debugString(mState.stack.peek()));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectoryLoader</span>(</span><br><span class="line">                        mInjector.features,</span><br><span class="line">                        context,</span><br><span class="line">                        mState.stack.getRoot(),</span><br><span class="line">                        mState.stack.peek(),</span><br><span class="line">                    <span class="comment">// 注意contentsUri, 通过buildChildDocumentsUri构造, </span></span><br><span class="line">                    <span class="comment">// content://authority/document:rootid/children</span></span><br><span class="line">                        contentsUri,</span><br><span class="line">                        mState.sortModel,</span><br><span class="line">                        mInjector.fileTypeLookup,</span><br><span class="line">                        mContentLock,</span><br><span class="line">                        mSearchMgr.isSearching());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在DirectoryLoader start状态后, 异步加载数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> DirectoryResult <span class="title function_">loadInBackground</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isLoadInBackgroundCanceled()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OperationCanceledException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        mSignal = <span class="keyword">new</span> <span class="title class_">CancellationSignal</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ContentResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> getContext().getContentResolver();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">authority</span> <span class="operator">=</span> mUri.getAuthority();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">DirectoryResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DirectoryResult</span>();</span><br><span class="line">    result.doc = mDoc;</span><br><span class="line"></span><br><span class="line">    <span class="type">ContentProviderClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    Cursor cursor;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        client = DocumentsApplication.acquireUnstableProviderOrThrow(resolver, authority);</span><br><span class="line">        <span class="keyword">if</span> (mDoc.isInArchive()) &#123;</span><br><span class="line">            ArchivesProvider.acquireArchive(client, mUri);</span><br><span class="line">        &#125;</span><br><span class="line">        result.client = client;</span><br><span class="line"></span><br><span class="line">        <span class="type">Resources</span> <span class="variable">resources</span> <span class="operator">=</span> getContext().getResources();</span><br><span class="line">        <span class="keyword">if</span> (mFeatures.isContentPagingEnabled()) &#123;</span><br><span class="line">            <span class="type">Bundle</span> <span class="variable">queryArgs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">            <span class="comment">// 构建查询排序条件, 根据mSortedDimension制定按那个条件排序</span></span><br><span class="line">            mModel.addQuerySortArgs(queryArgs);</span><br><span class="line">            cursor = client.query(mUri, <span class="literal">null</span>, queryArgs, mSignal);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cursor = client.query(</span><br><span class="line">                    mUri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, mModel.getDocumentSortQuery(), mSignal);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 数据变动时回调监听</span></span><br><span class="line">        cursor.registerContentObserver(mObserver);</span><br><span class="line">        <span class="comment">// 下面有好多CursorWrapper, 后面可以详细看一下</span></span><br><span class="line">        cursor = <span class="keyword">new</span> <span class="title class_">RootCursorWrapper</span>(mUri.getAuthority(), mRoot.rootId, cursor, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mSearchMode &amp;&amp; !mFeatures.isFoldersInSearchResultsEnabled()) &#123;</span><br><span class="line">            <span class="comment">// There is no findDocumentPath API. Enable filtering on folders in search mode.</span></span><br><span class="line">            cursor = <span class="keyword">new</span> <span class="title class_">FilteringCursorWrapper</span>(cursor, <span class="literal">null</span>, SEARCH_REJECT_MIMES);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mFeatures.isContentPagingEnabled()</span><br><span class="line">                    &amp;&amp; cursor.getExtras().containsKey(ContentResolver.QUERY_ARG_SORT_COLUMNS)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (VERBOSE) Log.d(TAG, <span class="string">&quot;Skipping sort of pre-sorted cursor. Booya!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cursor = mModel.sortCursor(cursor, mFileTypeLookup);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 最终的结果是封装了cursor</span></span><br><span class="line">        result.cursor = cursor;</span><br><span class="line">    &#125;  <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">&quot;Failed to query&quot;</span>, e);</span><br><span class="line">        <span class="comment">// query出错, exception不为空</span></span><br><span class="line">        result.exception = e;</span><br><span class="line">    &#125; ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在数据加载完后, 调用LoaderCallback的 onLoadFinished</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoadFinished</span><span class="params">(Loader&lt;DirectoryResult&gt; loader, DirectoryResult result)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Loader has finished for: &quot;</span></span><br><span class="line">                    + DocumentInfo.debugString(mState.stack.peek()));</span><br><span class="line">            <span class="keyword">assert</span>(result != <span class="literal">null</span>);</span><br><span class="line">            <span class="number">1.</span> 数据被封装到模型层 model中</span><br><span class="line">            mInjector.getModel().update(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> -&gt; <span class="comment">// model 数据的update</span></span><br><span class="line">     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(DirectoryResult result)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span>(result != <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.i(TAG, <span class="string">&quot;Updating model with new result set.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result.exception != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果load出错, 清空数据, 回调addUpdateListener注册的监听</span></span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Error while loading directory contents&quot;</span>, result.exception);</span><br><span class="line">            reset(); <span class="comment">// Resets this model to avoid access to old cursors.</span></span><br><span class="line">            notifyUpdateListeners(result.exception);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mCursor = result.cursor;</span><br><span class="line">        mCursorCount = mCursor.getCount();</span><br><span class="line">        doc = result.doc;</span><br><span class="line"><span class="number">2.</span> <span class="comment">// 从cursor中load数据</span></span><br><span class="line">        updateModelData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">extras</span> <span class="operator">=</span> mCursor.getExtras();</span><br><span class="line">        <span class="keyword">if</span> (extras != <span class="literal">null</span>) &#123;</span><br><span class="line">            info = extras.getString(DocumentsContract.EXTRA_INFO);</span><br><span class="line">            error = extras.getString(DocumentsContract.EXTRA_ERROR);</span><br><span class="line">            mIsLoading = extras.getBoolean(DocumentsContract.EXTRA_LOADING, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span><span class="comment">// 回调监听, </span></span><br><span class="line">    notifyUpdateListeners();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> -&gt; <span class="comment">// updateModelData, 文件夹下内容保存到mFileNames中, 并生成model id用于识别document </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateModelData</span><span class="params">()</span> &#123;</span><br><span class="line">        mIds = <span class="keyword">new</span> <span class="title class_">String</span>[mCursorCount];</span><br><span class="line">        mFileNames.clear();</span><br><span class="line">        mCursor.moveToPosition(-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>; pos &lt; mCursorCount; ++pos) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mCursor.moveToNext()) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Fail to move cursor to next pos: &quot;</span> + pos);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Generates a Model ID for a cursor entry that refers to a document. The Model ID is a</span></span><br><span class="line">            <span class="comment">// unique string that can be used to identify the document referred to by the cursor.</span></span><br><span class="line">            <span class="comment">// If the cursor is a merged cursor over multiple authorities, then prefix the ids</span></span><br><span class="line">            <span class="comment">// with the authority to avoid collisions.</span></span><br><span class="line">            <span class="keyword">if</span> (mCursor <span class="keyword">instanceof</span> MergeCursor) &#123;</span><br><span class="line">                mIds[pos] = getCursorString(mCursor, RootCursorWrapper.COLUMN_AUTHORITY)</span><br><span class="line">                        + <span class="string">&quot;|&quot;</span> + getCursorString(mCursor, Document.COLUMN_DOCUMENT_ID);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mIds[pos] = getCursorString(mCursor, Document.COLUMN_DOCUMENT_ID);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 文件夹下的内容加到mFileNames中, </span></span><br><span class="line">            mFileNames.add(getCursorString(mCursor, Document.COLUMN_DISPLAY_NAME));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Populate the positions.</span></span><br><span class="line">        mPositions.clear();</span><br><span class="line">    <span class="comment">// 以string的model id为key保存了 该项在cursor中的位置. 后面在getItem(string modelid)时用于检索</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mCursorCount; ++i) &#123;</span><br><span class="line">            mPositions.put(mIds[i], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> -&gt; <span class="comment">// 这里注册了两个监听, 回调其accept方法</span></span><br><span class="line">    <span class="number">3.1</span> -&gt; <span class="comment">// modelid的更新</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onModelUpdate</span><span class="params">(Update event)</span> &#123;</span><br><span class="line">        <span class="comment">// make sure the delegate handles the update before we do.</span></span><br><span class="line">        <span class="comment">// This isn&#x27;t ideal since the delegate might be listening</span></span><br><span class="line">        <span class="comment">// the updates itself. But this is the safe thing to do</span></span><br><span class="line">        <span class="comment">// since we read model ids from the delegate</span></span><br><span class="line">        <span class="comment">// in our update handler.</span></span><br><span class="line">        mDelegate.getModelUpdateListener().accept(event);</span><br><span class="line">    </span><br><span class="line">        mModelUpdateListener = <span class="keyword">new</span> <span class="title class_">EventListener</span>&lt;Model.Update&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Update event)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (event.hasException()) &#123;</span><br><span class="line">                    onModelUpdateFailed(event.getException());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    onModelUpdate(mEnv.getModel());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">onModelUpdate</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">            String[] modelIds = model.getModelIds();</span><br><span class="line">            mModelIds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(modelIds.length);</span><br><span class="line">            <span class="keyword">for</span> (String id : modelIds) &#123;</span><br><span class="line">                mModelIds.add(id);</span><br><span class="line">            &#125;</span><br><span class="line">    	&#125;</span><br><span class="line">        <span class="comment">// mModelIds为holdview的内部数据,</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ModelUpdateListener</span> <span class="keyword">implements</span> <span class="title class_">EventListener</span>&lt;Model.Update&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Model.Update update)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Received model update. Loading=&quot;</span> + mModel.isLoading());</span><br><span class="line"></span><br><span class="line">            mProgressBar.setVisibility(mModel.isLoading() ? View.VISIBLE : View.GONE);</span><br><span class="line">            <span class="comment">// 表格还是列表更新布局, 主要调用了 mRecView.requestLayout();方法, View的requestLayout方法会使view重绘,   requeLayout() : 控件会重新执行 onMesure() onLayout() ,比如 ScrollView中有LinearLaout ，LinearLayout里面有纵向排列的ImageView和TextView,那么假如ImageView的长宽发生了变化，而要立即在手机上显示这个变化的话，就可调用 imageView.requestLayout();这样的话ScrollView  会重新执行onMesure()这个方法会确定控件的大小然后在确定出自己的宽高，最后在执行onLayout()，这个方法是对所有的子控件进行定位的</span></span><br><span class="line">            <span class="comment">// 这里会重绘布局, </span></span><br><span class="line">            updateLayout(mState.derivedMode);</span><br><span class="line">            <span class="comment">// 更新视图数据 , 对于RecyclerView 会重新调用其onBindViewHolder 方法</span></span><br><span class="line">            mAdapter.notifyDataSetChanged();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mRestoredSelection != <span class="literal">null</span>) &#123;</span><br><span class="line">                mSelectionMgr.restoreSelection(mRestoredSelection);</span><br><span class="line">                mRestoredSelection = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Restore any previous instance state</span></span><br><span class="line">            <span class="keyword">final</span> SparseArray&lt;Parcelable&gt; container =</span><br><span class="line">                    mState.dirConfigs.remove(mLocalState.getConfigKey());</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">curSortedDimensionId</span> <span class="operator">=</span> mState.sortModel.getSortedDimensionId();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">SortDimension</span> <span class="variable">curSortedDimension</span> <span class="operator">=</span></span><br><span class="line">                    mState.sortModel.getDimensionById(curSortedDimensionId);</span><br><span class="line">            <span class="keyword">if</span> (container != <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; !getArguments().getBoolean(Shared.EXTRA_IGNORE_STATE, <span class="literal">false</span>)) &#123;</span><br><span class="line">                getView().restoreHierarchyState(container);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLocalState.mLastSortDimensionId != curSortedDimension.getId()</span><br><span class="line">                    || mLocalState.mLastSortDimensionId == SortModel.SORT_DIMENSION_ID_UNKNOWN</span><br><span class="line">                    || mLocalState.mLastSortDirection != curSortedDimension.getSortDirection()) &#123;</span><br><span class="line">                <span class="comment">// Scroll to the top if the sort order actually changed.</span></span><br><span class="line">                mRecView.smoothScrollToPosition(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mModel.isLoading()) &#123;</span><br><span class="line">                mActivity.notifyDirectoryLoaded(</span><br><span class="line">                        mModel.doc != <span class="literal">null</span> ? mModel.doc.derivedUri : <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>更新视图,  这里以ListDocumentHolder为例, </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DocumentHolder <span class="title function_">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="type">int</span> viewType)</span> &#123;</span><br><span class="line">        <span class="type">DocumentHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">State</span> <span class="variable">state</span> <span class="operator">=</span> mEnv.getDisplayState();</span><br><span class="line">        <span class="keyword">switch</span> (state.derivedMode) &#123;</span><br><span class="line">...<span class="comment">// 省略网格视图           </span></span><br><span class="line">            <span class="keyword">case</span> MODE_LIST:</span><br><span class="line">                holder = <span class="keyword">new</span> <span class="title class_">ListDocumentHolder</span>(</span><br><span class="line">                        mEnv.getContext(), parent, mIconHelper, mFileTypeLookup);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mEnv.initDocumentHolder(holder);</span><br><span class="line">        <span class="keyword">return</span> holder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ListDocumentHolder</span><span class="params">(Context context, ViewGroup parent, IconHelper iconHelper,</span></span><br><span class="line"><span class="params">            Lookup&lt;String, String&gt; fileTypeLookup)</span> &#123;</span><br><span class="line">        <span class="comment">// 设置布局为 item_doc_list</span></span><br><span class="line">        <span class="built_in">super</span>(context, parent, R.layout.item_doc_list);</span><br><span class="line">        <span class="comment">// 找到布局中的控件</span></span><br><span class="line">        mIconLayout = itemView.findViewById(android.R.id.icon);</span><br><span class="line">        mIconMime = (ImageView) itemView.findViewById(R.id.icon_mime);</span><br><span class="line">        mIconThumb = (ImageView) itemView.findViewById(R.id.icon_thumb);</span><br><span class="line">        mIconCheck = (ImageView) itemView.findViewById(R.id.icon_check);</span><br><span class="line">        mTitle = (TextView) itemView.findViewById(android.R.id.title);</span><br><span class="line">        mSummary = (TextView) itemView.findViewById(android.R.id.summary);</span><br><span class="line">        mSize = (TextView) itemView.findViewById(R.id.size);</span><br><span class="line">        mDate = (TextView) itemView.findViewById(R.id.date);</span><br><span class="line">        mType = (TextView) itemView.findViewById(R.id.file_type);</span><br><span class="line">        <span class="comment">// Warning: mDetails view doesn&#x27;t exists in layout-sw720dp-land layout</span></span><br><span class="line">        mDetails = (LinearLayout) itemView.findViewById(R.id.line2);</span><br><span class="line"></span><br><span class="line">        mIconHelper = iconHelper;</span><br><span class="line">        mFileTypeLookup = fileTypeLookup;</span><br><span class="line">        mDoc = <span class="keyword">new</span> <span class="title class_">DocumentInfo</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBindViewHolder</span><span class="params">(DocumentHolder holder, <span class="type">int</span> position, List&lt;Object&gt; payload)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (payload.contains(SelectionHelper.SELECTION_CHANGED_MARKER)) &#123;</span><br><span class="line">            <span class="comment">// 设置选中状态</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">selected</span> <span class="operator">=</span> mEnv.isSelected(mModelIds.get(position));</span><br><span class="line">            holder.setSelected(selected, <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            onBindViewHolder(holder, position);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBindViewHolder</span><span class="params">(DocumentHolder holder, <span class="type">int</span> position)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">modelId</span> <span class="operator">=</span> mModelIds.get(position);</span><br><span class="line">        <span class="comment">// 由position 反检索出 cursor 和 id.</span></span><br><span class="line">        <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> mEnv.getModel().getItem(modelId);</span><br><span class="line">        </span><br><span class="line"><span class="number">1.</span>        <span class="comment">// 更新视图,</span></span><br><span class="line">        holder.bind(cursor, modelId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">docMimeType</span> <span class="operator">=</span> getCursorString(cursor, Document.COLUMN_MIME_TYPE);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">docFlags</span> <span class="operator">=</span> getCursorInt(cursor, Document.COLUMN_FLAGS);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">enabled</span> <span class="operator">=</span> mEnv.isDocumentEnabled(docMimeType, docFlags);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">selected</span> <span class="operator">=</span> mEnv.isSelected(modelId);</span><br><span class="line">        <span class="keyword">if</span> (!enabled) &#123;</span><br><span class="line">            <span class="keyword">assert</span>(!selected);</span><br><span class="line">        &#125;</span><br><span class="line">        holder.setEnabled(enabled);</span><br><span class="line">        holder.setSelected(mEnv.isSelected(modelId), <span class="literal">false</span>);</span><br><span class="line">        mEnv.onBindDocumentHolder(holder, cursor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> -&gt; <span class="comment">// 更新子试图, 更新控件</span></span><br><span class="line">    </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bind</span><span class="params">(Cursor cursor, String modelId)</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span>(cursor != <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        mModelId = modelId;</span><br><span class="line">        <span class="comment">// 根据cursor更新DocumentInfo对象</span></span><br><span class="line">        mDoc.updateFromCursor(cursor, getCursorString(cursor, RootCursorWrapper.COLUMN_AUTHORITY));</span><br><span class="line">        <span class="comment">// 停止显示缩略图</span></span><br><span class="line">        mIconHelper.stopLoading(mIconThumb);</span><br><span class="line">        mIconMime.animate().cancel();</span><br><span class="line">        mIconMime.setAlpha(<span class="number">1f</span>);</span><br><span class="line">        mIconThumb.animate().cancel();</span><br><span class="line">        mIconThumb.setAlpha(<span class="number">0f</span>);</span><br><span class="line">        <span class="comment">// 重新显示缩略图信息</span></span><br><span class="line">        mIconHelper.load(mDoc, mIconThumb, mIconMime, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        mTitle.setText(mDoc.displayName, TextView.BufferType.SPANNABLE);</span><br><span class="line">        mTitle.setVisibility(View.VISIBLE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasDetails</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mDoc.isDirectory()) &#123;</span><br><span class="line">            <span class="comment">// Note, we don&#x27;t show any details for any directory...ever.</span></span><br><span class="line">            hasDetails = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Show summary if the file is partial. Otherwise, there tends</span></span><br><span class="line">            <span class="comment">// to be a bunch of confusing junk in the summary field</span></span><br><span class="line">            <span class="comment">// as populated by Downlaods (and others). So to make things</span></span><br><span class="line">            <span class="comment">// simpler and clearer for the user in list view, we only</span></span><br><span class="line">            <span class="comment">// show the summary if the file is partial &gt;</span></span><br><span class="line">            <span class="comment">// which we believe to mean actively downloading.</span></span><br><span class="line">            <span class="keyword">if</span> (mDoc.isPartial() &amp;&amp; mDoc.summary != <span class="literal">null</span>) &#123;</span><br><span class="line">                hasDetails = <span class="literal">true</span>;</span><br><span class="line">                mSummary.setText(mDoc.summary);</span><br><span class="line">                mSummary.setVisibility(View.VISIBLE);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mSummary.setVisibility(View.INVISIBLE);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mDoc.lastModified &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                hasDetails = <span class="literal">true</span>;</span><br><span class="line">                mDate.setText(Shared.formatTime(mContext, mDoc.lastModified));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mDate.setText(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mDoc.size &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                hasDetails = <span class="literal">true</span>;</span><br><span class="line">                mSize.setVisibility(View.VISIBLE);</span><br><span class="line">                mSize.setText(Formatter.formatFileSize(mContext, mDoc.size));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mSize.setVisibility(View.INVISIBLE);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mType.setText(mFileTypeLookup.lookup(mDoc.mimeType));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mDetails view doesn&#x27;t exists in layout-sw720dp-land layout</span></span><br><span class="line">        <span class="keyword">if</span> (mDetails != <span class="literal">null</span>) &#123;</span><br><span class="line">            mDetails.setVisibility(hasDetails ? View.VISIBLE : View.GONE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/AndroidP/" rel="tag"># AndroidP</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/07/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%88%9D%E6%8E%A2/" rel="prev" title="文件系统初探">
      <i class="fa fa-chevron-left"></i> 文件系统初探
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/07/01/%E5%AD%98%E5%82%A8%E7%9B%B8%E5%85%B3/Android%20fuse%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%BB%8B%E7%BB%8D/" rel="next" title="Android fuse 文件系统调研">
      Android fuse 文件系统调研 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E5%BA%94%E7%94%A8%E7%AB%AF%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.</span> <span class="nav-text">1. 应用端代码示例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E6%8E%88%E4%BA%88%E7%9B%AE%E5%BD%95%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="nav-number">1.1.</span> <span class="nav-text">1.1. 授予目录访问权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1-%E9%80%9A%E8%BF%87ACTION-OPEN-DOCUMENT-TREE%E6%8E%88%E4%BA%88%E5%BA%94%E7%94%A8%E8%AE%BF%E9%97%AE%E7%89%B9%E5%AE%9A%E7%9B%AE%E5%BD%95%E7%9A%84%E6%9D%83%E9%99%90"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1.1. 通过ACTION_OPEN_DOCUMENT_TREE授予应用访问特定目录的权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-2-%E9%80%9A%E8%BF%87ACTION-OPEN-EXTERNAL-DIRECTORY%E6%8E%88%E4%BA%88%E5%BA%94%E7%94%A8%E7%9B%AE%E5%BD%95%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.1.2. 通过ACTION_OPEN_EXTERNAL_DIRECTORY授予应用目录访问权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E6%96%87%E6%A1%A3%E6%90%9C%E7%B4%A2"><span class="nav-number">1.2.</span> <span class="nav-text">1.2. 文档搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-%E9%80%9A%E8%BF%87ACTION-OPEN-DOCUMENT%E5%AE%9E%E7%8E%B0%E6%90%9C%E7%B4%A2%E6%96%87%E4%BB%B6"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1. 通过ACTION_OPEN_DOCUMENT实现搜索文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E6%96%87%E6%A1%A3%E5%88%9B%E5%BB%BA"><span class="nav-number">1.3.</span> <span class="nav-text">1.3. 文档创建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-1-%E9%80%9A%E8%BF%87ACTION-CREATE-DOCUMENT-%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.3.1. 通过ACTION_CREATE_DOCUMENT 创建文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E6%96%87%E6%A1%A3%E7%BC%96%E8%BE%91"><span class="nav-number">1.4.</span> <span class="nav-text">1.4. 文档编辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-1-%E9%80%9A%E8%BF%87ACTION-OPEN-DOCUMENT-%E7%BC%96%E8%BE%91%E6%96%87%E6%A1%A3"><span class="nav-number">1.4.1.</span> <span class="nav-text">1.4.1. 通过ACTION_OPEN_DOCUMENT 编辑文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="nav-number">1.5.</span> <span class="nav-text">1.5. 删除文档</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-%E4%BF%9D%E7%95%99%E6%9D%83%E9%99%90"><span class="nav-number">1.6.</span> <span class="nav-text">1.6. 保留权限</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-DocumentUi-%E7%9B%B8%E5%85%B3%E8%B0%83%E7%94%A8%E8%A7%A3%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">2. DocumentUi 相关调用解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-ACTION-OPEN-EXTERNAL-DIRECTORY-%E6%8E%88%E6%9D%83%E5%A4%96%E9%83%A8%E5%AD%98%E5%82%A8%E6%9D%83%E9%99%90%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90"><span class="nav-number">2.1.</span> <span class="nav-text">2.1. ACTION_OPEN_EXTERNAL_DIRECTORY 授权外部存储权限流程解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E9%80%9A%E8%BF%87ACTION-CREATE-DOCUMENT-%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.2.</span> <span class="nav-text">2.2. 通过ACTION_CREATE_DOCUMENT 创建文档调用流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-SaveFragment"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1. SaveFragment</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-1-fragment%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">2.2.1.1. fragment生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-1-1-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%88%86%E6%9E%90"><span class="nav-number">2.2.1.1.1.</span> <span class="nav-text">2.2.1.1.1. 生命周期分析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-2-saveFragment-onCreateView-%E5%A1%AB%E5%85%85%E5%B8%83%E5%B1%80"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">2.2.1.2. saveFragment onCreateView 填充布局</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-3-saveFragment-%E4%BF%9D%E5%AD%98%E6%96%87%E4%BB%B6"><span class="nav-number">2.2.1.3.</span> <span class="nav-text">2.2.1.3. saveFragment 保存文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-4-provider%E7%AB%AF%E8%B0%83%E7%94%A8"><span class="nav-number">2.2.1.4.</span> <span class="nav-text">2.2.1.4. provider端调用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-application-%E5%88%86%E6%9E%90"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2. application 分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-ACTION-OPEN-DOCUMENT-%E7%BC%96%E8%BE%91%E6%96%87%E6%A1%A3%E7%9B%B8%E5%85%B3%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-number">2.3.</span> <span class="nav-text">2.3. ACTION_OPEN_DOCUMENT 编辑文档相关调用分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-Loader%E6%9C%BA%E5%88%B6"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.3.1. Loader机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-restartLoader%E8%B0%83%E7%94%A8"><span class="nav-number">2.3.2.</span> <span class="nav-text">2.3.2. restartLoader调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-RootsLoader-%E5%85%B3%E8%81%94%E7%9A%84-RootsAdapter"><span class="nav-number">2.3.3.</span> <span class="nav-text">2.3.3. RootsLoader 关联的 RootsAdapter</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-1-mvc%E6%A1%86%E6%9E%B6"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">2.3.3.1. mvc框架</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-2-%E9%9C%80%E8%A6%81%E5%85%B3%E6%B3%A8-RootItem"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">2.3.3.2. 需要关注 RootItem</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-DirectoryFragment"><span class="nav-number">2.4.</span> <span class="nav-text">2.4. DirectoryFragment</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-DirectoryFragment-%E5%B1%95%E7%A4%BAroot%E5%86%85%E5%AE%B9"><span class="nav-number">2.4.1.</span> <span class="nav-text">2.4.1. DirectoryFragment 展示root内容</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liguang.zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">159</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">110</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liguang.zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'dark',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'VrGRp2q7WwXjxsCNmlDIZYbC-gzGzoHsz',
      appKey     : 'JgMXmmB7yKQf2zm80TaBp3JT',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
