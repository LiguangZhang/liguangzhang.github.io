<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liguangzhang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="主要调研下Settings对应的通用搜索框架的实现. 1. 自定义fragment支持search扩展需要继承com.android.settings.search.Indexable接口, 定义SearchIndexProvider的实例, 并需要将自己加到SearchIndexableResources的sProviders中 1.1. 接口定义123456789101112131415161">
<meta property="og:type" content="article">
<meta property="og:title" content="Settings 搜索框架调研">
<meta property="og:url" content="https://liguangzhang.github.io/2018/10/21/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/%E8%AE%BE%E7%BD%AE%E4%B8%AD%E7%BB%9F%E4%B8%80%E6%90%9C%E7%B4%A2%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:description" content="主要调研下Settings对应的通用搜索框架的实现. 1. 自定义fragment支持search扩展需要继承com.android.settings.search.Indexable接口, 定义SearchIndexProvider的实例, 并需要将自己加到SearchIndexableResources的sProviders中 1.1. 接口定义123456789101112131415161">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-10-20T16:00:00.000Z">
<meta property="article:modified_time" content="2024-04-15T10:57:25.849Z">
<meta property="article:author" content="liguang.zhang">
<meta property="article:tag" content="设计模式">
<meta property="article:tag" content="Settings Search">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liguangzhang.github.io/2018/10/21/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/%E8%AE%BE%E7%BD%AE%E4%B8%AD%E7%BB%9F%E4%B8%80%E6%90%9C%E7%B4%A2%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Settings 搜索框架调研 | blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2018/10/21/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/%E8%AE%BE%E7%BD%AE%E4%B8%AD%E7%BB%9F%E4%B8%80%E6%90%9C%E7%B4%A2%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Settings 搜索框架调研
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-10-21 00:00:00" itemprop="dateCreated datePublished" datetime="2018-10-21T00:00:00+08:00">2018-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-15 18:57:25" itemprop="dateModified" datetime="2024-04-15T18:57:25+08:00">2024-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AF%BB%E4%B9%A6/" itemprop="url" rel="index"><span itemprop="name">读书</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>主要调研下Settings对应的通用搜索框架的实现.</p>
<h1 id="1-自定义fragment支持search扩展"><a href="#1-自定义fragment支持search扩展" class="headerlink" title="1. 自定义fragment支持search扩展"></a>1. 自定义fragment支持search扩展</h1><p>需要继承com.android.settings.search.Indexable接口, 定义SearchIndexProvider的实例, 并需要将自己加到SearchIndexableResources的sProviders中</p>
<h2 id="1-1-接口定义"><a href="#1-1-接口定义" class="headerlink" title="1.1. 接口定义"></a>1.1. 接口定义</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 嵌套接口的用法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Indexable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">SearchIndexProvider</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Return a list of references for indexing.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * See &#123;<span class="doctag">@link</span> android.provider.SearchIndexableResource&#125;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> context the context.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> enabled hint telling if the data needs to be considered into the search results</span></span><br><span class="line"><span class="comment">         *                or not.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> a list of &#123;<span class="doctag">@link</span> android.provider.SearchIndexableResource&#125; references.</span></span><br><span class="line"><span class="comment">         *         Can be null.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        List&lt;SearchIndexableResource&gt; <span class="title function_">getXmlResourcesToIndex</span><span class="params">(Context context, <span class="type">boolean</span> enabled)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Return a list of raw data for indexing. See &#123;<span class="doctag">@link</span> SearchIndexableRaw&#125;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> context the context.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> enabled hint telling if the data needs to be considered into the search results</span></span><br><span class="line"><span class="comment">         *                or not.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> a list of &#123;<span class="doctag">@link</span> SearchIndexableRaw&#125; references. Can be null.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        List&lt;SearchIndexableRaw&gt; <span class="title function_">getRawDataToIndex</span><span class="params">(Context context, <span class="type">boolean</span> enabled)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Return a list of data keys that cannot be indexed. See &#123;<span class="doctag">@link</span> SearchIndexableRaw&#125;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> context the context.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> a list of &#123;<span class="doctag">@link</span> SearchIndexableRaw&#125; references. Can be null.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        List&lt;String&gt; <span class="title function_">getNonIndexableKeys</span><span class="params">(Context context)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> a list of &#123;<span class="doctag">@link</span> AbstractPreferenceController&#125; for ResultPayload data during</span></span><br><span class="line"><span class="comment">         * Indexing.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        List&lt;AbstractPreferenceController&gt; <span class="title function_">getPreferenceControllers</span><span class="params">(Context context)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-接口实现"><a href="#1-2-接口实现" class="headerlink" title="1.2. 接口实现"></a>1.2. 接口实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义SearchIndexProvider的实例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">SearchIndexProvider</span> <span class="variable">SEARCH_INDEX_DATA_PROVIDER</span> <span class="operator">=</span> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">BaseSearchIndexProvider</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> List&lt;SearchIndexableResource&gt; <span class="title function_">getXmlResourcesToIndex</span><span class="params">(</span></span><br><span class="line"><span class="params">                    Context context, <span class="type">boolean</span> enabled)</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">SearchIndexableResource</span> <span class="variable">sir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchIndexableResource</span>(context);</span><br><span class="line">                sir.xmlResId = R.xml.tether_prefs;</span><br><span class="line">                <span class="keyword">return</span> Arrays.asList(sir);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseSearchIndexProvider</span> <span class="keyword">implements</span> <span class="title class_">Indexable</span>.SearchIndexProvider</span><br><span class="line"><span class="comment">// 加到sResMap中, 后面遍历时用打</span></span><br><span class="line">addIndex(TetherSettings.class, NO_DATA_RES_ID, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>定义了通用类, BaseSearchIndexProvider, 实现接口的通用方法, 如果有具体的定制需求, 需要自定义BaseSearchIndexProvider的子类覆盖对应方法.</p>
<h2 id="1-3-结构图"><a href="#1-3-结构图" class="headerlink" title="1.3. 结构图"></a>1.3. 结构图</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">interface Indexable &#123;               </span><br><span class="line">   interface SearchIndexProvider</span><br><span class="line">&#125;</span><br><span class="line">interface SearchIndexProvider &#123;</span><br><span class="line">    getXmlResourcesToIndex(...)</span><br><span class="line">    getRawDataToIndex()</span><br><span class="line">    getNonIndexableKeys()</span><br><span class="line">&#125;</span><br><span class="line">Indexable *-- SearchIndexProvider </span><br><span class="line">class BaseSearchIndexProvider implements SearchIndexProvider &#123;</span><br><span class="line">    getXmlResourcesToIndex(...)</span><br><span class="line">    getRawDataToIndex()</span><br><span class="line">    getNonIndexableKeys()</span><br><span class="line">&#125;</span><br><span class="line">class DemoFragment implements Indexable &#123;</span><br><span class="line">    SearchIndexProvider SEARCH_INDEX_DATA_PROVIDER</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DemoFragment o-- BaseSearchIndexProvider</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p>DemoFragment中的SEARCH_INDEX_DATA_PROVIDER为具体类, 需要根据实际情况覆写 Indexable.SearchIndexProvider的方法.</p>
<h1 id="2-Settings-搜索实现"><a href="#2-Settings-搜索实现" class="headerlink" title="2. Settings 搜索实现"></a>2. Settings 搜索实现</h1><h2 id="2-1-Search-入口分析"><a href="#2-1-Search-入口分析" class="headerlink" title="2.1. Search 入口分析,"></a>2.1. Search 入口分析,</h2><p>先看入口SettingsActivity, 工厂模式, 反射方式加载具体工厂 FeatureFactoryImpl, 进而找到 SearchFeatureProviderImpl代理.<br>SearchFeatureProviderImpl类为SearchFeatureProvider的代理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FeatureFactory.getFactory(<span class="built_in">this</span>).getSearchFeatureProvider()</span><br><span class="line">        .initSearchToolbar(<span class="built_in">this</span>, toolbar);</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">clsName</span> <span class="operator">=</span> context.getString(R.string.config_featureFactory);</span><br><span class="line">sFactory = (FeatureFactory) context.getClassLoader().loadClass(clsName).newInstance();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeatureFactoryImpl</span> <span class="keyword">extends</span> <span class="title class_">FeatureFactory</span></span><br></pre></td></tr></table></figure>

<p>FeatureFactory为抽象类, 实现类为FeatureFactoryImpl(代理类), 实现了 getSearchFeatureProvider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">FeatureFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> SearchFeatureProvider <span class="title function_">getSearchFeatureProvider</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FeatureFactoryImpl类</span></span><br><span class="line">    <span class="keyword">public</span> SearchFeatureProvider <span class="title function_">getSearchFeatureProvider</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSearchFeatureProvider == <span class="literal">null</span>) &#123;</span><br><span class="line">            mSearchFeatureProvider = <span class="keyword">new</span> <span class="title class_">SearchFeatureProviderImpl</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mSearchFeatureProvider;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>SearchFeatureProvider为interface, 含默认方法initSearchToolbar. Java中的接口可以有默认方法<br>initSearchToolbar中指定了Settings的搜索toolbar点击对应的动作.<br>启动SEARCH_UI_INTENT即SEARCH对应的fragment  “com.android.settings.action.SETTINGS_SEARCH”<br>对应SearchActivity.<br>同时通过绑定的getSlicesFeatureProvider初始化数据库.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SearchFeatureProvider</span> &#123;</span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">initSearchToolbar</span><span class="params">(Activity activity, Toolbar toolbar)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (activity == <span class="literal">null</span> || toolbar == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        toolbar.setOnClickListener(tb -&gt; &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> SEARCH_UI_INTENT;</span><br><span class="line">            intent.setPackage(getSettingsIntelligencePkgName());</span><br><span class="line"></span><br><span class="line">            FeatureFactory.getFactory(</span><br><span class="line">                    activity.getApplicationContext()).getSlicesFeatureProvider()</span><br><span class="line">                    .indexSliceDataAsync(activity.getApplicationContext());</span><br><span class="line">            activity.startActivityForResult(intent, <span class="number">0</span> <span class="comment">/* requestCode */</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-1-FeatureFactory的相关类图"><a href="#2-1-1-FeatureFactory的相关类图" class="headerlink" title="2.1.1. FeatureFactory的相关类图"></a>2.1.1. FeatureFactory的相关类图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">abstract class FeatureFactory &#123;</span><br><span class="line">    +abstract SearchFeatureProvider getSearchFeatureProvider()</span><br><span class="line">    +static FeatureFactory getFactory()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class FeatureFactoryImpl extends FeatureFactory &#123;</span><br><span class="line">    +SearchFeatureProvider getSearchFeatureProvider()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SearchFeatureProvider -d-o FeatureFactory</span><br><span class="line">SearchFeatureProvider ..o FeatureFactoryImpl: getSearchFeatureProvider</span><br><span class="line"></span><br><span class="line">class SearchFeatureProviderImpl implements SearchFeatureProvider&#123;</span><br><span class="line">    +updateIndex(Context context)</span><br><span class="line">    +DatabaseIndexingManager getIndexingManager(Context context)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface SearchFeatureProvider &#123;</span><br><span class="line">    default void initSearchToolbar(Activity activity, Toolbar toolbar)</span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<h3 id="2-1-2-getSlicesFeatureProvider-初始化数据"><a href="#2-1-2-getSlicesFeatureProvider-初始化数据" class="headerlink" title="2.1.2. getSlicesFeatureProvider 初始化数据"></a>2.1.2. getSlicesFeatureProvider 初始化数据</h3><p>通过FeatureFactory的<code>getSlicesFeatureProvider</code>方法找到SlicesFeatureProvider, 对应的实现代理为SlicesFeatureProviderImpl, 类的关系同SearchFeatureProvider<br>这里主要看下indexSliceDataAsync的实现. 是SlicesFeatureProvider接口的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">indexSliceDataAsync</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">SlicesIndexer</span> <span class="variable">indexer</span> <span class="operator">=</span> getSliceIndexer(context);</span><br><span class="line">    <span class="number">1.</span> ThreadUtils.postOnBackgroundThread(indexer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这里的get方法通通为单例模式</span></span><br><span class="line">mSlicesIndexer = <span class="keyword">new</span> <span class="title class_">SlicesIndexer</span>(context);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SlicesIndexer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlicesIndexer</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="comment">// getInstance 单例</span></span><br><span class="line">        mHelper = SlicesDatabaseHelper.getInstance(mContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="number">1.</span> indexSliceData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到数据库类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlicesDatabaseHelper</span> <span class="keyword">extends</span> <span class="title class_">SQLiteOpenHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">SlicesDatabaseHelper</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, DATABASE_NAME, <span class="literal">null</span> <span class="comment">/* CursorFactor */</span>, DATABASE_VERSION);</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过getSliceIndexer实例化SlicesIndexer(单例), 执行ThreadUtils.postOnBackgroundThread方法.<br>ThreadUtils为Thread工具类,  保存了ExecutorService对象(单例), 启动线程池执行Runnable的run方法, 即SlicesIndexer的run方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">postOnBackgroundThread</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sSingleThreadExecutor == <span class="literal">null</span>) &#123;</span><br><span class="line">        sSingleThreadExecutor = Executors.newSingleThreadExecutor();</span><br><span class="line">    &#125;</span><br><span class="line">    sSingleThreadExecutor.execute(runnable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来重点看下indexSliceData的执行流程</p>
<h3 id="2-1-3-indexSliceData"><a href="#2-1-3-indexSliceData" class="headerlink" title="2.1.3. indexSliceData"></a>2.1.3. indexSliceData</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">indexSliceData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 这里有个不重复加载的机制, 跟语言项有关, 注意替换apk的方式可能需要清空数据, 否则这里不再重新index. 与setIndexedState调用有关</span></span><br><span class="line">        <span class="keyword">if</span> (mHelper.isSliceDataIndexed()) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Slices already indexed - returning.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">SQLiteDatabase</span> <span class="variable">database</span> <span class="operator">=</span> mHelper.getWritableDatabase();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            database.beginTransaction();</span><br><span class="line"></span><br><span class="line">            mHelper.reconstruct(mHelper.getWritableDatabase());</span><br><span class="line">            <span class="comment">// 数据的获得通过 getSliceData</span></span><br><span class="line">            <span class="number">1.1</span> List&lt;SliceData&gt; indexData = getSliceData();</span><br><span class="line">            <span class="comment">// 插入数据库中</span></span><br><span class="line">            insertSliceData(database, indexData);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 只初始化一次? mHelper里也没有实现增删改的方法, 只有onUpgrade.</span></span><br><span class="line">            mHelper.setIndexedState();</span><br><span class="line">            database.setTransactionSuccessful();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            database.endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.1</span> -&gt; <span class="comment">// 获取数据,  </span></span><br><span class="line">    List&lt;SliceData&gt; <span class="title function_">getSliceData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 又见到 FeatureFactory, 同样方式拿到SliceDataConverter, 通过SlicesFeatureProviderImpl代理类拿到</span></span><br><span class="line">        <span class="keyword">return</span> FeatureFactory.getFactory(mContext)</span><br><span class="line">                .getSlicesFeatureProvider()</span><br><span class="line">                .getSliceDataConverter(mContext)</span><br><span class="line">                .getSliceData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SliceDataConverter <span class="title function_">getSliceDataConverter</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(mSliceDataConverter == <span class="literal">null</span>) &#123;</span><br><span class="line">            mSliceDataConverter = <span class="keyword">new</span> <span class="title class_">SliceDataConverter</span>(context.getApplicationContext());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mSliceDataConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">SliceDataConverter</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> List&lt;SliceData&gt; <span class="title function_">getSliceData</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSliceData.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> mSliceData;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 找到代理SearchFeatureProviderImpl的resource对象.</span></span><br><span class="line"> <span class="number">1.2</span>           <span class="keyword">final</span> Collection&lt;Class&gt; indexableClasses = FeatureFactory.getFactory(mContext)</span><br><span class="line">                    .getSearchFeatureProvider().getSearchIndexableResources().getProviderValues();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Class clazz : indexableClasses) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">fragmentName</span> <span class="operator">=</span> clazz.getName();</span><br><span class="line"></span><br><span class="line"> <span class="number">1.3</span>               <span class="keyword">final</span> <span class="type">SearchIndexProvider</span> <span class="variable">provider</span> <span class="operator">=</span> DatabaseIndexingUtils.getSearchIndexProvider(</span><br><span class="line">                        clazz);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// CodeInspection test guards against the null check. Keep check in case of bad actors.</span></span><br><span class="line">                <span class="keyword">if</span> (provider == <span class="literal">null</span>) &#123;</span><br><span class="line">                    Log.e(TAG, fragmentName + <span class="string">&quot; dose not implement Search Index Provider&quot;</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"> <span class="number">1.4</span>               <span class="keyword">final</span> List&lt;SliceData&gt; providerSliceData = getSliceDataFromProvider(provider,</span><br><span class="line">                        fragmentName);</span><br><span class="line">                mSliceData.addAll(providerSliceData);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> mSliceData;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.2</span> -&gt;  <span class="comment">// SearchFeatureProviderImpl的resource对象.</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SearchIndexableResources <span class="title function_">getSearchIndexableResources</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSearchIndexableResources == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 单例 + 代理</span></span><br><span class="line">            mSearchIndexableResources = <span class="keyword">new</span> <span class="title class_">SearchIndexableResourcesImpl</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mSearchIndexableResources;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通过上述方法终于找到了SearchIndexableResourcesImpl类, 这个存放了所有支持搜索的fragment的class, 通过其提供的<br>getProviderValues方法获取集合. 这个地方与<a href="#%E8%87%AA%E5%AE%9A%E4%B9%89fragment%E6%94%AF%E6%8C%81search%E6%89%A9%E5%B1%95">自定义fragment支持search扩展</a> 呼应</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">addIndex</span><span class="params">(Class indexClass)</span> &#123;</span><br><span class="line">    sProviders.add(indexClass);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Collection&lt;Class&gt; <span class="title function_">getProviderValues</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sProviders;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-1-4-怎样找到资源的"><a href="#2-1-4-怎样找到资源的" class="headerlink" title="2.1.4. 怎样找到资源的"></a>2.1.4. 怎样找到资源的</h3><p>工具类 DatabaseIndexingUtils, 遍历支持搜索的fragment的class的类名, 通过反射找到其SEARCH_INDEX_DATA_PROVIDER字段(如果支持搜索, 必须定义该字段)<br>反射出类 SearchIndexProvider(Indexable接口中的子接口)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">SearchIndexProvider</span> <span class="variable">provider</span> <span class="operator">=</span> DatabaseIndexingUtils.getSearchIndexProvider(clazz);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Indexable.SearchIndexProvider <span class="title function_">getSearchIndexProvider</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> clazz.getField(FIELD_NAME_SEARCH_INDEX_DATA_PROVIDER);</span><br><span class="line">            <span class="keyword">return</span> (Indexable.SearchIndexProvider) f.get(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.4</span> -&gt; 从provider中获取数据, 即支持搜索的fragment需要覆写方法提供数据</span><br><span class="line"><span class="keyword">final</span> List&lt;SliceData&gt; providerSliceData = getSliceDataFromProvider(provider,</span><br><span class="line">                        fragmentName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;SliceData&gt; <span class="title function_">getSliceDataFromProvider</span><span class="params">(SearchIndexProvider provider,</span></span><br><span class="line"><span class="params">            String fragmentName)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;SliceData&gt; sliceData = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 需要覆写 getXmlResourcesToIndex方法, 提供xml 资源id</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;SearchIndexableResource&gt; resList =</span><br><span class="line">                provider.getXmlResourcesToIndex(mContext, <span class="literal">true</span> <span class="comment">/* enabled */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SearchIndexableResource resource : resList) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">xmlResId</span> <span class="operator">=</span> resource.xmlResId;</span><br><span class="line">            <span class="keyword">if</span> (xmlResId == <span class="number">0</span>) &#123;</span><br><span class="line">                Log.e(TAG, fragmentName + <span class="string">&quot; provides invalid XML (0) in search provider.&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.4</span><span class="number">.1</span>            List&lt;SliceData&gt; xmlSliceData = getSliceDataFromXML(xmlResId, fragmentName);</span><br><span class="line">            sliceData.addAll(xmlSliceData);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sliceData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.4</span><span class="number">.1</span> -&gt; 通过xml id解析出元素填充到SliceData中</span><br><span class="line"><span class="keyword">private</span> List&lt;SliceData&gt; <span class="title function_">getSliceDataFromXML</span><span class="params">(<span class="type">int</span> xmlResId, String fragmentName)</span> &#123;</span><br><span class="line">        <span class="type">XmlResourceParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;SliceData&gt; xmlSliceData = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parser = mContext.getResources().getXml(xmlResId);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> type;</span><br><span class="line">            <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                    &amp;&amp; type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">                <span class="comment">// Parse next until start tag is found</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">nodeName</span> <span class="operator">=</span> parser.getName();</span><br><span class="line">  ...</span><br><span class="line">            <span class="keyword">final</span> <span class="type">AttributeSet</span> <span class="variable">attrs</span> <span class="operator">=</span> Xml.asAttributeSet(parser);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">screenTitle</span> <span class="operator">=</span> PreferenceXmlParserUtils.getDataTitle(mContext, attrs);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// TODO (b/67996923) Investigate if we need headers for Slices, since they never</span></span><br><span class="line">            <span class="comment">// correspond to an actual setting.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> List&lt;Bundle&gt; metadata = PreferenceXmlParserUtils.extractMetadata(mContext,</span><br><span class="line">                    xmlResId,</span><br><span class="line">                    MetadataFlag.FLAG_NEED_KEY</span><br><span class="line">                            | MetadataFlag.FLAG_NEED_PREF_CONTROLLER</span><br><span class="line">                            | MetadataFlag.FLAG_NEED_PREF_TYPE</span><br><span class="line">                            | MetadataFlag.FLAG_NEED_PREF_TITLE</span><br><span class="line">                            | MetadataFlag.FLAG_NEED_PREF_ICON</span><br><span class="line">                            | MetadataFlag.FLAG_NEED_PREF_SUMMARY</span><br><span class="line">                            | MetadataFlag.FLAG_NEED_PLATFORM_SLICE_FLAG);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Bundle bundle : metadata) &#123;</span><br><span class="line">                <span class="comment">// TODO (b/67996923) Non-controller Slices should become intent-only slices.</span></span><br><span class="line">                <span class="comment">// Note that without a controller, dynamic summaries are impossible.</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">controllerClassName</span> <span class="operator">=</span> bundle.getString(METADATA_CONTROLLER);</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(controllerClassName)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> bundle.getString(METADATA_KEY);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> bundle.getString(METADATA_TITLE);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">summary</span> <span class="operator">=</span> bundle.getString(METADATA_SUMMARY);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">iconResId</span> <span class="operator">=</span> bundle.getInt(METADATA_ICON);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">int</span> <span class="variable">sliceType</span> <span class="operator">=</span> SliceBuilderUtils.getSliceType(mContext, controllerClassName,</span><br><span class="line">                        key);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isPlatformSlice</span> <span class="operator">=</span> bundle.getBoolean(METADATA_PLATFORM_SLICE_FLAG);</span><br><span class="line">                <span class="comment">// Build模式</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">SliceData</span> <span class="variable">xmlSlice</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SliceData</span>.Builder()</span><br><span class="line">                        .setKey(key)</span><br><span class="line">                        .setTitle(title)</span><br><span class="line">                        .setSummary(summary)</span><br><span class="line">                        .setIcon(iconResId)</span><br><span class="line">                        .setScreenTitle(screenTitle)</span><br><span class="line">                        .setPreferenceControllerClassName(controllerClassName)</span><br><span class="line">                        .setFragmentName(fragmentName)</span><br><span class="line">                        .setSliceType(sliceType)</span><br><span class="line">                        .setPlatformDefined(isPlatformSlice)</span><br><span class="line">                        .build();</span><br><span class="line"></span><br><span class="line">                xmlSliceData.add(xmlSlice);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> xmlSliceData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>拿到数据后, 即List<SliceData>  后, 通过<code>insertSliceData(database, indexData)</code> 插入到数据库中.</p>
<h3 id="2-1-5-小节"><a href="#2-1-5-小节" class="headerlink" title="2.1.5. 小节"></a>2.1.5. 小节</h3><p>Settings入口分析结束, 其中看到了统一的工厂, 抽象工厂, 具体工厂, 通过工厂管理各种工种, 成员为抽象的, 调用工厂的方法找到实际的工种代理.<br>统一管理起来. 每个代理都是单例的, 其中又涉及到了builder模式, 工具类的使用等等.<br>抽象 + 具体的模式使用非常普遍, 保存成员时都是保存的抽象.</p>
<p>上述过程主要涉及到元数据的索引, provider和database并不是直接的联系, 而是通过了几层的桥接. 数据类为SliceData</p>
<h2 id="2-2-搜索过程"><a href="#2-2-搜索过程" class="headerlink" title="2.2. 搜索过程"></a>2.2. 搜索过程</h2><p>通过输入关键词找到关键词对应的fragment. 对应的ui是SearchActivity, 需要回想之前的fragment的生命周期. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">// 绑定layout 为 search_main</span></span><br><span class="line">    setContentView(R.layout.search_main);</span><br><span class="line">    <span class="comment">// Keeps layouts in-place when keyboard opens.</span></span><br><span class="line">    getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_ADJUST_PAN);</span><br><span class="line"></span><br><span class="line">    <span class="type">FragmentManager</span> <span class="variable">fragmentManager</span> <span class="operator">=</span> getFragmentManager();</span><br><span class="line">    <span class="type">Fragment</span> <span class="variable">fragment</span> <span class="operator">=</span> fragmentManager.findFragmentById(R.id.main_content);</span><br><span class="line">    <span class="comment">// 绑定布局, 关联到SearchFragment</span></span><br><span class="line">    <span class="keyword">if</span> (fragment == <span class="literal">null</span>) &#123;</span><br><span class="line">        fragmentManager.beginTransaction()</span><br><span class="line">                .add(R.id.main_content, <span class="keyword">new</span> <span class="title class_">SearchFragment</span>())</span><br><span class="line">                .commit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入SearchFragment的生命周期中, 这里又使用到了Loader</p>
<h3 id="2-2-1-SearchFragment的生命周期"><a href="#2-2-1-SearchFragment的生命周期" class="headerlink" title="2.2.1. SearchFragment的生命周期"></a>2.2.1. SearchFragment的生命周期</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 继承LoaderCallbacks</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> <span class="keyword">implements</span> <span class="title class_">SearchView</span>.OnQueryTextListener,</span><br><span class="line">        LoaderManager.LoaderCallbacks&lt;List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt;&gt;, IndexingCallback &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onAttach(context);</span><br><span class="line">        <span class="comment">// 关联SearchFeatureProvider</span></span><br><span class="line">        mSearchFeatureProvider = FeatureFactory.get(context).searchFeatureProvider();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">LoaderManager</span> <span class="variable">loaderManager</span> <span class="operator">=</span> getLoaderManager();</span><br><span class="line">        <span class="comment">// 对应的Adapter</span></span><br><span class="line">        mSearchAdapter = <span class="keyword">new</span> <span class="title class_">SearchResultsAdapter</span>(<span class="built_in">this</span> <span class="comment">/* fragment */</span>);</span><br><span class="line">        mSavedQueryController = <span class="keyword">new</span> <span class="title class_">SavedQueryController</span>(</span><br><span class="line">                getContext(), loaderManager, mSearchAdapter);</span><br><span class="line">        <span class="comment">// 更新元数据索引, 又更新一轮</span></span><br><span class="line">        <span class="number">1.</span> mSearchFeatureProvider.updateIndexAsync(getContext(), <span class="built_in">this</span> <span class="comment">/* indexingCallback */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container,</span></span><br><span class="line"><span class="params">            Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> getActivity();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">View</span> <span class="variable">view</span> <span class="operator">=</span> inflater.inflate(R.layout.search_panel, container, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// 这里又使用到了 RecyclerView, item元素的布局为list_results</span></span><br><span class="line">        mResultsRecyclerView = view.findViewById(R.id.list_results);</span><br><span class="line">        mResultsRecyclerView.setAdapter(mSearchAdapter);</span><br><span class="line">        <span class="comment">// 设定线性布局管理</span></span><br><span class="line">        mResultsRecyclerView.setLayoutManager(<span class="keyword">new</span> <span class="title class_">LinearLayoutManager</span>(activity));</span><br><span class="line">        mResultsRecyclerView.addOnScrollListener(mScrollListener);</span><br><span class="line"></span><br><span class="line">        mNoResultsView = view.findViewById(R.id.no_results_layout);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Toolbar</span> <span class="variable">toolbar</span> <span class="operator">=</span> view.findViewById(R.id.search_toolbar);</span><br><span class="line">        activity.setActionBar(toolbar);</span><br><span class="line">        activity.getActionBar().setDisplayHomeAsUpEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        mSearchView = toolbar.findViewById(R.id.search_view);</span><br><span class="line">        <span class="comment">// Query数据保存到 mQuery中. 触发时机为onQueryTextSubmit 和  onQueryTextChange时</span></span><br><span class="line">        <span class="comment">// 封装了SearchView, 为Search Toolbar对应的布局.</span></span><br><span class="line">        mSearchView.setQuery(mQuery, <span class="literal">false</span> <span class="comment">/* submitQuery */</span>);</span><br><span class="line">        mSearchView.setOnQueryTextListener(<span class="built_in">this</span>);</span><br><span class="line">        mSearchView.requestFocus();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> view;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-2-provider-updateIndexAsync"><a href="#2-2-2-provider-updateIndexAsync" class="headerlink" title="2.2.2. provider.updateIndexAsync"></a>2.2.2. provider.updateIndexAsync</h3><p>这个地方在SearchFragment进入时, 又更新了一遍搜索数据库index, 需要重点看下, 整个过程为启动AsyncTask, 检索数据, 对数据进行处理, 放在数据库中.<br>在AsyncTask中执行, 检索完成后调用callback. 回调<code>SearchFragment.onIndexingFinished</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> -&gt; <span class="comment">// 1. mSearchFeatureProvider.updateIndexAsync(getContext(), this /* indexingCallback */);</span></span><br><span class="line"><span class="comment">// 数据的更新直接参与者都是provider, 只不过这里的provider更加抽象, 前面查到数据后往数据库里写的操作</span></span><br><span class="line"><span class="comment">// callback为本身, 加载完成后通过AsyncTask的onPostExecute回调onIndexingFinished</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateIndexAsync</span><span class="params">(Context context, IndexingCallback callback)</span> &#123;</span><br><span class="line">        getIndexingManager(context).indexDatabase(callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DatabaseIndexingManager <span class="title function_">getIndexingManager</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDatabaseIndexingManager == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 关联到 数据库索引管理类, 单例</span></span><br><span class="line">            mDatabaseIndexingManager = <span class="keyword">new</span> <span class="title class_">DatabaseIndexingManager</span>(context.getApplicationContext());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mDatabaseIndexingManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 启动AsyncTask</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">indexDatabase</span><span class="params">(IndexingCallback callback)</span> &#123;</span><br><span class="line">        <span class="type">IndexingTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexingTask</span>(callback);</span><br><span class="line">        task.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexingTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Void, Void, Void&gt; &#123;</span><br><span class="line">        <span class="keyword">protected</span> Void <span class="title function_">doInBackground</span><span class="params">(Void... voids)</span> &#123;</span><br><span class="line">            <span class="number">1.1</span> performIndexing();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.2</span> <span class="comment">// 加载完成回调SearchFragment.onIndexingFinished</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onIndexingFinished</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (getActivity() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mShowingSavedQuery) &#123;</span><br><span class="line">            mSavedQueryController.loadSavedQueries();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">LoaderManager</span> <span class="variable">loaderManager</span> <span class="operator">=</span> getLoaderManager();</span><br><span class="line">            loaderManager.initLoader(SearchLoaderId.SEARCH_RESULT, <span class="literal">null</span> <span class="comment">/* args */</span>,</span><br><span class="line">                    <span class="built_in">this</span> <span class="comment">/* callback */</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        requery();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="number">1.1</span> -&gt; <span class="comment">// performIndexing</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">performIndexing</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 通过intent 匹配 action provider, 关联到了 SettingsSearchIndexablesProvider</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(SearchIndexablesContract.PROVIDER_INTERFACE);</span><br><span class="line">        <span class="keyword">final</span> List&lt;ResolveInfo&gt; providers =</span><br><span class="line">                mContext.getPackageManager().queryIntentContentProviders(intent, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isFullIndex</span> <span class="operator">=</span> IndexDatabaseHelper.isFullIndex(mContext, providers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isFullIndex) &#123;</span><br><span class="line">            <span class="comment">// 第一次进来, 会进入里面, 实际操作数据的是IndexDatabaseHelper类</span></span><br><span class="line">            <span class="number">1.1</span><span class="number">.1</span>  rebuildDatabase();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取数据</span></span><br><span class="line">        <span class="number">1.1</span><span class="number">.2</span> <span class="type">PreIndexData</span> <span class="variable">indexData</span> <span class="operator">=</span> getIndexDataFromProviders(providers, isFullIndex);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">updateDatabaseStartTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// setIndex后, 会往sharePreference里写, isFullIndex就变为false, 首次的话 isFullIndex 为 true</span></span><br><span class="line">        <span class="number">1.1</span><span class="number">.3</span>   updateDatabase(indexData, isFullIndex);</span><br><span class="line">        IndexDatabaseHelper.setIndexed(mContext, providers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.search.SettingsSearchIndexablesProvider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;com.android.settings&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:multiprocess</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:permission</span>=<span class="string">&quot;android.permission.READ_SEARCH_INDEXABLES&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.content.action.SEARCH_INDEXABLES_PROVIDER&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先看下数据库重建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.1</span><span class="number">.1</span> -&gt; <span class="comment">// 重建数据库表, 清空sharePreference</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rebuildDatabase</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Drop the database when the locale or build has changed. This eliminates rows which are</span></span><br><span class="line">        <span class="comment">// dynamically inserted in the old language, or deprecated settings.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">SQLiteDatabase</span> <span class="variable">db</span> <span class="operator">=</span> getWritableDatabase();</span><br><span class="line">        IndexDatabaseHelper.getInstance(mContext).reconstruct(db);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reconstruct</span><span class="params">(SQLiteDatabase db)</span> &#123;</span><br><span class="line">        <span class="comment">// 清空sharePreference</span></span><br><span class="line">        mContext.getSharedPreferences(SHARED_PREFS_TAG, Context.MODE_PRIVATE)</span><br><span class="line">                .edit()</span><br><span class="line">                .clear()</span><br><span class="line">                .commit();</span><br><span class="line">        <span class="comment">//清空数据库的table</span></span><br><span class="line">        dropTables(db);</span><br><span class="line">        <span class="comment">// 重建数据库table</span></span><br><span class="line">        bootstrapDB(db);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.1</span><span class="number">.2</span> -&gt; <span class="comment">//获取数据 这里的跟之前又有不同</span></span><br><span class="line"><span class="number">1.1</span><span class="number">.2</span> <span class="type">PreIndexData</span> <span class="variable">indexData</span> <span class="operator">=</span> getIndexDataFromProviders(providers, isFullIndex);</span><br><span class="line"></span><br><span class="line">    PreIndexData <span class="title function_">getIndexDataFromProviders</span><span class="params">(List&lt;ResolveInfo&gt; providers, <span class="type">boolean</span> isFullIndex)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCollector == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 单例关联到 PreIndexDataCollector类, 找到的provider为SettingsSearchIndexablesProvider</span></span><br><span class="line">            mCollector = <span class="keyword">new</span> <span class="title class_">PreIndexDataCollector</span>(mContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mCollector.collectIndexableData(providers, isFullIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PreIndexData <span class="title function_">collectIndexableData</span><span class="params">(List&lt;ResolveInfo&gt; providers, <span class="type">boolean</span> isFullIndex)</span> &#123;</span><br><span class="line">        mIndexData = <span class="keyword">new</span> <span class="title class_">PreIndexData</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> ResolveInfo info : providers) &#123;</span><br><span class="line">            <span class="comment">// 权限相关</span></span><br><span class="line">            <span class="keyword">if</span> (!isWellKnownProvider(info)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">authority</span> <span class="operator">=</span> info.providerInfo.authority;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> info.providerInfo.packageName;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 首次重建</span></span><br><span class="line">            <span class="keyword">if</span> (isFullIndex) &#123;</span><br><span class="line"><span class="number">1.1</span><span class="number">.2</span><span class="number">.1</span>                addIndexablesFromRemoteProvider(packageName, authority);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="number">1.1</span><span class="number">.2</span><span class="number">.2</span>     addNonIndexablesKeysFromRemoteProvider(packageName, authority);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mIndexData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.1</span><span class="number">.2</span><span class="number">.1</span>  -&gt; <span class="comment">// 构建查询uri, 查询SettingsSearchIndexablesProvider获取数据</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addIndexablesFromRemoteProvider</span><span class="params">(String packageName, String authority)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> BASE_AUTHORITY.equals(authority) ?</span><br><span class="line">                    mContext : mContext.createPackageContext(packageName, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构建xml的查询数据uri</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Uri</span> <span class="variable">uriForResources</span> <span class="operator">=</span> buildUriForXmlResources(authority);</span><br><span class="line">            mIndexData.dataToUpdate.addAll(getIndexablesForXmlResourceUri(context, packageName,</span><br><span class="line">                    uriForResources, SearchIndexablesContract.INDEXABLES_XML_RES_COLUMNS));</span><br><span class="line">            <span class="comment">// 构建rawdata的查询数据uri</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Uri</span> <span class="variable">uriForRawData</span> <span class="operator">=</span> buildUriForRawData(authority);</span><br><span class="line">            <span class="comment">// 查询完后, 统一放在mIndexData.dataToUpdate中</span></span><br><span class="line">            mIndexData.dataToUpdate.addAll(getIndexablesForRawDataUri(context, packageName,</span><br><span class="line">                    uriForRawData, SearchIndexablesContract.INDEXABLES_RAW_COLUMNS));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.1</span><span class="number">.2</span><span class="number">.2</span> -&gt;<span class="comment">// 构建查询uri, 查询查询SettingsSearchIndexablesProvider获取数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addNonIndexablesKeysFromRemoteProvider</span><span class="params">(String packageName,</span></span><br><span class="line"><span class="params">            String authority)</span> &#123;</span><br><span class="line">        <span class="comment">// 构建NonIndexableKeys的查询uri</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;String&gt; keys =</span><br><span class="line">                getNonIndexablesKeysFromRemoteProvider(packageName, authority);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (keys != <span class="literal">null</span> &amp;&amp; !keys.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 查询到后统一放入mIndexData.nonIndexableKeys map中</span></span><br><span class="line">            mIndexData.nonIndexableKeys.put(authority, <span class="keyword">new</span> <span class="title class_">ArraySet</span>&lt;&gt;(keys));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.1</span><span class="number">.3</span> -&gt; <span class="comment">// 填充数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateDatabase</span><span class="params">(PreIndexData preIndexData, <span class="type">boolean</span> needsReindexing)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, Set&lt;String&gt;&gt; nonIndexableKeys = preIndexData.nonIndexableKeys;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">SQLiteDatabase</span> <span class="variable">database</span> <span class="operator">=</span> getWritableDatabase();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            database.beginTransaction();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Convert all Pre-index data to Index data.</span></span><br><span class="line">            <span class="comment">// 重新获取元数据, 对元数据进行处理</span></span><br><span class="line">            <span class="number">1.1</span><span class="number">.3</span><span class="number">.1</span> List&lt;IndexData&gt; indexData = getIndexData(preIndexData);</span><br><span class="line">            <span class="comment">// 获取元数据后, 插入数据库相应字段中   跟 insertSliceData 对比</span></span><br><span class="line">            <span class="number">1.1</span><span class="number">.3</span><span class="number">.2</span> insertIndexData(database, indexData);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Only check for non-indexable key updates after initial index.</span></span><br><span class="line">            <span class="comment">// Enabled state with non-indexable keys is checked when items are first inserted.</span></span><br><span class="line">            <span class="comment">// 当前场景为首次, needsReindexing为true, 下面流程不走</span></span><br><span class="line">            <span class="keyword">if</span> (!needsReindexing) &#123;</span><br><span class="line">            <span class="number">1.1</span><span class="number">.3</span><span class="number">.3</span>    updateDataInDatabase(database, nonIndexableKeys);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            database.setTransactionSuccessful();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            database.endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.1</span><span class="number">.3</span><span class="number">.1</span>-&gt; <span class="comment">//  List&lt;IndexData&gt; indexData = getIndexData(preIndexData);</span></span><br><span class="line">    List&lt;IndexData&gt; <span class="title function_">getIndexData</span><span class="params">(PreIndexData data)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mConverter == <span class="literal">null</span>) &#123;</span><br><span class="line">            mConverter = <span class="keyword">new</span> <span class="title class_">IndexDataConverter</span>(mContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mConverter.convertPreIndexDataToIndexData(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;IndexData&gt; <span class="title function_">convertPreIndexDataToIndexData</span><span class="params">(PreIndexData preIndexData)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 取出从xml资源和rawdata数据</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;SearchIndexableData&gt; indexableData = preIndexData.dataToUpdate;</span><br><span class="line">        <span class="comment">// 取出nonIndexableKeys获得的数据</span></span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, Set&lt;String&gt;&gt; nonIndexableKeys = preIndexData.nonIndexableKeys;</span><br><span class="line">        <span class="keyword">final</span> List&lt;IndexData&gt; indexData = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (SearchIndexableData data : indexableData) &#123;</span><br><span class="line">            <span class="keyword">if</span> (data <span class="keyword">instanceof</span> SearchIndexableRaw) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">SearchIndexableRaw</span> <span class="variable">rawData</span> <span class="operator">=</span> (SearchIndexableRaw) data;</span><br><span class="line">                <span class="keyword">final</span> Set&lt;String&gt; rawNonIndexableKeys = nonIndexableKeys.get(</span><br><span class="line">                        rawData.intentTargetPackage);</span><br><span class="line">                <span class="comment">// builder模式, nonIndexableKeys最终作用到了IndexData的enabled字段, 最终放在了values.put(ENABLED, dataRow.enabled);里, 可能后面数据库查询时会用到</span></span><br><span class="line">                <span class="keyword">final</span> IndexData.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> convertRaw(rawData, rawNonIndexableKeys);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (builder != <span class="literal">null</span>) &#123;</span><br><span class="line">                    indexData.add(builder.build(mContext));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data <span class="keyword">instanceof</span> SearchIndexableResource) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">SearchIndexableResource</span> <span class="variable">sir</span> <span class="operator">=</span> (SearchIndexableResource) data;</span><br><span class="line">                <span class="keyword">final</span> Set&lt;String&gt; resourceNonIndexableKeys =</span><br><span class="line">                        getNonIndexableKeysForResource(nonIndexableKeys, sir.packageName);</span><br><span class="line">                <span class="keyword">final</span> List&lt;IndexData&gt; resourceData = convertResource(sir, resourceNonIndexableKeys);</span><br><span class="line">                indexData.addAll(resourceData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> indexData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.1</span><span class="number">.3</span><span class="number">.2</span> -&gt; <span class="comment">// 更新数据库字段,  注意跟SlicesIndexer.insertSliceData的不同, 替换的是TABLE_SLICES_INDEX表</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertIndexData</span><span class="params">(SQLiteDatabase database, List&lt;IndexData&gt; indexData)</span> &#123;</span><br><span class="line">        ContentValues values;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (IndexData dataRow : indexData) &#123;</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(dataRow.normalizedTitle)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            values = <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">            values.put(IndexDatabaseHelper.IndexColumns.DOCID, dataRow.getDocId());</span><br><span class="line">            values.put(LOCALE, dataRow.locale);</span><br><span class="line">            values.put(DATA_TITLE, dataRow.updatedTitle);</span><br><span class="line">            values.put(DATA_TITLE_NORMALIZED, dataRow.normalizedTitle);</span><br><span class="line">            values.put(DATA_SUMMARY_ON, dataRow.updatedSummaryOn);</span><br><span class="line">            values.put(DATA_SUMMARY_ON_NORMALIZED, dataRow.normalizedSummaryOn);</span><br><span class="line">            values.put(DATA_ENTRIES, dataRow.entries);</span><br><span class="line">            values.put(DATA_KEYWORDS, dataRow.spaceDelimitedKeywords);</span><br><span class="line">            values.put(CLASS_NAME, dataRow.className);</span><br><span class="line">            values.put(SCREEN_TITLE, dataRow.screenTitle);</span><br><span class="line">            values.put(INTENT_ACTION, dataRow.intentAction);</span><br><span class="line">            values.put(INTENT_TARGET_PACKAGE, dataRow.intentTargetPackage);</span><br><span class="line">            values.put(INTENT_TARGET_CLASS, dataRow.intentTargetClass);</span><br><span class="line">            values.put(ICON, dataRow.iconResId);</span><br><span class="line">            values.put(ENABLED, dataRow.enabled);</span><br><span class="line">            values.put(DATA_KEY_REF, dataRow.key);</span><br><span class="line">            values.put(USER_ID, dataRow.userId);</span><br><span class="line">            values.put(PAYLOAD_TYPE, dataRow.payloadType);</span><br><span class="line">            values.put(PAYLOAD, dataRow.payload);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意替换的表</span></span><br><span class="line">            database.replaceOrThrow(TABLE_PREFS_INDEX, <span class="literal">null</span>, values);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(dataRow.className)</span><br><span class="line">                    &amp;&amp; !TextUtils.isEmpty(dataRow.childClassName)) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">ContentValues</span> <span class="variable">siteMapPair</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">                siteMapPair.put(SiteMapColumns.PARENT_CLASS, dataRow.className);</span><br><span class="line">                siteMapPair.put(SiteMapColumns.PARENT_TITLE, dataRow.screenTitle);</span><br><span class="line">                siteMapPair.put(SiteMapColumns.CHILD_CLASS, dataRow.childClassName);</span><br><span class="line">                siteMapPair.put(SiteMapColumns.CHILD_TITLE, dataRow.updatedTitle);</span><br><span class="line"><span class="comment">// 注意替换的表</span></span><br><span class="line">                database.replaceOrThrow(IndexDatabaseHelper.Tables.TABLE_SITE_MAP,</span><br><span class="line">                        <span class="literal">null</span> <span class="comment">/* nullColumnHack */</span>, siteMapPair);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1.1</span><span class="number">.3</span><span class="number">.3</span> -&gt; <span class="comment">// updateDataInDatabase(database, nonIndexableKeys); 这个方法是转换往数据库中更新enable的值.</span></span><br><span class="line">     * All rows which are enabled but are now flagged with non-indexable keys will become disabled.</span><br><span class="line">     * All rows which are disabled but no longer a non-indexable key will become enabled.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>获取数据的PreIndexDataCollector类为客户端, 匹配到Authority的远端的provider为<code>SettingsSearchIndexablesProvider</code><br>该类在内部通过<code>DatabaseIndexingUtils</code>工具类遍历注册的Indexable.SEARCH_INDEX_DATA_PROVIDER, 找到子类覆写的getXmlResourcesToIndex&#x2F;getRawDataToIndex&#x2F;getNonIndexableKeys&#x2F;getPreferenceControllers方法, 如果没有覆写, 则使用其基类BaseSearchIndexProvider的方法<br>检索元数据.</p>
<p>在检索元数据,并将数据放入数据库中后, 检索的AsyncTask走完, 会回调</p>
<h3 id="2-2-3-检索完数据-回调onIndexingFinished方法"><a href="#2-2-3-检索完数据-回调onIndexingFinished方法" class="headerlink" title="2.2.3. 检索完数据, 回调onIndexingFinished方法"></a>2.2.3. 检索完数据, 回调onIndexingFinished方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.2</span> -&gt; <span class="comment">// onIndexingFinished</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onIndexingFinished</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (getActivity() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// mShowingSavedQuery首次加载是为true.</span></span><br><span class="line">        <span class="keyword">if</span> (mShowingSavedQuery) &#123;</span><br><span class="line">   <span class="number">1.2</span><span class="number">.1</span>     mSavedQueryController.loadSavedQueries();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">LoaderManager</span> <span class="variable">loaderManager</span> <span class="operator">=</span> getLoaderManager();</span><br><span class="line">            loaderManager.initLoader(SearchLoaderId.SEARCH_RESULT, <span class="literal">null</span> <span class="comment">/* args */</span>,</span><br><span class="line">                    <span class="built_in">this</span> <span class="comment">/* callback */</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="number">1.2</span><span class="number">.2</span>    requery();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="number">1.2</span><span class="number">.1</span> -&gt; <span class="comment">// Loader restart</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadSavedQueries</span><span class="params">()</span> &#123;</span><br><span class="line">        mLoaderManager.restartLoader(SearchFragment.SearchLoaderId.SAVED_QUERIES, <span class="literal">null</span> <span class="comment">/* args */</span>,</span><br><span class="line">                <span class="built_in">this</span> <span class="comment">/* callback */</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>调用restartLoader后, Loader的生命周期就开启了</p>
<h3 id="2-2-4-进入Loader流程"><a href="#2-2-4-进入Loader流程" class="headerlink" title="2.2.4. 进入Loader流程"></a>2.2.4. 进入Loader流程</h3><p>缓存Loader的控制在SavedQueryController中, <code>SAVED_QUERIES</code>应该是保存的查询项的缓存, 缓存结果保存在了saved_queries表中.<br>真正查询的地方在id为 SEARCH_RESULT的SearchResultLoader中, 是由TextChange事件触发的. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Loader <span class="title function_">onCreateLoader</span><span class="params">(<span class="type">int</span> id, Bundle args)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (id) &#123;</span><br><span class="line">        <span class="keyword">case</span> SearchFragment.SearchLoaderId.SAVE_QUERY_TASK:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SavedQueryRecorder</span>(mContext, args.getString(ARG_QUERY));</span><br><span class="line">        <span class="keyword">case</span> SearchFragment.SearchLoaderId.REMOVE_QUERY_TASK:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SavedQueryRemover</span>(mContext);</span><br><span class="line">        <span class="keyword">case</span> SearchFragment.SearchLoaderId.SAVED_QUERIES:</span><br><span class="line">            <span class="keyword">return</span> mSearchFeatureProvider.getSavedQueryLoader(mContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在onQueryTextChange时会触发</p>
<h3 id="2-2-5-触发查询"><a href="#2-2-5-触发查询" class="headerlink" title="2.2.5. 触发查询"></a>2.2.5. 触发查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 查询条件为 query</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onQueryTextChange</span><span class="params">(String query)</span> &#123;</span><br><span class="line">        <span class="comment">// 上次缓存的条件为 mQuery</span></span><br><span class="line">        <span class="keyword">if</span> (TextUtils.equals(query, mQuery)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isEmptyQuery</span> <span class="operator">=</span> TextUtils.isEmpty(query);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hide no-results-view when the new query is not a super-string of the previous</span></span><br><span class="line">        <span class="keyword">if</span> (mQuery != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; mNoResultsView.getVisibility() == View.VISIBLE</span><br><span class="line">                &amp;&amp; query.length() &lt; mQuery.length()) &#123;</span><br><span class="line">            mNoResultsView.setVisibility(View.GONE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mNeverEnteredQuery = <span class="literal">false</span>;</span><br><span class="line">        mQuery = query;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If indexing is not finished, register the query text, but don&#x27;t search.</span></span><br><span class="line">        <span class="comment">// index 索引未完成的情况下, 先保存查询条件, 待index结束后, 回调callback, 执行requery查询</span></span><br><span class="line">        <span class="keyword">if</span> (!mSearchFeatureProvider.isIndexingComplete(getActivity())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 查询条件为空, 取出缓存的查询项结果</span></span><br><span class="line">        <span class="keyword">if</span> (isEmptyQuery) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">LoaderManager</span> <span class="variable">loaderManager</span> <span class="operator">=</span> getLoaderManager();</span><br><span class="line">            loaderManager.destroyLoader(SearchLoaderId.SEARCH_RESULT);</span><br><span class="line">            mShowingSavedQuery = <span class="literal">true</span>;</span><br><span class="line">            mSavedQueryController.loadSavedQueries();</span><br><span class="line">            mSearchFeatureProvider.hideFeedbackButton(getView());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 开始查询</span></span><br><span class="line"> <span class="number">2.</span>           restartLoaders();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">restartLoaders</span><span class="params">()</span> &#123;</span><br><span class="line">        mShowingSavedQuery = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">LoaderManager</span> <span class="variable">loaderManager</span> <span class="operator">=</span> getLoaderManager();</span><br><span class="line">        loaderManager.restartLoader(</span><br><span class="line">                SearchLoaderId.SEARCH_RESULT, <span class="literal">null</span> <span class="comment">/* args */</span>, <span class="built_in">this</span> <span class="comment">/* callback */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Loader&lt;List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt;&gt; onCreateLoader(<span class="type">int</span> id, Bundle args) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Activity</span> <span class="variable">activity</span> <span class="operator">=</span> getActivity();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (id) &#123;</span><br><span class="line">            <span class="keyword">case</span> SearchLoaderId.SEARCH_RESULT:</span><br><span class="line">                <span class="keyword">return</span> mSearchFeatureProvider.getSearchResultLoader(activity, mQuery);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> SearchResultLoader <span class="title function_">getSearchResultLoader</span><span class="params">(Context context, String query)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchResultLoader</span>(context, cleanQuery(query));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 异步执行AsyncLoader的loadInBackground, 由构造函数传入了查询条件mQuery</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchResultLoader</span> <span class="keyword">extends</span> <span class="title class_">AsyncLoader</span>&lt;List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">public</span> List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt; loadInBackground() &#123;</span><br><span class="line">            <span class="type">SearchResultAggregator</span> <span class="variable">aggregator</span> <span class="operator">=</span> SearchResultAggregator.getInstance();</span><br><span class="line"> <span class="number">2.1</span>           <span class="keyword">return</span> aggregator.fetchResults(getContext(), mQuery);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt; fetchResults(Context context, String query) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SearchFeatureProvider</span> <span class="variable">mFeatureProvider</span> <span class="operator">=</span> FeatureFactory.get(context)</span><br><span class="line">                .searchFeatureProvider();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> mFeatureProvider.getExecutorService();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里封装了四个Task, 但最终索要结果的只有一个Task.</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;SearchQueryTask&gt; tasks =</span><br><span class="line">                mFeatureProvider.getSearchQueryTasks(context, query);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;SearchQueryTask&gt; <span class="title function_">getSearchQueryTasks</span><span class="params">(Context context, String query)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> List&lt;SearchQueryTask&gt; tasks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">cleanQuery</span> <span class="operator">=</span> cleanQuery(query);</span><br><span class="line">            tasks.add(DatabaseResultTask.newTask(context, getSiteMapManager(), cleanQuery));</span><br><span class="line">            tasks.add(InstalledAppResultTask.newTask(context, getSiteMapManager(), cleanQuery));</span><br><span class="line">            tasks.add(AccessibilityServiceResultTask.newTask(context, getSiteMapManager(), cleanQuery));</span><br><span class="line">            tasks.add(InputDeviceResultTask.newTask(context, getSiteMapManager(), cleanQuery));</span><br><span class="line">            <span class="keyword">return</span> tasks;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start tasks, 执行task </span></span><br><span class="line">        <span class="keyword">for</span> (SearchQueryTask task : tasks) &#123;</span><br><span class="line"><span class="number">2.2</span>            executorService.execute(task);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Collect results</span></span><br><span class="line">        <span class="keyword">final</span> Map&lt;Integer, List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt;&gt; taskResults = <span class="keyword">new</span> <span class="title class_">ArrayMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SearchQueryTask task : tasks) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> task.getTaskId();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 以taskid为键值, 存入taskResults中, task.get会阻塞, 未执行完不会返回</span></span><br><span class="line">                taskResults.put(taskId,</span><br><span class="line">                        task.get(SHORT_CHECK_TASK_TIMEOUT_MS, TimeUnit.MILLISECONDS));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Merge results</span></span><br><span class="line"><span class="number">2.3</span>        <span class="keyword">final</span> List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt; mergedResults = mergeSearchResults(taskResults);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mergedResults;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-5-1-DatabaseResultTask执行过程"><a href="#2-2-5-1-DatabaseResultTask执行过程" class="headerlink" title="2.2.5.1. DatabaseResultTask执行过程"></a>2.2.5.1. DatabaseResultTask执行过程</h4><p>DatabaseResultTask并不是AsyncTask, 而是java中的FutureTask机制, 这里简单看一下执行过程.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.2</span> -&gt; <span class="comment">// Add and execute</span></span><br><span class="line">    tasks.add(DatabaseResultTask.newTask(context, getSiteMapManager(), cleanQuery));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DatabaseResultTask</span> <span class="keyword">extends</span> <span class="title class_">SearchQueryTask</span>.QueryWorker &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> SearchQueryTask <span class="title function_">newTask</span><span class="params">(Context context, SiteMapManager siteMapManager,</span></span><br><span class="line"><span class="params">                String query)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchQueryTask</span>(<span class="keyword">new</span> <span class="title class_">DatabaseResultTask</span>(context, siteMapManager, query));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Set&lt;SearchResult&gt; <span class="title function_">query</span><span class="params">(String whereClause, String[] selection, <span class="type">int</span> baseRank)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">SQLiteDatabase</span> <span class="variable">database</span> <span class="operator">=</span></span><br><span class="line">                    IndexDatabaseHelper.getInstance(mContext).getReadableDatabase();</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Cursor</span> <span class="variable">resultCursor</span> <span class="operator">=</span> database.query(TABLE_PREFS_INDEX, SELECT_COLUMNS,</span><br><span class="line">                    whereClause,</span><br><span class="line">                    selection, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> mConverter.convertCursor(resultCursor, baseRank, mSiteMapManager);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchQueryTask</span> <span class="keyword">extends</span> <span class="title class_">FutureTask</span>&lt;List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">SearchQueryTask</span><span class="params">(<span class="meta">@NonNull</span> QueryWorker queryWorker)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(queryWorker);</span><br><span class="line">            mId = queryWorker.getQueryWorkerId();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">QueryWorker</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt;&gt; &#123;</span><br><span class="line">            <span class="keyword">public</span> List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt; call() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> query();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>相关类图</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line"></span><br><span class="line">class FutureTask</span><br><span class="line">package SearchQueryTask &#123;</span><br><span class="line">    class SearchQueryTask extends FutureTask &#123;</span><br><span class="line">        QueryWorker queryWorker</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abstract class QueryWorker implements Callable &#123;</span><br><span class="line">            &lt;b&gt;call()</span><br><span class="line">            query()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    QueryWorker -d-o SearchQueryTask</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class DatabaseResultTask extends QueryWorker &#123;</span><br><span class="line">    &lt;b&gt;query()</span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<h4 id="2-2-5-2-查询过程"><a href="#2-2-5-2-查询过程" class="headerlink" title="2.2.5.2. 查询过程"></a>2.2.5.2. 查询过程</h4><p>真正的查询是通过FutureTask的 execute执行call方法, 最终走到子类DatabaseResultTask的query中执行的查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt; query() &#123;</span><br><span class="line">        <span class="keyword">if</span> (mQuery == <span class="literal">null</span> || mQuery.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Start a Future to get search result scores.</span></span><br><span class="line">        <span class="comment">// 出现几个Task了, Task嵌套Task再嵌套Task</span></span><br><span class="line">        FutureTask&lt;List&lt;Pair&lt;String, Float&gt;&gt;&gt; rankerTask = mFeatureProvider.getRankerTask(</span><br><span class="line">                mContext, mQuery);</span><br><span class="line">        <span class="comment">// 这里并没有指定RankerTask, 忽略</span></span><br><span class="line">        <span class="keyword">if</span> (rankerTask != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> mFeatureProvider.getExecutorService();</span><br><span class="line">            executorService.execute(rankerTask);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Set&lt;SearchResult&gt; resultSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 这里分别根据几个字段分别查, 最终结果保存到resultSet. 查询条件中都有AND enabled = 1, 与前面数据库enabled字段相匹配</span></span><br><span class="line">        <span class="comment">// 第二个参数为评分分数, 与结果的展示有关, resultSet有去重功能</span></span><br><span class="line">        <span class="number">3.1</span> resultSet.addAll(firstWordQuery(MATCH_COLUMNS_PRIMARY, BASE_RANKS[<span class="number">0</span>]));</span><br><span class="line">        resultSet.addAll(secondaryWordQuery(MATCH_COLUMNS_PRIMARY, BASE_RANKS[<span class="number">1</span>]));</span><br><span class="line">        resultSet.addAll(anyWordQuery(MATCH_COLUMNS_SECONDARY, BASE_RANKS[<span class="number">2</span>]));</span><br><span class="line">        resultSet.addAll(anyWordQuery(MATCH_COLUMNS_TERTIARY, BASE_RANKS[<span class="number">3</span>]));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Try to retrieve the scores in time. Otherwise use static ranking.</span></span><br><span class="line">        <span class="comment">// rankerTask为空, 忽略, 排名相关</span></span><br><span class="line">        <span class="keyword">if</span> (rankerTask != <span class="literal">null</span>) &#123;</span><br><span class="line">...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;SearchResult&gt; resultList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(resultSet);</span><br><span class="line">        <span class="comment">// 采用默认排序</span></span><br><span class="line">        Collections.sort(resultList);</span><br><span class="line">        <span class="keyword">return</span> resultList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里只看第一个查询条件即可</span></span><br><span class="line">    <span class="number">3.1</span> -&gt; <span class="comment">// firstWordQuery</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;SearchResult&gt; <span class="title function_">firstWordQuery</span><span class="params">(String[] matchColumns, <span class="type">int</span> baseRank)</span> &#123;</span><br><span class="line">        <span class="comment">// whereClause是匹配字段, selection是通过mQuery定的匹配条件</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">whereClause</span> <span class="operator">=</span> buildSingleWordWhereClause(matchColumns);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> mQuery + <span class="string">&quot;%&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> String[] selection = buildSingleWordSelection(query, matchColumns.length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> query(whereClause, selection, baseRank);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Set&lt;SearchResult&gt; <span class="title function_">query</span><span class="params">(String whereClause, String[] selection, <span class="type">int</span> baseRank)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SQLiteDatabase</span> <span class="variable">database</span> <span class="operator">=</span></span><br><span class="line">                IndexDatabaseHelper.getInstance(mContext).getReadableDatabase();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Cursor</span> <span class="variable">resultCursor</span> <span class="operator">=</span> database.query(TABLE_PREFS_INDEX, SELECT_COLUMNS,</span><br><span class="line">                whereClause,</span><br><span class="line">                selection, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="comment">// 查询结果由CursorToSearchResultConverter 转化为 SearchResult的集合</span></span><br><span class="line">            <span class="keyword">return</span> mConverter.convertCursor(resultCursor, baseRank, mSiteMapManager);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="number">2.3</span> -&gt; <span class="comment">//合并结果, 只取了DatabaseResultTask的结果, 其他的task执行并未索取</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt; mergeSearchResults(</span><br><span class="line">            Map&lt;Integer, List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt;&gt; taskResults) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List&lt;SearchResult&gt; searchResults = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// First add db results as a special case</span></span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        searchResults.addAll(taskResults.remove(DatabaseResultTask.QUERY_WORKER_ID));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Merge the rest into result list: add everything to heap then pop them out one by one.</span></span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;SearchResult&gt; heap = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (List&lt;? <span class="keyword">extends</span> <span class="title class_">SearchResult</span>&gt; taskResult : taskResults.values()) &#123;</span><br><span class="line">            heap.addAll(taskResult);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!heap.isEmpty()) &#123;</span><br><span class="line">            searchResults.add(heap.poll());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> searchResults;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-6-搜索结果显示"><a href="#2-2-6-搜索结果显示" class="headerlink" title="2.2.6. 搜索结果显示"></a>2.2.6. 搜索结果显示</h3><p>在走完AsyncLoader的loadInBackground后会进入LoaderCallbacks的onLoadFinished方法中, SearchResultsAdapter为RecyclerView, 保存单项的显示结果<br>响应顺序:<br>-&gt;<code>getItemViewType</code>(拿到viewType)<br>-&gt;<code>onCreateViewHolder</code>(根据viewType设置自定义holder)<br>-&gt;<code>onBindViewHolder</code>(响应自定义holder的onBind方法)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoadFinished</span><span class="params">(Loader&lt;List&lt;? extends SearchResult&gt;&gt; loader,</span></span><br><span class="line"><span class="params">        List&lt;? extends SearchResult&gt; data)</span> &#123;</span><br><span class="line">    mSearchAdapter.postSearchResults(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getItemViewType</span><span class="params">(<span class="type">int</span> position)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mSearchResults.get(position).viewType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> SearchViewHolder <span class="title function_">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="type">int</span> viewType)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> parent.getContext();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">LayoutInflater</span> <span class="variable">inflater</span> <span class="operator">=</span> LayoutInflater.from(context);</span><br><span class="line">    <span class="keyword">final</span> View view;</span><br><span class="line">    <span class="keyword">switch</span> (viewType) &#123;</span><br><span class="line">        <span class="comment">// RecyleView 可以随意更换item的布局, viewType来自getItemViewType方法</span></span><br><span class="line">        <span class="comment">// IntentSearchViewHolder中定义了item的点击事件</span></span><br><span class="line">        <span class="keyword">case</span> ResultPayload.PayloadType.INTENT:</span><br><span class="line">            view = inflater.inflate(R.layout.search_intent_item, parent, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IntentSearchViewHolder</span>(view);</span><br><span class="line">        <span class="keyword">case</span> ResultPayload.PayloadType.INLINE_SWITCH:</span><br><span class="line">            view = inflater.inflate(R.layout.search_intent_item, parent, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IntentSearchViewHolder</span>(view);</span><br><span class="line">        <span class="keyword">case</span> ResultPayload.PayloadType.INLINE_LIST:</span><br><span class="line">            view = inflater.inflate(R.layout.search_intent_item, parent, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IntentSearchViewHolder</span>(view);</span><br><span class="line">        <span class="keyword">case</span> ResultPayload.PayloadType.SAVED_QUERY:</span><br><span class="line">            view = inflater.inflate(R.layout.search_saved_query_item, parent, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SavedQueryViewHolder</span>(view);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBindViewHolder</span><span class="params">(SearchViewHolder holder, <span class="type">int</span> position)</span> &#123;</span><br><span class="line">    <span class="comment">// 响应自定义的holder的onBind</span></span><br><span class="line">    holder.onBind(mFragment, mSearchResults.get(position));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IntentSearchViewHolder</span> <span class="keyword">extends</span> <span class="title class_">SearchViewHolder</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBind</span><span class="params">(<span class="keyword">final</span> SearchFragment fragment, <span class="keyword">final</span> SearchResult result)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onBind(fragment, result);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SearchViewHolder</span> <span class="variable">viewHolder</span> <span class="operator">=</span> <span class="built_in">this</span>;</span><br><span class="line">        itemView.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="comment">// 点击跳转到对应的intent</span></span><br><span class="line">                fragment.onSearchResultClicked(viewHolder, result);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> result.payload.getIntent();</span><br><span class="line">                <span class="comment">// Use app user id to support work profile use case.</span></span><br><span class="line">                <span class="keyword">if</span> (result <span class="keyword">instanceof</span> AppSearchResult) &#123;</span><br><span class="line">                    <span class="type">AppSearchResult</span> <span class="variable">appResult</span> <span class="operator">=</span> (AppSearchResult) result;</span><br><span class="line">                    fragment.getActivity().startActivity(intent);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> fragment.getActivity().getPackageManager();</span><br><span class="line">                    <span class="keyword">final</span> List&lt;ResolveInfo&gt; info = pm.queryIntentActivities(intent, <span class="number">0</span> <span class="comment">/* flags */</span>);</span><br><span class="line">                    <span class="keyword">if</span> (info != <span class="literal">null</span> &amp;&amp; !info.isEmpty()) &#123;</span><br><span class="line">                        fragment.startActivityForResult(intent, REQUEST_CODE_NO_OP);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag"># 设计模式</a>
              <a href="/tags/Settings-Search/" rel="tag"># Settings Search</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/10/12/OTA%E7%9B%B8%E5%85%B3/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E5%AF%86%E6%95%B4%E7%90%86/" rel="prev" title="文件加密FBE&DirectBoot模式介绍">
      <i class="fa fa-chevron-left"></i> 文件加密FBE&DirectBoot模式介绍
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/10/21/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/incremental%20fs/" rel="next" title="Incrementalfs 调研">
      Incrementalfs 调研 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E8%87%AA%E5%AE%9A%E4%B9%89fragment%E6%94%AF%E6%8C%81search%E6%89%A9%E5%B1%95"><span class="nav-number">1.</span> <span class="nav-text">1. 自定义fragment支持search扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="nav-number">1.1.</span> <span class="nav-text">1.1. 接口定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.2.</span> <span class="nav-text">1.2. 接口实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="nav-number">1.3.</span> <span class="nav-text">1.3. 结构图</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Settings-%E6%90%9C%E7%B4%A2%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">2. Settings 搜索实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-Search-%E5%85%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="nav-number">2.1.</span> <span class="nav-text">2.1. Search 入口分析,</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-FeatureFactory%E7%9A%84%E7%9B%B8%E5%85%B3%E7%B1%BB%E5%9B%BE"><span class="nav-number">2.1.1.</span> <span class="nav-text">2.1.1. FeatureFactory的相关类图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-getSlicesFeatureProvider-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.1.2. getSlicesFeatureProvider 初始化数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-3-indexSliceData"><span class="nav-number">2.1.3.</span> <span class="nav-text">2.1.3. indexSliceData</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-4-%E6%80%8E%E6%A0%B7%E6%89%BE%E5%88%B0%E8%B5%84%E6%BA%90%E7%9A%84"><span class="nav-number">2.1.4.</span> <span class="nav-text">2.1.4. 怎样找到资源的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-5-%E5%B0%8F%E8%8A%82"><span class="nav-number">2.1.5.</span> <span class="nav-text">2.1.5. 小节</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E6%90%9C%E7%B4%A2%E8%BF%87%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">2.2. 搜索过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-SearchFragment%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1. SearchFragment的生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-provider-updateIndexAsync"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2. provider.updateIndexAsync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-%E6%A3%80%E7%B4%A2%E5%AE%8C%E6%95%B0%E6%8D%AE-%E5%9B%9E%E8%B0%83onIndexingFinished%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.3.</span> <span class="nav-text">2.2.3. 检索完数据, 回调onIndexingFinished方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-4-%E8%BF%9B%E5%85%A5Loader%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.4.</span> <span class="nav-text">2.2.4. 进入Loader流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-5-%E8%A7%A6%E5%8F%91%E6%9F%A5%E8%AF%A2"><span class="nav-number">2.2.5.</span> <span class="nav-text">2.2.5. 触发查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-5-1-DatabaseResultTask%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-number">2.2.5.1.</span> <span class="nav-text">2.2.5.1. DatabaseResultTask执行过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-5-2-%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B"><span class="nav-number">2.2.5.2.</span> <span class="nav-text">2.2.5.2. 查询过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-6-%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E6%98%BE%E7%A4%BA"><span class="nav-number">2.2.6.</span> <span class="nav-text">2.2.6. 搜索结果显示</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liguang.zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">269</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">96</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liguang.zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
