<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW WenKai:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liguangzhang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":{"valine":{"order":-1}},"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="spinlock结构1234567891011arch_spinlock_ttypedef union &#123;	unsigned int lock;        &#x2F;&#x2F; union结构, 总共占用一个word	struct &#123;        &#x2F;&#x2F; 正在服务的号  bit 0-15		unsigned short serving_now;        &#x2F;&#x2F; 等待取的号    bit">
<meta property="og:type" content="article">
<meta property="og:title" content="mips linux spinlock">
<meta property="og:url" content="https://liguangzhang.github.io/2021/10/17/freertos/mips%20linux%20spinlock%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:description" content="spinlock结构1234567891011arch_spinlock_ttypedef union &#123;	unsigned int lock;        &#x2F;&#x2F; union结构, 总共占用一个word	struct &#123;        &#x2F;&#x2F; 正在服务的号  bit 0-15		unsigned short serving_now;        &#x2F;&#x2F; 等待取的号    bit">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-10-17T10:15:54.000Z">
<meta property="article:modified_time" content="2024-04-18T08:11:36.728Z">
<meta property="article:author" content="liguang.zhang">
<meta property="article:tag" content="freertos">
<meta property="article:tag" content="spinlock">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liguangzhang.github.io/2021/10/17/freertos/mips%20linux%20spinlock%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'" />

  <title>mips linux spinlock | blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2021/10/17/freertos/mips%20linux%20spinlock%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mips linux spinlock
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-17 18:15:54" itemprop="dateCreated datePublished" datetime="2021-10-17T18:15:54+08:00">2021-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-18 16:11:36" itemprop="dateModified" datetime="2024-04-18T16:11:36+08:00">2024-04-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MIPS/" itemprop="url" rel="index"><span itemprop="name">MIPS</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MIPS/os/" itemprop="url" rel="index"><span itemprop="name">os</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/10/17/freertos/mips%20linux%20spinlock%E5%88%86%E6%9E%90/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/10/17/freertos/mips%20linux%20spinlock%E5%88%86%E6%9E%90/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="spinlock结构"><a href="#spinlock结构" class="headerlink" title="spinlock结构"></a>spinlock结构</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">arch_spinlock_t</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> lock;    </span><br><span class="line">    <span class="comment">// union结构, 总共占用一个word</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="comment">// 正在服务的号  bit 0-15</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">short</span> serving_now;</span><br><span class="line">        <span class="comment">// 等待取的号    bit 16-31</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">short</span> ticket;</span><br><span class="line">	&#125; h;</span><br><span class="line">&#125; <span class="type">arch_spinlock_t</span>;</span><br></pre></td></tr></table></figure>
<h1 id="api"><a href="#api" class="headerlink" title="api"></a>api</h1><h2 id="arch-spin-is-locked"><a href="#arch-spin-is-locked" class="headerlink" title="arch_spin_is_locked"></a>arch_spin_is_locked</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">arch_spin_is_locked</span><span class="params">(<span class="type">arch_spinlock_t</span> *lock)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> counters = ACCESS_ONCE(lock-&gt;lock);</span><br><span class="line">    <span class="comment">// 取高16位和低16位做异或运算, 如果其他的 thread 已经获取了该 lock，那么返回非零值，即ticket 和 serving_now不相同时, 返回非0, 否则返回 0, 返回0时表明没上锁或者是本thread获取了锁.</span></span><br><span class="line">	<span class="keyword">return</span> ((counters &gt;&gt; <span class="number">16</span>) ^ counters) &amp; <span class="number">0xffff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="自旋锁的变体"><a href="#自旋锁的变体" class="headerlink" title="自旋锁的变体"></a>自旋锁的变体</h1><table>
<thead>
<tr>
<th>接口 API 的类型</th>
<th>spinlock 中的定义</th>
<th>raw_spinlock 的定义</th>
</tr>
</thead>
<tbody><tr>
<td>定义 spin lock 并初始化</td>
<td>DEFINE_SPINLOCK</td>
<td>DEFINE_RAW_SPINLOCK</td>
</tr>
<tr>
<td>动态初始化 spin lock</td>
<td>spin_lock_init</td>
<td>raw_spin_lock_init</td>
</tr>
<tr>
<td>获取指定的 spin lock</td>
<td>spin_lock</td>
<td>raw_spin_lock</td>
</tr>
<tr>
<td>获取指定的 spin lock 同时 disable 本 CPU 中断</td>
<td>spin_lock_irq</td>
<td>raw_spin_lock_irq</td>
</tr>
<tr>
<td>保存本 CPU 当前的 irq 状态，disable 本 CPU 中断并获取指定的 spin lock</td>
<td>spin_lock_irqsave</td>
<td>raw_spin_lock_irqsave</td>
</tr>
<tr>
<td>获取指定的 spin lock 同时 disable 本 CPU 的 bottom half</td>
<td>spin_lock_bh</td>
<td>raw_spin_lock_bh</td>
</tr>
<tr>
<td>释放指定的 spin lock</td>
<td>spin_unlock</td>
<td>raw_spin_unlock</td>
</tr>
<tr>
<td>释放指定的 spin lock 同时 enable 本 CPU 中断</td>
<td>spin_unlock_irq</td>
<td>raw_spin_unock_irq</td>
</tr>
<tr>
<td>释放指定的 spin lock 同时恢复本 CPU 的中断状态</td>
<td>spin_unlock_irqstore</td>
<td>raw_spin_unlock_irqstore</td>
</tr>
<tr>
<td>获取指定的 spin lock 同时 enable 本 CPU 的 bottom half</td>
<td>spin_unlock_bh</td>
<td>raw_spin_unlock_bh</td>
</tr>
<tr>
<td>尝试去获取 spin lock，如果失败，不会 spin，而是返回非零值</td>
<td>spin_trylock</td>
<td>raw_spin_trylock</td>
</tr>
<tr>
<td>判断 spin lock 是否是 locked，如果其他的 thread 已经获取了该 lock，那么返回非零值，否则返回 0</td>
<td>spin_is_locked</td>
<td>raw_spin_is_locked</td>
</tr>
</tbody></table>
<h1 id="mips-体系加锁分析"><a href="#mips-体系加锁分析" class="headerlink" title="mips 体系加锁分析"></a>mips 体系加锁分析</h1><h2 id="arch-spin-lock"><a href="#arch-spin-lock" class="headerlink" title="arch_spin_lock"></a>arch_spin_lock</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">arch_spin_lock</span><span class="params">(<span class="type">arch_spinlock_t</span> *lock)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> my_ticket;</span><br><span class="line">	<span class="type">int</span> tmp;</span><br><span class="line">	<span class="type">int</span> inc = <span class="number">0x10000</span>;</span><br><span class="line">    __asm__ __volatile__ (</span><br><span class="line">        <span class="string">&quot;	.set push		# arch_spin_lock	\n&quot;</span></span><br><span class="line">        <span class="string">&quot;	.set noreorder					\n&quot;</span></span><br><span class="line">        <span class="string">&quot;							\n&quot;</span></span><br><span class="line">        <span class="string">&quot;1:	ll	%[ticket], %[ticket_ptr]		\n&quot;</span>                      # ticket_ptr(lock-&gt;lock), 取出lock-&gt;lock 到 ticket(tmp) ll 原子操作, 取出一个word</span><br><span class="line">        <span class="string">&quot;	addu	%[my_ticket], %[ticket], %[inc]		\n&quot;</span>              # my_ticket &lt;- ticket(tmp) + <span class="number">0x10000</span>  这里应该是ticket + <span class="number">1</span>的意思, ticket自增,即当前的调用取的号+<span class="number">1</span>,  </span><br><span class="line">        <span class="string">&quot;	sc	%[my_ticket], %[ticket_ptr]		\n&quot;</span>                      <span class="meta"># lock-&gt;lock <span class="string">&lt;- my_ticket      # 把ticket + 1后存回到 lock-&gt;</span>ticket, 这个代表更新当前发的所有号, 来了一个新调用, 说明这个调用要抢资源, 给它分一个号</span></span><br><span class="line">        <span class="string">&quot;	beqz	%[my_ticket], 1b			\n&quot;</span>                      <span class="meta"># sc失败, 返回结果0, 跳转回1b, 说明有其他cpu或中断在该指令执行前偷偷调用sc 把 tick_ptr给修改了, 这时sc会失败, 返回1b 重新来这个操作</span></span><br><span class="line">        <span class="string">&quot;	 srl	%[my_ticket], %[ticket], 16		\n&quot;</span>                  # my_ticket &lt;- ticket(tmp) &gt;&gt; <span class="number">16</span>      my_ticket &lt;- lock-&gt;ticket  换算ticket + <span class="number">1</span></span><br><span class="line">        <span class="string">&quot;	andi	%[ticket], %[ticket], 0xffff		\n&quot;</span>              <span class="meta"># ticket(tmp) = ticket(tmp) &amp; 0xffff  tmp<span class="string">&lt;- lock-&gt;</span>serving_now</span></span><br><span class="line">        <span class="string">&quot;	bne	%[ticket], %[my_ticket], 4f		\n&quot;</span>                      <span class="meta"># lock-&gt;ticket 与 lock-&gt;serving_now 不相等, 调转到 4f, 说明不是本上下文上的锁, 需要等待, 如相等,往下走    !!!!</span></span><br><span class="line">        <span class="string">&quot;	 subu	%[ticket], %[my_ticket], %[ticket]	\n&quot;</span>              <span class="meta"># tmp <span class="string">&lt;- lock-&gt;</span>serving_now - lock-&gt;ticket, 相等的, tmp变成0了, 因为在延迟槽里,不相等的话 tmp <span class="string">&lt;-  lock-&gt;</span>serving_now - lock-&gt;ticket</span></span><br><span class="line">        <span class="string">&quot;2:							\n&quot;</span></span><br><span class="line">        <span class="string">&quot;	.subsection 2					\n&quot;</span>                          # # 程序后半段, !!!! 拼在函数jr ra 后面,正常情况下走不到这里, 注意跳转前 subu	%[ticket], %[my_ticket], %[ticket] 在延迟槽里, 总是会执行</span><br><span class="line">        <span class="string">&quot;4:	andi	%[ticket], %[ticket], 0x1fff		\n&quot;</span>              <span class="meta"># lock-&gt;ticket 与 lock-&gt;serving_now 不相等时,走到这, tmp <span class="string">&lt;- tmp &amp; 0x1fff 取(lock-&gt;</span>serving_now)0-12位</span></span><br><span class="line">        <span class="string">&quot;	sll	%[ticket], 5				\n&quot;</span>                          <span class="meta"># tmp &lt;&lt; 5</span></span><br><span class="line">        <span class="string">&quot;							\n&quot;</span></span><br><span class="line">        <span class="string">&quot;6:	bnez	%[ticket], 6b				\n&quot;</span>                      <span class="meta"># tmp 不为0 , 循环tmp-1, 直到tmp 变成0</span></span><br><span class="line">        <span class="string">&quot;	 subu	%[ticket], 1				\n&quot;</span>                      # 循环体, 每次tmp<span class="number">-1</span></span><br><span class="line">        <span class="string">&quot;							\n&quot;</span></span><br><span class="line">        <span class="string">&quot;	lhu	%[ticket], %[serving_now_ptr]		\n&quot;</span>                  <span class="meta"># tmp <span class="string">&lt;- lock-&gt;</span>h.serving_now, 这个地方会从内存中更新serving_now, 别的调用方可能会放锁,导致serving_now变化, 因此这里需要更新</span></span><br><span class="line">        <span class="string">&quot;	beq	%[ticket], %[my_ticket], 2b		\n&quot;</span>                      # my_ticket 与 lock-&gt;serving_now 相等,则跳到<span class="number">2b</span>, 调到<span class="number">2b</span>后,函数就可以马上出去了</span><br><span class="line">        <span class="string">&quot;	 subu	%[ticket], %[my_ticket], %[ticket]	\n&quot;</span>              <span class="meta"># tmp <span class="string">&lt;-    lock-&gt;</span>h.serving_now - lock-&gt;ticket</span></span><br><span class="line">        <span class="string">&quot;	b	4b					\n&quot;</span>                                  # 回到<span class="number">4b</span>, 重新等</span><br><span class="line">        <span class="string">&quot;	 subu	%[ticket], %[ticket], 1			\n&quot;</span>                  <span class="meta"># tmp - 1</span></span><br><span class="line">        <span class="string">&quot;	.previous					\n&quot;</span></span><br><span class="line">        <span class="string">&quot;	.set pop					\n&quot;</span></span><br><span class="line">        : [ticket_ptr] <span class="string">&quot;+m&quot;</span> (lock-&gt;lock),</span><br><span class="line">        [serving_now_ptr] <span class="string">&quot;+m&quot;</span> (lock-&gt;h.serving_now),</span><br><span class="line">        [ticket] <span class="string">&quot;=&amp;r&quot;</span> (tmp),</span><br><span class="line">        [my_ticket] <span class="string">&quot;=&amp;r&quot;</span> (my_ticket)</span><br><span class="line">        : [inc] <span class="string">&quot;r&quot;</span> (inc));</span><br><span class="line">	smp_llsc_mb(); <span class="comment">// 调用sync. 内存屏障, 保证cache同步 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>subsection的作用是分割线, subsection前面的部分为函数本应该在的位置, subsection后面的部分直接拼接到了函数尾部.<br>比如函数调用结束后, 一般会调用<code>jr ra</code> 返回, 而subsection后面的部分直接拼在了这条<code>jr ra</code>后面, 不破坏函数的执行, 只有b语句 标签[no]f 的时候才会跳到这里,否则程序一条一条往下运行, 永远不会跑到这里</p>
</blockquote>
<p>这个函数做了两件事:</p>
<ol>
<li>每来一个调用, 就给它一个号, 号每次+1.</li>
<li>判断serving_now 与 ticket是否相等, 相等的话, 就退出函数, 不相等,就让这个调用方在这等着, 等ticket 与 serving_now 相等.</li>
</ol>
<p>这里两条原子性操作 <code>ll``sc</code>保证读取与写入lock(共享内存)时, 读操作和写操作都是原子性的, 函数最后调用了sync, 保证了cache同步.<br>sync的作用可以参考, 简单概括就是 约束执行CPU上的读写操作的顺序，CPU一定是完成read memory barrier之前的读写操作之后，才开始执行read memory barrier之后的读写操作。<br><a target="_blank" rel="noopener" href="https://www.yuque.com/huakaibanxia-loogp/oubdco/ggoqqz?view=doc_embed">内存屏障（Memory Barrier）究竟是个什么鬼？ - 知乎</a><br>那什么时候serving_now变化的呢. 就需要看下释放锁的函数</p>
<h2 id="arch-spin-unlock"><a href="#arch-spin-unlock" class="headerlink" title="arch_spin_unlock"></a>arch_spin_unlock</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">arch_spin_unlock</span><span class="params">(<span class="type">arch_spinlock_t</span> *lock)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> serving_now = lock-&gt;h.serving_now + <span class="number">1</span>;  <span class="comment">// serving_now + 1</span></span><br><span class="line">	wmb();  #调用 __syncw()</span><br><span class="line">	lock-&gt;h.serving_now = (<span class="type">unsigned</span> <span class="type">short</span>)serving_now;   <span class="comment">// 存回lock-&gt;serving_now</span></span><br><span class="line">	nudge_writes();  <span class="comment">// 调用 syncw</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>多个函数片段拿锁时, 会陷入到arch_spin_lock的等待中, 每个调用都给分了一个ticket, 在<code>subsection 4</code>中, 每个调用持有的是<code>my_ticket</code>, 即调用<code>arch_spin_lock</code>时分给这个调用过程的ticket号, 这个号属于该次调用.<br>在这个循环中, 最终延时了一定数目的时钟周期后, 都要判断<code>my_ticket</code>与内存中的<code>serving_now</code>是否相等, 相等则退出arch_spin_lock的等待.<br>而<code>arch_spin_unlock</code>放锁过程, 会把serving_now++, 存回到共享内存中.<br>每个因调用arch_spin_lock陷入到循环中的调用体, 等到自己的my_ticket与serving_now相等时, 解除等待状态.</p>
<blockquote>
<p>spin_lock的主体是调用过程, 而不是本线程, 或本函数, 不支持递归拿锁或反复拿锁</p>
</blockquote>
<p>取号机制可以避免有的调用过程被饿死, 防止多个调用过程之间的无序竞争.</p>
<h2 id="arch-spin-trylock"><a href="#arch-spin-trylock" class="headerlink" title="arch_spin_trylock"></a>arch_spin_trylock</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">arch_spin_trylock</span><span class="params">(<span class="type">arch_spinlock_t</span> *lock)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> tmp, tmp2, tmp3;</span><br><span class="line">	<span class="type">int</span> inc = <span class="number">0x10000</span>;</span><br><span class="line"></span><br><span class="line">    __asm__ __volatile__ (</span><br><span class="line">        <span class="string">&quot;	.set push		# arch_spin_trylock	\n&quot;</span></span><br><span class="line">        <span class="string">&quot;	.set noreorder					\n&quot;</span></span><br><span class="line">        <span class="string">&quot;							\n&quot;</span></span><br><span class="line">        <span class="string">&quot;1:	ll	%[ticket], %[ticket_ptr]		\n&quot;</span>           <span class="meta"># tmp <span class="string">&lt;- lock-&gt;</span>lock</span></span><br><span class="line">        <span class="string">&quot;	srl	%[my_ticket], %[ticket], 16		\n&quot;</span>           # my_ticket &lt;- lock-&gt;ticket</span><br><span class="line">        <span class="string">&quot;	andi	%[now_serving], %[ticket], 0xffff	\n&quot;</span>   # now_serving &lt;- lock-&gt;serving</span><br><span class="line">        <span class="string">&quot;	bne	%[my_ticket], %[now_serving], 3f	\n&quot;</span>       # my_ticket == now_serving? (等于则继续) : <span class="number">3f</span> (不等, 跳<span class="number">3f</span>)</span><br><span class="line">        <span class="string">&quot;	 addu	%[ticket], %[ticket], %[inc]		\n&quot;</span>   <span class="meta"># ticket + 1</span></span><br><span class="line">        <span class="string">&quot;	sc	%[ticket], %[ticket_ptr]		\n&quot;</span>           # 更新lock-&gt;ticket, 即lock-&gt;ticket ++ </span><br><span class="line">        <span class="string">&quot;	beqz	%[ticket], 1b				\n&quot;</span>           <span class="meta"># ticket 溢出, 回到1b</span></span><br><span class="line">        <span class="string">&quot;	 li	%[ticket], 1				\n&quot;</span>               # 函数出去, 返回ticket (tmp) 返回<span class="number">1</span>, 表示能拿到锁</span><br><span class="line">        <span class="string">&quot;2:							\n&quot;</span></span><br><span class="line">        <span class="string">&quot;	.subsection 2					\n&quot;</span></span><br><span class="line">        <span class="string">&quot;3:	b	2b					\n&quot;</span></span><br><span class="line">        <span class="string">&quot;	 li	%[ticket], 0				\n&quot;</span>               # 函数出去, 返回ticket(tmp) 返回<span class="number">0</span>, 表示拿不到锁</span><br><span class="line">        <span class="string">&quot;	.previous					\n&quot;</span></span><br><span class="line">        <span class="string">&quot;	.set pop					\n&quot;</span></span><br><span class="line">        : [ticket_ptr] <span class="string">&quot;+m&quot;</span> (lock-&gt;lock),</span><br><span class="line">        [ticket] <span class="string">&quot;=&amp;r&quot;</span> (tmp),</span><br><span class="line">        [my_ticket] <span class="string">&quot;=&amp;r&quot;</span> (tmp2),</span><br><span class="line">        [now_serving] <span class="string">&quot;=&amp;r&quot;</span> (tmp3)</span><br><span class="line">        : [inc] <span class="string">&quot;r&quot;</span> (inc));</span><br><span class="line">	<span class="comment">// sync</span></span><br><span class="line">	smp_llsc_mb();</span><br><span class="line">	<span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尝试拿锁, 即判断my_ticket 与 now_serving 是否相等, 相等则返回1, 表示能拿到锁</p>
<h1 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h1><p>允许多个调用过程同时持同一个读锁, 但同一时刻只能有一个写锁.</p>
<h2 id="arch-read-lock"><a href="#arch-read-lock" class="headerlink" title="arch_read_lock"></a>arch_read_lock</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">arch_read_lock</span><span class="params">(<span class="type">arch_rwlock_t</span> *rw)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> tmp;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        __asm__ __volatile__(</span><br><span class="line">            <span class="string">&quot;1:	ll	%1, %2	# arch_read_lock	\n&quot;</span>    <span class="meta"># tmp <span class="string">&lt;- rw-&gt;</span>lock</span></span><br><span class="line">            <span class="string">&quot;	bltz	%1, 1b				\n&quot;</span>        <span class="meta"># tmp 小于0, 循环, 即有写锁情况下 (0x80000000=-1), 阻塞</span></span><br><span class="line">            <span class="string">&quot;	 addu	%1, 1				\n&quot;</span>        <span class="meta"># tmp + 1</span></span><br><span class="line">            <span class="string">&quot;2:	sc	%1, %0				\n&quot;</span>            # 存回rw-&gt;lock, 即serving+<span class="number">1</span></span><br><span class="line">            : <span class="string">&quot;=m&quot;</span> (rw-&gt;lock), <span class="string">&quot;=&amp;r&quot;</span> (tmp)</span><br><span class="line">            : <span class="string">&quot;m&quot;</span> (rw-&gt;lock)</span><br><span class="line">            : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!tmp);                                    <span class="meta"># tmp是0, 循环, 不为0, 退出循环</span></span><br><span class="line">	smp_llsc_mb();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有写锁时阻塞, 没有写锁, 多个读可以同时调用</p>
<h2 id="arch-read-unlock"><a href="#arch-read-unlock" class="headerlink" title="arch_read_unlock"></a>arch_read_unlock</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">arch_read_unlock</span><span class="params">(<span class="type">arch_rwlock_t</span> *rw)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> tmp;</span><br><span class="line">	<span class="comment">// 同步</span></span><br><span class="line">	smp_mb__before_llsc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        __asm__ __volatile__(</span><br><span class="line">            <span class="string">&quot;1:	ll	%1, %2	# arch_read_unlock	\n&quot;</span>  <span class="meta"># tmp <span class="string">&lt;- rw-&gt;</span>lock</span></span><br><span class="line">            <span class="string">&quot;	sub	%1, 1				\n&quot;</span>          <span class="meta"># tmp - 1</span></span><br><span class="line">            <span class="string">&quot;	sc	%1, %0				\n&quot;</span>          # 存回rw-&gt;lock, 即serving<span class="number">-1</span> </span><br><span class="line">            : <span class="string">&quot;=m&quot;</span> (rw-&gt;lock), <span class="string">&quot;=&amp;r&quot;</span> (tmp)</span><br><span class="line">            : <span class="string">&quot;m&quot;</span> (rw-&gt;lock)</span><br><span class="line">            : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!tmp);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="arch-write-lock"><a href="#arch-write-lock" class="headerlink" title="arch_write_lock"></a>arch_write_lock</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">arch_write_lock</span><span class="params">(<span class="type">arch_rwlock_t</span> *rw)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> tmp;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        __asm__ __volatile__(</span><br><span class="line">            <span class="string">&quot;1:	ll	%1, %2	# arch_write_lock	\n&quot;</span> <span class="meta"># tmp <span class="string">&lt;- rw-&gt;</span>lock</span></span><br><span class="line">            <span class="string">&quot;	bnez	%1, 1b				\n&quot;</span>     # 不为<span class="number">0</span> 循环, 即有读锁或写锁时, 自旋等待</span><br><span class="line">            <span class="string">&quot;	 lui	%1, 0x8000			\n&quot;</span>     <span class="meta"># tmp &lt;- 0x80000000</span></span><br><span class="line">            <span class="string">&quot;2:	sc	%1, %0				\n&quot;</span>         <span class="meta"># rw-&gt;lock 更新为0x80000000</span></span><br><span class="line">            : <span class="string">&quot;=m&quot;</span> (rw-&gt;lock), <span class="string">&quot;=&amp;r&quot;</span> (tmp)</span><br><span class="line">            : <span class="string">&quot;m&quot;</span> (rw-&gt;lock)</span><br><span class="line">            : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!tmp);</span><br><span class="line">	smp_llsc_mb();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为0时才可以持锁(有读锁或写锁时,自旋等待), 持锁后, lock被写入<code>0x80000000</code>. 锁上期间新的调用过程拿不到锁, 直到该调用过程把锁放掉</p>
<h2 id="arch-write-unlock"><a href="#arch-write-unlock" class="headerlink" title="arch_write_unlock"></a>arch_write_unlock</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">arch_write_unlock</span><span class="params">(<span class="type">arch_rwlock_t</span> *rw)</span></span><br><span class="line">&#123;</span><br><span class="line">	smp_mb();</span><br><span class="line">	__asm__ __volatile__(</span><br><span class="line">	<span class="string">&quot;				# arch_write_unlock	\n&quot;</span></span><br><span class="line">	<span class="string">&quot;	sw	$0, %0					\n&quot;</span>      <span class="meta"># rw-&gt;lock更新为0</span></span><br><span class="line">	: <span class="string">&quot;=m&quot;</span> (rw-&gt;lock)</span><br><span class="line">	: <span class="string">&quot;m&quot;</span> (rw-&gt;lock)</span><br><span class="line">	: <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/freertos/" rel="tag"># freertos</a>
              <a href="/tags/spinlock/" rel="tag"># spinlock</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/10/16/freertos/freertos%E4%BB%BB%E5%8A%A1%E5%88%87%E6%8D%A2%E5%88%86%E6%9E%90/" rel="prev" title="freertos 任务切换">
      <i class="fa fa-chevron-left"></i> freertos 任务切换
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/11/17/freertos/rt_thread%E5%A4%9A%E6%A0%B8%E8%B0%83%E5%BA%A6/" rel="next" title="rt_thread 多核调度">
      rt_thread 多核调度 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#spinlock%E7%BB%93%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">spinlock结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#api"><span class="nav-number">2.</span> <span class="nav-text">api</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#arch-spin-is-locked"><span class="nav-number">2.1.</span> <span class="nav-text">arch_spin_is_locked</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%87%AA%E6%97%8B%E9%94%81%E7%9A%84%E5%8F%98%E4%BD%93"><span class="nav-number">3.</span> <span class="nav-text">自旋锁的变体</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#mips-%E4%BD%93%E7%B3%BB%E5%8A%A0%E9%94%81%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">mips 体系加锁分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#arch-spin-lock"><span class="nav-number">4.1.</span> <span class="nav-text">arch_spin_lock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#arch-spin-unlock"><span class="nav-number">4.2.</span> <span class="nav-text">arch_spin_unlock</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">4.2.1.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#arch-spin-trylock"><span class="nav-number">4.3.</span> <span class="nav-text">arch_spin_trylock</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E9%94%81"><span class="nav-number">5.</span> <span class="nav-text">读写锁</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#arch-read-lock"><span class="nav-number">5.1.</span> <span class="nav-text">arch_read_lock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#arch-read-unlock"><span class="nav-number">5.2.</span> <span class="nav-text">arch_read_unlock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#arch-write-lock"><span class="nav-number">5.3.</span> <span class="nav-text">arch_write_lock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#arch-write-unlock"><span class="nav-number">5.4.</span> <span class="nav-text">arch_write_unlock</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liguang.zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">157</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">93</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">109</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liguang.zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'VrGRp2q7WwXjxsCNmlDIZYbC-gzGzoHsz',
      appKey     : 'JgMXmmB7yKQf2zm80TaBp3JT',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
