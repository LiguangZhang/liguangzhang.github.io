<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liguangzhang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="blog">
<meta property="og:url" content="https://liguangzhang.github.io/page/24/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="liguang.zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liguangzhang.github.io/page/24/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2019/09/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/vscode%E8%B0%83%E8%AF%95c++/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/vscode%E8%B0%83%E8%AF%95c++/" class="post-title-link" itemprop="url">vscode 调试 C++</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-20 10:00:01" itemprop="dateCreated datePublished" datetime="2019-09-20T10:00:01+08:00">2019-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-15 18:56:35" itemprop="dateModified" datetime="2024-04-15T18:56:35+08:00">2024-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/debug/" itemprop="url" rel="index"><span itemprop="name">debug</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>添加配置, 设置.<br>launch脚本</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 使用 IntelliSense 了解相关属性.</span></span><br><span class="line">    <span class="comment">// 悬停以查看现有属性的描述。</span></span><br><span class="line">    <span class="comment">// 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(gdb) Launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceRoot&#125;/bin/main&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceRoot&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;preLaunchTask&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;setupCommands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Enable pretty-printing for gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-enable-pretty-printing&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>其中的task脚本</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// See https://go.microsoft.com/fwlink/?LinkId=733558</span></span><br><span class="line">    <span class="comment">// for the documentation about the tasks.json format</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="comment">// See https://go.microsoft.com/fwlink/?LinkId=733558</span></span><br><span class="line">        <span class="comment">// for the documentation about the tasks.json format</span></span><br><span class="line">        <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;taskname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;g++-5&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;-g&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;-Wall&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;-std=c++14&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;$&#123;file&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;-lpthread&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;-o&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="string">&quot;$&#123;workspaceRoot&#125;/bin/main&quot;</span></span><br><span class="line">                <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;owner&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cpp&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;fileLocation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;absolute&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^(.*):(\\d+):(\\d+):\\s+(error):\\s+(.*)$&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;column&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Run&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceRoot&#125;/bin/main&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;presentation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;reveal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;always&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;focus&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;isDefault&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>其中build部分可以替换为makefile. 如果是多文件编译, 可以使用make all命令, 编译单一cpp(含main)的文件, 使用make $(file)进行替换.</p>
<figure class="highlight make"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 描述： multifile 项目 makefile文件</span></span><br><span class="line"><span class="comment"># 版本： v2.0</span></span><br><span class="line"><span class="comment"># 修改记录:  1.先测试普通的cpp文件的编译运行</span></span><br><span class="line"><span class="comment">#           2.使用变量来改进我们的makefile文件</span></span><br><span class="line"><span class="comment">#           3.新加了一个源文件</span></span><br><span class="line"><span class="comment">#           4.使用伪目标，加上clean规则</span></span><br><span class="line"><span class="comment">#           5.使用wildcard函数，自动扫描当前目录下的源文件</span></span><br><span class="line"><span class="comment">#           6.加入了自动规则依赖</span></span><br><span class="line"><span class="comment">#           7.实现了opencv程序的编译</span></span><br><span class="line"><span class="comment"># 定义了可执行文件变量</span></span><br><span class="line">BIN := bin</span><br><span class="line">OUT := out</span><br><span class="line">CFLAGS := -std=c++14</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传递了文件参数</span></span><br><span class="line">FILE := <span class="variable">$(FILE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义了源文件列表变量</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">strip</span> <span class="variable">$(FILE)</span>)</span>, )</span><br><span class="line">sources := <span class="variable">$(<span class="built_in">wildcard</span> *.cpp)</span></span><br><span class="line">target:= all</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">sources := <span class="variable">$(FILE)</span></span><br><span class="line">target:=<span class="variable">$(<span class="built_in">notdir</span> $(<span class="built_in">basename</span> <span class="variable">$(sources)</span>)</span>)</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">executable  := <span class="variable">$(BIN)</span>/<span class="variable">$(target)</span></span><br><span class="line">executable_main := <span class="variable">$(BIN)</span>/main</span><br><span class="line"></span><br><span class="line">SRC := <span class="variable">$(<span class="built_in">notdir</span> <span class="variable">$(sources)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用变量的引用替换，定义了object文件列表</span></span><br><span class="line">objects := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(OUT)</span>/,  $(SRC:.cpp=.o)</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用变量引用替换，定义依赖文件列表</span></span><br><span class="line">deps    := $(SRC:.cpp=.d)</span><br><span class="line"><span class="comment"># 定义编译命令变量</span></span><br><span class="line">CC  := g++-5</span><br><span class="line">rm  := rm -rf</span><br><span class="line"></span><br><span class="line"><span class="comment">#需要调用的链接库</span></span><br><span class="line">LIBS := -lpthread</span><br><span class="line"></span><br><span class="line"><span class="comment"># 头文件路径</span></span><br><span class="line">INCLUDE := -I.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接库路径</span></span><br><span class="line">LDFLAGS := -L/usr/local/lib</span><br><span class="line"><span class="comment"># 终极目标规则，生成可执行文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$(executable)</span> : <span class="variable">$(objects)</span></span><br><span class="line">	-mkdir bin</span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -o <span class="variable">$@</span> <span class="variable">$^</span> <span class="variable">$(LDFLAGS)</span> <span class="variable">$(LIBS)</span></span><br><span class="line">	mv <span class="variable">$(executable)</span> <span class="variable">$(executable_main)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(objects)</span>: %.o: <span class="variable">$(sources)</span></span><br><span class="line">	-mkdir <span class="variable">$(OUT)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -o <span class="variable">$@</span> -c <span class="variable">$&lt;</span> <span class="variable">$(INCLUDE)</span></span><br><span class="line"></span><br><span class="line">all : <span class="variable">$(executable)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#clean规则</span></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line"><span class="comment">#清除编译生成的所有文件</span></span><br><span class="line"><span class="comment">#$(RM) $(executable) $(objects) $(deps)</span></span><br><span class="line"><span class="comment">#清除编译生成的所有文件,不包括可执行文件</span></span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(objects)</span> <span class="variable">$(deps)</span> <span class="variable">$(executable)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动规则依赖</span></span><br><span class="line">deps := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(OUT)</span>/, $(SRC:.cpp=.d)</span>)</span><br><span class="line"><span class="keyword">sinclude</span> <span class="variable">$(deps)</span></span><br><span class="line"><span class="variable">$(deps)</span>: %.d: <span class="variable">$(sources)</span></span><br><span class="line">	<span class="variable">$(CC)</span> -MM <span class="variable">$(CFLAGS)</span> <span class="variable">$&lt;</span> &gt; <span class="variable">$@</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2019/09/12/OTA%E7%9B%B8%E5%85%B3/%E7%BC%96%E8%AF%91%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/12/OTA%E7%9B%B8%E5%85%B3/%E7%BC%96%E8%AF%91%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">Android bp 编译相关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-12 18:15:54" itemprop="dateCreated datePublished" datetime="2019-09-12T18:15:54+08:00">2019-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-16 15:07:08" itemprop="dateModified" datetime="2024-04-16T15:07:08+08:00">2024-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-编译相关"><a href="#1-编译相关" class="headerlink" title="1. 编译相关"></a>1. 编译相关</h1><h2 id="1-1-bp-makefile通用规则"><a href="#1-1-bp-makefile通用规则" class="headerlink" title="1.1. bp makefile通用规则"></a>1.1. bp makefile通用规则</h2><p>编译规则:</p>
<ul>
<li>bp 可以引用bp定义的module</li>
<li>bp不能引用mk定义的module</li>
<li>mk可以引用mk和bp定义的module</li>
</ul>
<p>传统的写法下, bp中不能引用外部的make定义的变量</p>
<p>可以借助原生文件的写法, 在soong_config.mk中引用mk文件<br>build&#x2F;core&#x2F;soong_config.mk<br>    –include miui&#x2F;build&#x2F;soong&#x2F;import_miui_soong_vars.mk</p>
<p>在mk文件中可以加bp规则的hook</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifeq</span> (true,<span class="variable">$(ENABLE_MIUI_DEBUGGING)</span>)</span><br><span class="line">_adb_local_cflags := -UALLOW_ADBD_ROOT -DALLOW_ADBD_ROOT=1 -DALLOW_ADBD_DISABLE_VERITY -DALLOW_ADBD_NO_AUTH</span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> add_additional_soong_var, adbd_defaults, cflags, <span class="variable">$(_adb_local_cflags)</span>)</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cc_defaults &#123;</span><br><span class="line">    name: <span class="string">&quot;adbd_defaults&quot;</span>,</span><br><span class="line">    defaults: [<span class="string">&quot;adb_defaults&quot;</span>],</span><br><span class="line"></span><br><span class="line">    cflags: [<span class="string">&quot;-UADB_HOST&quot;</span>, <span class="string">&quot;-DADB_HOST=0&quot;</span>],</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cc_library &#123;</span><br><span class="line">    name: <span class="string">&quot;libadbd&quot;</span>,</span><br><span class="line">    defaults: [<span class="string">&quot;adbd_defaults&quot;</span>, <span class="string">&quot;host_adbd_supported&quot;</span>],</span><br><span class="line">    recovery_available: <span class="literal">true</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参照上述写法, 可以在bp中引用外部的mk变量</p>
<blockquote>
<p>bp中的required规则可以无视上述规则. 即bp可以required mk定义的module</p>
</blockquote>
<h2 id="1-2-recovery-bp相关编译规则"><a href="#1-2-recovery-bp相关编译规则" class="headerlink" title="1.2. recovery bp相关编译规则"></a>1.2. recovery bp相关编译规则</h2><p>在androidq上新增了<code>recovery_available</code>和<code>recovery</code>变量<br>定义了<code>recovery_available</code>后, 如果目标需要被recovery引用(主系统也需要用), 需要添加 <code>recovery_available:true</code><br>如果目标只是给recovery用的可以添加<code>recovery:true</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cc_library &#123;</span><br><span class="line">    name: <span class="string">&quot;libadbd&quot;</span>,</span><br><span class="line">    defaults: [<span class="string">&quot;adbd_defaults&quot;</span>, <span class="string">&quot;host_adbd_supported&quot;</span>],</span><br><span class="line">    recovery_available: <span class="literal">true</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cc_binary &#123;</span><br><span class="line">    name: <span class="string">&quot;fastbootd&quot;</span>,</span><br><span class="line">    defaults: [<span class="string">&quot;fastboot_defaults&quot;</span>],</span><br><span class="line"></span><br><span class="line">    recovery: <span class="literal">true</span>,</span><br><span class="line">...</span><br><span class="line">    shared_libs: [</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">&quot;libadbd&quot;</span>,</span><br><span class="line">        <span class="string">&quot;libasyncio&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义<code>recovery_available</code>的module可以直接被引用, 如编译fastbootd时, 指定<code>shared_libs</code>可以直接引用<code>libadbd</code><br>如果不能直接引用的, 如required规则, 则需要添加<code>.recovery</code>后缀, 而定义了<code>recovery</code>的module则不需要添加<code>.recovery</code>后缀</p>
<p>如<code>binary</code>不能被直接引用, 可以被required规则引用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cc_binary &#123;</span><br><span class="line">    name: <span class="string">&quot;recovery&quot;</span>,</span><br><span class="line">    recovery: <span class="literal">true</span>,</span><br><span class="line">...</span><br><span class="line">    required: [</span><br><span class="line">    ...</span><br><span class="line">        <span class="string">&quot;mke2fs.recovery&quot;</span>,</span><br><span class="line">        <span class="string">&quot;recovery_deps&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cc_binary &#123;</span><br><span class="line">    name: <span class="string">&quot;mke2fs&quot;</span>,</span><br><span class="line">    host_supported: <span class="literal">true</span>,</span><br><span class="line">    recovery_available: <span class="literal">true</span>,</span><br><span class="line">    defaults: [<span class="string">&quot;e2fsprogs-defaults&quot;</span>],</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者可以被PRODUCT_PACKAGES引用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_PACKAGES += \</span><br><span class="line">    adbd.recovery \</span><br><span class="line">    android.hardware.health@<span class="number">2.0</span>-impl-<span class="keyword">default</span>.recovery \</span><br><span class="line">    cgroups.recovery.json \</span><br><span class="line">    charger.recovery \</span><br><span class="line">    init_second_stage.recovery \</span><br></pre></td></tr></table></figure>

<p>被<code>PRODUCT_PACKAGES</code> 引用后, 在生成recoveryimage时会拷贝对应的module放到对应位置的module path下</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2019/08/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/gdb%20stl%E6%94%AF%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/gdb%20stl%E6%94%AF%E6%8C%81/" class="post-title-link" itemprop="url">Android AOSP gdb stl 支持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-20 10:00:01" itemprop="dateCreated datePublished" datetime="2019-08-20T10:00:01+08:00">2019-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-15 18:55:11" itemprop="dateModified" datetime="2024-04-15T18:55:11+08:00">2024-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/debug/" itemprop="url" rel="index"><span itemprop="name">debug</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Android-AOSP-gdb-stl-支持"><a href="#Android-AOSP-gdb-stl-支持" class="headerlink" title="Android AOSP gdb stl 支持"></a>Android AOSP gdb stl 支持</h1><p>默认情况下不支持stl 输出, 需要gdb支持python脚本, 一般需要自己编译.</p>
<ol>
<li><p>下载编译python3.x 源码:</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://www.python.org/ftp/python/3.8.1/Python-3.8.1.tar.xz</span><br><span class="line">cd Python-3.8.1</span><br><span class="line">mkdir build</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">prefix 是指定安装目录, 也可指到任一目录, 因为这里只用到编译python时生成的临时文件</span></span><br><span class="line">../configure --prefix=~/Programs/python3 --enable-optimizations --enable-shared</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载编译gdb源码:</p>
<p> <a target="_blank" rel="noopener" href="https://ftp.gnu.org/gnu/gdb/gdb-9.2.tar.xz">https://ftp.gnu.org/gnu/gdb/gdb-9.2.tar.xz</a></p>
<p> 这个链接有点慢, 可以直接下附件中的</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tar gdb-9.2.tar.xz</span><br><span class="line">mkdir build</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">prefix 是安装目录, with-python选项的路径填上一步编译python的build路径</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">arm64</span></span><br><span class="line">../configure --target=aarch64-linux-android --prefix=/home/mi/Programs/gdb --enable-unicode=ucs4 --with-python=/home/mi/Programs/Python-3.8.1/build</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mips</span></span><br><span class="line">../configure --target=mips-mti-elf --prefix=/home/mi/program/mips-gdb --enable-unicode=ucs4 --with-python=/usr --with-auto-load-dir=$debugdir:$datadir/auto-load --with-auto-load-safe-path=$debugdir:$datadir/auto-load --with-expat --without-libunwind-ia64 --without-lzma --without-babeltrace --without-intel-pt --disable-libmcheck --without-mpfr --without-guile</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>切换本地python版本为python3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /usr/bin/python; sudo ln -s /usr/bin/python3 /usr/bin/python;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里注意的点是xiaomi的code环境是依赖python2的, repo可以切到python2上, 将repo的第一行改成<code>#!/usr/bin/env python2 </code>即可, 但代码编译时, 有些模块在python3下会报错, 目前发现的有依赖kernel 模块的, 使用ninja都会报错. 所以最好在编译时将python版本切换到python2.</p>
</blockquote>
</li>
<li><p>定制gdbinit</p>
<p>android上废弃了stlport和gnustl的支持, 只支持libc++的方式集成stl.</p>
<p>所以python解析脚本是基于libc++开发的, 这里提供一下github上的一个脚本</p>
<p><a target="_blank" rel="noopener" href="https://github.com/koutheir/libcxx-pretty-printers">https://github.com/koutheir/libcxx-pretty-printers</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/koutheir/libcxx-pretty-printers</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">python</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment">#路径填刚才clone到本地的, 指定到第一级src目录</span></span><br><span class="line">sys.path.insert(<span class="number">0</span>, <span class="string">&#x27;/home/mi/program/libcxx-pretty-printers/src&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> libcxx.v1.printers <span class="keyword">import</span> register_libcxx_printers</span><br><span class="line">register_libcxx_printers (<span class="literal">None</span>)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>



</li>
<li><p>android编译module修改, Android.bp修改</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 添加stl支持</span><br><span class="line">cflags<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;-O0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">stl<span class="punctuation">:</span> <span class="string">&quot;c++_static&quot;</span><span class="punctuation">,</span> 或</span><br><span class="line">stl<span class="punctuation">:</span> <span class="string">&quot;c++_shared&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>vscode 中使用gdb</p>
<p>vscode的launch.json也要配置打开 pretty-printers, 对于remote调试感兴趣的可以看另一篇文档中的介绍</p>
</li>
</ol>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(gdb) Remote Launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;miDebuggerServerAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1:8888&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/mi/work_space/miui-r-umi-dev/out/target/product/cmi/symbols/system/bin/test_code_aaaaaaa&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sourceFileMap&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;system/core/crypto_test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/mi/work_space/miui-r-umi-dev/system/core/test_code&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;trace&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;traceResponse&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;engineLogging&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;miDebuggerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/mi/Programs/gdb/bin/aarch64-linux-android-gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;setupCommands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Enable pretty-printing for gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-enable-pretty-printing&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2019/08/12/OTA%E7%9B%B8%E5%85%B3/f2fs%20gc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/12/OTA%E7%9B%B8%E5%85%B3/f2fs%20gc/" class="post-title-link" itemprop="url">f2fs gc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-12 18:15:54" itemprop="dateCreated datePublished" datetime="2019-08-12T18:15:54+08:00">2019-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-16 15:18:29" itemprop="dateModified" datetime="2024-04-16T15:18:29+08:00">2024-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Filesystem/" itemprop="url" rel="index"><span itemprop="name">Filesystem</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>vnote_backup_file_826537664 &#x2F;home&#x2F;mi&#x2F;Documents&#x2F;backup&#x2F;VnoteBook&#x2F;OTA相关&#x2F;f2fs gc.md</p>
<h1 id="1-f2fs-gc"><a href="#1-f2fs-gc" class="headerlink" title="1. f2fs gc"></a>1. f2fs gc</h1><p>do_garbage_collect<br>    -&gt; gc_data_segment<br>        -&gt; move_data_page<br>           -&gt; f2fs_pin_file_control<br>    -&gt; stat_inc_seg_count</p>
<p>解密map</p>
<p>umi:&#x2F;data&#x2F;media&#x2F;0&#x2F;downloaded_rom # sha1sum &#x2F;cache&#x2F;recovery&#x2F;block.map<br>a31f2e057e6a02fc64f55dedd3e69ed71c2c4821  &#x2F;cache&#x2F;recovery&#x2F;block.map</p>
<p>初次解密后</p>
<p>umi:&#x2F;data&#x2F;media&#x2F;0&#x2F;downloaded_rom # sha1sum miui_UMI_9.11.18_6d674ad5a9_10.0.zip<br>631b3f61f9ea85911d354c277c98f9fcdb56b0bc  miui_UMI_9.11.18_6d674ad5a9_10.0.zip</p>
<p>recovery会更改?<br>-rw-rw-r– 1 media_rw media_rw 2594048280 2019-11-18 10:14 miui_UMI_9.11.18_6d674ad5a9_10.0.zip<br>sha1sum miui_UMI_9.11.18_6d674ad5a9_10.0.zip<br>parse_ld_lib_path (null)<br>6fcdd51f751fe1a19af20c70302575b3fdb70086  miui_UMI_9.11.18_6d674ad5a9_10.0.zip</p>
<p>原始</p>
<p>[$] -&gt; sha1sum ~&#x2F;Downloads&#x2F;miui_UMI_9.11.18_6d674ad5a9_10.0.zip<br>88abea31fe641216b7a2659a6e63f5c4d619efaa  &#x2F;home&#x2F;mi&#x2F;Downloads&#x2F;miui_UMI_9.11.18_6d674ad5a9_10.0.zip</p>
<p>recovery 初始block.map<br>88abea31fe641216b7a2659a6e63f5c4d619efaa</p>
<p>Get package’s sha bay MemMapping.<br>sha1: 88abea31fe641216b7a2659a6e63f5c4d619efaa</p>
<p>pin_file  存到文件系统的扩展属性中<br>[   34.256381] F2FS-fs (dm-4): f2fs_pin_file_control: Enable GC &#x3D; ino 204c after 801 GC trials</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> segno = start_segno;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> end_segno = start_segno + sbi-&gt;segs_per_sec;</span><br><span class="line"><span class="keyword">for</span> (segno = start_segno; segno &lt; end_segno; segno++) &#123;</span><br><span class="line">...</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> type = IS_DATASEG(get_seg_entry(sbi, segno)-&gt;type) ?</span><br><span class="line">						SUM_TYPE_DATA : SUM_TYPE_NODE;						</span><br><span class="line">	<span class="keyword">if</span> (type == SUM_TYPE_NODE)</span><br><span class="line">		submitted += gc_node_segment(sbi, sum-&gt;entries, segno,</span><br><span class="line">							gc_type);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		submitted += gc_data_segment(sbi, sum-&gt;entries, gc_list,</span><br><span class="line">						segno, gc_type);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (off = <span class="number">0</span>; off &lt; sbi-&gt;blocks_per_seg; off++, entry++) &#123;</span><br><span class="line">        inode = find_gc_inode(gc_list, dni.ino);</span><br><span class="line">        <span class="keyword">if</span>(inode) &#123;</span><br><span class="line">        		<span class="keyword">if</span> (f2fs_post_read_required(inode))</span><br><span class="line">    			    err = move_data_block(inode, start_bidx,</span><br><span class="line">						gc_type, segno, off);</span><br><span class="line">						</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2019/08/12/OTA%E7%9B%B8%E5%85%B3/fbe%E4%B8%8E%E7%94%A8%E6%88%B7%E5%AE%89%E5%85%A8%E5%AF%86%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/12/OTA%E7%9B%B8%E5%85%B3/fbe%E4%B8%8E%E7%94%A8%E6%88%B7%E5%AE%89%E5%85%A8%E5%AF%86%E7%A0%81/" class="post-title-link" itemprop="url">fbe与用户安全密码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-12 18:15:54" itemprop="dateCreated datePublished" datetime="2019-08-12T18:15:54+08:00">2019-08-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-16 15:19:06" itemprop="dateModified" datetime="2024-04-16T15:19:06+08:00">2024-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Filesystem/" itemprop="url" rel="index"><span itemprop="name">Filesystem</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Filesystem/%E5%8A%A0%E5%AF%86/" itemprop="url" rel="index"><span itemprop="name">加密</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h1 id="1-fbe与用户安全密码"><a href="#1-fbe与用户安全密码" class="headerlink" title="1. fbe与用户安全密码"></a>1. fbe与用户安全密码</h1><p>之前介绍了fde与用户安全密码的关系，发现其是相对简单的。而对fbe和metadata加密的方式，在调研过程中发现密码的存储与文件ce区的密钥的关系则复杂的多。</p>
<h2 id="1-1-用户ce区文件解密"><a href="#1-1-用户ce区文件解密" class="headerlink" title="1.1. 用户ce区文件解密"></a>1.1. 用户ce区文件解密</h2><p>这个过程伴随着一个函数向下执行的，即<code>unlockUserKey</code><em><strong>函数</strong></em>，首先看下伴随这个过程的密钥来自哪里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">unlockUserKey(userId, <span class="literal">null</span>, auth.deriveDiskEncryptionKey());</span><br><span class="line">    <span class="comment">/** Unlock disk encryption */</span></span><br><span class="line"><span class="number">1712</span>     <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlockUserKey</span><span class="params">(<span class="type">int</span> userId, <span class="type">byte</span>[] token, <span class="type">byte</span>[] secret)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"><span class="number">1713</span>         <span class="keyword">final</span> <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> mUserManager.getUserInfo(userId);</span><br><span class="line"><span class="number">1714</span>         mStorageManager.unlockUserKey(userId, userInfo.serialNumber, token, secret);</span><br><span class="line"><span class="number">1715</span>     &#125;</span><br></pre></td></tr></table></figure>
<p>以机主用户为例， 上述参数中userID为0， token 为空， serialNumber为0，未知的只有secret，来自<code>deriveDiskEncryptionKey</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">public</span> <span class="type">byte</span>[] deriveDiskEncryptionKey() &#123;</span><br><span class="line"><span class="number">179</span>             <span class="keyword">return</span> derivePassword(PERSONALIZATION_FBE_KEY);</span><br><span class="line"><span class="number">180</span>         &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">160</span>         <span class="keyword">private</span> <span class="type">byte</span>[] derivePassword(<span class="type">byte</span>[] personalization) &#123;</span><br><span class="line"><span class="number">161</span>             <span class="keyword">if</span> (mVersion == SYNTHETIC_PASSWORD_VERSION_V3) &#123;</span><br><span class="line"><span class="number">162</span>                 <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title class_">SP800Derive</span>(syntheticPassword.getBytes()))</span><br><span class="line"><span class="number">163</span>                     .withContext(personalization, PERSONALISATION_CONTEXT);</span><br><span class="line"><span class="number">164</span>             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">165</span>                 <span class="keyword">return</span> SyntheticPasswordCrypto.personalisedHash(personalization,</span><br><span class="line"><span class="number">166</span>                         syntheticPassword.getBytes());</span><br><span class="line"><span class="number">167</span>             &#125;</span><br><span class="line"><span class="number">168</span>         &#125;</span><br></pre></td></tr></table></figure>
<p>关键参数只有一个<code>syntheticPassword</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(<span class="type">byte</span>[] P0, <span class="type">byte</span>[] P1)</span> &#123;</span><br><span class="line"><span class="number">191</span>             <span class="built_in">this</span>.P1 = P1;</span><br><span class="line"><span class="number">192</span>             <span class="built_in">this</span>.syntheticPassword = String.valueOf(HexEncoding.encode(</span><br><span class="line"><span class="number">193</span>                     SyntheticPasswordCrypto.personalisedHash(</span><br><span class="line"><span class="number">194</span>                             PERSONALIZATION_SP_SPLIT, P0, P1)));</span><br></pre></td></tr></table></figure>
<p>这个密码生成的时候是一个随机的值？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> AuthenticationToken <span class="title function_">newSyntheticPasswordAndSid</span><span class="params">(IGateKeeperService gatekeeper,</span></span><br><span class="line"><span class="params"> <span class="number">463</span>             <span class="type">byte</span>[] hash, <span class="type">byte</span>[] credential, <span class="type">int</span> userId)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"> <span class="number">464</span>         <span class="type">AuthenticationToken</span> <span class="variable">result</span> <span class="operator">=</span> AuthenticationToken.create();</span><br><span class="line">...</span><br><span class="line"> <span class="number">478</span>         saveEscrowData(result, userId);</span><br><span class="line"> <span class="number">479</span>         <span class="keyword">return</span> result;</span><br><span class="line"> <span class="number">480</span>     &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">protected</span> <span class="keyword">static</span> AuthenticationToken <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line"> <span class="number">204</span>             <span class="type">AuthenticationToken</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthenticationToken</span>(SYNTHETIC_PASSWORD_VERSION_V3);</span><br><span class="line"> <span class="number">205</span>                     result.initialize(secureRandom(SYNTHETIC_PASSWORD_LENGTH),</span><br><span class="line"> <span class="number">206</span>                     secureRandom(SYNTHETIC_PASSWORD_LENGTH));</span><br><span class="line"> <span class="number">207</span>             <span class="keyword">return</span> result;</span><br><span class="line"> <span class="number">208</span>         &#125;</span><br></pre></td></tr></table></figure>

<p>还有一个地方表明这个是伴随用户密码解锁过程解出来的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">private</span> AuthenticationToken <span class="title function_">unwrapSyntheticPasswordBlob</span><span class="params">(<span class="type">long</span> handle, <span class="type">byte</span> type,</span></span><br><span class="line"><span class="params"> <span class="number">979</span>             <span class="type">byte</span>[] applicationId, <span class="type">long</span> sid, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line"> <span class="number">980</span>         <span class="type">byte</span>[] blob = loadState(SP_BLOB_NAME, handle, userId);</span><br><span class="line"> </span><br><span class="line"><span class="number">94</span>         <span class="keyword">if</span> (version == SYNTHETIC_PASSWORD_VERSION_V1) &#123;</span><br><span class="line"> <span class="number">995</span>             secret = SyntheticPasswordCrypto.decryptBlobV1(getHandleName(handle),</span><br><span class="line"> <span class="number">996</span>                     Arrays.copyOfRange(blob, <span class="number">2</span>, blob.length), applicationId);</span><br><span class="line"> <span class="number">997</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="number">998</span>             secret = decryptSPBlob(getHandleName(handle),</span><br><span class="line"> <span class="number">999</span>                 Arrays.copyOfRange(blob, <span class="number">2</span>, blob.length), applicationId);</span><br><span class="line"><span class="number">1000</span>         &#125;</span><br><span class="line"><span class="comment">// 来自secret，secret的解密又有keymaster gatekeeper的参与</span></span><br><span class="line">         <span class="keyword">if</span> (type == SYNTHETIC_PASSWORD_TOKEN_BASED) &#123;</span><br><span class="line"><span class="number">1007</span>             <span class="keyword">if</span> (!loadEscrowData(result, userId)) &#123;</span><br><span class="line"><span class="number">1008</span>                 Log.e(TAG, <span class="string">&quot;User is not escrowable: &quot;</span> + userId);</span><br><span class="line"><span class="number">1009</span>                 <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">1010</span>             &#125;</span><br><span class="line"><span class="number">1011</span>             result.recreate(secret);</span><br><span class="line"><span class="number">1012</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1013</span>             result.syntheticPassword = <span class="keyword">new</span> <span class="title class_">String</span>(secret);</span><br><span class="line"><span class="number">1014</span>         &#125;</span><br></pre></td></tr></table></figure>
<p>这个流程可以追溯到解锁后，解锁密码的保存时触发的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">saveChosenPasswordnAndFinish(final String pin)    <span class="comment">#ChooseLockPassword.java - MiuiSystemUI</span></span></span><br><span class="line">  \ - saveLockPassword(pin, mUserPassword, mRequestedQuality, mUserIdToSetPassword) # LockPatternUtils.java</span><br><span class="line">     \ -  setLockCredential(password, CREDENTIAL_TYPE_PASSWORD, savedPassword,</span><br><span class="line">                      requestedQuality, userHandle, allowUntrustedChange); #LockSettingService.java</span><br><span class="line">         \ - setLockCredentialInternal(credential, type, savedCredential, requestedQuality, userId,</span><br><span class="line">                     allowUntrustedChange, /* isLockTiedToParent= */ false); #LockSettingService.java</span><br><span class="line">             \ - spBasedSetLockCredentialInternalLocked(credential, credentialType, savedCredential,</span><br><span class="line">                         requestedQuality, userId, allowUntrustedChange, isLockTiedToParent); #LockSettingService.java</span><br><span class="line">                  \ -  AuthenticationResult authResult = mSpManager.unwrapPasswordBasedSyntheticPassword(</span><br><span class="line">                            getGateKeeperService(), handle, savedCredential, userId, null);</span><br><span class="line">                  | - setLockCredentialWithAuthTokenLocked(credential, credentialType, auth, requestedQuality, userId);</span><br><span class="line">                       \ - unlockUserKey(userId, null, auth.deriveDiskEncryptionKey());</span><br><span class="line">             | -  setUserKeyProtection(userId, credential, convertResponse(gkResponse));</span><br><span class="line">                 \ - addUserKeyAuth(userId, token, secretFromCredential(credential)); #LockSettingService.java</span><br></pre></td></tr></table></figure>
<p>上述过程只是解锁的一个流程，在用户密码校验的地方，有一处值得注意，即使用<code>spBasedSetLockCredentialInternalLocked</code>进行核对时，是有条件的<br>注意这个函数<code>isSyntheticPasswordBasedCredentialLocked</code>, 只有这个函数为true时，才会对secret加这一层封装。从之前的流程分析下来，这个封装的中间文件存在了<br><code>/data/system_de/0/spblob</code>下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSyntheticPasswordBasedCredentialLocked</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line">...</span><br><span class="line"><span class="number">2517</span>         <span class="type">long</span> <span class="variable">handle</span> <span class="operator">=</span> getSyntheticPasswordHandleLocked(userId);</span><br><span class="line"><span class="number">2518</span>         <span class="comment">// This is a global setting</span></span><br><span class="line"><span class="number">2519</span>         <span class="type">long</span> <span class="variable">enabled</span> <span class="operator">=</span> getLong(SYNTHETIC_PASSWORD_ENABLED_KEY,</span><br><span class="line"><span class="number">2520</span>                 SYNTHETIC_PASSWORD_ENABLED_BY_DEFAULT, UserHandle.USER_SYSTEM);</span><br><span class="line"><span class="number">2521</span>       <span class="keyword">return</span> enabled != <span class="number">0</span> &amp;&amp; handle != SyntheticPasswordManager.DEFAULT_HANDLE;</span><br><span class="line"><span class="number">2522</span>     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>初步流程分析下来，用户密码和ce区文件解锁密码之间的导出关系比较复杂，且需要多个中间参数和keymater的参与</p>
<blockquote>
<p>上面的流程分析有点问题，unlockUserKey应该时UserController下发的<br>关注下面的函数：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">private</span> VerifyCredentialResponse <span class="title function_">verifyCredential</span><span class="params">(<span class="type">int</span> userId, CredentialHash storedHash,</span></span><br><span class="line"><span class="params"><span class="number">1907</span>             <span class="type">byte</span>[] credential, <span class="type">boolean</span> hasChallenge, <span class="type">long</span> challenge,</span></span><br><span class="line"><span class="params"><span class="number">1908</span>             ICheckCredentialProgressCallback progressCallback)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里如果<code>isSyntheticPasswordBasedCredentialLocked</code>返回false，再对整个解锁流程做一下梳理，密码输入后，会触发check的逻辑</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">+- onPatternDetected(List&lt;Cell&gt; pattern) #图案绘完 ConfirmLockPattern.java</span><br><span class="line"> \ +- startVerifyPattern(pattern)</span><br><span class="line">    \ - long challenge = getActivity().getIntent().getLongExtra(MiuiChooseLockSettingsHelper.EXTRA_KEY_CHALLENGE, 0);</span><br><span class="line">    | +- LockPatternChecker.verifyPattern(mLockPatternUtils, pattern, challenge, localUserId, mContext, onVerifyCallback) #challenge未知，由外部传入</span><br><span class="line">       \ +- LockPatternUtils.verifyPattern(patternCopy, challenge, userId) # LockPatternChecker.java</span><br><span class="line">         \ - verifyCredential(patternToByteArray(pattern), CREDENTIAL_TYPE_PATTERN, challenge, userId); # LockPatternUtils.java</span><br><span class="line">            \ - getLockSettings().verifyCredential(credential, type, challenge, userId);</span><br><span class="line">               \ +- doVerifyCredential(credential, type, true, challenge, userId, null) # LockSettingService.java</span><br><span class="line">                  \ +-  response = spBasedDoVerifyCredential(credential, credentialType, hasChallenge, challenge, userId, progressCallback);</span><br><span class="line">                      \ - spBasedDoVerifyCredential&lt;credential, credentialType, hasChallenge, challenge, userId, progressCallback&gt;</span><br><span class="line">                        \ - long handle = getSyntheticPasswordHandleLocked(userId);</span><br><span class="line">                        | - mSpManager.unwrapPasswordBasedSyntheticPassword( getGateKeeperService(), handle, userCredential, userId, progressCallback); </span><br><span class="line">                  | +-  response = verifyCredential(userId, storedHash, credentialToVerify, hasChallenge, challenge, progressCallback);</span><br><span class="line">                     \ - CredentialHash storedHash = mStorage.readCredentialHash(userId) #从保存的密钥中间文件中构造hash</span><br><span class="line">                     | - gateKeeperResponse = getGateKeeperService().verifyChallenge(userId, challenge, storedHash.hash, credential); #challenge由外部传入，storedHash读取/data/system/gatekeeper.pattern.key|gatekeeper.password.key，通过verifyChallenge返回了一个token</span><br><span class="line">                     | - VerifyCredentialResponse response = convertResponse(gateKeeperResponse); #这里仍然有gatekeeper参与</span><br><span class="line">                     | - unlockKeystore(credential, userId);</span><br><span class="line">                     | - unlockUser(userId, response.getPayload(), secretFromCredential(credential)); #未知参数变成了token</span><br><span class="line">                        \ - mActivityManager.unlockUser(userId, token, secret, listener);</span><br><span class="line">                           \ - mUserController.unlockUser(userId, token, secret, listener) # ActivityManagerService.java</span><br><span class="line">                              \ - unlockUserCleared(userId, token, secret, listener) #UserController.java</span><br><span class="line">                                 \ - storageManager.unlockUserKey(userId, userInfo.serialNumber, token, secret);</span><br><span class="line">                                    \- mVold.unlockUserKey(userId, serialNumber, encodeBytes(token), encodeBytes(secret)) #StorageManagrService</span><br></pre></td></tr></table></figure>

<p>从上面的流程看，对于<code>isSyntheticPasswordBasedCredentialLocked</code>返回false的情况，需要关注的点是外部传入的<code>chanllenge</code>, 以及用户安全密码的中间文件<code>storeHash</code>和用户输入的安全密码，unlockKeyStore GateKeeper都需要能被调用到 <code>system/security/keystore</code> <code>system/core/gatekeeperd</code></p>
<h2 id="1-2-小结"><a href="#1-2-小结" class="headerlink" title="1.2. 小结"></a>1.2. 小结</h2><p>从上述流程分析来看，fde和fbe用户密码与直接解锁密码的逻辑并不相同：</p>
<ul>
<li>fde的解锁方式上看，开机时CryptKeeper接管了keyguard的操作，用户密码与解锁fde磁盘加密主密钥直接相关，因此导出关系很单一。</li>
<li>而fbe的解锁方式，开机后直接走的keyguard，keyguard的模块逻辑比较复杂，而且用户密码经过了多层加密，最终的用户密码到ce区的文件解锁密码关系要复杂的多。中间经过了多层中转，需要逐层分析。 需要通过设备调试，发现其中的中转关系</li>
</ul>
<h2 id="1-3-spblob方式流程跟进"><a href="#1-3-spblob方式流程跟进" class="headerlink" title="1.3. spblob方式流程跟进"></a>1.3. spblob方式流程跟进</h2><p>从上面isSyntheticPasswordBasedCredentialLocked返回true的场景上，q的机型正是用的这种加密方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">774</span>         <span class="type">long</span> <span class="variable">handle</span> <span class="operator">=</span> getSyntheticPasswordHandleLocked(userId);</span><br><span class="line"><span class="number">2775</span>         <span class="type">AuthenticationResult</span> <span class="variable">authResult</span> <span class="operator">=</span> mSpManager.unwrapPasswordBasedSyntheticPassword(</span><br><span class="line"><span class="number">2776</span>                 getGateKeeperService(), handle, savedCredential, userId, <span class="literal">null</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>先看  <code>getSyntheticPasswordHandleLocked</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getSyntheticPasswordHandleLocked</span><span class="params">(<span class="type">int</span> userId)</span> &#123;</span><br><span class="line"><span class="number">2566</span>         <span class="keyword">return</span> getLong(SYNTHETIC_PASSWORD_HANDLE_KEY,</span><br><span class="line"><span class="number">2567</span>                 SyntheticPasswordManager.DEFAULT_HANDLE, userId);</span><br><span class="line"><span class="number">2568</span>     &#125;</span><br></pre></td></tr></table></figure>
<p><code>SYNTHETIC_PASSWORD_HANDLE_KEY</code>来自于<code>initializeSyntheticPasswordLocked</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">2533</span>     <span class="keyword">protected</span> AuthenticationToken <span class="title function_">initializeSyntheticPasswordLocked</span><span class="params">(<span class="type">byte</span>[] credentialHash,</span></span><br><span class="line"><span class="params"><span class="number">2534</span>             <span class="type">byte</span>[] credential, <span class="type">int</span> credentialType, <span class="type">int</span> requestedQuality,</span></span><br><span class="line"><span class="params"><span class="number">2535</span>             <span class="type">int</span> userId)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"><span class="number">2536</span>         Slog.i(TAG, <span class="string">&quot;Initialize SyntheticPassword for user: &quot;</span> + userId);</span><br><span class="line"><span class="number">2537</span>         <span class="keyword">final</span> <span class="type">AuthenticationToken</span> <span class="variable">auth</span> <span class="operator">=</span> mSpManager.newSyntheticPasswordAndSid(</span><br><span class="line"><span class="number">2538</span>                 getGateKeeperService(), credentialHash, credential, userId);</span><br><span class="line"><span class="number">2539</span>         onAuthTokenKnownForUser(userId, auth);</span><br><span class="line"><span class="comment">// 创建password相关的handle和spblob中间文件</span></span><br><span class="line"><span class="number">2544</span>         <span class="type">long</span> <span class="variable">handle</span> <span class="operator">=</span> mSpManager.createPasswordBasedSyntheticPassword(getGateKeeperService(),</span><br><span class="line"><span class="number">2545</span>                 credential, credentialType, auth, requestedQuality, userId);</span><br><span class="line"><span class="number">2546</span>         <span class="keyword">if</span> (credential != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">2547</span>             <span class="keyword">if</span> (credentialHash == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">2548</span>                 <span class="comment">// Since when initializing SP, we didn&#x27;t provide an existing password handle</span></span><br><span class="line"><span class="number">2549</span>                 <span class="comment">// for it to migrate SID, we need to create a new SID for the user.</span></span><br><span class="line"><span class="number">2550</span>                 mSpManager.newSidForUser(getGateKeeperService(), auth, userId);</span><br><span class="line"><span class="number">2551</span>             &#125;</span><br><span class="line"><span class="number">2552</span>             mSpManager.verifyChallenge(getGateKeeperService(), auth, <span class="number">0L</span>, userId);</span><br><span class="line"><span class="number">2553</span>             setAuthlessUserKeyProtection(userId, auth.deriveDiskEncryptionKey());</span><br><span class="line"><span class="number">2554</span>             setKeystorePassword(auth.deriveKeyStorePassword(), userId);</span><br><span class="line"><span class="number">2555</span>         &#125;</span><br><span class="line"><span class="number">2560</span>         fixateNewestUserKeyAuth(userId);</span><br><span class="line"><span class="number">2561</span>         setLong(SYNTHETIC_PASSWORD_HANDLE_KEY, handle, userId);</span><br><span class="line"><span class="number">2562</span>         <span class="keyword">return</span> auth;</span><br><span class="line"><span class="number">2563</span>     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">createPasswordBasedSyntheticPassword</span><span class="params">(IGateKeeperService gatekeeper,</span></span><br><span class="line"><span class="params"> <span class="number">627</span>             <span class="type">byte</span>[] credential, <span class="type">int</span> credentialType, AuthenticationToken authToken,</span></span><br><span class="line"><span class="params"> <span class="number">628</span>             <span class="type">int</span> requestedQuality, <span class="type">int</span> userId)</span></span><br><span class="line"> <span class="number">29</span>                     <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"> <span class="comment">//可以看到handle是一个随机值，最终setLong(SYNTHETIC_PASSWORD_HANDLE_KEY, handle, userId); 到数据库中，再次取得时候，直接从数据库中getLong获取</span></span><br><span class="line">         <span class="type">long</span> <span class="variable">handle</span> <span class="operator">=</span> generateHandle();</span><br><span class="line"> <span class="number">636</span>         <span class="type">PasswordData</span> <span class="variable">pwd</span> <span class="operator">=</span> PasswordData.create(credentialType);</span><br><span class="line"> <span class="number">637</span>         <span class="type">byte</span>[] pwdToken = computePasswordToken(credential, pwd);</span><br><span class="line"> ...</span><br><span class="line">         saveState(PASSWORD_DATA_NAME, pwd.toBytes(), handle, userId);</span><br><span class="line"> <span class="number">676</span>         createSyntheticPasswordBlob(handle, SYNTHETIC_PASSWORD_PASSWORD_BASED, authToken,</span><br><span class="line"> <span class="number">677</span>                 applicationId, sid, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而unwrapPasswordBasedSyntheticPassword函数，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数为上面得handle 用户凭据  userId</span></span><br><span class="line">        <span class="type">AuthenticationResult</span> <span class="variable">authResult</span> <span class="operator">=</span> mSpManager.unwrapPasswordBasedSyntheticPassword(</span><br><span class="line"><span class="number">2776</span>                 getGateKeeperService(), handle, savedCredential, userId, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> AuthenticationResult <span class="title function_">unwrapPasswordBasedSyntheticPassword</span><span class="params">(IGateKeeperService gatekeeper,</span></span><br><span class="line"><span class="params"> <span class="number">861</span>             <span class="type">long</span> handle, <span class="type">byte</span>[] credential, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params"> <span class="number">862</span>             ICheckCredentialProgressCallback progressCallback)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"> <span class="number">866</span>         <span class="type">AuthenticationResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthenticationResult</span>();</span><br><span class="line"> <span class="comment">//从中间文件解出 passworddata</span></span><br><span class="line"> <span class="number">867</span>         <span class="type">PasswordData</span> <span class="variable">pwd</span> <span class="operator">=</span> PasswordData.fromBytes(loadState(PASSWORD_DATA_NAME, handle, userId));</span><br><span class="line"> <span class="number">868</span>         result.credentialType = pwd.passwordType;</span><br><span class="line"> <span class="number">869</span>         <span class="type">byte</span>[] pwdToken = computePasswordToken(credential, pwd);</span><br><span class="line"><span class="comment">// 这中间走的分支都需要debug才能知道</span></span><br><span class="line"><span class="number">918</span>             sid = sidFromPasswordHandle(pwd.passwordHandle);</span><br><span class="line"> <span class="number">919</span>             applicationId = transformUnderSecdiscardable(pwdToken,</span><br><span class="line"> <span class="number">920</span>                     loadSecdiscardable(handle, userId));</span><br><span class="line"></span><br><span class="line">。。。</span><br><span class="line"> <span class="comment">// 需要参数 applicationId， sid</span></span><br><span class="line">        result.authToken = unwrapSyntheticPasswordBlob(handle, SYNTHETIC_PASSWORD_PASSWORD_BASED,</span><br><span class="line"> <span class="number">928</span>                 applicationId, sid, userId);</span><br><span class="line"><span class="number">31</span>         result.gkResponse = verifyChallenge(gatekeeper, result.authToken, <span class="number">0L</span>, userId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最终要得到 authToken，进行验证得到的结果为gkResponse，然后再通过Spmanager的verifyChallenge验证challenge， 都为正确的，才说明密码是正确的。</span></span><br><span class="line">             <span class="keyword">if</span> (response.getResponseCode() == VerifyCredentialResponse.RESPONSE_OK) &#123;</span><br><span class="line"><span class="number">2634</span>                 <span class="comment">// perform verifyChallenge with synthetic password which generates the real GK auth</span></span><br><span class="line"><span class="number">2635</span>                 <span class="comment">// token and response for the current user</span></span><br><span class="line"><span class="number">2636</span>                 response = mSpManager.verifyChallenge(getGateKeeperService(), authResult.authToken,</span><br><span class="line"><span class="number">2637</span>                         challenge, userId);</span><br><span class="line"><span class="number">2638</span>                 <span class="keyword">if</span> (response.getResponseCode() != VerifyCredentialResponse.RESPONSE_OK) &#123;</span><br><span class="line"><span class="number">2639</span>                     <span class="comment">// This shouldn&#x27;t really happen: the unwrapping of SP succeeds, but SP doesn&#x27;t</span></span><br><span class="line"><span class="number">2640</span>                     <span class="comment">// match the recorded GK password handle.</span></span><br><span class="line"><span class="number">2641</span>                     Slog.wtf(TAG, <span class="string">&quot;verifyChallenge with SP failed.&quot;</span>);</span><br><span class="line"><span class="number">2642</span>                     <span class="keyword">return</span> VerifyCredentialResponse.ERROR;</span><br><span class="line"><span class="number">2643</span>                 &#125;</span><br><span class="line"><span class="number">2644</span>             &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 而文件密码与/data/system_de/0/spblob/下存储的文件，applicationId， 上面提到的handle有关</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationToken <span class="title function_">unwrapSyntheticPasswordBlob</span><span class="params">(<span class="type">long</span> handle, <span class="type">byte</span> type,</span></span><br><span class="line"><span class="params"> <span class="number">979</span>             <span class="type">byte</span>[] applicationId, <span class="type">long</span> sid, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line"> <span class="number">980</span>         <span class="type">byte</span>[] blob = loadState(SP_BLOB_NAME, handle, userId);</span><br><span class="line"> <span class="number">981</span>         <span class="keyword">if</span> (blob == <span class="literal">null</span>) &#123;</span><br><span class="line"> <span class="number">982</span>             <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"> <span class="number">983</span>         &#125;</span><br><span class="line"> <span class="number">984</span>         <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">version</span> <span class="operator">=</span> blob[<span class="number">0</span>];</span><br><span class="line"> <span class="number">985</span>         <span class="keyword">if</span> (version != SYNTHETIC_PASSWORD_VERSION_V3</span><br><span class="line"> <span class="number">986</span>                 &amp;&amp; version != SYNTHETIC_PASSWORD_VERSION_V2</span><br><span class="line"> <span class="number">987</span>                 &amp;&amp; version != SYNTHETIC_PASSWORD_VERSION_V1) &#123;</span><br><span class="line"> <span class="number">988</span>             <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unknown blob version&quot;</span>);</span><br><span class="line"> <span class="number">989</span>         &#125;</span><br><span class="line"> <span class="number">990</span>         <span class="keyword">if</span> (blob[<span class="number">1</span>] != type) &#123;</span><br><span class="line"> <span class="number">991</span>             <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Invalid blob type&quot;</span>);</span><br><span class="line"> <span class="number">992</span>         &#125;</span><br><span class="line"> <span class="number">993</span>         <span class="keyword">final</span> <span class="type">byte</span>[] secret;</span><br><span class="line"> <span class="number">994</span>         <span class="keyword">if</span> (version == SYNTHETIC_PASSWORD_VERSION_V1) &#123;</span><br><span class="line"> <span class="comment">// 解用户ce区文件的密码</span></span><br><span class="line"> <span class="number">995</span>             secret = SyntheticPasswordCrypto.decryptBlobV1(getHandleName(handle),</span><br><span class="line"> <span class="number">996</span>                     Arrays.copyOfRange(blob, <span class="number">2</span>, blob.length), applicationId);</span><br><span class="line"> <span class="number">997</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="number">998</span>             secret = decryptSPBlob(getHandleName(handle),</span><br><span class="line"> <span class="number">999</span>                 Arrays.copyOfRange(blob, <span class="number">2</span>, blob.length), applicationId);</span><br><span class="line"><span class="number">1000</span>         &#125;</span><br><span class="line"><span class="number">1005</span>         <span class="type">AuthenticationToken</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthenticationToken</span>(version);</span><br><span class="line"><span class="comment">// 这个地方也需要debug，应该是用的 SYNTHETIC_PASSWORD_TOKEN_BASED 方式</span></span><br><span class="line"></span><br><span class="line"><span class="number">1006</span>         <span class="keyword">if</span> (type == SYNTHETIC_PASSWORD_TOKEN_BASED) &#123;</span><br><span class="line"><span class="number">1007</span>             <span class="keyword">if</span> (!loadEscrowData(result, userId)) &#123;</span><br><span class="line"><span class="number">1008</span>                 Log.e(TAG, <span class="string">&quot;User is not escrowable: &quot;</span> + userId);</span><br><span class="line"><span class="number">1009</span>                 <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"><span class="number">1010</span>             &#125;</span><br><span class="line"><span class="number">1011</span>             result.recreate(secret);</span><br><span class="line"><span class="number">1012</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">1013</span>             result.syntheticPassword = <span class="keyword">new</span> <span class="title class_">String</span>(secret);</span><br><span class="line"><span class="number">1014</span>         &#125;</span><br><span class="line"><span class="comment">// spblob格式升级</span></span><br><span class="line"><span class="number">1015</span>         <span class="keyword">if</span> (version == SYNTHETIC_PASSWORD_VERSION_V1) &#123;</span><br><span class="line"><span class="number">1016</span>             Log.i(TAG, <span class="string">&quot;Upgrade v1 SP blob for user &quot;</span> + userId + <span class="string">&quot;, type = &quot;</span> + type);</span><br><span class="line"><span class="number">1017</span>             createSyntheticPasswordBlob(handle, type, result, applicationId, sid, userId);</span><br><span class="line"><span class="number">1018</span>         &#125;</span><br><span class="line"><span class="number">1019</span>         <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">1020</span>     &#125;</span><br></pre></td></tr></table></figure>
<p>上述过程，很多地方需要通过debug才能确定，需要进一步调研。查看哪些是可以拆解出来的。可以通过native程序解出来。</p>
<p>在keyguard解锁后校验密码的流程走的spblob的方式，在gatekeeper和keymaster的基础上对密码又做了一层封装。将spblob中间文件删除后，重启手机，用户ce区文件不能解密，重建spblob后也无法解密。用户ce区解锁也是每次开机加载机主用户时执行的，并不是每次解锁都会进行unlock。用户密码更新后，ce区密码也会更新，但该密码只是用来加密文件主密钥的密码，文件主密钥并没变，所以用户密码改变不需要重新解锁用户ce区，只需要更新中间文件spblob和&#x2F;data&#x2F;misc&#x2F;vold&#x2F;user_keys&#x2F;0&#x2F;current下的中间文件即可。<br>需要进一步调试跟踪各中间参数是怎样生成的， 最终效果是能模拟用户密码是否输入正确及推导出加密ce区主密钥的密钥</p>
<h2 id="1-4-debug-调试"><a href="#1-4-debug-调试" class="headerlink" title="1.4. debug 调试"></a>1.4. debug 调试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">01-09 15:05:25.848  2575  2717 E LockPatternUtils: zlg:</span><br><span class="line">60167 01-09 15:05:25.848  2575  2717 E LockPatternUtils: java.lang.RuntimeException: checkCredential log</span><br><span class="line">60168 01-09 15:05:25.848  2575  2717 E LockPatternUtils: |at com.android.internal.widget.LockPatternUtils.checkCredential(LockPatternUtils.java:393)</span><br><span class="line">60169 01-09 15:05:25.848  2575  2717 E LockPatternUtils: |at com.android.internal.widget.LockPatternUtils.checkPattern(LockPatternUtils.java:447)</span><br><span class="line">60170 01-09 15:05:25.848  2575  2717 E LockPatternUtils: |at com.android.keyguard.LockPatternChecker$1.checkPattern(LockPatternChecker.java:91)</span><br><span class="line">60171 01-09 15:05:25.848  2575  2717 E LockPatternUtils: |at com.android.keyguard.LockPatternChecker$1.doInBackground(LockPatternChecker.java:49)</span><br><span class="line">60172 01-09 15:05:25.848  2575  2717 E LockPatternUtils: |at com.android.keyguard.LockPatternChecker$1.doInBackground(LockPatternChecker.java:39)</span><br><span class="line">60173 01-09 15:05:25.848  2575  2717 E LockPatternUtils: |at android.os.AsyncTask$3.call(AsyncTask.java:378)</span><br><span class="line">60174 01-09 15:05:25.848  2575  2717 E LockPatternUtils: |at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">60175 01-09 15:05:25.848  2575  2717 E LockPatternUtils: |at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167)</span><br><span class="line">60176 01-09 15:05:25.848  2575  2717 E LockPatternUtils: |at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)</span><br><span class="line">60177 01-09 15:05:25.848  2575  2717 E LockPatternUtils: |at java.lang.Thread.run(Thread.java:919)</span><br><span class="line">60178 01-09 15:05:25.849  2115  2546 D LockSettingsService: spBasedDoVerifyCredential: user=0</span><br><span class="line">60179 01-09 15:05:25.850  2115  2546 E LockSettingsService: zlg :</span><br><span class="line">60180 01-09 15:05:25.850  2115  2546 E LockSettingsService: java.lang.RuntimeException: spBasedDoVerifyCredential log</span><br><span class="line">60181 01-09 15:05:25.850  2115  2546 E LockSettingsService: | at com.android.server.locksettings.LockSettingsService.spBasedDoVerifyCredential(LockSettingsService.java:2623)</span><br><span class="line">60182 01-09 15:05:25.850  2115  2546 E LockSettingsService: | at com.android.server.locksettings.LockSettingsService.doVerifyCredential(LockSettingsService.java:1875)</span><br><span class="line">60183 01-09 15:05:25.850  2115  2546 E LockSettingsService: | at com.android.server.locksettings.LockSettingsService.checkCredential(LockSettingsService.java:1840)</span><br><span class="line">60184 01-09 15:05:25.850  2115  2546 E LockSettingsService: | at com.android.internal.widget.ILockSettings$Stub.onTransact(ILockSettings.java:556)</span><br><span class="line">60185 01-09 15:05:25.850  2115  2546 E LockSettingsService: | at android.os.Binder.execTransactInternal(Binder.java:1021)</span><br><span class="line">60186 01-09 15:05:25.850  2115  2546 E LockSettingsService: | at android.os.Binder.execTransact(Binder.java:994)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>从上述流程看，是走的checkPattern<br>图案解锁方式， 最后到checkCredential处，没有challenge，即challenge为0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkPattern</span><span class="params">(List&lt;LockPatternView.Cell&gt; pattern, <span class="type">int</span> userId)</span></span><br><span class="line"> <span class="number">433</span>             <span class="keyword">throws</span> RequestThrottledException &#123;</span><br><span class="line"> <span class="number">434</span>         <span class="keyword">return</span> checkPattern(pattern, userId, <span class="literal">null</span> <span class="comment">/* progressCallback */</span>);</span><br><span class="line"> <span class="number">435</span>     &#125;</span><br><span class="line"> <span class="number">436</span></span><br><span class="line"> <span class="number">437</span>     <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 438      * Check to see if a pattern matches the saved pattern.  If no pattern exists,</span></span><br><span class="line"><span class="comment"> 439      * always returns true.</span></span><br><span class="line"><span class="comment"> 440      * <span class="doctag">@param</span> pattern The pattern to check.</span></span><br><span class="line"><span class="comment"> 441      * <span class="doctag">@return</span> Whether the pattern matches the stored one.</span></span><br><span class="line"><span class="comment"> 442      */</span></span><br><span class="line"> <span class="number">443</span>     <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkPattern</span><span class="params">(List&lt;LockPatternView.Cell&gt; pattern, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params"> <span class="number">444</span>             <span class="meta">@Nullable</span> CheckCredentialProgressCallback progressCallback)</span></span><br><span class="line"> <span class="number">445</span>             <span class="keyword">throws</span> RequestThrottledException &#123;</span><br><span class="line"> <span class="number">446</span>         throwIfCalledOnMainThread();</span><br><span class="line"> <span class="number">447</span>         <span class="keyword">return</span> checkCredential(patternToByteArray(pattern), CREDENTIAL_TYPE_PATTERN, userId,</span><br><span class="line"> <span class="number">448</span>                 progressCallback);</span><br><span class="line"> <span class="number">449</span>     &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1837</span>     <span class="keyword">public</span> VerifyCredentialResponse <span class="title function_">checkCredential</span><span class="params">(<span class="type">byte</span>[] credential, <span class="type">int</span> type, <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params"><span class="number">1838</span>             ICheckCredentialProgressCallback progressCallback)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"><span class="number">1839</span>         checkPasswordReadPermission(userId);</span><br><span class="line"><span class="comment">// 没有challenge</span></span><br><span class="line"><span class="number">1840</span>         <span class="type">VerifyCredentialResponse</span> <span class="variable">response</span> <span class="operator">=</span> doVerifyCredential(credential, type,</span><br><span class="line"><span class="number">1841</span>                                         <span class="literal">false</span>, <span class="number">0</span>, userId, progressCallback);</span><br><span class="line"><span class="number">1842</span>         <span class="keyword">if</span> ((response.getResponseCode() == VerifyCredentialResponse.RESPONSE_OK) &amp;&amp;</span><br><span class="line"><span class="number">1843</span>                                            (userId == UserHandle.USER_OWNER)) &#123;</span><br><span class="line"><span class="number">1844</span>                 <span class="comment">//TODO(b/127810705): Update to credentials to use byte[]</span></span><br><span class="line"><span class="number">1845</span>                 <span class="type">String</span> <span class="variable">credentialString</span> <span class="operator">=</span> credential == <span class="literal">null</span> ? <span class="literal">null</span> : <span class="keyword">new</span> <span class="title class_">String</span>(credential);</span><br><span class="line"><span class="number">1846</span>                 retainPassword(credentialString);</span><br><span class="line"><span class="number">1847</span>         &#125;</span><br><span class="line"><span class="number">1848</span>         <span class="keyword">return</span> response;</span><br><span class="line"><span class="number">1849</span>     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>sid和applicationId是容易解出的， 根据上面debug的关键信息， 再跟一遍代码流程和参数的求解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/data/system_de/<span class="number">0</span>/spblob/4497efca1dd620f6.<span class="type">secdis</span></span><br><span class="line"><span class="variable">applicationId</span> <span class="operator">=</span> transformUnderSecdiscardable(pwdToken,</span><br><span class="line"> <span class="number">927</span>                     loadSecdiscardable(handle, userId));</span><br><span class="line">     <span class="keyword">private</span> <span class="type">byte</span>[] transformUnderSecdiscardable(<span class="type">byte</span>[] data, <span class="type">byte</span>[] rawSecdiscardable) &#123;</span><br><span class="line">     <span class="comment">// pwdToken 和 secdis文件内容联合做sha1-512</span></span><br><span class="line"><span class="number">1109</span>         <span class="type">byte</span>[] secdiscardable = SyntheticPasswordCrypto.personalisedHash(</span><br><span class="line"><span class="number">1110</span>                 PERSONALISATION_SECDISCARDABLE, rawSecdiscardable);</span><br><span class="line"><span class="number">1111</span>         <span class="type">byte</span>[] result = <span class="keyword">new</span> <span class="title class_">byte</span>[data.length + secdiscardable.length];</span><br><span class="line"><span class="number">1112</span>         System.arraycopy(data, <span class="number">0</span>, result, <span class="number">0</span>, data.length);</span><br><span class="line"><span class="number">1113</span>         System.arraycopy(secdiscardable, <span class="number">0</span>, result, data.length, secdiscardable.length);</span><br><span class="line"><span class="number">1114</span>         <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">1115</span>     &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nativeSidFromPasswordHandle-&gt;<span class="built_in">sidFromPasswordHandle</span>(pwd.passwordHandle);</span><br><span class="line"><span class="number">2</span><span class="function"><span class="type">static</span> jlong <span class="title">android_server_SyntheticPasswordManager_nativeSidFromPasswordHandle</span><span class="params">(JNIEnv* env, jobject, jbyteArray handleArray)</span> </span>&#123;</span><br><span class="line"><span class="number">33</span></span><br><span class="line"><span class="number">34</span>    jbyte* data = (jbyte*)env-&gt;<span class="built_in">GetPrimitiveArrayCritical</span>(handleArray, <span class="literal">NULL</span>);</span><br><span class="line"><span class="number">37</span>        <span class="type">const</span> gatekeeper::<span class="type">password_handle_t</span> *handle =</span><br><span class="line"><span class="number">38</span>                <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> gatekeeper::<span class="type">password_handle_t</span> *&gt;(data);</span><br><span class="line"><span class="number">39</span>        jlong sid = handle-&gt;user_id;</span><br><span class="line"><span class="number">45</span>&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LockSettingsService: zlg: credential: [B@3ada1b6 hasChallenge: false challenge: 0 handle: 4942682767425413366</span><br><span class="line">SyntheticPasswordManager: zlg weaverSlot is INVALID_WEAVER_SLOT</span><br><span class="line">SyntheticPasswordManager: zlg: unwrapSyntheticPasswordBlob version not V1</span><br><span class="line">SyntheticPasswordManager: zlg: not unwrapSyntheticPasswordBlob type SYNTHETIC_PASSWORD_TOKEN_BASED</span><br><span class="line">LockSettingsService: zlg Unlocking user 0 with secret only, length 32 secret: [B@8fb4f53</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> String <span class="title function_">getHandleName</span><span class="params">(<span class="type">long</span> handle)</span> &#123;</span><br><span class="line">  <span class="number">1182</span>         <span class="keyword">return</span> String.format(<span class="string">&quot;%s%x&quot;</span>, LockPatternUtils.SYNTHETIC_PASSWORD_KEY_PREFIX, handle);</span><br><span class="line">  <span class="number">1183</span>     &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SYNTHETIC_PASSWORD_KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;synthetic_password_&quot;</span>;</span><br><span class="line"> <span class="type">byte</span>[] blob = loadState(SP_BLOB_NAME, handle, userId);</span><br><span class="line"> <span class="comment">// handle信息其实就是/data/system_de/0/spblob/&lt;handle&gt;.spblob</span></span><br><span class="line"> <span class="comment">// secret就是文件ce区主密钥的密钥， blob 是 /data/system_de/0/spblob/&lt;handle&gt;.spblob 读取的内容， applicationId是上面提到的sha1-512的值</span></span><br><span class="line">            secret = decryptSPBlob(getHandleName(handle),</span><br><span class="line">  <span class="number">1008</span>                 Arrays.copyOfRange(blob, <span class="number">2</span>, blob.length), applicationId);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] decryptBlob(String keyAlias, <span class="type">byte</span>[] blob, <span class="type">byte</span>[] applicationId) &#123;</span><br><span class="line"><span class="number">139</span>         <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 调用 &quot;android.security.keystore&quot;的接口，这个地方注意KeyStore是java.Security.keyStore,是Java的公共接口</span></span><br><span class="line">源码在libcore/ojluni/src/main/java/java/security/KeyStore.java</span><br><span class="line"></span><br><span class="line"><span class="number">140</span>             <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(<span class="string">&quot;AndroidKeyStore&quot;</span>);</span><br><span class="line"><span class="number">141</span>             keyStore.load(<span class="literal">null</span>);</span><br><span class="line"><span class="number">142</span></span><br><span class="line"><span class="number">143</span>             <span class="type">SecretKey</span> <span class="variable">decryptionKey</span> <span class="operator">=</span> (SecretKey) keyStore.getKey(keyAlias, <span class="literal">null</span>);</span><br><span class="line"><span class="number">144</span>             <span class="type">byte</span>[] intermediate = decrypt(decryptionKey, blob);</span><br><span class="line"><span class="number">145</span>             <span class="keyword">return</span> decrypt(applicationId, APPLICATION_ID_PERSONALIZATION, intermediate);</span><br><span class="line"><span class="number">146</span>         &#125; </span><br><span class="line"></span><br><span class="line"><span class="number">1055</span>    <span class="keyword">public</span> <span class="keyword">final</span> Key <span class="title function_">getKey</span><span class="params">(String alias, <span class="type">char</span>[] password)</span></span><br><span class="line"><span class="number">1056</span>        <span class="keyword">throws</span> KeyStoreException, NoSuchAlgorithmException,</span><br><span class="line"><span class="number">1057</span>            UnrecoverableKeyException</span><br><span class="line"><span class="number">1058</span>    &#123;</span><br><span class="line"><span class="number">1062</span>        <span class="keyword">return</span> keyStoreSpi.engineGetKey(alias, password);</span><br><span class="line"><span class="number">1063</span>    &#125;</span><br><span class="line">这个keyStore的调用有点深，需要进一步查看， 最终进入了AndroidKeyStoreSpi.java内部</span><br></pre></td></tr></table></figure>


<p><code>KeyStore.getInstance(&quot;AndroidKeyStore&quot;)</code>返回的的是<code>AndroidKeyStoreSpi</code>的实例，调用<code>getKey</code>方法，最终调到了<code>AndroidKeyStoreSpi</code>的<code>engineGetKey</code></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/diegodu/p/6273611.html">ciper</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">+- secret = decryptSPBlob&lt;getHandleName(handle), Arrays.copyOfRange(blob, 2, blob.length), applicationId&gt;  #SyntheticPasswordManager.java</span><br><span class="line">                                                            # handle blob applicationId 都可以解出</span><br><span class="line">  \ +- decryptBlob(String keyAlias, byte[] blob, byte[] applicationId)  # SyntheticPasswordCrypto.java</span><br><span class="line">    \ - KeyStore keyStore = KeyStore.getInstance(&quot;AndroidKeyStore&quot;);  #调用java se的公共接口，最终访问到了AndroidKeyStoreSpi</span><br><span class="line">    | +- keyStore.load(null); # AndroidkeyStoreSpi.engineLoad(param);</span><br><span class="line">       \ - android.security.KeyStore.getInstance  # 调用到了 native keyStore &quot;android.security.keystore&quot; 实例，构造AndroidKeyStoreSpi的mKeyStore 对象， 该对象持有remote 端， native的 keyStore service</span><br><span class="line">    | +- SecretKey decryptionKey = (SecretKey) keyStore.getKey(keyAlias, null);</span><br><span class="line">       \ +- AndroidkeyStoreSpi.engineGetKey(alias, password)   # passwd 为null， alias为 synthetic_password_&lt;handle&gt;值 getHandleName方法</span><br><span class="line">          \ - String userKeyAlias = Credentials.USER_PRIVATE_KEY + alias; # USERKEY_synthetic_password_&lt;handle&gt;</span><br><span class="line">          | +- key = AndroidKeyStoreProvider.loadAndroidKeyStoreKeyFromKeystore(mKeyStore, userKeyAlias, mUid);</span><br><span class="line">             \ - KeyCharacteristics keyCharacteristics = getKeyCharacteristics(keyStore, userKeyAlias, uid); # keyStore为上面实例的mKeyStore实例</span><br><span class="line">             | +- keyStore.getKeyCharacteristics(alias, null, null, uid, keyCharacteristics) # clientId为空 appid为空 android KeyStore.java</span><br><span class="line">          |      \ - mBinder.getKeyCharacteristics(promise, alias, clientId, appId, uid);  #key_store_service.cpp 这个clientId appId 是构造了两个KeymasterBlob[new byte[0]] 出来，native层也有相应的类， KeymasterBlob.h</span><br><span class="line">                | +- return loadAndroidKeyStoreSecretKeyFromKeystore(userKeyAlias, uid, keyCharacteristics)</span><br><span class="line">                   \ - Integer keymasterAlgorithm = keyCharacteristics.getEnum(KeymasterDefs.KM_TAG_ALGORITHM); #获得加密算法</span><br><span class="line">          |         | - List&lt;Integer&gt; keymasterDigests = keyCharacteristics.getEnums(KeymasterDefs.KM_TAG_DIGEST);</span><br><span class="line">                   | - keyAlgorithmString = fromKeymasterSecretKeyAlgorithm(keymasterAlgorithm, keymasterDigest); # 解出来为AES</span><br><span class="line">                   | +- return new AndroidKeyStoreSecretKey(secretKeyAlias, uid, keyAlgorithmString);</span><br><span class="line">          |           \ - AndroidKeyStoreKey(String alias, int uid, String algorithm) # mAlias mUid mAlgorithm   # AndroidKeyStoreKey 构造函数</span><br><span class="line">   | +- byte[] intermediate = decrypt(decryptionKey, blob); # SyntheticPasswordCrypto.java 获得key后进行解密 blob为spblob读出的数据</span><br><span class="line">      \ - byte[] iv = Arrays.copyOfRange(blob, 0, PROFILE_KEY_IV_SIZE); #初始化向量</span><br><span class="line">      | - byte[] ciphertext = Arrays.copyOfRange(blob, PROFILE_KEY_IV_SIZE, blob.length); # 密文</span><br><span class="line">      | - Cipher cipher = Cipher.getInstance(KeyProperties.KEY_ALGORITHM_AES + &quot;/&quot;</span><br><span class="line">                  + KeyProperties.BLOCK_MODE_GCM + &quot;/&quot; + KeyProperties.ENCRYPTION_PADDING_NONE); # AES/GCM/NoPadding</span><br><span class="line">        \ - cipher.init(Cipher.DECRYPT_MODE, key, new GCMParameterSpec(DEFAULT_TAG_LENGTH_BITS, iv));   #解密数据 128 GCMParameterSpec怎么构造？ key为SecurityKey类型， C++怎么构造</span><br><span class="line">        | - return cipher.doFinal(ciphertext); # ciphertext是密文，解密出明文</span><br><span class="line">   | +- return decrypt(applicationId, APPLICATION_ID_PERSONALIZATION, intermediate); # intermediate为上面Cipher解出的明文</span><br><span class="line">      \ - byte[] keyHash = personalisedHash(personalisation, keyBytes); # APPLICATION_ID_PERSONALIZATION 和 APPLICATION_ID_PERSONALIZATION</span><br><span class="line">      | - SecretKeySpec key = new SecretKeySpec(Arrays.copyOf(keyHash, AES_KEY_LENGTH), AES); # javax.crypto.spec.SecretKeySpec</span><br><span class="line">      | - decrypt(key, ciphertext) #此处ciphertext为上面的解出的intermediate， 重复上面的流程</span><br></pre></td></tr></table></figure>

<p>从keyStore的模型上看，涉及的模块较多，如果多机型是同样的解密算法的话，解密流程还是可以还原的。 但从实现上看，预估不同机型的不同平台上的解密插件是不同的，如果做定制的话，涉及的解析debug 转换java代码很多。 当前流程涉及到了很多java的sdk的类，这些类怎么转换成native的代码也是一个大问题。 而解密这块，目前涉及到AES&#x2F;GCM&#x2F;NoPadding的解密，native层可以使用openssl的库来完成。 ^a300bf</p>
<p>上述密码解出后，还有最后一步，即验证用户密码是否正确。<br>这个主要涉及到gatekeeper的校验</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">         result.authToken = unwrapSyntheticPasswordBlob(handle, SYNTHETIC_PASSWORD_PASSWORD_BASED,</span><br><span class="line"> <span class="number">937</span>                 applicationId, sid, userId);</span><br><span class="line"> <span class="number">938</span></span><br><span class="line"> <span class="number">939</span>         <span class="comment">// Perform verifyChallenge to refresh auth tokens for GK if user password exists.</span></span><br><span class="line"> <span class="number">940</span>         result.gkResponse = verifyChallenge(gatekeeper, result.authToken, <span class="number">0L</span>, userId);</span><br><span class="line"></span><br><span class="line"><span class="number">43</span>     <span class="keyword">public</span> <span class="meta">@Nullable</span> VerifyCredentialResponse <span class="title function_">verifyChallenge</span><span class="params">(IGateKeeperService gatekeeper,</span></span><br><span class="line"><span class="params">  <span class="number">1044</span>             <span class="meta">@NonNull</span> AuthenticationToken auth, <span class="type">long</span> challenge, <span class="type">int</span> userId)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">  <span class="number">1045</span>         <span class="type">byte</span>[] spHandle = loadSyntheticPasswordHandle(userId);</span><br><span class="line">  <span class="number">1051</span>         VerifyCredentialResponse result;</span><br><span class="line">&gt; <span class="number">1052</span>         <span class="type">GateKeeperResponse</span> <span class="variable">response</span> <span class="operator">=</span> gatekeeper.verifyChallenge(userId, challenge,</span><br><span class="line">  <span class="number">1053</span>                 spHandle, auth.deriveGkPassword());</span><br><span class="line">  <span class="number">1054</span>         <span class="type">int</span> <span class="variable">responseCode</span> <span class="operator">=</span> response.getResponseCode();</span><br><span class="line">  <span class="number">1055</span>         <span class="keyword">if</span> (responseCode == GateKeeperResponse.RESPONSE_OK) &#123;</span><br><span class="line">  <span class="number">1056</span>             result = <span class="keyword">new</span> <span class="title class_">VerifyCredentialResponse</span>(response.getPayload());</span><br><span class="line">  <span class="number">1057</span>             <span class="keyword">if</span> (response.getShouldReEnroll()) &#123;</span><br><span class="line">  <span class="number">1058</span>                 response = gatekeeper.enroll(userId, spHandle,</span><br><span class="line">  <span class="number">1059</span>                         spHandle, auth.deriveGkPassword());</span><br><span class="line">  <span class="number">1060</span>                 <span class="keyword">if</span> (response.getResponseCode() == GateKeeperResponse.RESPONSE_OK) &#123;</span><br><span class="line">  <span class="number">1061</span>                     spHandle = response.getPayload();</span><br><span class="line">  <span class="number">1062</span>                     saveSyntheticPasswordHandle(spHandle, userId);</span><br><span class="line">  <span class="number">1063</span>                     <span class="comment">// Call self again to re-verify with updated handle</span></span><br><span class="line">&gt; <span class="number">1064</span>                     <span class="keyword">return</span> verifyChallenge(gatekeeper, auth, challenge, userId);</span><br><span class="line">  <span class="number">1065</span>                 &#125;</span><br><span class="line">  <span class="number">1069</span>             &#125;</span><br><span class="line">  <span class="number">1070</span>         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (responseCode == GateKeeperResponse.RESPONSE_RETRY) &#123;</span><br><span class="line">  <span class="number">1071</span>             result = <span class="keyword">new</span> <span class="title class_">VerifyCredentialResponse</span>(response.getTimeout());</span><br><span class="line">  <span class="number">1072</span>         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="number">1073</span>             result = VerifyCredentialResponse.ERROR;</span><br><span class="line">  <span class="number">1074</span>         &#125;</span><br><span class="line">  <span class="number">1075</span>         <span class="keyword">return</span> result;</span><br><span class="line">  <span class="number">1076</span>     &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">+++++++++++-- verifyChallenge --+++++++++</span><br><span class="line">+- verifyChallenge(gatekeeper, result.authToken, 0L, userId); #SyntheticPasswordManager.java</span><br><span class="line">  \ - byte[] spHandle = loadSyntheticPasswordHandle(userId); # /data/system_de/0/spblob/*.handle</span><br><span class="line">  | - response = gatekeeper.verifyChallenge(userId, challenge, spHandle, auth.deriveGkPassword()); # chanllenge 为 0</span><br><span class="line">     \ +- auth.deriveGkPassword()</span><br><span class="line">        \ -  derivePassword(PERSONALIZATION_SP_GK_AUTH)</span><br><span class="line">          \ - new SP800Derive(syntheticPassword.getBytes().withContext(PERSONALIZATION_SP_GK_AUTH, PERSONALISATION_CONTEXT);</span><br><span class="line">            \ - Mac m = Mac.getInstance(&quot;HmacSHA256&quot;); m.init(new SecretKeySpec(syntheticPassword, m.getAlgorithm())); # javax.crypto.Mac</span><br><span class="line">              \ - spi.engineInit(key, params); #javax/crypto/Mac.java</span><br><span class="line">     |          \ - init(key, params) #AndroidKeyStoreHmacSpi.java params为空</span><br><span class="line">                | - ensureKeystoreOperationInitialized()</span><br><span class="line">                   \ - mKeyStore.begin(mKey.getAlias(), KeymasterDefs.KM_PURPOSE_SIGN, true,keymasterArgs, ... )</span><br><span class="line">                      \ - mBinder.begin(promise, getToken(), alias, purpose, pruneable, args, entropy, uid) # /system/core/keystore</span><br><span class="line">                      | - mChunkedStreamer = new KeyStoreCryptoOperationChunkedStreamer(</span><br><span class="line">                            new KeyStoreCryptoOperationChunkedStreamer.MainDataStream(</span><br><span class="line">                            mKeyStore, mOperationToken));    #后面update会用到,保存keystore和oprationtoken</span><br><span class="line">            | - withContext(PERSONALIZATION_SP_GK_AUTH, PERSONALISATION_CONTEXT); #SP800Derive</span><br><span class="line">               \ - m.update(label);</span><br><span class="line">     |             \ - engineUpdate(new byte[] &#123;input&#125;, 0, 1);</span><br><span class="line">                      \ -  mChunkedStreamer.update(input, offset, len)</span><br><span class="line">                         \ - mKeyStoreStream.update(chunk)</span><br><span class="line">                             \ - mKeyStore.update(mOperationToken, null, input)</span><br><span class="line">                                 \ - mBinder.update(promise, token, arguments, input)</span><br><span class="line">               | - m.doFinal()      #SP800Derive.java</span><br><span class="line">                  \ - spi.engineDoFinal()</span><br><span class="line">                      \ -  engineDoFinal()</span><br><span class="line">                          \ - return result = mChunkedStreamer.doFinal(null, 0, 0, null, null);</span><br><span class="line">                             \ - output = update(input, inputOffset, inputLength)</span><br><span class="line">                                 \ - mKeyStoreStream.update(chunk)</span><br><span class="line">                                     \ - mKeyStore.update(mOperationToken, null, input)</span><br><span class="line">                                        \ - mBinder.update(promise, token, arguments, input)</span><br><span class="line">                             | -  mKeyStoreStream.finish(signature, additionalEntropy)</span><br><span class="line">                                 \ - mKeyStore.finish(mOperationToken, null, signature, additionalEntropy)</span><br><span class="line">                                     \ - mBinder.finish(promise, token, arguments, signature, entropy);</span><br><span class="line">                  | - spi.engineReset()</span><br><span class="line">                     \ - resetWhilePreservingInitState()</span><br><span class="line">     | - verifyChallenge(uid, challenge, (uint8_t *) currentPasswordHandle,</span><br><span class="line">                    currentPasswordHandleSize, (uint8_t *) currentPassword, currentPasswordSize,</span><br><span class="line">                    &amp;out, &amp;outSize, &amp;request_reenroll); # system/core/gatekeeperd/IGateKeeperService.cpp</span><br><span class="line">        \ -  verifyChallenge(uint32_t uid, uint64_t challenge,</span><br><span class="line">            const uint8_t *enrolled_password_handle, uint32_t enrolled_password_handle_length,</span><br><span class="line">            const uint8_t *provided_password, uint32_t provided_password_length,</span><br><span class="line">            uint8_t **auth_token, uint32_t *auth_token_length, bool *request_reenroll) #gatekeeperd.cpp 返回结果为auth_token, 如执行成功，                                                         reply-&gt;writeInt32(GATEKEEPER_RESPONSE_OK); reply-&gt;writeInt32(request_reenroll ? 1 : 0);</span><br><span class="line">  | - result = new VerifyCredentialResponse(response.getPayload()); # 执行成功，校验成功满足 GATEKEEPER_RESPONSE_OK 条件</span><br><span class="line">     \ -  mResponseCode = RESPONSE_OK;   #  VerifyCredentialResponse payload构造函数</span><br><span class="line">  | - response.getResponseCode() == VerifyCredentialResponse.RESPONSE_OK # 校验成功， 解锁成功</span><br></pre></td></tr></table></figure>

<p>经过debug， Mac.getInstance(“HmacSHA256”)，并init后得到的并不是<code>AndroidKeyStoreHmacSpi</code>的实例，而是OpenSSLMac，代码位于<code>/external/conscrypt/repackaged/common/src/main/java/com/android/org/conscrypt/</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">01-09 17:41:15.323  2608  2833 E zlg:    : getMac: spi com.android.org.conscrypt.OpenSSLMac.HmacSHA256 getProvider: com.android.org.conscrypt.OpenSSLProvider</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">+++++++++++-- verifyChallenge --+++++++++</span><br><span class="line">+- verifyChallenge(gatekeeper, result.authToken, 0L, userId); #SyntheticPasswordManager.java</span><br><span class="line">  \ - byte[] spHandle = loadSyntheticPasswordHandle(userId); # /data/system_de/0/spblob/*.handle</span><br><span class="line">  | - response = gatekeeper.verifyChallenge(userId, challenge, spHandle, auth.deriveGkPassword()); # chanllenge 为 0</span><br><span class="line">     \ +- auth.deriveGkPassword()</span><br><span class="line">        \ -  derivePassword(PERSONALIZATION_SP_GK_AUTH)</span><br><span class="line">          \ - new SP800Derive(syntheticPassword.getBytes().withContext(PERSONALIZATION_SP_GK_AUTH, PERSONALISATION_CONTEXT);</span><br><span class="line">            \ - Mac m = Mac.getInstance(&quot;HmacSHA256&quot;); m.init(new SecretKeySpec(syntheticPassword, m.getAlgorithm())); # javax.crypto.Mac</span><br><span class="line">              \ - super(EvpMdRef.SHA256.EVP_MD, EvpMdRef.SHA256.SIZE_BYTES); #OpenSSLMac.java </span><br><span class="line">                 \ - NativeCrypto.EVP_get_digestbyname(&quot;sha256&quot;) # libopenssl</span><br><span class="line">              | - spi.engineInit(key, params); #javax/crypto/Mac.java</span><br><span class="line">                \ - resetContext(); #OpenSSLMac.java</span><br><span class="line">                  \ - new NativeRef.HMAC_CTX(NativeCrypto.HMAC_CTX_new()) #libopenssl</span><br><span class="line">                  | - NativeCrypto.HMAC_Init_ex(ctxLocal, keyBytes, evp_md)</span><br><span class="line">            | - withContext(PERSONALIZATION_SP_GK_AUTH, PERSONALISATION_CONTEXT); #SP800Derive</span><br><span class="line">               \ - m.update(label);</span><br><span class="line">     |             \ - engineUpdate(singleByte, 0, 1); # OpenSSLMac.java</span><br><span class="line">                      \ -  NativeCrypto.HMAC_Update(ctxLocal, input, offset, len) #OpenSSLMac.java</span><br><span class="line">               | - m.doFinal()      #SP800Derive.java</span><br><span class="line">                  \ - spi.engineDoFinal()</span><br><span class="line">                     \ - engineDoFinal() #OpenSSLMac.java</span><br><span class="line">                        \ - output = NativeCrypto.HMAC_Final(ctxLocal); # libopenssl</span><br><span class="line">                        | - resetContext();</span><br><span class="line">     | - verifyChallenge(uid, challenge, (uint8_t *) currentPasswordHandle,</span><br><span class="line">                    currentPasswordHandleSize, (uint8_t *) currentPassword, currentPasswordSize,</span><br><span class="line">                    &amp;out, &amp;outSize, &amp;request_reenroll); # system/core/gatekeeperd/IGateKeeperService.cpp</span><br><span class="line">        \ -  verifyChallenge(uint32_t uid, uint64_t challenge,</span><br><span class="line">            const uint8_t *enrolled_password_handle, uint32_t enrolled_password_handle_length,</span><br><span class="line">            const uint8_t *provided_password, uint32_t provided_password_length,</span><br><span class="line">            uint8_t **auth_token, uint32_t *auth_token_length, bool *request_reenroll) #gatekeeperd.cpp 返回结果为auth_token, 如执行成功，                                                         reply-&gt;writeInt32(GATEKEEPER_RESPONSE_OK); reply-&gt;writeInt32(request_reenroll ? 1 : 0);</span><br><span class="line">  | - result = new VerifyCredentialResponse(response.getPayload()); # 执行成功，校验成功满足 GATEKEEPER_RESPONSE_OK 条件</span><br><span class="line">     \ -  mResponseCode = RESPONSE_OK;   #  VerifyCredentialResponse payload构造函数</span><br><span class="line">  | - response.getResponseCode() == VerifyCredentialResponse.RESPONSE_OK # 校验成功， 解锁成功</span><br></pre></td></tr></table></figure>
<p>从上述实现看， OpenSSLMac 的实现相对比较简单，都是直接调到native 的libopenssl库中，而AndroidKeyStoreHmacSpi的实现方式则复杂很多，本身上层代码经过了很复杂的处理，最后又通过keystore进行加解密。</p>
<h3 id="1-4-1-Cipher-封装"><a href="#1-4-1-Cipher-封装" class="headerlink" title="1.4.1. Cipher 封装"></a>1.4.1. Cipher 封装</h3><p>测试下来，Cipher 的AES解密成功的条件是gatekeeper需要先</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gatekeeper.verifyChallenge(fakeUid(userId), <span class="number">0L</span>,</span><br><span class="line"> <span class="number">898</span>                     pwd.passwordHandle, gkPwdToken)；</span><br></pre></td></tr></table></figure>
<p>这里有必要对Cipher AES的Android封装过程调研一下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] decryptBlob(String keyAlias, <span class="type">byte</span>[] blob, <span class="type">byte</span>[] applicationId) &#123;</span><br><span class="line">            <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(<span class="string">&quot;AndroidKeyStore&quot;</span>);</span><br><span class="line">            keyStore.load(<span class="literal">null</span>);</span><br><span class="line">            <span class="type">SecretKey</span> <span class="variable">decryptionKey</span> <span class="operator">=</span> (SecretKey) keyStore.getKey(keyAlias, <span class="literal">null</span>);</span><br><span class="line">            <span class="type">byte</span>[] intermediate = decrypt(decryptionKey, blob);</span><br><span class="line">            <span class="keyword">return</span> decrypt(applicationId, APPLICATION_ID_PERSONALIZATION, intermediate);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] decrypt(SecretKey key, <span class="type">byte</span>[] blob)</span><br><span class="line">            <span class="keyword">throws</span> NoSuchAlgorithmException, NoSuchPaddingException, InvalidKeyException,</span><br><span class="line">            InvalidAlgorithmParameterException, IllegalBlockSizeException, BadPaddingException &#123;</span><br><span class="line">        <span class="type">byte</span>[] iv = Arrays.copyOfRange(blob, <span class="number">0</span>, PROFILE_KEY_IV_SIZE);</span><br><span class="line">        <span class="type">byte</span>[] ciphertext = Arrays.copyOfRange(blob, PROFILE_KEY_IV_SIZE, blob.length);</span><br><span class="line">        <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(KeyProperties.KEY_ALGORITHM_AES + <span class="string">&quot;/&quot;</span></span><br><span class="line">                + KeyProperties.BLOCK_MODE_GCM + <span class="string">&quot;/&quot;</span> + KeyProperties.ENCRYPTION_PADDING_NONE);</span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, key, <span class="keyword">new</span> <span class="title class_">GCMParameterSpec</span>(DEFAULT_TAG_LENGTH_BITS, iv));</span><br><span class="line">        <span class="keyword">return</span> cipher.doFinal(ciphertext);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>前面的过程如keystore的getInstace 和 load函数大部分都调研完了，需要注意的是Cipher的这个地方还没看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">+ - Cipher cipher = Cipher.getInstance(&quot;AES/GCM/NoPadding&quot;);</span><br><span class="line">  \ - javax.crypto.Cipher.createCipher(trans, null)</span><br><span class="line">     \ -  cipherSpiAndProvider =  tryCombinations(null /*params*/, null, tokenizedTransformation);</span><br><span class="line">        \ -  CipherSpiAndProvider sap = tryTransformWithProvider(null, tokenizedTransformation, transform.needToSet, service); #获得对应的Provider，这个应该最终指向了 android.security.keystore.AndroidKeyStoreBCWorkaroundProvider</span><br><span class="line">           \ - Cipher spi = sap.cipherSpi   # 指向AndroidKeyStoreCipherSpiBase.java</span><br><span class="line">| - cipher.init(Cipher.DECRYPT_MODE, key, new GCMParameterSpec(DEFAULT_TAG_LENGTH_BITS, iv)); #SyntheticPasswordCrypto.java</span><br><span class="line">   \ - init(opmode, key, params, JceSecurity.RANDOM); #Cipher.java</span><br><span class="line">      \ - chooseProvider(InitType.ALGORITHM_PARAM_SPEC, DECRYPT_MODE, key, params, null, random);</span><br><span class="line">         \ - spiAndProviderUpdater.updateAndGetSpiAndProvider(initParams, spi, provider);</span><br><span class="line">           \ - tryTransformWithProvider(initParams, tokenizedTransformation, transform.needToSet, service);</span><br><span class="line">              \ - spi.engineSetMode(tokenizedTransformation[1]);</span><br><span class="line">              | - spi.engineSetPadding(tokenizedTransformation[2]);</span><br><span class="line">              | - spi.engineInit(initParams.opmode, initParams.key, initParams.spec, initParams.random);</span><br><span class="line">                \ -  init(opmode, key, random); </span><br><span class="line">                | - initAlgorithmSpecificParameters(params);</span><br><span class="line">                | - ensureKeystoreOperationInitialized();</span><br><span class="line">                   \ -  byte[] additionalEntropy = EmptyArray.BYTE;</span><br><span class="line">                   | - KeymasterArguments keymasterInputArgs = new KeymasterArguments();</span><br><span class="line">                   | - purpose = KeymasterDefs.KM_PURPOSE_DECRYPT;</span><br><span class="line">                   | - mKeyStore.begin(mKey.getAlias(), purpose, true, keymasterInputArgs, additionalEntropy, mKey.getUid()); #调进native的keystore中                              </span><br><span class="line">| - cipher.doFinal(ciphertext) #SyntheticPasswordCrypto.java</span><br><span class="line">   \ - updateProviderIfNeeded(); </span><br><span class="line">      \ - spiAndProviderUpdater.updateAndGetSpiAndProvider(null, spi, provider);</span><br><span class="line">        \ - return new CipherSpiAndProvider(sap.cipherSpi, sap.provider); </span><br><span class="line">   | -  return spi.engineDoFinal(input, 0, input.length);</span><br><span class="line">      \ - ensureKeystoreOperationInitialized()</span><br><span class="line">          \ -  byte[] additionalEntropy = EmptyArray.BYTE;</span><br><span class="line">          | - KeymasterArguments keymasterInputArgs = new KeymasterArguments();</span><br><span class="line">          | - purpose = KeymasterDefs.KM_PURPOSE_DECRYPT;</span><br><span class="line">          | - OperationResult opResult = mKeyStore.begin(mKey.getAlias(), purpose, true, keymasterInputArgs, additionalEntropy, mKey.getUid()); #调进native的keystore中</span><br><span class="line">          | - loadAlgorithmSpecificParametersFromBeginResult(opResult.outParams)</span><br><span class="line">             \ - byte[] returnedIv = keymasterArgs.getBytes(KeymasterDefs.KM_TAG_NONCE, null);</span><br><span class="line">             | - if (mIvRequired) mIv = returnedIv  # mIvRequired应该是false，没看到赋值的地方，可以加log验证</span><br><span class="line">          | - mMainDataStreamer = createMainDataStreamer(mKeyStore, opResult.token); #mKeyStore为android KeyStore的instance，其对端即为native的keystore</span><br><span class="line">             \ - return new KeyStoreCryptoOperationChunkedStreamer(                                                                                                                          </span><br><span class="line">                     new KeyStoreCryptoOperationChunkedStreamer.MainDataStream(keyStore, operationToken)); # 用到了keystore返回的参数token</span><br><span class="line">          |- mAdditionalAuthenticationDataStreamer = createAdditionalAuthenticationDataStreamer(mKeyStore, opResult.token); </span><br><span class="line">             \ - return new KeyStoreCryptoOperationChunkedStreamer(</span><br><span class="line">                    new AdditionalAuthenticationDataStream(keyStore, operationToken)); </span><br><span class="line">      | - flushAAD()</span><br><span class="line">         \ - output = mAdditionalAuthenticationDataStreamer.doFinal(EmptyArray.BYTE, 0 , 0 ,null, null);</span><br><span class="line">            \ - output = update(input, inputOffset, inputLength);</span><br><span class="line">               \ - mKeyStoreStream.update(chunk)  #经过了复杂的流程，最终调到这里 </span><br><span class="line">                  \ - keymasterArgs.addBytes(KeymasterDefs.KM_TAG_ASSOCIATED_DATA, input);</span><br><span class="line">                  | - mKeyStore.update(mOperationToken, keymasterArgs, null);    #AdditionalAuthenticationDataStream  # - 1.</span><br><span class="line">                     \ - output = new OperationResult(result.resultCode, result.token, result.operationHandle, input.length, result.output, result.outParams);</span><br><span class="line">            | - output = ArrayUtils.concat(output, flush()); #flush又是一个复杂的函数     </span><br><span class="line">            | - OperationResult opResult = mKeyStoreStream.finish(null, null)；</span><br><span class="line">               \ - return new OperationResult(KeyStore.NO_ERROR, mOperationToken, 0 ,0 , EmptyArray.BYTE, new KeymasterArguments());</span><br><span class="line">            | - return ArrayUtils.concat(output, opResult.output);</span><br><span class="line">      | - output = mMainDataStreamer.doFinal(input, offset, len, null, EmptyArray.BYTE);</span><br><span class="line">         \ - output = update(input, inputOffset, inputLength);</span><br><span class="line">            \ - mKeyStoreStream.update(chunk)  #经过了复杂的流程，最终调到这里</span><br><span class="line">               \ -  return mKeyStore.update(mOperationToken, null, input);  # - 2. </span><br><span class="line">         | - output = ArrayUtils.concat(output, flush()); #flush又是一个复杂的函数     </span><br><span class="line">         | - OperationResult opResult = mKeyStoreStream.finish(null, EmptyArray.BYTE)；</span><br><span class="line">           \ - opResult = mKeyStore.finish(mOperationToken, null, null, EmptyArray.BYTE); # - 3.</span><br><span class="line">         | - return ArrayUtils.concat(output, opResult.output);</span><br><span class="line">         | - return output</span><br></pre></td></tr></table></figure>
<p>从上面的流程看，经历的过程很复杂，而经过native keystore的操作有</p>
<ol>
<li>mKeyStore.update(mOperationToken, keymasterArgs, null);</li>
<li>mKeyStore.update(mOperationToken, null, input);</li>
<li>mKeyStore.finish(mOperationToken, null, null, EmptyArray.BYTE);<br>最终finish 结束了访问， 获得了结果， 而再keystore update 和 finish前 Java层又经过了一系列的转换数据的操作。包括数据分片的处理</li>
</ol>
<p>gatekeeperd 守护进程会向 Android 框架 API 授予访问 HAL 的权限，并且会参与向 Keystore 报告设备身份验证的活动。gatekeeperd 守护进程会在自己的进程中运行，与系统服务器隔离开来。</p>
<p>LockSettingsService 会通过 Binder 发出一个请求，该请求会到达 Android 操作系统中的 gatekeeperd 守护进程。gatekeeperd 守护进程会发出一个请求，该请求会到达此守护进程在 TEE 中的副本 (Gatekeeper)：</p>
<p><img src="/images/20200527161613.png" alt="gatekeeper"></p>
<p>每次密码验证成功时生成的身份验证令牌 (AuthToken)<br>用户安全 ID (SID)</p>
<p>每当用户注册新密码时，如果未提供之前的密码，系统就会使用加密伪随机数生成器 (PRNG) 生成一个用户 SID。这称为“不可信”重新注册，在正常情况下，Android 框架不允许进行这种操作。如果用户提供了之前的有效密码，便会发生“可信”重新注册；在这种情况下，用户 SID 会迁移到新密码句柄，从而保留绑定到它的密钥。</p>
<p>注册密码时，用户 SID 会随密码句柄中的密码一起接受 HMAC 处理。<br>用户 SID 会写入到 verify 函数返回的 AuthToken 中，并且会同所有与身份验证绑定的 Keystore 密钥相关联（如需详细了解 AuthToken 格式和 Keystore，请参阅身份验证）。由于对 enroll 函数的不可信调用会更改用户 SID，因此此类调用会使绑定到相应密码的密钥无法再使用。攻击者在控制 Android 操作系统后可以更改设备密码，但在此过程中，他们需要破坏掉受 Root 保护的敏感密钥。</p>
<h4 id="1-4-1-1-身份验证"><a href="#1-4-1-1-身份验证" class="headerlink" title="1.4.1.1. 身份验证"></a>1.4.1.1. 身份验证</h4><p>用户设置凭据并收到用户 SID 后，便可以开始进行身份验证，身份验证从用户提供 PIN 码、解锁图案、密码或指纹开始。所有 TEE 组件都共用一个密钥来验证对方的消息。</p>
<p><img src="/images/20200527161620.png" alt="身份验证"></p>
<p>对于 PIN 码、解锁图案或密码，LockSettingsService 会向 gatekeeperd 发出请求。守护进程将数据发至其副本，后者生成 AuthToken：对于 PIN 码&#x2F;解锁图案&#x2F;密码身份验证，gatekeeperd 将 PIN 码、解锁图案或密码哈希发送到 TEE 中的 Gatekeeper。如果 TEE 中的身份验证成功，TEE 中的 Gatekeeper 会将包含相应用户 SID（已使用 AuthToken HMAC 密钥签名）的 AuthToken 发送到它在 Android 操作系统中的副本。<br>守护进程收到经过签名的 AuthToken，并通过 Keystore 服务 Binder 接口的扩展程序将 AuthToken 传递给 Keystore 服务。（gatekeeperd 还会在设备被重新锁定以及设备密码发生变化时通知 Keystore 服务。）<br>Keystore 服务将 AuthToken 传递给 Keymaster，并使用与 Gatekeeper 和支持的生物识别 TEE 组件共用的密钥来验证这些 AuthToken。Keymaster 会将令牌中的时间戳视为最后一次身份验证的时间，并根据该时间戳做出密钥发布决定（以允许应用使用相应密钥）。</p>
<p>debug验证时，keystore解密的工作前需要gatekeeper先通过对用户密码的验证，验证正确后，gatekeeperd 守护进程会向 Android 框架 API 授予访问 HAL 的权限，并且会参与向 Keystore 报告设备身份验证的活动。keystore才可以使用，而在apk demo中碰到了<code>android.security.KeyStoreException: Signature/MAC verification failed </code>的问题，在手机解锁后执行也报这样的错误，可能与gatekeeper的授权有关。因为gatekeeper的访问不在public api中，需要进一步在编译系统中构建应用验证。如果没有验证用户安全密码，则会报<code>android.security.keystore.KeyPermanentlyInvalidatedException: Key permanently invalidated</code>的异常。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2019/07/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/clion%20%E9%98%85%E8%AF%BB%E8%B0%83%E8%AF%95Android%20native%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/clion%20%E9%98%85%E8%AF%BB%E8%B0%83%E8%AF%95Android%20native%E6%BA%90%E7%A0%81/" class="post-title-link" itemprop="url">clion vscode 阅读Android native源码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-20 10:00:01" itemprop="dateCreated datePublished" datetime="2019-07-20T10:00:01+08:00">2019-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-15 18:54:24" itemprop="dateModified" datetime="2024-04-15T18:54:24+08:00">2024-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/debug/" itemprop="url" rel="index"><span itemprop="name">debug</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-clion-vscode-阅读Android-native源码"><a href="#1-clion-vscode-阅读Android-native源码" class="headerlink" title="1. clion vscode 阅读Android native源码"></a>1. clion vscode 阅读Android native源码</h1><h2 id="1-1-为native源码编译生成cmake文件"><a href="#1-1-为native源码编译生成cmake文件" class="headerlink" title="1.1. 为native源码编译生成cmake文件"></a>1.1. 为native源码编译生成cmake文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> SOONG_GEN_CMAKEFILES=1</span><br><span class="line"><span class="built_in">export</span> SOONG_GEN_CMAKEFILES_DEBUG=1</span><br></pre></td></tr></table></figure>
<p>将上面两句加入到~&#x2F;.bashrc下, 以后新工程就不用重复export了</p>
<p>源码source lunch后, 直接make随便一个module即可.<br>cmake文件会生成在源码根目录的out&#x2F;development&#x2F;ide&#x2F;clion下</p>
<h2 id="1-2-使用clion导入native工程"><a href="#1-2-使用clion导入native工程" class="headerlink" title="1.2. 使用clion导入native工程"></a>1.2. 使用clion导入native工程</h2><p>可以直接看单module,<br>file-&gt;new cmake project from sources</p>
<p>但多个module 需要手动写cmake 引进子的module, 重复工作量大, 而且soong生成的cmake 同一module包含多个子目标</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drwxrwxr-x  2 mi mi 4096 3月  13 20:51 librecovery-arm64-android</span><br><span class="line">drwxrwxr-x  2 mi mi 4096 3月  13 20:51 librecovery-arm-android</span><br></pre></td></tr></table></figure>
<p>手动添加工作量比较大, 而且是重复工作</p>
<p>这边提供一个脚本<br>比如我想看 <code>miui-q-cepheus-dev </code>分支的  <code>bootable/recovery</code>&#x2F; <code>system/vold</code>等的源码, 可以这样写</p>
<ul>
<li>第一个参数: 建立的工程目录</li>
<li>第二个参数: 哪套源码的</li>
<li>第…个参数: 想看的子目录的源码</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find_and_add_cmake2.py cepheus-q-recovery miui-q-cepheus-dev bootable/recovery system/vold bionic/libc system/core/base system/core/fs_mgr system/core/crypto_test system/security/keystore system/gatekeeper system/core/libcutils system/core/init frameworks/base/media/jni</span><br></pre></td></tr></table></figure>

<blockquote>
<p>规则是 第一个参数: 工程目录位于~&#x2F;program&#x2F;cmake_work_space下, 建新的工程都会在该目录下创建工程的根目录<br>第二个参数, 源码的根目录在 ~&#x2F;work_space下, 这些文件夹可以自己修改脚本指定</p>
</blockquote>
<h2 id="1-3-clion导入工程"><a href="#1-3-clion导入工程" class="headerlink" title="1.3. clion导入工程"></a>1.3. clion导入工程</h2><p>上面建的工程位于~&#x2F;program&#x2F;cmake_work_space下, clion 菜单 File-&gt;new cmake project from sources, 点击之前通过脚本建立的CMakeLists.txt文件导入, 点击<code>Open Existing Project</code>即可, 等待symbol加载完成.</p>
<h1 id="2-clion-gdb-remote-debug-native源码"><a href="#2-clion-gdb-remote-debug-native源码" class="headerlink" title="2. clion gdb remote debug native源码"></a>2. clion gdb remote debug native源码</h1><h3 id="2-1-1-手机端设置gdbserver"><a href="#2-1-1-手机端设置gdbserver" class="headerlink" title="2.1.1. 手机端设置gdbserver"></a>2.1.1. 手机端设置gdbserver</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进程已经启动的情况下</span></span><br><span class="line">ps -e ; #查找native进程的pid</span><br><span class="line">gdbserver64 --attach :8888 &lt;pid&gt;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进程未启动情况下</span></span><br><span class="line">gdbserver64 :8888 /system/bin/recovery</span><br></pre></td></tr></table></figure>
<p>pc 端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:8888 tcp:8888</span><br></pre></td></tr></table></figure>

<h3 id="2-1-2-clion-端配置"><a href="#2-1-2-clion-端配置" class="headerlink" title="2.1.2. clion 端配置"></a>2.1.2. clion 端配置</h3><p>参考下图<br>Run-&gt;Edit Configurations</p>
<ul>
<li>Templates</li>
</ul>
<p><img src="/images/20200525151202.png"><br>注意上面的几个参数都要配置正确</p>
<ul>
<li>gdb: 源码下的prebuilts&#x2F;gdb&#x2F;linux-x86&#x2F;bin&#x2F;gdb</li>
<li>target remote args tcp:127.0.0.1:8888</li>
<li>path mappings: 注意映射完整路径</li>
</ul>
<h1 id="3-vscode-gdb-remote-debug"><a href="#3-vscode-gdb-remote-debug" class="headerlink" title="3. vscode gdb remote debug"></a>3. vscode gdb remote debug</h1><p>将prebuilts&#x2F;gdb&#x2F;linux-x86&#x2F;bin&#x2F;gdb 和 gdb orig 链接到环境变量下的系统目录中,或者单独加入到环境变量下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(gdb) Remote Launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;miDebuggerServerAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1:8888&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/mi/work_space/miui-q-umi-dev/out/target/product/cmi/symbols/exaid/root/sbin/exaid&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sourceFileMap&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;bootable/exaid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/mi/work_space/miui-q-umi-dev/bootable/exaid&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;trace&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;traceResponse&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;engineLogging&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="gdb-init"><a href="#gdb-init" class="headerlink" title="gdb init"></a>gdb init</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define target hookpost-remote</span><br><span class="line"><span class="built_in">set</span> solib-absolute-prefix /home/mi/work_space/miui-r-umi-dev/out/target/product/cmi/symbols/</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h1 id="stl-支持"><a href="#stl-支持" class="headerlink" title="stl 支持"></a>stl 支持</h1><p>默认情况下不支持stl 输出, 需要gdb支持python脚本, 一般需要自己编译.</p>
<p>另外需要定制gdbinit, android上废弃了stlport和gnustl的支持, 只支持libc++的方式集成stl.</p>
<p>所以python解析脚本是基于libc++开发的, 这里提供一下github上的一个脚本</p>
<p><a target="_blank" rel="noopener" href="https://github.com/koutheir/libcxx-pretty-printers">https://github.com/koutheir/libcxx-pretty-printers</a></p>
<p>同时, vscode的launch.json也要配置打开 pretty-printers</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(gdb) Remote Launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;miDebuggerServerAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1:8888&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/mi/work_space/miui-r-umi-dev/out/target/product/cmi/symbols/system/bin/test_code_aaaaaaa&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sourceFileMap&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;system/core/crypto_test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/mi/work_space/miui-r-umi-dev/system/core/test_code&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;trace&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;traceResponse&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;engineLogging&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;miDebuggerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/mi/Programs/gdb/bin/aarch64-linux-android-gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="comment">//&quot;miDebuggerPath&quot;: &quot;/home/mi/work_space/miui-r-umi-dev/prebuilts/gdb/linux-x86/bin/gdb&quot;,</span></span><br><span class="line">          <span class="attr">&quot;setupCommands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Enable pretty-printing for gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-enable-pretty-printing&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2019/07/12/OTA%E7%9B%B8%E5%85%B3/ext3%E8%AF%BB%E5%86%99%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/12/OTA%E7%9B%B8%E5%85%B3/ext3%E8%AF%BB%E5%86%99%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%20/" class="post-title-link" itemprop="url">OTA相关/ext3读写过程分析 .md</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-12 18:15:54" itemprop="dateCreated datePublished" datetime="2019-07-12T18:15:54+08:00">2019-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-16 15:17:29" itemprop="dateModified" datetime="2024-04-16T15:17:29+08:00">2024-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Filesystem/" itemprop="url" rel="index"><span itemprop="name">Filesystem</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-Ext3文件系统读写过程分析"><a href="#1-Ext3文件系统读写过程分析" class="headerlink" title="1. Ext3文件系统读写过程分析"></a>1. Ext3文件系统读写过程分析</h1><h2 id="1-1-Ext3文件读写流程概述"><a href="#1-1-Ext3文件读写流程概述" class="headerlink" title="1.1. Ext3文件读写流程概述"></a>1.1. Ext3文件读写流程概述</h2><p> Ext3文件系统在进行读写操作的时候，首先需要open相应的文件，然后再进行读写操作。在open操作时，Linux kernel会创建一个file对象描述这个文件。File对象和文件的dentry和inode对象建立联系，并且将ext3的文件操作方法、映射处理方法（address space）注册到file对象中。 </p>
<p>Ext3文件读写过程会涉及到VFS层的<strong>page cache</strong>，并且通常的读写操作都会使用到这层page cache，目的是提高磁盘的IO性能。在Linux中后台会运行writeback线程定时同步pagecache和设备之间的数据。Page cache的方式虽然能够提高IO性能，但是也对数据的安全性带来了潜在影响。 </p>
<p>本文的目的是分析ext3文件系统读写流程中的关键函数，对于page cache原理以及writeback机制将在后继文章中做深入分析。</p>
<h2 id="1-2-关键数据结构"><a href="#1-2-关键数据结构" class="headerlink" title="1.2. 关键数据结构"></a>1.2. 关键数据结构</h2><p>File数据结构是Linux用来描述文件的关键数据结构，该对象在一个文件被进程打开的时候被创建。当一个文件被关闭的时候，file对象也会被立即销毁。file数据结构不会被作为元数据信息持久化保存至设备。该数据结构定义如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span>  </span><br><span class="line">    <span class="comment">/*  </span></span><br><span class="line"><span class="comment">     * fu_list becomes invalid after file_free is called and queued via  </span></span><br><span class="line"><span class="comment">     * fu_rcuhead for RCU freeing  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">fu_list</span>;</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>     <span class="title">fu_rcuhead</span>;</span>  </span><br><span class="line">    &#125; f_u;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">path</span>     <span class="title">f_path</span>;</span>     <span class="comment">/* 文件路径，包含文件dentry目录项和vfsmount信息 */</span>  </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> f_dentry    f_path.dentry  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> f_vfsmnt    f_path.mnt  </span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>    *<span class="title">f_op</span>;</span>  <span class="comment">/* 文件操作函数集 */</span>  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*  </span></span><br><span class="line"><span class="comment">     * Protects f_ep_links, f_flags, f_pos vs i_size in lseek SEEK_CUR.  </span></span><br><span class="line"><span class="comment">     * Must not be taken from IRQ context.  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="type">spinlock_t</span>      f_lock;  </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SMP  </span></span><br><span class="line">    <span class="type">int</span>         f_sb_list_cpu;  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line">    <span class="type">atomic_long_t</span>       f_count;  </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        f_flags;  </span><br><span class="line">    <span class="type">fmode_t</span>         f_mode; <span class="comment">/* 文件操作模式 */</span>  </span><br><span class="line">    <span class="type">loff_t</span>          f_pos;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span>  <span class="title">f_owner</span>;</span>  </span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>   *<span class="title">f_cred</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span>    <span class="title">f_ra</span>;</span>  </span><br><span class="line"> </span><br><span class="line">    u64         f_version;  </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY  </span></span><br><span class="line">    <span class="type">void</span>            *f_security;  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line">    <span class="comment">/* needed for tty driver, and maybe others */</span>  </span><br><span class="line">    <span class="type">void</span>            *private_data;  </span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EPOLL  </span></span><br><span class="line">    <span class="comment">/* Used by fs/eventpoll.c to link all the hooks to this file */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">f_ep_links</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">f_tfile_llink</span>;</span>  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* #ifdef CONFIG_EPOLL */</span>  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>    *<span class="title">f_mapping</span>;</span> <span class="comment">/* address space映射信息，指向inode中的i_mapping */</span>  </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_WRITECOUNT  </span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> f_mnt_write_state;  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>每个文件在内存中都会对应一个inode对象。在设备上也会保存每个文件的inode元数据信息，通过inode元数据信息可以找到该文件所占用的所有文件数据块（block）。VFS定义了一个通用的inode数据结构，同时ext3定义了ext3_inode元数据结构。在创建内存inode对象时，需要采用ext3_inode元数据信息初始化inode对象。Inode数据结构定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> &#123;</span>  </span><br><span class="line">    <span class="type">umode_t</span>         i_mode;  </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span>      i_opflags;  </span><br><span class="line">    <span class="type">uid_t</span>           i_uid;  </span><br><span class="line">    <span class="type">gid_t</span>           i_gid;  </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        i_flags;  </span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_POSIX_ACL  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span>    *<span class="title">i_acl</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span>    *<span class="title">i_default_acl</span>;</span>  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line"> </span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span>   *<span class="title">i_op</span>;</span>  <span class="comment">/* inode操作函数集 */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">super_block</span>  *<span class="title">i_sb</span>;</span>      <span class="comment">/* 指向superblock */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>    *<span class="title">i_mapping</span>;</span> <span class="comment">/* 指向当前使用的页缓存的映射信息 */</span>  </span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY  </span></span><br><span class="line">    <span class="type">void</span>            *i_security;  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Stat data, not accessed from path walking */</span>  </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       i_ino;  </span><br><span class="line">    <span class="comment">/*  </span></span><br><span class="line"><span class="comment">     * Filesystems may only read i_nlink directly.  They shall use the  </span></span><br><span class="line"><span class="comment">     * following functions for modification:  </span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     *    (set|clear|inc|drop)_nlink  </span></span><br><span class="line"><span class="comment">     *    inode_(inc|dec)_link_count  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span>  </span><br><span class="line">        <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> i_nlink;  </span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> __i_nlink;  </span><br><span class="line">    &#125;;  </span><br><span class="line">    <span class="type">dev_t</span>           i_rdev;     <span class="comment">/* 设备号，major&amp;minor */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span>     <span class="title">i_atime</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span>     <span class="title">i_mtime</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span>     <span class="title">i_ctime</span>;</span>  </span><br><span class="line">    <span class="type">spinlock_t</span>      i_lock; <span class="comment">/* i_blocks, i_bytes, maybe i_size */</span>  </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span>          i_bytes;  </span><br><span class="line">    <span class="type">blkcnt_t</span>        i_blocks;   <span class="comment">/* 文件块数量 */</span>  </span><br><span class="line">    <span class="type">loff_t</span>          i_size;  </span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __NEED_I_SIZE_ORDERED  </span></span><br><span class="line">    <span class="type">seqcount_t</span>      i_size_seqcount;  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Misc */</span>  </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       i_state;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>        <span class="title">i_mutex</span>;</span>  </span><br><span class="line"> </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>       dirtied_when;   <span class="comment">/* jiffies of first dirtying */</span>  </span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>   <span class="title">i_hash</span>;</span> <span class="comment">/* 连接到inode Hash Table中 */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">i_wb_list</span>;</span>  <span class="comment">/* backing dev IO list */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">i_lru</span>;</span>      <span class="comment">/* inode LRU list */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">i_sb_list</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">i_dentry</span>;</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>     <span class="title">i_rcu</span>;</span>  </span><br><span class="line">    &#125;;  </span><br><span class="line">    <span class="type">atomic_t</span>        i_count;  </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        i_blkbits;  <span class="comment">/* 块大小，通常磁盘块大小为512字节，因此i_blkbits为9 */</span>  </span><br><span class="line">    u64         i_version;  </span><br><span class="line">    <span class="type">atomic_t</span>        i_dio_count;  </span><br><span class="line">    <span class="type">atomic_t</span>        i_writecount;  </span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>    *<span class="title">i_fop</span>;</span> <span class="comment">/* former -&gt;i_op-&gt;default_file_ops，文件操作函数集 */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_lock</span>    *<span class="title">i_flock</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>    <span class="title">i_data</span>;</span> <span class="comment">/* 页高速缓存映射信息 */</span>  </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_QUOTA  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dquot</span>        *<span class="title">i_dquot</span>[<span class="title">MAXQUOTAS</span>];</span>  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">i_devices</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>  *<span class="title">i_pipe</span>;</span>        <span class="comment">/* 管道设备 */</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">i_bdev</span>;</span>    <span class="comment">/* block device块设备 */</span>  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span>     *<span class="title">i_cdev</span>;</span>    <span class="comment">/* 字符设备 */</span>  </span><br><span class="line">    &#125;;  </span><br><span class="line"> </span><br><span class="line">    __u32           i_generation;  </span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FSNOTIFY  </span></span><br><span class="line">    __u32           i_fsnotify_mask; <span class="comment">/* all events this inode cares about */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>   <span class="title">i_fsnotify_marks</span>;</span>  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_IMA  </span></span><br><span class="line">    <span class="type">atomic_t</span>        i_readcount; <span class="comment">/* struct files open RO */</span>  </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line">    <span class="type">void</span>            *i_private; <span class="comment">/* fs or device private pointer */</span>  </span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>##读过程源码分析</p>
<p> Ext3文件系统读过程相对比较简单，函数调用关系如下图所示：</p>
<p><a target="_blank" rel="noopener" href="https://s1.51cto.com/attachment/201301/003443623.jpg"><img src="https://s1.51cto.com/attachment/201301/003443623.jpg" alt="img"></a> </p>
<p>读过程可以分为两大类：Direct_io方式和page_cache方式。对于Direct_io方式，首先通过filemap_write_and_wait_range函数将page cache中的数据与设备同步并且无效掉page cache中的内容，然后再通过ext3提供的direct_io方法从设备读取数据。</p>
<p>另一种是直接从page cache中获取数据，通过do_generic_file_read函数实现该方式。该函数的主要流程说明如下：</p>
<p>1，通过读地址从page cache的radix树中获取相应的page页。</p>
<p>2，如果对应的page页不存在，那么需要创建一个page，然后再从设备读取相应的数据更新至page页。</p>
<p>3，当page页准备完毕之后，从页中拷贝数据至用户空间，page_cache方式的读操作完成。</p>
<p><strong>写过程源码分析</strong></p>
<p>Ext3的写过程主要分为direct_io写过程和page cache写过程两大类，整个写过程的函数调用关系如下图所示：</p>
<p><a target="_blank" rel="noopener" href="https://s1.51cto.com/attachment/201301/003523223.jpg"><img src="https://s1.51cto.com/attachment/201301/003523223.jpg" alt="img"></a> </p>
<p>写操作的核心函数是__generic_file_aio_write，该函数实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> __generic_file_aio_write(<span class="keyword">struct</span> kiocb *iocb, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov,  </span><br><span class="line">                 <span class="type">unsigned</span> <span class="type">long</span> nr_segs, <span class="type">loff_t</span> *ppos)  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span> =</span> iocb-&gt;ki_filp;  </span><br><span class="line">    <span class="comment">/* 获取address space映射信息 */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> * <span class="title">mapping</span> =</span> file-&gt;f_mapping;  </span><br><span class="line">    <span class="type">size_t</span> ocount;      <span class="comment">/* original count */</span>  </span><br><span class="line">    <span class="type">size_t</span> count;       <span class="comment">/* after file limit checks */</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span>    *<span class="title">inode</span> =</span> mapping-&gt;host; <span class="comment">/* 获取文件inode索引节点 */</span>  </span><br><span class="line">    <span class="type">loff_t</span>      pos;  </span><br><span class="line">    <span class="type">ssize_t</span>     written;  </span><br><span class="line">    <span class="type">ssize_t</span>     err;  </span><br><span class="line"> </span><br><span class="line">    ocount = <span class="number">0</span>;  </span><br><span class="line">    <span class="comment">/* 检验数据区域是否存在问题，数据由iov数据结构管理 */</span>  </span><br><span class="line">    err = generic_segment_checks(iov, &amp;nr_segs, &amp;ocount, VERIFY_READ);  </span><br><span class="line">    <span class="keyword">if</span> (err)  </span><br><span class="line">        <span class="keyword">return</span> err;  </span><br><span class="line">    <span class="comment">/* ocount为可以写入的数据长度 */</span>  </span><br><span class="line">    count = ocount;  </span><br><span class="line">    pos = *ppos;  </span><br><span class="line"> </span><br><span class="line">    vfs_check_frozen(inode-&gt;i_sb, SB_FREEZE_WRITE);  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* We can write back this queue in page reclaim */</span>  </span><br><span class="line">    current-&gt;backing_dev_info = mapping-&gt;backing_dev_info;  </span><br><span class="line">    written = <span class="number">0</span>;  </span><br><span class="line">    <span class="comment">/* 边界检查，需要判断写入数据是否超界、小文件边界检查以及设备是否是read-only。如果超界，那么降低写入数据长度 */</span>  </span><br><span class="line">    err = generic_write_checks(file, &amp;pos, &amp;count, S_ISBLK(inode-&gt;i_mode));  </span><br><span class="line">    <span class="keyword">if</span> (err)  </span><br><span class="line">        <span class="keyword">goto</span> out;  </span><br><span class="line">    <span class="comment">/* count为实际可以写入的数据长度，如果写入数据长度为0，直接结束 */</span>  </span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>)  </span><br><span class="line">        <span class="keyword">goto</span> out;  </span><br><span class="line"> </span><br><span class="line">    err = file_remove_suid(file);  </span><br><span class="line">    <span class="keyword">if</span> (err)  </span><br><span class="line">        <span class="keyword">goto</span> out;  </span><br><span class="line"> </span><br><span class="line">    file_update_time(file);  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* coalesce the iovecs and go direct-to-BIO for O_DIRECT */</span>  </span><br><span class="line">    <span class="keyword">if</span> (unlikely(file-&gt;f_flags &amp; O_DIRECT)) &#123;  </span><br><span class="line">        <span class="comment">/* Direct IO操作模式，该模式会bypass Page Cache，直接将数据写入磁盘设备 */</span>  </span><br><span class="line">        <span class="type">loff_t</span> endbyte;  </span><br><span class="line">        <span class="type">ssize_t</span> written_buffered;  </span><br><span class="line">        <span class="comment">/* 将对应page cache无效掉，然后将数据直接写入磁盘 */</span>  </span><br><span class="line">        written = generic_file_direct_write(iocb, iov, &amp;nr_segs, pos,  </span><br><span class="line">                            ppos, count, ocount);  </span><br><span class="line">        <span class="keyword">if</span> (written &lt; <span class="number">0</span> || written == count)  </span><br><span class="line">            <span class="comment">/* 所有数据已经写入磁盘，正确返回 */</span>  </span><br><span class="line">            <span class="keyword">goto</span> out;  </span><br><span class="line">        <span class="comment">/*  </span></span><br><span class="line"><span class="comment">         * direct-io write to a hole: fall through to buffered I/O  </span></span><br><span class="line"><span class="comment">         * for completing the rest of the request.  </span></span><br><span class="line"><span class="comment">         */</span>  </span><br><span class="line">        pos += written;  </span><br><span class="line">        count -= written;  </span><br><span class="line">        <span class="comment">/* 有些请求由于没有和块大小（通常为512字节）对齐，那么将无法正确完成direct-io操作。在__blockdev_direct_IO 函数中会检查逻辑地址是否和块大小对齐，__blockdev_direct_IO无法处理不对齐的请求。另外，在ext3逻辑地址和物理块地址映射操作函数ext3_get_block返回失败时，无法完成buffer_head的映射，那么request请求也将无法得到正确处理。所有没有得到处理的请求通过 buffer写的方式得到处理。从这点来看，direct_io并没有完全bypass page cache，在有些情况下是一种写无效模式。generic_file_buffered_write函数完成buffer写，将数据直接写入page cache */</span>  </span><br><span class="line">        written_buffered = generic_file_buffered_write(iocb, iov,  </span><br><span class="line">                        nr_segs, pos, ppos, count,  </span><br><span class="line">                        written);  </span><br><span class="line">        <span class="comment">/*  </span></span><br><span class="line"><span class="comment">         * If generic_file_buffered_write() retuned a synchronous error  </span></span><br><span class="line"><span class="comment">         * then we want to return the number of bytes which were  </span></span><br><span class="line"><span class="comment">         * direct-written, or the error code if that was zero.  Note  </span></span><br><span class="line"><span class="comment">         * that this differs from normal direct-io semantics, which  </span></span><br><span class="line"><span class="comment">         * will return -EFOO even if some bytes were written.  </span></span><br><span class="line"><span class="comment">         */</span>  </span><br><span class="line">        <span class="keyword">if</span> (written_buffered &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="comment">/* 如果page cache写失败，那么返回写成功的数据长度 */</span>  </span><br><span class="line">            err = written_buffered;  </span><br><span class="line">            <span class="keyword">goto</span> out;  </span><br><span class="line">        &#125;  </span><br><span class="line"> </span><br><span class="line">        <span class="comment">/*  </span></span><br><span class="line"><span class="comment">         * We need to ensure that the page cache pages are written to  </span></span><br><span class="line"><span class="comment">         * disk and invalidated to preserve the expected O_DIRECT  </span></span><br><span class="line"><span class="comment">         * semantics.  </span></span><br><span class="line"><span class="comment">         */</span>  </span><br><span class="line">        endbyte = pos + written_buffered - written - <span class="number">1</span>;  </span><br><span class="line">        <span class="comment">/* 将page cache中的数据同步到磁盘 */</span>  </span><br><span class="line">        err = filemap_write_and_wait_range(file-&gt;f_mapping, pos, endbyte);  </span><br><span class="line">        <span class="keyword">if</span> (err == <span class="number">0</span>) &#123;  </span><br><span class="line">            written = written_buffered;  </span><br><span class="line">            <span class="comment">/* 将page cache无效掉，保证下次读操作从磁盘获取数据 */</span>  </span><br><span class="line">            invalidate_mapping_pages(mapping,  </span><br><span class="line">                         pos &gt;&gt; PAGE_CACHE_SHIFT,  </span><br><span class="line">                         endbyte &gt;&gt; PAGE_CACHE_SHIFT);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="comment">/*  </span></span><br><span class="line"><span class="comment">             * We don&#x27;t know how much we wrote, so just return  </span></span><br><span class="line"><span class="comment">             * the number of bytes which were direct-written  </span></span><br><span class="line"><span class="comment">             */</span>  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="comment">/* 将数据写入page cache。绝大多数的ext3写操作都会采用page cache写方式，通过后台writeback线程将page cache同步到硬盘 */</span>  </span><br><span class="line">        written = generic_file_buffered_write(iocb, iov, nr_segs,  </span><br><span class="line">                pos, ppos, count, written);  </span><br><span class="line">    &#125;  </span><br><span class="line">out:  </span><br><span class="line">    current-&gt;backing_dev_info = <span class="literal">NULL</span>;  </span><br><span class="line">    <span class="keyword">return</span> written ? written : err;  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>从__generic_file_aio_write函数可以看出，ext3写操作主要分为两大类：一类为direct_io；另一类为buffer_io （page cache write）。Direct IO可以bypass page cache，直接将数据写入设备。下面首先分析一下direct_io的处理流程。</p>
<p>如果操作地址对应的page页存在于page cache中，那么首先需要将这些page页中的数据同磁盘进行同步，然后将这些page缓存页无效掉，从而保证后继读操作能够从磁盘获取最新数据。在代码实现过程中，还需要考虑预读机制引入的page缓存页，所以在数据写入磁盘之后，需要再次查找page cache的radix树，保证写入的地址范围没有数据被缓存。</p>
<p>Generic_file_direct_write是处理direct_io的主要函数，该函数的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span>  </span><br><span class="line"><span class="title function_">generic_file_direct_write</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov,  </span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">long</span> *nr_segs, <span class="type">loff_t</span> pos, <span class="type">loff_t</span> *ppos,  </span></span><br><span class="line"><span class="params">        <span class="type">size_t</span> count, <span class="type">size_t</span> ocount)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span> =</span> iocb-&gt;ki_filp;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span> =</span> file-&gt;f_mapping;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span>    *<span class="title">inode</span> =</span> mapping-&gt;host;  </span><br><span class="line">    <span class="type">ssize_t</span>     written;  </span><br><span class="line">    <span class="type">size_t</span>      write_len;  </span><br><span class="line">    <span class="type">pgoff_t</span>     end;  </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (count != ocount)  </span><br><span class="line">        *nr_segs = iov_shorten((<span class="keyword">struct</span> iovec *)iov, *nr_segs, count);  </span><br><span class="line"> </span><br><span class="line">    write_len = iov_length(iov, *nr_segs);  </span><br><span class="line">    end = (pos + write_len - <span class="number">1</span>) &gt;&gt; PAGE_CACHE_SHIFT;  </span><br><span class="line">    <span class="comment">/* 将对应区域page cache中的新数据页刷新到设备，这个操作是同步的 */</span>  </span><br><span class="line">    written = filemap_write_and_wait_range(mapping, pos, pos + write_len - <span class="number">1</span>);  </span><br><span class="line">    <span class="keyword">if</span> (written)  </span><br><span class="line">        <span class="keyword">goto</span> out;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*  </span></span><br><span class="line"><span class="comment">     * After a write we want buffered reads to be sure to go to disk to get  </span></span><br><span class="line"><span class="comment">     * the new data.  We invalidate clean cached page from the region we&#x27;re  </span></span><br><span class="line"><span class="comment">     * about to write.  We do this *before* the write so that we can return  </span></span><br><span class="line"><span class="comment">     * without clobbering -EIOCBQUEUED from -&gt;direct_IO().  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="comment">/* 将page cache对应page 缓存无效掉，这样可以保证后继的读操作能从磁盘获取最新数据 */</span>  </span><br><span class="line">    <span class="keyword">if</span> (mapping-&gt;nrpages) &#123;  </span><br><span class="line">        <span class="comment">/* 无效对应的page缓存 */</span>  </span><br><span class="line">        written = invalidate_inode_pages2_range(mapping,  </span><br><span class="line">                    pos &gt;&gt; PAGE_CACHE_SHIFT, end);  </span><br><span class="line">        <span class="comment">/*  </span></span><br><span class="line"><span class="comment">         * If a page can not be invalidated, return 0 to fall back  </span></span><br><span class="line"><span class="comment">         * to buffered write.  </span></span><br><span class="line"><span class="comment">         */</span>  </span><br><span class="line">        <span class="keyword">if</span> (written) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (written == -EBUSY)  </span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">            <span class="keyword">goto</span> out;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">/* 调用ext3文件系统的direct io方法，将数据写入磁盘 */</span>  </span><br><span class="line">    written = mapping-&gt;a_ops-&gt;direct_IO(WRITE, iocb, iov, pos, *nr_segs);  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*  </span></span><br><span class="line"><span class="comment">     * Finally, try again to invalidate clean pages which might have been  </span></span><br><span class="line"><span class="comment">     * cached by non-direct readahead, or faulted in by get_user_pages()  </span></span><br><span class="line"><span class="comment">     * if the source of the write was an mmap&#x27;ed region of the file  </span></span><br><span class="line"><span class="comment">     * we&#x27;re writing.  Either one is a pretty crazy thing to do,  </span></span><br><span class="line"><span class="comment">     * so we don&#x27;t support it 100%.  If this invalidation  </span></span><br><span class="line"><span class="comment">     * fails, tough, the write still worked...  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="comment">/* 再次无效掉由于预读操作导致的对应地址的page cache缓存页 */</span>  </span><br><span class="line">    <span class="keyword">if</span> (mapping-&gt;nrpages) &#123;  </span><br><span class="line">        invalidate_inode_pages2_range(mapping,  </span><br><span class="line">                          pos &gt;&gt; PAGE_CACHE_SHIFT, end);  </span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (written &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">        pos += written;  </span><br><span class="line">        <span class="keyword">if</span> (pos &gt; i_size_read(inode) &amp;&amp; !S_ISBLK(inode-&gt;i_mode)) &#123;  </span><br><span class="line">            i_size_write(inode, pos);  </span><br><span class="line">            mark_inode_dirty(inode);  </span><br><span class="line">        &#125;  </span><br><span class="line">        *ppos = pos;  </span><br><span class="line">    &#125;  </span><br><span class="line">out:  </span><br><span class="line">    <span class="keyword">return</span> written;  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>generic_file_direct_write函数中刷新page cache的函数调用关系描述如下：</p>
<p>filemap_write_and_wait_range à__filemap_fdatawrite_rangeà do_writepages</p>
<p>do_writepages函数的作用是将page页中的数据同步到设备，该函数实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">do_writepages</span><span class="params">(<span class="keyword">struct</span> address_space *mapping, <span class="keyword">struct</span> writeback_control *wbc)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="type">int</span> ret;  </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (wbc-&gt;nr_to_write &lt;= <span class="number">0</span>)  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">    <span class="keyword">if</span> (mapping-&gt;a_ops-&gt;writepages)  </span><br><span class="line">        <span class="comment">/* 如果文件系统定义了writepages方法，调用该方法刷新page cache页 */</span>  </span><br><span class="line">        ret = mapping-&gt;a_ops-&gt;writepages(mapping, wbc);  </span><br><span class="line">    <span class="keyword">else</span>  </span><br><span class="line">        <span class="comment">/* ext3没有定义writepages方法，因此调用generic_writepages()函数将page cache中的脏页刷新到磁盘 */</span>  </span><br><span class="line">        ret = generic_writepages(mapping, wbc);  </span><br><span class="line">    <span class="keyword">return</span> ret;  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>从上述分析可以看出，direct_io需要块大小对齐，否则还会调用page cache的路径。为了提高I&#x2F;O性能，通常情况下ext3都会采用page cache异步写的方式。这也就是ext3的第二种写操作方式，该方式实现的关键函数是generic_file_buffered_write，其实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span>  </span><br><span class="line"><span class="title function_">generic_file_buffered_write</span><span class="params">(<span class="keyword">struct</span> kiocb *iocb, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov,  </span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">long</span> nr_segs, <span class="type">loff_t</span> pos, <span class="type">loff_t</span> *ppos,  </span></span><br><span class="line"><span class="params">        <span class="type">size_t</span> count, <span class="type">ssize_t</span> written)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span> =</span> iocb-&gt;ki_filp;  </span><br><span class="line">    <span class="type">ssize_t</span> status;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iov_iter</span> <span class="title">i</span>;</span>  </span><br><span class="line"> </span><br><span class="line">    iov_iter_init(&amp;i, iov, nr_segs, count, written);  </span><br><span class="line">    <span class="comment">/* 执行page cache写操作 */</span>  </span><br><span class="line">    status = generic_perform_write(file, &amp;i, pos);  </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (likely(status &gt;= <span class="number">0</span>)) &#123;  </span><br><span class="line">        written += status;  </span><br><span class="line">        *ppos = pos + status;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">return</span> written ? written : status;  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>generic_file_buffered_write其实是对generic_perform_write函数的封装，generic_perform_write实现了page cache写的所有流程，该函数实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">generic_perform_write</span><span class="params">(<span class="keyword">struct</span> file *file,  </span></span><br><span class="line"><span class="params">                <span class="keyword">struct</span> iov_iter *i, <span class="type">loff_t</span> pos)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span> =</span> file-&gt;f_mapping;  </span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> *<span class="title">a_ops</span> =</span> mapping-&gt;a_ops;  <span class="comment">/* 映射处理函数集 */</span>  </span><br><span class="line">    <span class="type">long</span> status = <span class="number">0</span>;  </span><br><span class="line">    <span class="type">ssize_t</span> written = <span class="number">0</span>;  </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags = <span class="number">0</span>;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">/*  </span></span><br><span class="line"><span class="comment">     * Copies from kernel address space cannot fail (NFSD is a big user).  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">if</span> (segment_eq(get_fs(), KERNEL_DS))  </span><br><span class="line">        flags |= AOP_FLAG_UNINTERRUPTIBLE;  </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">do</span> &#123;  </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span>  </span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> offset;   <span class="comment">/* Offset into pagecache page */</span>  </span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> bytes;    <span class="comment">/* Bytes to write to page */</span>  </span><br><span class="line">        <span class="type">size_t</span> copied;      <span class="comment">/* Bytes copied from user */</span>  </span><br><span class="line">        <span class="type">void</span> *fsdata;  </span><br><span class="line"> </span><br><span class="line">        offset = (pos &amp; (PAGE_CACHE_SIZE - <span class="number">1</span>));  </span><br><span class="line">        bytes = <span class="type">min_t</span>(<span class="type">unsigned</span> <span class="type">long</span>, PAGE_CACHE_SIZE - offset,  </span><br><span class="line">                        iov_iter_count(i));  </span><br><span class="line"> </span><br><span class="line">again:  </span><br><span class="line">        <span class="comment">/*  </span></span><br><span class="line"><span class="comment">         * Bring in the user page that we will copy from _first_.  </span></span><br><span class="line"><span class="comment">         * Otherwise there&#x27;s a nasty deadlock on copying from the  </span></span><br><span class="line"><span class="comment">         * same page as we&#x27;re writing to, without it being marked  </span></span><br><span class="line"><span class="comment">         * up-to-date.  </span></span><br><span class="line"><span class="comment">         *  </span></span><br><span class="line"><span class="comment">         * Not only is this an optimisation, but it is also required  </span></span><br><span class="line"><span class="comment">         * to check that the address is actually valid, when atomic  </span></span><br><span class="line"><span class="comment">         * usercopies are used, below.  </span></span><br><span class="line"><span class="comment">         */</span>  </span><br><span class="line">        <span class="keyword">if</span> (unlikely(iov_iter_fault_in_readable(i, bytes))) &#123;  </span><br><span class="line">            status = -EFAULT;  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="comment">/* 调用ext3中的write_begin函数（inode.c中）ext3_write_begin， 如果写入的page页不存在，那么ext3_write_begin会创建一个Page页，然后从硬盘中读入相应的数据 */</span>  </span><br><span class="line">        status = a_ops-&gt;write_begin(file, mapping, pos, bytes, flags,  </span><br><span class="line">                        &amp;page, &amp;fsdata);  </span><br><span class="line">        <span class="keyword">if</span> (unlikely(status))  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (mapping_writably_mapped(mapping))  </span><br><span class="line">            flush_dcache_page(page);  </span><br><span class="line"> </span><br><span class="line">        pagefault_disable();  </span><br><span class="line">        <span class="comment">/* 将数据拷贝到page cache中 */</span>  </span><br><span class="line">        copied = iov_iter_copy_from_user_atomic(page, i, offset, bytes);  </span><br><span class="line">        pagefault_enable();  </span><br><span class="line">        flush_dcache_page(page);  </span><br><span class="line"> </span><br><span class="line">        mark_page_accessed(page);  </span><br><span class="line">        <span class="comment">/* 调用ext3的write_end函数（inode.c中），写完数据之后会将page页标识为dirty，后台writeback线程会将dirty page刷新到设备 */</span>  </span><br><span class="line">        status = a_ops-&gt;write_end(file, mapping, pos, bytes, copied,  </span><br><span class="line">                        page, fsdata);  </span><br><span class="line">        <span class="keyword">if</span> (unlikely(status &lt; <span class="number">0</span>))  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        copied = status;  </span><br><span class="line"> </span><br><span class="line">        cond_resched();  </span><br><span class="line"> </span><br><span class="line">        iov_iter_advance(i, copied);  </span><br><span class="line">        <span class="keyword">if</span> (unlikely(copied == <span class="number">0</span>)) &#123;  </span><br><span class="line">            <span class="comment">/*  </span></span><br><span class="line"><span class="comment">             * If we were unable to copy any data at all, we must  </span></span><br><span class="line"><span class="comment">             * fall back to a single segment length write.  </span></span><br><span class="line"><span class="comment">             *  </span></span><br><span class="line"><span class="comment">             * If we didn&#x27;t fallback here, we could livelock  </span></span><br><span class="line"><span class="comment">             * because not all segments in the iov can be copied at  </span></span><br><span class="line"><span class="comment">             * once without a pagefault.  </span></span><br><span class="line"><span class="comment">             */</span>  </span><br><span class="line">            bytes = <span class="type">min_t</span>(<span class="type">unsigned</span> <span class="type">long</span>, PAGE_CACHE_SIZE - offset,  </span><br><span class="line">                        iov_iter_single_seg_count(i));  </span><br><span class="line">            <span class="keyword">goto</span> again;  </span><br><span class="line">        &#125;  </span><br><span class="line">        pos += copied;  </span><br><span class="line">        written += copied;  </span><br><span class="line"> </span><br><span class="line">        balance_dirty_pages_ratelimited(mapping);  </span><br><span class="line">        <span class="keyword">if</span> (fatal_signal_pending(current)) &#123;  </span><br><span class="line">            status = -EINTR;  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">while</span> (iov_iter_count(i));  </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> written ? written : status;  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2018/10/21/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/fingerprint%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/21/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/fingerprint%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">fingerprint介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-10-21 00:00:00" itemprop="dateCreated datePublished" datetime="2018-10-21T00:00:00+08:00">2018-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-15 17:59:59" itemprop="dateModified" datetime="2024-04-15T17:59:59+08:00">2024-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-fingerprint编译过程"><a href="#1-fingerprint编译过程" class="headerlink" title="1. fingerprint编译过程"></a>1. fingerprint编译过程</h1><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_BRAND := SPRD</span><br><span class="line">PRODUCT_DEVICE :=   --TARGET_DEVICE</span><br><span class="line">PRODUCT_NAME :=   --TARGET_PRODUCT</span><br><span class="line"><span class="comment"># build_id.mk</span></span><br><span class="line">BUILD_ID :=</span><br><span class="line"><span class="section">TARGET_BUILD_VARIANT:userdebug:user</span></span><br><span class="line"><span class="section">BUILD_VERSION_TAGS:test-keys release-keys</span></span><br><span class="line">BF_BUILD_NUMBER := <span class="variable">$(USER)</span>$$(<span class="variable">$(DATE_FROM_FILE)</span> +%m%d%H%M)</span><br><span class="line"></span><br><span class="line">BUILD_FINGERPRINT := <span class="variable">$(PRODUCT_BRAND)</span>/<span class="variable">$(TARGET_PRODUCT)</span>/<span class="variable">$(TARGET_DEVICE)</span>:<span class="variable">$(PLATFORM_VERSION)</span>/<span class="variable">$(BUILD_ID)</span>/<span class="variable">$(BF_BUILD_NUMBER)</span>:<span class="variable">$(TARGET_BUILD_VARIANT)</span>/<span class="variable">$(BUILD_VERSION_TAGS)</span></span><br></pre></td></tr></table></figure>

<p>SPRD&#x2F;sp9832e_1h10_oversea&#x2F;sp9832e_1h10:9&#x2F;PPR1.180610.021&#x2F;liguang.zhang12111501:userdebug&#x2F;test-keys</p>
<blockquote>
<p>fingerprint的变动是跟着<code>BF_BUILD_NUMBER</code>字段变更的, 而<code>BF_BUILD_NUMBER</code>字段只在make时更新, 即执行一次make更新一次.<br>整编时, 一次编译出所有的img, img中所有的fingerprint都是一样的.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">start</span><br><span class="line">#HotPink:make;</span><br><span class="line">-&gt;system.img\nvendor.img\nproduct.img\nrecovery.img\n;</span><br><span class="line">note right:ro.build.fingerprint\nro.product.build.fingerprint\nro.vendor.build.fingerprint</span><br><span class="line">#pink:pac;</span><br><span class="line">:make productimage;</span><br><span class="line">-&gt;product.img;</span><br><span class="line">note right:ro.product.build.fingerprint</span><br><span class="line">:replace pac;</span><br><span class="line">end</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<h1 id="2-fingerprint用途"><a href="#2-fingerprint用途" class="headerlink" title="2. fingerprint用途"></a>2. fingerprint用途</h1><h2 id="2-1-ota升级"><a href="#2-1-ota升级" class="headerlink" title="2.1. ota升级"></a>2.1. ota升级</h2><p>差分升级时会校验fingerprint. 升级包中的fingerprint来自ota素材包(target_file)中的system分区的build.prop文件.<br>src recovery分区的fingerprint来自prop.default<br>即进到recovery模式下getprop ro.build.fingerprint 与基础版本和目标版本的ro.build.fingerprint值进行比对, 有一个相等则符合要求.</p>
<ul>
<li>prop.default结构:<br>ro.build.fingerprint         -&lt; 来自system编译过程<br>ro.product.build.fingerprint -&lt; 来自product编译过程</li>
</ul>
<p>如果只make productimage, 则recovery分区的prop.default不会更新.</p>
<h2 id="2-2-system-package升级"><a href="#2-2-system-package升级" class="headerlink" title="2.2. system package升级"></a>2.2. system package升级</h2><p>升级之前data分区保存的old ro.build.fingerprint和升级之后的ro.build.fingerprint作比较, 如果不相同, 为upgrade条件.</p>
<h2 id="2-3-google兼容性测试"><a href="#2-3-google兼容性测试" class="headerlink" title="2.3. google兼容性测试"></a>2.3. google兼容性测试</h2><p>相同的ro.build.fingerprint被认为是同一个包, 不再重复测试.</p>
<blockquote>
<p>vts测试会同时使用ro.vendor.build.fingerprint</p>
</blockquote>
<h1 id="3-fingerprint方案"><a href="#3-fingerprint方案" class="headerlink" title="3. fingerprint方案"></a>3. fingerprint方案</h1><p>覆盖property, 会有system分区升级的问题.<br>不覆盖property, 会有送测问题.</p>
<ol>
<li>现有方案, 不做改动</li>
</ol>
<ul>
<li>google兼容性测试问题</li>
<li>只升级product分区(如果应用放在product分区), 升级完后, product中的应用不会更新</li>
</ul>
<ol start="2">
<li>ro.product.build.fingerprint覆盖ro.build.fingerprint</li>
</ol>
<ul>
<li>只升级system分区<br>fingerprint读的product分区的, 升级结束后, fingerprint没变, 升级完后system中应用不更新</li>
<li>只升级product分区  ok<br>升级结束后, fingerprint变动</li>
<li>同时升级system分区和product分区<br>product分区如果没变化, 还是有问题.</li>
</ul>
<ol start="3">
<li>不覆盖property, 修改libc, 读取ro.build.fingerprint时, 使用ro.product.build.fingerprint值替换.</li>
</ol>
<ul>
<li>recovery中使用android:base:GetProperty</li>
<li>android上层使用android:base:GetProperty访问</li>
<li><del>native层也可以使用property_get访问</del></li>
<li>shell中对应toolbox, 使用类似android:base:GetProperty访问</li>
</ul>
<ol start="4">
<li>手机开机时, 在初始化<code>ro.build.fingerprint</code>, 即将该ro属性加载到内存中时, 使用<code>ro.product.build.fingerprint</code>值替换<blockquote>
<p>前提是<code>ro.product.build.fingerprint</code>已经在前面加载到内存中了.</p>
</blockquote>
</li>
</ol>
<p>修改init会同时作用到正常开机和recovery子系统, 但因为在recovery子系统中, ro.build.fingerprint在<code>ro.product.build.fingerprint</code>前面, 所以在recovery子系统中<code>ro.build.fingerprint</code>不会被替换掉.</p>
<p>正常开机 init 替换<code>ro.build.fingerprint</code>流程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">start</span><br><span class="line">:set ro.product.build.fingerprint;</span><br><span class="line">note right: read from product.img</span><br><span class="line">:replace ro.build.fingerprint;</span><br><span class="line">end</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<h2 id="3-1-小结"><a href="#3-1-小结" class="headerlink" title="3.1. 小结"></a>3.1. 小结</h2><p>综合考虑上述方案, 采用第4个方案修改较小, 副作用也比较小. 上述方案中2&#x2F;3&#x2F;4其实是对应的同一种, 仅修改方式不同. 副作用也是相同的.</p>
<h1 id="4-修改方案提出的要求"><a href="#4-修改方案提出的要求" class="headerlink" title="4. 修改方案提出的要求"></a>4. 修改方案提出的要求</h1><p>考虑下面几种场景:</p>
<h2 id="4-1-google兼容性测试"><a href="#4-1-google兼容性测试" class="headerlink" title="4.1. google兼容性测试"></a>4.1. google兼容性测试</h2><p>需要综合考虑cts&#x2F;gts&#x2F;vts测试的要求, 重点是vts测试使用<code>ro.vendor.build.fingperint</code>, 如果vendor分区不跟product分区的fingerprint保持一致, 会带来同一个pac包, cts&#x2F;gts的测试target和vts的测试target不是同一个的问题.</p>
<p>因此需要保证vendor分区的<code>ro.vendor.build.fingperint</code>和product分区的<code>ro.product.build.fingerprint</code>保持一致.</p>
<h2 id="4-2-对功能影响层面"><a href="#4-2-对功能影响层面" class="headerlink" title="4.2. 对功能影响层面"></a>4.2. 对功能影响层面</h2><p>主要影响ota升级流程和升级结束后应用的更新流程.<br>需要重点考虑只有某一个分区变动的情况:</p>
<h3 id="4-2-1-只有product分区变动了"><a href="#4-2-1-只有product分区变动了" class="headerlink" title="4.2.1. 只有product分区变动了"></a>4.2.1. 只有product分区变动了</h3><p>这种情况对应多个product(config)对应同一软件版本的情况.<br>需要将vendor和product的编译绑到一起(对应4.1中的要求)<br>可以采用下面流程, 利用编译vendor会先编译product的规则.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">start</span><br><span class="line">:make;</span><br><span class="line">:pac;</span><br><span class="line">:...;</span><br><span class="line">:remove vendor &amp; product;</span><br><span class="line">note right: delete vendor.img/product.img and its dir in $PRODUCT_OUT</span><br><span class="line">:make vendorimg;</span><br><span class="line">:make productimg;</span><br><span class="line">:repac;</span><br><span class="line">end</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p>而对应ota升级流程(recovery中的系统升级), 对差分升级来说, 如果需要差分升级product&#x2F;vendor, 需要重新制作ota的target-files, 并重新制作ota的差分包.<br>而对ota整包升级则不受影响</p>
<h3 id="4-2-2-只有system分区变动"><a href="#4-2-2-只有system分区变动" class="headerlink" title="4.2.2. 只有system分区变动"></a>4.2.2. 只有system分区变动</h3><p>这种情况对应芯片厂商向下游厂商只推送system.img情况. 由于最终的ro.build.fingerprint来自于product分区, 下游厂商需要重新编译vendor.img 和 product.img(或者手动修改vendor和product中的<code>ro.vendor.build.fingperint</code>和<code>ro.product.build.fingerprint</code>, 目的是要和system.img中的<code>ro.build.fingerprint</code>保持一致), 再重新打包.</p>
<p>对应ota升级(recovery子系统中进行升级的情况), 因底包(system.img&#x2F;vendor.img&#x2F;product.img)变动了, 需要重新制作targetfiles素材包和ota差分包, ota整包不用考虑.</p>
<h3 id="4-2-3-只有vendor分区变动"><a href="#4-2-3-只有vendor分区变动" class="headerlink" title="4.2.3. 只有vendor分区变动"></a>4.2.3. 只有vendor分区变动</h3><p>这种情况对应(4.2.1中)只有product分区变动的情况</p>
<h1 id="5-Requirements"><a href="#5-Requirements" class="headerlink" title="5. Requirements"></a>5. Requirements</h1><p>The solution description:<br>When init initially sets the value of the ro.build.fingerprint property, first check if ro.product.build.fingerprint is empty. If it is not empty, use this value replace the value of ro.build.fingerprint.<br>At such situation, multiple product partitions (configurations) correspond to the same software version. Usually, only product partition is different.</p>
<p>Need to consider the requirements of the cts&#x2F;gts&#x2F;vts test, the focus is on the vts test using <code>ro.vendor.build.fingperint</code>. If <code>ro.vendor.build.fingerprint</code> in vendor partition is not consistent with the fingerprint of the product partition, it will bring the problem of for same pac package, cts&#x2F;gts test target and the vts test target are not same.</p>
<p>Therefore, need to ensure that the <code>ro.vendor.build.fingperint</code> in vendor partition is consistent with the <code>ro.product.build.fingerprint</code> in product partition.<br>And for OTA incremental upgrade, should make OTA target-files for all different product and vendor image.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2018/10/21/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/21/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">软件小设计读书笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-10-21 00:00:00" itemprop="dateCreated datePublished" datetime="2018-10-21T00:00:00+08:00">2018-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-15 18:57:18" itemprop="dateModified" datetime="2024-04-15T18:57:18+08:00">2024-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AF%BB%E4%B9%A6/" itemprop="url" rel="index"><span itemprop="name">读书</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-设计原则"><a href="#1-设计原则" class="headerlink" title="1. 设计原则"></a>1. 设计原则</h1><h2 id="1-1-通用原则"><a href="#1-1-通用原则" class="headerlink" title="1.1. 通用原则"></a>1.1. 通用原则</h2><h3 id="1-1-1-KISS原则-keep-it-sample-and-stupid"><a href="#1-1-1-KISS原则-keep-it-sample-and-stupid" class="headerlink" title="1.1.1. KISS原则(keep it sample and stupid)"></a>1.1.1. KISS原则(keep it sample and stupid)</h3><ul>
<li>懒人原则</li>
<li>注重简约的原则, 逻辑处理上应该用简单直接的设计.</li>
<li>圈复杂度越小越好, if for case while的数量.</li>
</ul>
<p><code>如非必要, 请远离各种设计模式</code></p>
<h2 id="1-2-核心原则"><a href="#1-2-核心原则" class="headerlink" title="1.2. 核心原则"></a>1.2. 核心原则</h2><h3 id="1-2-1-单一职责原则-SRP"><a href="#1-2-1-单一职责原则-SRP" class="headerlink" title="1.2.1. 单一职责原则(SRP)"></a>1.2.1. 单一职责原则(SRP)</h3><p><code>做一个专一的人</code></p>
<p>不能存在多于一个导致类变更的原因, 一个类之负责一项职责.</p>
<blockquote>
<p>迭代器的实现, 集合只负责存储数据, 迭代器完成遍历数据的功能</p>
</blockquote>
<h3 id="1-2-2-开放封闭原则-OCP"><a href="#1-2-2-开放封闭原则-OCP" class="headerlink" title="1.2.2. 开放封闭原则 (OCP)"></a>1.2.2. 开放封闭原则 (OCP)</h3><p><code>改造世界的大部分不能破坏原来的秩序</code></p>
<p>软件实体应该是可扩展, 不可修改的. 对扩展开放, 对修改封闭<br>新的修改不要大幅度波及现有的对象</p>
<blockquote>
<p>小技巧: 使用继承&#x2F;组合封装变化点,<br>将变化点封装出一个抽象基类, 使用继承机制, 让子类演绎变化</p>
</blockquote>
<h3 id="1-2-3-里氏替换原则-LSP"><a href="#1-2-3-里氏替换原则-LSP" class="headerlink" title="1.2.3. 里氏替换原则 (LSP)"></a>1.2.3. 里氏替换原则 (LSP)</h3><p><code>长大后, 我就成了你</code></p>
<p>任何积累可以出现的地方, 子类一定可以出现.</p>
<blockquote>
<p>子类不破坏父类的接口成员<br>当基类出现了子类不想要的接口成员时, 继承关系欠缺考虑, 违反LSP原则</p>
</blockquote>
<h3 id="1-2-4-接口分离原则-ISP"><a href="#1-2-4-接口分离原则-ISP" class="headerlink" title="1.2.4. 接口分离原则 (ISP)"></a>1.2.4. 接口分离原则 (ISP)</h3><p><code>不要一口吃成胖子</code></p>
<p>不能强迫用户去依赖那些不使用的接口, 使用多个专门的接口比使用单一的总接口要好</p>
<h3 id="1-2-5-依赖倒置原则-DIP"><a href="#1-2-5-依赖倒置原则-DIP" class="headerlink" title="1.2.5. 依赖倒置原则 (DIP)"></a>1.2.5. 依赖倒置原则 (DIP)</h3><p><code>抽象的艺术才有生命力</code></p>
<ul>
<li>高层模块不应依赖底层模块, 两者都应依赖于抽象</li>
<li>抽象不应依赖细节</li>
<li>细节(具体实现类)依赖抽象</li>
</ul>
<h3 id="1-2-6-核心原则小结"><a href="#1-2-6-核心原则小结" class="headerlink" title="1.2.6. 核心原则小结"></a>1.2.6. 核心原则小结</h3><p><code>类要单纯, 继承要纯粹, 变化要封装, 抽象类型要多用</code></p>
<h2 id="1-3-扩展规则"><a href="#1-3-扩展规则" class="headerlink" title="1.3. 扩展规则"></a>1.3. 扩展规则</h2><h3 id="1-3-1-狄米特法则"><a href="#1-3-1-狄米特法则" class="headerlink" title="1.3.1. 狄米特法则"></a>1.3.1. 狄米特法则</h3><p><code>尽量不与无关的类发生关系</code></p>
<p>最少知识原则: 你调用的类的内部是如何实现的, 与我无关. 我只知道你提供的接口方法, 其他的一概不关心.</p>
<p>通俗点的说法:</p>
<ul>
<li>只与你的朋友说话</li>
<li>不要与陌生人说话</li>
<li>对象因该只与必须交互的对象通信</li>
</ul>
<p>技术上的说法, 对象只与下类必须交互的各类对象进行通信:</p>
<ul>
<li>当前对象本身(this)</li>
<li>以参数形式传入当前方法中的对象</li>
<li>当前对象的成员对象 (this的成员变量)</li>
<li>如果成员对象是一个集合, 集合中的元素也是可以交互的</li>
<li>当前对象创建的对象</li>
</ul>
<h3 id="1-3-2-好莱坞法则"><a href="#1-3-2-好莱坞法则" class="headerlink" title="1.3.2. 好莱坞法则"></a>1.3.2. 好莱坞法则</h3><p><code>不要调用我, 让我调用你</code></p>
<p>多使用回调的方式. </p>
<h3 id="1-3-3-优先使用组合"><a href="#1-3-3-优先使用组合" class="headerlink" title="1.3.3. 优先使用组合"></a>1.3.3. 优先使用组合</h3><p>多使用组合, 少使用继承.</p>
<p>继承使用的场景:</p>
<p>满足严格的IS-A关系, 即子类可以完全复用基类的所有信息时, 继承是必须的</p>
<p>要么有冗余关系, 要么复用程度不够时, 不推荐完全使用继承关系.</p>
<h2 id="1-4-应对变化"><a href="#1-4-应对变化" class="headerlink" title="1.4. 应对变化"></a>1.4. 应对变化</h2><h3 id="1-4-1-增量修改原则"><a href="#1-4-1-增量修改原则" class="headerlink" title="1.4.1. 增量修改原则"></a>1.4.1. 增量修改原则</h3><p>开闭原则, 尽量不修改原有的类和方法, 通过新增类和方法实现.</p>
<h3 id="1-4-2-整体策略原则"><a href="#1-4-2-整体策略原则" class="headerlink" title="1.4.2. 整体策略原则"></a>1.4.2. 整体策略原则</h3><p>设计整体上考虑变化,而不仅仅考虑变化点周围的小区域</p>
<h3 id="1-4-3-应对变化的设计思路"><a href="#1-4-3-应对变化的设计思路" class="headerlink" title="1.4.3. 应对变化的设计思路"></a>1.4.3. 应对变化的设计思路</h3><ul>
<li><p>预先设计<br>程序设计时就把可能存在的变化考虑到, 在程序上预留一定的扩展性<br>采用抽象类型来描述稳定的接口, 使用子类和多态机制来描述变化.</p>
</li>
<li><p>简单设计+封装变化<br>很多时候, 变化总是不期而至,无法做到预先设计,当变化来的时候, 通过封装变化点来重构程序</p>
</li>
</ul>
<h2 id="1-5-设计的四个阶段"><a href="#1-5-设计的四个阶段" class="headerlink" title="1.5. 设计的四个阶段"></a>1.5. 设计的四个阶段</h2><h3 id="1-5-1-设计不足"><a href="#1-5-1-设计不足" class="headerlink" title="1.5.1. 设计不足"></a>1.5.1. 设计不足</h3><ul>
<li>没有系统的观念, 代码写到哪想到哪,想到哪写到哪.</li>
<li>代码随意堆彻, 各种编程元素随意使用, 元素可见性\生命周期使用混乱</li>
<li>元素随意命名, 数字随意使用</li>
<li>代码随意复制和粘贴, 功能相似的函数不考虑复用</li>
<li>代码无法应对需求变化, 维护成本很高</li>
</ul>
<h3 id="1-5-2-模仿设计"><a href="#1-5-2-模仿设计" class="headerlink" title="1.5.2. 模仿设计"></a>1.5.2. 模仿设计</h3><ul>
<li>开始考虑程序对系统其他方面的影响, 开始考虑设计</li>
<li>开始应用简单的模式</li>
<li>开始学习一些好的写法, 并学会整理自己的代码</li>
</ul>
<h3 id="1-5-3-过度设计"><a href="#1-5-3-过度设计" class="headerlink" title="1.5.3. 过度设计"></a>1.5.3. 过度设计</h3><ul>
<li>见到全局的概念就使用单例模式</li>
<li>需要通知就使用观察者模式</li>
<li>见到稍微复杂一点的对象创建就使用抽象工厂模式</li>
<li>见到算法变化了一点就使用策略模式</li>
<li>见到软件就分三层</li>
<li>见到变化就抽象</li>
<li>见到依赖就注入</li>
<li>任何行为都想抽象接口</li>
<li>任何设计都考虑是否具有通用扩展性</li>
</ul>
<p>过度设计是在软件设计过程中实施了不必要的通用的扩展性设计, 增加了不必要的面向未来的设计, 进行了不必要的抽象封装.</p>
<h3 id="适度设计"><a href="#适度设计" class="headerlink" title="适度设计"></a>适度设计</h3><p>合时宜，　恰如其分，有时间制约，　合适的时间成本，　恰当的对接需求．</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2018/10/21/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/incremental%20fs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/21/%E5%85%B6%E4%BB%96%E8%B0%83%E7%A0%94/incremental%20fs/" class="post-title-link" itemprop="url">Incrementalfs 调研</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-10-21 00:00:00" itemprop="dateCreated datePublished" datetime="2018-10-21T00:00:00+08:00">2018-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-15 19:07:15" itemprop="dateModified" datetime="2024-04-15T19:07:15+08:00">2024-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">文件系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Incremental-File-System"><a href="#Incremental-File-System" class="headerlink" title="Incremental File System"></a>Incremental File System</h1><h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>Incremental FS is special-purpose Linux virtual file system that allows<br>execution of a program while its binary and resource files are still being<br>lazily downloaded over the network, USB etc. It is focused on incremental<br>delivery for a small number (under 100) of big files (more than 10 megabytes).<br>Incremental FS doesn?t allow direct writes into files and, once loaded, file<br>content never changes. Incremental FS doesn?t use a block device, instead it<br>saves data into a backing file located on a regular file-system.</p>
<h2 id="But-why"><a href="#But-why" class="headerlink" title="But why?"></a>But why?</h2><p>To allow running <strong>big</strong> Android apps before their binaries and resources are<br>fully downloaded to an Android device. If an app reads something not loaded yet,<br>it needs to wait for the data block to be fetched, but in most cases hot blocks<br>can be loaded in advance.</p>
<h2 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h2><p>A userspace process, called a data loader, mounts an instance of incremental-fs<br>giving it a file descriptor on an underlying file system (like ext4 or f2fs).<br>Incremental-fs reads content (if any) of this backing file and interprets it as<br>a file system image with files, directories and data blocks. At this point<br>the data loader can declare new files to be shown by incremental-fs.</p>
<p>A process is started from a binary located on incremental-fs.<br>All reads are served directly from the backing file<br>without roundtrips into userspace. If the process accesses a data block that was<br>not originally present in the backing file, the read operation waits.</p>
<p>Meanwhile the data loader can feed new data blocks to incremental-fs by calling<br>write() on a special .cmd pseudo-file. The data loader can request information<br>about pending reads by calling poll() and read() on the .cmd pseudo-file.<br>This mechanism allows the data loader to serve most urgently needed data first.<br>Once a data block is given to incremental-fs, it saves it to the backing file<br>and unblocks all the reads waiting for this block.</p>
<p>Eventually all data for all files is uploaded by the data loader, and saved by<br>incremental-fs into the backing file. At that moment the data loader is not<br>needed any longer. The backing file will play the role of a complete<br>filesystem image for all future runs of the program.</p>
<h2 id="Non-goals"><a href="#Non-goals" class="headerlink" title="Non-goals"></a>Non-goals</h2><ul>
<li>Allowing direct writes by the executing processes into files on incremental-fs</li>
<li>Allowing the data loader change file size or content after it was loaded.</li>
<li>Having more than a couple hundred files and directories.</li>
</ul>
<h1 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h1><h2 id="Read-only-but-not-unchanging"><a href="#Read-only-but-not-unchanging" class="headerlink" title="Read-only, but not unchanging"></a>Read-only, but not unchanging</h2><p>On the surface a mount directory of incremental-fs would look similar to<br>a read-only instance of network file system: files and directories can be<br>listed and read, but can?t be directly created or modified via creat() or<br>write(). At the same time the data loader can make changes to a directory<br>structure via external ioctl-s. i.e. link and unlink files and directories<br>(if they empty). Data can’t be changed this way, once a file block is loaded<br>there is no way to change it.</p>
<h2 id="Filesystem-image-in-a-backing-file"><a href="#Filesystem-image-in-a-backing-file" class="headerlink" title="Filesystem image in a backing file"></a>Filesystem image in a backing file</h2><p>Instead of using a block device, all data and metadata is stored in a<br>backing file provided as a mount parameter. The backing file is located on<br>an underlying file system (like ext4 or f2fs). Such approach is very similar<br>to what might be achieved by using loopback device with a traditional file<br>system, but it avoids extra set-up steps and indirections. It also allows<br>incremental-fs image to dynamically grow as new files and data come without<br>having to do any extra steps for resizing.</p>
<p>If the backing file contains data at the moment when incremental-fs is mounted,<br>content of the backing file is being interpreted as filesystem image.<br>New files and data can still be added through the external interface,<br>and they will be saved to the backing file.</p>
<h2 id="Data-compression"><a href="#Data-compression" class="headerlink" title="Data compression"></a>Data compression</h2><p>Incremental-fs can store compressed data. In this case each 4KB data block is<br>compressed separately. Data blocks can be provided to incremental-fs by<br>the data loader in a compressed form. Incremental-fs uncompresses blocks<br>each time a executing process reads it (modulo page cache). Compression also<br>takes care of blocks composed of all zero bytes removing necessity to handle<br>this case separately.</p>
<h2 id="Partially-present-files"><a href="#Partially-present-files" class="headerlink" title="Partially present files"></a>Partially present files</h2><p>Data in the files consists of 4KB blocks, each block can be present or absent.<br>Unlike in sparse files, reading an absent block doesn?t return all zeros.<br>It waits for the data block to be loaded via the ioctl interface<br>(respecting a timeout). Once a data block is loaded it never disappears<br>and can?t be changed or erased from a file. This ability to frictionlessly<br>wait for temporary missing data is the main feature of incremental-fs.</p>
<h2 id="Hard-links-Multiple-names-for-the-same-file"><a href="#Hard-links-Multiple-names-for-the-same-file" class="headerlink" title="Hard links. Multiple names for the same file"></a>Hard links. Multiple names for the same file</h2><p>Like all traditional UNIX file systems, incremental-fs supports hard links,<br>i.e. different file names in different directories can refer to the same file.<br>As mentioned above new hard links can be created and removed via<br>the ioctl interface, but actual data files are immutable, modulo partial<br>data loading. Each directory can only have at most one name referencing it.</p>
<h2 id="Inspection-of-incremental-fs-internal-state"><a href="#Inspection-of-incremental-fs-internal-state" class="headerlink" title="Inspection of incremental-fs internal state"></a>Inspection of incremental-fs internal state</h2><p>poll() and read() on the .cmd pseudo-file allow data loaders to get a list of<br>read operations stalled due to lack of a data block (pending reads).</p>
<h1 id="Application-Programming-Interface"><a href="#Application-Programming-Interface" class="headerlink" title="Application Programming Interface"></a>Application Programming Interface</h1><h2 id="Regular-file-system-interface"><a href="#Regular-file-system-interface" class="headerlink" title="Regular file system interface"></a>Regular file system interface</h2><p>Executing process access files and directories via regular Linux file interface:<br>open, read, close etc. All the intricacies of data loading a file representation<br>are hidden from them.</p>
<h2 id="External-cmd-file-interface"><a href="#External-cmd-file-interface" class="headerlink" title="External .cmd file interface"></a>External .cmd file interface</h2><p>When incremental-fs is mounted, a mount directory contains a pseudo-file<br>called ‘.cmd’. The data loader will open this file and call read(), write(),<br>poll() and ioctl() on it inspect and change state of incremental-fs.</p>
<p>poll() and read() are used by the data loader to wait for pending reads to<br>appear and obtain an array of <code>struct incfs_pending_read_info</code>.</p>
<p>write() is used by the data loader to feed new data blocks to incremental-fs.<br>A data buffer given to write() is interpreted as an array of<br><code>struct incfs_new_data_block</code>. Structs in the array describe locations and<br>properties of data blocks loaded with this write() call.</p>
<p><code>ioctl(INCFS_IOC_PROCESS_INSTRUCTION)</code> is used to change structure of<br>incremental-fs. It receives an pointer to <code>struct incfs_instruction</code><br>where type field can have be one of the following values.</p>
<p><strong>INCFS_INSTRUCTION_NEW_FILE</strong><br>Creates an inode (a file or a directory) without a name.<br>It assumes <code>incfs_new_file_instruction.file</code> is populated with details.</p>
<p><strong>INCFS_INSTRUCTION_ADD_DIR_ENTRY</strong><br>Creates a name (aka hardlink) for an inode in a directory.<br>A directory can’t have more than one hardlink pointing to it, but files can be<br>linked from different directories.<br>It assumes <code>incfs_new_file_instruction.dir_entry</code> is populated with details.</p>
<p><strong>INCFS_INSTRUCTION_REMOVE_DIR_ENTRY</strong><br>Remove a name (aka hardlink) for a file from a directory.<br>Only empty directories can be unlinked.<br>It assumes <code>incfs_new_file_instruction.dir_entry</code> is populated with details.</p>
<p>For more details see in uapi&#x2F;linux&#x2F;incrementalfs.h and samples below.</p>
<h2 id="Supported-mount-options"><a href="#Supported-mount-options" class="headerlink" title="Supported mount options"></a>Supported mount options</h2><p>See <code>fs/incfs/options.c</code> for more details.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* ``backing_fd=&lt;unsigned int&gt;``</span><br><span class="line">    Required. A file descriptor of a backing file opened by the process</span><br><span class="line">    calling mount(2). This descriptor can be closed after mount returns.</span><br><span class="line"></span><br><span class="line">* ``read_timeout_msc=&lt;unsigned int&gt;``</span><br><span class="line">    Default: 1000. Timeout in milliseconds before a read operation fails</span><br><span class="line">    if no data found in the backing file or provided by the data loader.</span><br></pre></td></tr></table></figure>

<h2 id="Sysfs-files"><a href="#Sysfs-files" class="headerlink" title="Sysfs files"></a>Sysfs files</h2><p><code>/sys/fs/incremental-fs/version</code> - a current version of the filesystem.<br>One ASCII encoded positive integer number with a new line at the end.</p>
<h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><p>See <code>sample_data_loader.c</code> for a complete implementation of a data loader.</p>
<p>Mount incremental-fs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">::</span><br><span class="line"></span><br><span class="line">    int mount_fs(char *mount_dir, char *backing_file, int timeout_msc)</span><br><span class="line">    &#123;</span><br><span class="line">        static const char fs_name[] = INCFS_NAME;</span><br><span class="line">        char mount_options[512];</span><br><span class="line">        int backing_fd;</span><br><span class="line">        int result;</span><br><span class="line"></span><br><span class="line">        backing_fd = open(backing_file, O_RDWR);</span><br><span class="line">        if (backing_fd == -1) &#123;</span><br><span class="line">            perror(&quot;Error in opening backing file&quot;);</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        snprintf(mount_options, ARRAY_SIZE(mount_options),</span><br><span class="line">            &quot;backing_fd=%u,read_timeout_msc=%u&quot;, backing_fd, timeout_msc);</span><br><span class="line"></span><br><span class="line">        result = mount(fs_name, mount_dir, fs_name, 0, mount_options);</span><br><span class="line">        if (result != 0)</span><br><span class="line">            perror(&quot;Error mounting fs.&quot;);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Open .cmd file</span><br></pre></td></tr></table></figure>

<p>::</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">open_commands_file</span><span class="params">(<span class="type">char</span> *mount_dir)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> cmd_file[<span class="number">255</span>];</span><br><span class="line">    <span class="type">int</span> cmd_fd;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(cmd_file, ARRAY_SIZE(cmd_file), <span class="string">&quot;%s/.cmd&quot;</span>, mount_dir);</span><br><span class="line">    cmd_fd = open(cmd_file, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (cmd_fd &lt; <span class="number">0</span>)</span><br><span class="line">        perror(<span class="string">&quot;Can&#x27;t open commands file&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> cmd_fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Add a file to the file system</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">::</span><br><span class="line"></span><br><span class="line">    int create_file(int cmd_fd, char *filename, int *ino_out, size_t size)</span><br><span class="line">    &#123;</span><br><span class="line">        int ret = 0;</span><br><span class="line">        __u16 ino = 0;</span><br><span class="line">        struct incfs_instruction inst = &#123;</span><br><span class="line">                .version = INCFS_HEADER_VER,</span><br><span class="line">                .type = INCFS_INSTRUCTION_NEW_FILE,</span><br><span class="line">                .file = &#123;</span><br><span class="line">                    .size = size,</span><br><span class="line">                    .mode = S_IFREG | 0555,</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ret = ioctl(cmd_fd, INCFS_IOC_PROCESS_INSTRUCTION, &amp;inst);</span><br><span class="line">        if (ret)</span><br><span class="line">            return -errno;</span><br><span class="line"></span><br><span class="line">        ino = inst.file.ino_out;</span><br><span class="line">        inst = (struct incfs_instruction)&#123;</span><br><span class="line">                .version = INCFS_HEADER_VER,</span><br><span class="line">                .type = INCFS_INSTRUCTION_ADD_DIR_ENTRY,</span><br><span class="line">                .dir_entry = &#123;</span><br><span class="line">                    .dir_ino = INCFS_ROOT_INODE,</span><br><span class="line">                    .child_ino = ino,</span><br><span class="line">                    .name = ptr_to_u64(filename),</span><br><span class="line">                    .name_len = strlen(filename)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        ret = ioctl(cmd_fd, INCFS_IOC_PROCESS_INSTRUCTION, &amp;inst);</span><br><span class="line">        if (ret)</span><br><span class="line">            return -errno;</span><br><span class="line">        *ino_out = ino;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Load data into a file</span><br></pre></td></tr></table></figure>

<p>::</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> cmd_fd = open_commands_file(path_to_mount_dir);</span><br><span class="line"><span class="type">char</span> *data = get_some_data();</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">incfs_new_data_block</span> <span class="title">block</span>;</span></span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">block.file_ino = file_ino;</span><br><span class="line">block.block_index = <span class="number">0</span>;</span><br><span class="line">block.compression = COMPRESSION_NONE;</span><br><span class="line">block.data = (__u64)data;</span><br><span class="line">block.data_len = INCFS_DATA_FILE_BLOCK_SIZE;</span><br><span class="line"></span><br><span class="line">err = write(cmd_fd, &amp;block, <span class="keyword">sizeof</span>(block));</span><br></pre></td></tr></table></figure>

<p>Get an array of pending reads</p>
<p>::</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> poll_res = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">incfs_pending_read_info</span> <span class="title">reads</span>[10];</span></span><br><span class="line"><span class="type">int</span> cmd_fd = open_commands_file(path_to_mount_dir);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span> =</span> &#123;</span><br><span class="line">    .fd = cmd_fd,</span><br><span class="line">    .events = POLLIN</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">poll_res = poll(&amp;pollfd, <span class="number">1</span>, timeout);</span><br><span class="line"><span class="keyword">if</span> (poll_res &gt; <span class="number">0</span> &amp;&amp; (pollfd.revents | POLLIN)) &#123;</span><br><span class="line">    <span class="type">ssize_t</span> read_res = read(cmd_fd, reads, <span class="keyword">sizeof</span>(reads));</span><br><span class="line">    <span class="keyword">if</span> (read_res &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Waiting reads %ld\n&quot;</span>, read_res / <span class="keyword">sizeof</span>(reads[<span class="number">0</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/20200604140901.svg"></p>
<h1 id="Ondisk-format"><a href="#Ondisk-format" class="headerlink" title="Ondisk format"></a>Ondisk format</h1><h2 id="General-principles"><a href="#General-principles" class="headerlink" title="General principles"></a>General principles</h2><ul>
<li><p>The backbone of the incremental-fs ondisk format is an append only linked<br>list of metadata blocks. Each metadata block contains an offset of the next<br>one. These blocks describe files and directories on the<br>file system. They also represent actions of adding and removing file names<br>(hard links).<br>Every time incremental-fs instance is mounted, it reads through this list<br>to recreate filesystem’s state in memory. An offset of the first record in the<br>metadata list is stored in the superblock at the beginning of the backing<br>file.</p>
</li>
<li><p>Most of the backing file is taken by data areas and blockmaps.<br>Since data blocks can be compressed and have different sizes,<br>single per-file data area can’t be pre-allocated. That’s why blockmaps are<br>needed in order to find a location and size of each data block in<br>the backing file. Each time a file is created, a corresponding block map is<br>allocated to store future offsets of data blocks.</p>
<p>Whenever a data block is given by data loader to incremental-fs:</p>
<ul>
<li>A data area with the given block is appended to the end of<br>the backing file.</li>
<li>A record in the blockmap for the given block index is updated to reflect<br>its location, size, and compression algorithm.</li>
</ul>
</li>
</ul>
<h2 id="Important-format-details"><a href="#Important-format-details" class="headerlink" title="Important format details"></a>Important format details</h2><p>Ondisk structures are defined in the <code>format.h</code> file. They are all packed<br>and use little-endian order.<br>A backing file must start with <code>incfs_super_block</code> with <code>s_magic</code> field<br>equal to 0x5346434e49 “INCFS”.</p>
<p>Metadata records:</p>
<ul>
<li><code>incfs_inode</code> - metadat^a record to declare^ a file or a directory.<br>              <code>incfs_inode.i_mode</code> determents if it is a file<br>              or a directory.</li>
<li><code>incfs_blockmap_entry</code> - metadata record that specifies size and location<br>                      of a blockmap area for a given file. This area<br>                      contains an array of <code>incfs_blockmap_entry</code>-s.</li>
<li><code>incfs_dir_action</code> - metadata record that specifies changes made to a<br>              to a directory structure, e.g. add or remove a hardlink.</li>
<li><code>incfs_md_header</code> - header of a metadata record. It’s always a part<br>              of other structures and served purpose of metadata<br>              bookkeeping.</li>
</ul>
<p>Other ondisk structures:</p>
<ul>
<li><code>incfs_super_block</code> - backing file header</li>
<li><code>incfs_blockmap_entry</code> - a record in a blockmap area that describes size<br>                  and location of a data block.</li>
<li>Data blocks dont have any particular structure, they are written to the backing<br>file in a raw form as they come from a data loader.</li>
</ul>
<h2 id="Backing-file-layout"><a href="#Backing-file-layout" class="headerlink" title="Backing file layout"></a>Backing file layout</h2><p>::</p>
<p><img src="/images/20200601211053.png"></p>
<h2 id="Unreferenced-files-and-absence-of-garbage-collection"><a href="#Unreferenced-files-and-absence-of-garbage-collection" class="headerlink" title="Unreferenced files and absence of garbage collection"></a>Unreferenced files and absence of garbage collection</h2><p>Described file format can produce files that don’t have any names for them in<br>any directories. Incremental-fs takes no steps to prevent such situations or<br>reclaim space occupied by such files in the backing file. If garbage collection<br>is needed it has to be implemented as a separate userspace tool.</p>
<h1 id="Design-alternatives"><a href="#Design-alternatives" class="headerlink" title="Design alternatives"></a>Design alternatives</h1><h2 id="Why-isn’t-incremental-fs-implemented-via-FUSE"><a href="#Why-isn’t-incremental-fs-implemented-via-FUSE" class="headerlink" title="Why isn’t incremental-fs implemented via FUSE?"></a>Why isn’t incremental-fs implemented via FUSE?</h2><p>TLDR: FUSE-based filesystems add 20-80% of performance overhead for target<br>scenarios, and increase power use on mobile beyond acceptable limit<br>for widespread deployment. A custom kernel filesystem is the way to overcome<br>these limitations.</p>
<p>From the theoretical side of things, FUSE filesystem adds some overhead to<br>each filesystem operation that?s not handled by OS page cache:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* When an IO request arrives to FUSE driver (D), it puts it into a queue</span><br><span class="line">  that runs on a separate kernel thread</span><br><span class="line">* Then another separate user-mode handler process (H) has to run,</span><br><span class="line">  potentially after a context switch, to read the request from the queue.</span><br><span class="line">  Reading the request adds a kernel-user mode transition to the handling.</span><br><span class="line">* (H) sends the IO request to kernel to handle it on some underlying storage</span><br><span class="line">  filesystem. This adds a user-kernel and kernel-user mode transition</span><br><span class="line">  pair to the handling.</span><br><span class="line">* (H) then responds to the FUSE request via a write(2) call.</span><br><span class="line">  Writing the response is another user-kernel mode transition.</span><br><span class="line">* (D) needs to read the response from (H) when its kernel thread runs</span><br><span class="line">  and forward it to the user</span><br></pre></td></tr></table></figure>

<p>Together, the scenario adds 2 extra user-kernel-user mode transition pairs,<br>and potentially has up to 3 additional context switches for the FUSE kernel<br>thread and the user-mode handler to start running for each IO request on the<br>filesystem.<br>This overhead can vary from unnoticeable to unmanageable, depending on the<br>target scenario. But it will always burn extra power via CPU staying longer<br>in non-idle state, handling context switches and mode transitions.<br>One important goal for the new filesystem is to be able to handle each page<br>read separately on demand, because we don’t want to wait and download more data<br>than absolutely necessary. Thus readahead would need to be disabled completely.<br>This increases the number of separate IO requests and the FUSE related overhead<br>by almost 32x (128KB readahead limit vs 4KB individual block operations)</p>
<p>For more info see a 2017 USENIX research paper:<br>To FUSE or Not to FUSE: Performance of User-Space File Systems<br>Bharath Kumar Reddy Vangoor, Stony Brook University;<br>Vasily Tarasov, IBM Research-Almaden;<br>Erez Zadok, Stony Brook University<br><a target="_blank" rel="noopener" href="https://www.usenix.org/system/files/conference/fast17/fast17-vangoor.pdf">https://www.usenix.org/system/files/conference/fast17/fast17-vangoor.pdf</a></p>
<h1 id="references"><a href="#references" class="headerlink" title="references"></a>references</h1><p><a target="_blank" rel="noopener" href="https://lore.kernel.org/linux-fsdevel/20190502040331.81196-1-ezemtsov@google.com/">https://lore.kernel.org/linux-fsdevel/20190502040331.81196-1-ezemtsov@google.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://lore.kernel.org/linux-fsdevel/20190502040331.81196-2-ezemtsov@google.com/">https://lore.kernel.org/linux-fsdevel/20190502040331.81196-2-ezemtsov@google.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://lore.kernel.org/linux-fsdevel/20190502040331.81196-3-ezemtsov@google.com/">https://lore.kernel.org/linux-fsdevel/20190502040331.81196-3-ezemtsov@google.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://lore.kernel.org/linux-fsdevel/20190502040331.81196-4-ezemtsov@google.com/">https://lore.kernel.org/linux-fsdevel/20190502040331.81196-4-ezemtsov@google.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://lore.kernel.org/linux-fsdevel/20190502040331.81196-5-ezemtsov@google.com/">https://lore.kernel.org/linux-fsdevel/20190502040331.81196-5-ezemtsov@google.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://lore.kernel.org/linux-fsdevel/20190502040331.81196-7-ezemtsov@google.com/">https://lore.kernel.org/linux-fsdevel/20190502040331.81196-7-ezemtsov@google.com/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/23/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><span class="page-number current">24</span><a class="page-number" href="/page/25/">25</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/25/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liguang.zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">269</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">96</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button motion-element"><i class="fa fa-comment"></i>
    Chat
  </a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liguang.zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
