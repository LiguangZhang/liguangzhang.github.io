<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=LXGW WenKai:300,300italic,400,400italic,700,700italic|LXGW WenKai Mono, Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liguangzhang.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":{"valine":{"order":-1}},"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="blog">
<meta property="og:url" content="https://liguangzhang.github.io/page/6/index.html">
<meta property="og:site_name" content="blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="liguang.zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liguangzhang.github.io/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>
<link rel="stylesheet" href="https://npm.elemecdn.com/lxgw-wenkai-screen-webfont/style.css" media="print" onload="this.media='all'" />

  <title>blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2022/10/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/riscv%20imsic%20%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/riscv%20imsic%20%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">riscv imsic 相关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-11 18:15:54" itemprop="dateCreated datePublished" datetime="2022-10-11T18:15:54+08:00">2022-10-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-06 17:10:36" itemprop="dateModified" datetime="2024-05-06T17:10:36+08:00">2024-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">虚拟化</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/10/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/riscv%20imsic%20%E7%9B%B8%E5%85%B3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/10/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/riscv%20imsic%20%E7%9B%B8%E5%85%B3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考文档<br>Documentation&#x2F;devicetree&#x2F;bindings&#x2F;interrupt-controller&#x2F;riscv,imsics.yaml</p>
<h1 id="dts-信息"><a href="#dts-信息" class="headerlink" title="dts 信息"></a>dts 信息</h1><p>ex:<br>提供了两个interrupt file M-mode 和 S-mode的.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">imsic_mlevel: interrupt-controller@<span class="number">24000000</span> &#123;</span><br><span class="line">  compatible = <span class="string">&quot;riscv,qemu-imsics&quot;</span>, <span class="string">&quot;riscv,imsics&quot;</span>;</span><br><span class="line">  interrupts-extended = &lt;&amp;cpu1_intc <span class="number">11</span>&gt;,</span><br><span class="line">                        &lt;&amp;cpu2_intc <span class="number">11</span>&gt;,</span><br><span class="line">                        &lt;&amp;cpu3_intc <span class="number">11</span>&gt;,</span><br><span class="line">                        &lt;&amp;cpu4_intc <span class="number">11</span>&gt;;</span><br><span class="line">  reg = &lt;<span class="number">0x28000000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">  interrupt-controller;</span><br><span class="line">  <span class="meta">#interrupt-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line">  msi-controller;</span><br><span class="line">  riscv,num-ids = &lt;<span class="number">127</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">imsic_slevel: interrupt-controller@<span class="number">28000000</span> &#123;</span><br><span class="line">  compatible = <span class="string">&quot;riscv,qemu-imsics&quot;</span>, <span class="string">&quot;riscv,imsics&quot;</span>;</span><br><span class="line">  interrupts-extended = &lt;&amp;cpu1_intc <span class="number">9</span>&gt;,</span><br><span class="line">                        &lt;&amp;cpu2_intc <span class="number">9</span>&gt;,</span><br><span class="line">                        &lt;&amp;cpu3_intc <span class="number">9</span>&gt;,</span><br><span class="line">                        &lt;&amp;cpu4_intc <span class="number">9</span>&gt;;</span><br><span class="line">  reg = &lt;<span class="number">0x28000000</span> <span class="number">0x2000</span>&gt;, <span class="comment">/* Group0 IMSICs */</span></span><br><span class="line">        &lt;<span class="number">0x29000000</span> <span class="number">0x2000</span>&gt;; <span class="comment">/* Group1 IMSICs */</span></span><br><span class="line">  interrupt-controller;</span><br><span class="line">  <span class="meta">#interrupt-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line">  msi-controller;</span><br><span class="line">  riscv,num-ids = &lt;<span class="number">127</span>&gt;;</span><br><span class="line">  riscv,group-index-bits = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">  riscv,group-index-shift = &lt;<span class="number">24</span>&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>下面对上述dts的相关属性做一个大概的介绍</p>
<ol>
<li>interrupts-extended<br>对应cpu1-4, 每个cpu都有这两个interrupt file M-mode和S-mode的<br>M的对应中断位为11,  代表 Machine external interrupt<br>S的对应中断位为9, 代表 Supervisor external interrupt</li>
<li>riscv,num-ids<br>Number of interrupt identities supported by IMSIC interrupt file.<br>外部中断数量, 反映到eip和eie中, 最小63 最大 2047</li>
<li>riscv,group-index-bits<br>Number of group index bits in the MSI target address. When not specified it is assumed to be 0.<br>总的group index bits</li>
<li>riscv,group-index-shift<br>The least significant bit position of the group index bits in the MSI target address. When not specified it is assumed to be 24.</li>
<li>reg<br>Base address of each IMSIC group.<br>关于MSI target address:<br>从第24 bit 开始, 上述group-index-bits 表示在Group Index中总共有几个bit 被使用<br>riscv,group-index-shift 表示Group Index中当前interrupt file 占位开始的那个bit位, 如其占了两个bit位 26-27, shift表示最开始的bit位 26.</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">XLEN<span class="number">-1</span>           &gt;=<span class="number">24</span>                                 <span class="number">12</span>    <span class="number">0</span></span><br><span class="line">|                  |                                  |     |</span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">|xxxxxx|Group Index|xxxxxxxxxxx|HART Index|Guest Index|  <span class="number">0</span>  |</span><br><span class="line">-------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h2 id="guest-os相关"><a href="#guest-os相关" class="headerlink" title="guest os相关"></a>guest os相关</h2><p>guest external interrupt 相关的dts信息</p>
<ol>
<li>riscv,num-guest-ids<br>Number of interrupt identities are supported by IMSIC guest interrupt<br>file. When not specified it is assumed to be same as specified by the<br>riscv,num-ids property.<br>guest external 硬件中断号 最小63 最大2047</li>
<li>riscv,hart-index-bits<br>Number of HART index bits in the MSI target address. When not<br>specified it is estimated based on the interrupts-extended property.<br>MSI target address 中 Hart Index 总共使用了几个bit位.<br>最小0 最大 15</li>
<li>riscv,guest-index-bits<br>Number of HART index bits in the MSI target address. When not<br>specified it is estimated based on the interrupts-extended property.<br>MSI target address 中 Guest Index 总共使用了几个bit位.<br>最小0 最大 7</li>
</ol>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/10/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/riscv%20imsic%20%E7%9B%B8%E5%85%B3/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2022/10/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/riscv%20%E8%99%9A%E6%8B%9F%E5%8C%96%E4%B8%AD%E6%96%AD%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/riscv%20%E8%99%9A%E6%8B%9F%E5%8C%96%E4%B8%AD%E6%96%AD%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">riscv 虚拟化中断相关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-11 18:15:54" itemprop="dateCreated datePublished" datetime="2022-10-11T18:15:54+08:00">2022-10-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-06 15:53:13" itemprop="dateModified" datetime="2024-05-06T15:53:13+08:00">2024-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">虚拟化</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/10/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/riscv%20%E8%99%9A%E6%8B%9F%E5%8C%96%E4%B8%AD%E6%96%AD%E7%9B%B8%E5%85%B3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/10/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/riscv%20%E8%99%9A%E6%8B%9F%E5%8C%96%E4%B8%AD%E6%96%AD%E7%9B%B8%E5%85%B3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Hypervisor-Status-Register-hstatus"><a href="#Hypervisor-Status-Register-hstatus" class="headerlink" title="Hypervisor Status Register (hstatus)"></a>Hypervisor Status Register (hstatus)</h4><p><img src="https://gitee.com/zhangliguang1/tuchuang/raw/master/img/20221124162340.png"></p>
<p>When VTSR&#x3D;1, an attempt in VS-mode to execute SRET raises a virtual instruction exception.<br>When VTW&#x3D;1 (and assuming <code>mstatus</code>.TW&#x3D;0), an attempt in VS-mode to execute WFI raises a virtual instruction exception if the WFI does not complete within an implementation-specific, bounded time limit.<br>When VTVM&#x3D;1, an attempt in VS-mode to execute SFENCE.VMA or to access CSR <code>satp</code> raises a virtual instruction exception.</p>
<p>The VGEIN (Virtual Guest External Interrupt Number) field selects a guest external interrupt source for VS-level external interrupts. VGEIN is a <strong>WLRL</strong> field that must be able to hold values between zero and the maximum guest external interrupt number (known as GEILEN), inclusive.<br>When VGEIN&#x3D;0, no guest external interrupt source is selected for VS-level external interrupts. GEILEN may be zero, in which case VGEIN may be hardwired to zero.<br>Guest external interrupts are explained in Section <a target="_blank" rel="noopener" href="https://five-embeddev.com/riscv-isa-manual/latest/hypervisor.html#sec:hgeinterruptregs">1.2.4</a>, and the use of VGEIN is covered further in Section <a target="_blank" rel="noopener" href="https://five-embeddev.com/riscv-isa-manual/latest/hypervisor.html#sec:hinterruptregs">1.2.3</a>.</p>
<p>Field HU (Hypervisor User mode) controls whether the virtual-machine load&#x2F;store instructions, HLV, HLVX, and HSV, can be used also in U-mode. When HU&#x3D;1, these instructions can be executed in U-mode the same as in HS-mode. When HU&#x3D;0, all hypervisor instructions cause an illegal instruction trap in U-mode.</p>
<h4 id="hip-hie"><a href="#hip-hie" class="headerlink" title="hip &amp; hie"></a>hip &amp; hie</h4><p>Registers <code>hip</code> and <code>hie</code> are HSXLEN-bit read&#x2F;write registers that supplement HS-level’s <code>sip</code> and <code>sie</code> respectively. The <code>hip</code> register indicates pending VS-level and hypervisor-specific interrupts, while <code>hie</code> contains enable bits for the same interrupts. As with <code>sip</code> and <code>sie</code>, an interrupt <em>i</em> will be taken in HS-mode if bit <em>i</em> is set in both <code>hip</code> and <code>hie</code>, and if supervisor-level interrupts are globally enabled.</p>
<p><img src="https://gitee.com/zhangliguang1/tuchuang/raw/master/img/20221124162341.png"></p>
<p>Bits <code>hip</code>.SGEIP and <code>hie</code>.SGEIE are the interrupt-pending and interrupt-enable bits for guest external interrupts at supervisor level (HS-level).<br>SGEIP is read-only in <code>hip</code>, and is 1 if and only if the bitwise logical-AND of CSRs <code>hgeip</code> and <code>hgeie</code> is nonzero in any bit.</p>
<p>Bits <code>hip</code>.VSEIP and <code>hie</code>.VSEIE are the interrupt-pending and interrupt-enable bits for VS-level external interrupts. VSEIP is read-only in <code>hip</code>, and is the logical-OR of these interrupt sources:</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/10/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/%E8%99%9A%E6%8B%9F%E5%8C%96/riscv%20%E8%99%9A%E6%8B%9F%E5%8C%96%E4%B8%AD%E6%96%AD%E7%9B%B8%E5%85%B3/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/linux%20mmu%20pte%20%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/linux%20mmu%20pte%20%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">linux mmu pte 相关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-11 18:15:54" itemprop="dateCreated datePublished" datetime="2022-09-11T18:15:54+08:00">2022-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-06 14:13:56" itemprop="dateModified" datetime="2024-05-06T14:13:56+08:00">2024-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/linux%20mmu%20pte%20%E7%9B%B8%E5%85%B3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/linux%20mmu%20pte%20%E7%9B%B8%E5%85%B3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h1><p>kmalloc， vmalloc malloc</p>
<h2 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h2><p>基于 slab 分配器。 slab 缓存在一个连续物理地址的大块内存上。所以其缓存对象也是物理地址连续的。</p>
<h2 id="vmalloc"><a href="#vmalloc" class="headerlink" title="vmalloc"></a>vmalloc</h2><p>仅能保证虚拟地址连续</p>
<h3 id="vmalloc-地址范围"><a href="#vmalloc-地址范围" class="headerlink" title="vmalloc 地址范围"></a>vmalloc 地址范围</h3><p>VMALLOC_START<br>VMALLOC_END</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[    0.000000] Virtual kernel memory layout:</span><br><span class="line">[    0.000000]       fixmap : 0xff1bfffffea00000 - 0xff1bffffff000000   (6144 kB)</span><br><span class="line">[    0.000000]       pci io : 0xff1bffffff000000 - 0xff1c000000000000   (  16 MB)</span><br><span class="line">[    0.000000]      vmemmap : 0xff1c000000000000 - 0xff20000000000000   (1024 TB)</span><br><span class="line">[    0.000000]      vmalloc : 0xff20000000000000 - 0xff60000000000000   (16384 TB)   #vmalloc_start - vmalloc_endl</span><br><span class="line">[    0.000000]      modules : 0xffffffff01576000 - 0xffffffff80000000   (2026 MB)</span><br><span class="line">[    0.000000]       lowmem : 0xff60000000000000 - 0xff600000c0000000   (3072 MB)</span><br><span class="line">[    0.000000]       kernel : 0xffffffff80000000 - 0xffffffffffffffff   (2047 MB)</span><br></pre></td></tr></table></figure>

<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">-+ vmalloc<span class="params">(unsigned long size)</span></span><br><span class="line"> \ -+ __vmalloc_node<span class="params">(size, align:<span class="number">1</span>, GFP_KERNEL)</span></span><br><span class="line">    \ -+ __vmalloc_node_range<span class="params">(size, align, VMALLOC_START, VMALLOC_END,...)</span></span><br><span class="line">       \ -+ area = __get_vm_area_node<span class="params">(real_size, align, shift, VM_ALLOC | VM_UNINITIALIZED | vm_flags, start, end, node,</span></span><br><span class="line"><span class="params">          \ -  struct vm_struct *area = kzalloc_node(sizeof(*area), gfp_mask &amp; GFP_RECLAIM_MASK, node);</span></span><br><span class="line"><span class="params">          | -+ struct vmap_area *va = alloc_vmap_area(size, align, start, end, node, gfp_mask, <span class="number">0</span>); <span class="string">&quot;在 vmalloc 整个空间中查找一块合适的没有使用的空间 hole&quot;</span></span></span><br><span class="line"><span class="params">                         <span class="string">&quot;查找的地址从 VMALLOC_START 开始， 首先从 vmap_area_root 红黑数上查找， 该树上存放着正在使用的 vmalloc 区块”</span></span></span><br><span class="line"><span class="string"><span class="params">                         “从 VMALOC_START 开始， 查找每个存在的vmalloc 区块的hole能够容纳目前要分配的大小。 如果找到了合适的hole， </span></span></span><br><span class="line"><span class="string"><span class="params">                         调用 __insert_vmap_area 把这个 hole 注册到该红黑树中， 如果没找到hole， 则从最后一个 vmalloc 区块的结束地址开始一个新的 vmalloc 区块&quot;</span></span></span><br><span class="line"><span class="params">          | -+ setup_vmalloc_vm(area, va, flags, caller); <span class="string">&quot;将该找到的 va 填充到 vm area 中&quot;</span>  </span></span><br><span class="line"><span class="params">          | -+ __vmalloc_area_node(area, gfp_mask, prot, shift, node);</span></span><br><span class="line"><span class="params">             \ -  area-&gt;pages = kmalloc_node(array_size, nested_gfp, node); <span class="string">&quot;分配 area-&gt;pages 二维数组指针&quot;</span></span></span><br><span class="line"><span class="params">             | -  area-&gt;nr_pages = vm_area_alloc_pages(gfp_mask | __GFP_NOWARN, node, page_order, nr_small_pages, area-&gt;pages); </span></span><br><span class="line"><span class="params">                      <span class="string">&quot;使用 alloc_page 分配物理页面， 并使用 area-&gt;pages 保存这些 page的指针&quot;</span></span></span><br><span class="line"><span class="params">             | -+ vmap_pages_range(addr, addr + size, prot, area-&gt;pages, page_shift);  <span class="string">&quot;建立页面映射&quot;</span></span></span><br><span class="line"><span class="params">                \ -+ vmap_pages_range_noflush(addr, end, prot, pages, page_shift);</span></span><br><span class="line"><span class="params">                   \ -+ __vmap_pages_range_noflush(addr, end, prot, pages, page_shift);</span></span><br><span class="line"><span class="params">                      \ -+ for i in npages:</span></span><br><span class="line"><span class="params">                         \ -+ vmap_range_noflush(addr, addr + (<span class="number">1</span>UL &lt;&lt; page_shift), 	page_to_phys(pages[i]), prot, page_shift)</span>; &quot;为每个 pte 建立映射&quot;</span><br><span class="line">                                          &quot;pgd-&gt; p4d -&gt; pud -&gt; pmd -&gt; pte&quot;</span><br><span class="line">                            \ -  pgd = pgd_offset_k<span class="params">(addr)</span>; &quot;从 init_mm 中获取 指向 pgd 页面目录项的基址, 然后通过addr 找到对应的pgd 表项&quot;             </span><br><span class="line">                | -+ flush_cache_vmap<span class="params">(addr, end)</span>;   &quot;按地址 刷新tlb&quot;</span><br><span class="line">                   \ -+ flush_tlb_kernel_range<span class="params">(start, end)</span></span><br><span class="line">                      \ -+ __flush_tlb_range<span class="params">(struct mm_struct *mm, unsigned long start, unsigned long size, unsigned long stride)</span></span><br><span class="line">                         \ -  &quot;sfence.vma ...<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/linux%20mmu%20pte%20%E7%9B%B8%E5%85%B3/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/u-boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/u-boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">u-boot启动流程分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-11 18:15:54" itemprop="dateCreated datePublished" datetime="2022-09-11T18:15:54+08:00">2022-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-06 14:14:40" itemprop="dateModified" datetime="2024-05-06T14:14:40+08:00">2024-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/u-boot/" itemprop="url" rel="index"><span itemprop="name">u-boot</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/u-boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/u-boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="RISCV-start-S-uboot-初始化总体框架解析"><a href="#RISCV-start-S-uboot-初始化总体框架解析" class="headerlink" title="RISCV start.S uboot 初始化总体框架解析"></a>RISCV start.S uboot 初始化总体框架解析</h1><p>u-boot 运行在S-mode下</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">+ _start:</span><br><span class="line"> \-- mv tp, a0 <span class="string">&quot;tp register save hartid&quot;</span></span><br><span class="line"> |-- csrw   MODE_PREFIX(tvec), t0 <span class="string">&quot;设置中断stvec 入口为 trap_entry&quot;</span></span><br><span class="line"> |-- li t0, SIE_SSIE</span><br><span class="line"> |-- csrs   MODE_PREFIX(ie), t0 <span class="string">&quot;设置sie 协处理器, 打开中断, 用来处理ipi 中断&quot;</span></span><br><span class="line"> |-+ call_board_init_f <span class="string">&quot;Set sp in internal/ex RAM to call board_init_f&quot;</span></span><br><span class="line">   \ -- li t1, CONFIG_SYS_INIT_SP_ADDR <span class="string">&quot;设置初始栈基址&quot;</span></span><br><span class="line">   | -- li t0, -<span class="number">16</span></span><br><span class="line">   | -- <span class="keyword">and</span>    sp, t1, t0   <span class="string">&quot;将堆栈16 bits对齐&quot;</span></span><br><span class="line"> |-+ call_board_init_f_0 <span class="string">&quot;从堆栈开始的地方，为u-boot的global data（struct global_data）分配空间&quot;</span></span><br><span class="line">   \ -- mv a0, sp</span><br><span class="line">   | -+ jal board_init_f_alloc_reserve</span><br><span class="line">      \ - top -= CONFIG_VAL(SYS_MALLOC_F_LEN) <span class="string">&quot;如定义了CONFIG_SYS_MALLOC_F_LEN，需预留出early malloc所需的空间&quot;</span></span><br><span class="line">   | -- slli t0, tp, CONFIG_STACK_SIZE_SHIFT <span class="string">&quot;tp代表的是hartid, 每个hart 分配STACK_SIZE 空间&quot;</span></span><br><span class="line">   | -- sub sp, a0, t0 <span class="string">&quot;sp = a0 - t0, 地址在初始栈基址上向上增长, a0 初始栈基址 top - malloc空间&quot;</span></span><br><span class="line">   | -- bnez   tp, secondary_hart_loop <span class="string">&quot;其他hart 跳转到 secondary_hart_loop, hart 0 继续&quot;</span></span><br><span class="line">   | -+ jal board_init_f_init_reserve <span class="string">&quot;初始化uboot的global data, 置0&quot;</span></span><br><span class="line">      \ -- <span class="string">&quot;如定义了SYS_MALLOC_F_LEN，则会初始化gd-&gt;malloc_base&quot;</span></span><br><span class="line">   | -- jal icache_enable</span><br><span class="line">   | -- jal dcache_enable</span><br><span class="line">   | -+ jalr -&gt; board_init_f <span class="string">&quot;调用board_init_f接口，执行前置的初始化操作&quot;</span> common/board_f.c</span><br><span class="line">      \ -+ initcall_run_list(init_sequence_f) <span class="string">&quot;执行init_sequence_f&quot;</span> 里的一系列初始化函数</span><br><span class="line">         \ -+ init_sequence_f</span><br><span class="line">            \ -- initf_malloc</span><br><span class="line">            | -- arch_cpu_init</span><br><span class="line">            | -- arch_cpu_init_dm</span><br><span class="line">            | -- timer_init</span><br><span class="line">            | -- env_init</span><br><span class="line">            | -- console_init_f</span><br><span class="line">            | -- print_cpuinfo</span><br><span class="line">            | -- dram_init</span><br><span class="line">            | -- ..</span><br><span class="line">            | -- reloc_fdt</span><br><span class="line">            | -- reloc_bootstage</span><br><span class="line">            | -- setup_reloc</span><br><span class="line">            | -+ jump_to_copy</span><br><span class="line">               \ -+ relocate_code(gd-&gt;start_addr_sp, gd-&gt;new_gd, gd-&gt;relocaddr) <span class="string">&quot;开始进行主核relocate&quot;</span></span><br><span class="line">                  \ -- mv s2, a0          /* save addr_sp */</span><br><span class="line">                  | -- mv s3, a1          /* save addr <span class="keyword">of</span> gd */</span><br><span class="line">                  | -- mv s4, a2          /* save addr <span class="keyword">of</span> destination */</span><br><span class="line">                  | -+ stack_setup</span><br><span class="line">                     \ -- slli   t0, tp, CONFIG_STACK_SIZE_SHIFT</span><br><span class="line">                     | -- sub    sp, s2, t0 <span class="string">&quot;gd-&gt;start_addr_sp - offset(of hartid)&quot;</span> </span><br><span class="line">                                 设置新的sp, 这个sp 是reloc 后的sp <span class="string">&quot;gd-&gt;start_addr_sp = gd-&gt;relocaddr;&quot;</span></span><br><span class="line">                     | -- clear_bss clbss_l  <span class="string">&quot;将__bss_start到__bss_end&quot;</span> 之间reloc 到 ram上的bss 区段清<span class="number">0</span>           </span><br><span class="line">                     | -- copy_loop <span class="string">&quot;reloc 将_start到_bss_start之间的代码段拷贝到 relocaddr处&quot;</span></span><br><span class="line">                  | -+ fix_rela_dyn <span class="string">&quot;Update dynamic relocations after board_init_f&quot;</span></span><br><span class="line">                  | -+ relocate_secondary_harts</span><br><span class="line">                     \ -- la  t0, secondary_hart_relocate</span><br><span class="line">                     | -- add a0, t0, t6 <span class="string">&quot;到reloc 地址上执行secondary_hart_relocate&quot;</span> </span><br><span class="line">                           a0 为 secondary_hart_relocate</span><br><span class="line">                     | -- mv a1, s2 <span class="string">&quot;s2 为 addr_sp&quot;</span></span><br><span class="line">                     | -- mv a2, s3 <span class="string">&quot;s3 为 gd 指针&quot;</span></span><br><span class="line">                     | -+ jal    smp_call_function</span><br><span class="line">                        \ -+ send_ipi_many(&amp;ipi); <span class="string">&quot;发送ipi中断&quot;</span>, 前面传的三个参数保存在 gd-&gt;arch.ipi 中</span><br><span class="line">                           \ -+ riscv_send_ipi(reg) <span class="string">&quot;reg为从uboot fdt中查到的所有的hart&quot;</span></span><br><span class="line">                              \ -- SBI_CALL_1(SBI_SEND_IPI, hart_mask); </span><br><span class="line">                                   <span class="string">&quot;调用opensbi的函数, 给指定的hart发送ipi中断&quot;</span></span><br><span class="line">               -----------------------------ipi中断, 跳入其他核----------------------------------------------                    </span><br><span class="line">                           | -+ secondary_hart_loop <span class="string">&quot;其他hart处在secondary_hart_loop 处调了 wfi 等待&quot;</span></span><br><span class="line">                              \ -- csrr   t0, MODE_PREFIX(ip) <span class="string">&quot;读sip&quot;</span></span><br><span class="line">                              | -- andi   t0, t0, SIE_SSIE</span><br><span class="line">                              | -- mv a0, tp <span class="string">&quot;hartid 为第一个参数&quot;</span></span><br><span class="line">                              | -+ jal handle_ipi <span class="string">&quot;如果来了software 中断, 即会跳到 handle_ipi 处理, 否则继续 secondary_hart_loop&quot;</span></span><br><span class="line">                                 \-+ handle_ipi(hartid) <span class="string">&quot;对应的hart 收到ipi 中断&quot;</span></span><br><span class="line">                                   \ -- riscv_clear_ipi(hart); <span class="string">&quot;会导致 mip.SSIP = sip.SSIP 清0&quot;</span></span><br><span class="line">                                   | -- invalidate_icache_all(); </span><br><span class="line">                                   | -- smp_function = gd-&gt;arch.ipi[hart].addr;</span><br><span class="line">                                      <span class="string">&quot;此处为传递的第一个参数, secondary_hart_relocate&quot;</span></span><br><span class="line">                                   | -+ smp_function(hart, gd-&gt;arch.ipi[hart].arg0, gd-&gt;arch.ipi[hart].arg1);</span><br><span class="line">                                      \ -+ secondary_hart_relocate   </span><br><span class="line">                                         \ -- slli   t0, tp, CONFIG_STACK_SIZE_SHIFT </span><br><span class="line">                                         | -- sub    sp, a1, t0 <span class="string">&quot;a1 为 new_sp, new_sp - offset(of hartid)&quot;</span></span><br><span class="line">                                         | -- mv gp, a2 <span class="string">&quot;更新gd指针到gp寄存器&quot;</span></span><br><span class="line">                                         | -- secondary_hart_loop wfi </span><br><span class="line">                                             <span class="string">&quot;其他核响应完ipi后, 只更新了sp和gp, 然后继续挂起等待&quot;</span></span><br><span class="line">      ---------------------------------回主核-------------------------------------------------</span><br><span class="line">            | -+ call_board_init_r</span><br><span class="line">               \ -- jal invalidate_icache_all</span><br><span class="line">               | -- jal flush_dcache_all</span><br><span class="line">               | -- mv  a0, s3          /* gd_t */</span><br><span class="line">               | -- mv  a1, s4          /* dest_addr */</span><br><span class="line">               | -+ jalr -&gt; board_init_r <span class="string">&quot;跳转到reloc board_init_r执行&quot;</span></span><br><span class="line">                  \ -+ initcall_run_list(init_sequence_r)</span><br><span class="line">                     \ -+ init_sequence_r</span><br><span class="line">                        \ -- initr_reloc_global_data</span><br><span class="line">                        | -- initr_barrier</span><br><span class="line">                        | -- bootstage_relocate</span><br><span class="line">                        | -- board_init</span><br><span class="line">                        | -- arch_early_init_r</span><br><span class="line">                        | -- initr_secondary_cpu</span><br><span class="line">                        | -- interrupt_init</span><br><span class="line">                        | -- board_late_init <span class="string">&quot;board 相关修改&quot;</span></span><br><span class="line">                        | -+ run_main_loop <span class="string">&quot;loop 等待接收输入的命令&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>上述过程中, riscv_send_ipi 发送ipi 中断给其他核, 其他核是在M-mode 的opensbi 下处理的ipi中断, 处理时会调用sbi_ipi_process_smode 函数将 MIP.SSIP 置位, 因为开启了mideleg的 MIP_SSIP 位, 会导致sip.SSIP 也会被置位. 返回给uboot后, 从核在secondary_hart_loop 中loop, 判断sip.SSIP &amp; sie.SSIE, 这个时候都置位了, 从核跳出secondary_hart_loop, 执行后面的handle_ipi 函数</p>
</blockquote>
<h1 id="u-boot-设计规范"><a href="#u-boot-设计规范" class="headerlink" title="u-boot 设计规范"></a>u-boot 设计规范</h1><p>u-boot是一个bootloader，有些情况下，它可能位于系统的只读存储器（ROM或者flash）中，并从那里开始执行。<br>因此，这种情况下，在u-boot执行的前期（在将自己copy到可读写的存储器之前），它所在的存储空间，是不可写的，这会有两个问题：</p>
<ol>
<li>堆栈无法使用，无法执行函数调用，也即C环境不可用。</li>
<li>没有data段（或者正确初始化的data段）可用，不同函数或者代码之间，无法通过全局变量的形式共享数据。<br>对于问题1，通常的解决方案是：<br>u-boot运行起来之后，在那些<code>不需要执行任何初始化动作</code>即可使用的、可读写的存储区域，开辟一段堆栈（stack）空间。<br>一般来说，大部分的平台，都有自己的SRAM，可用作堆栈空间。如果实在不行，也有可借用CPU的data cache的方法（不再过多说明）。</li>
</ol>
<p>对于问题2，解决方案要稍微复杂一些：<br>首先，对于开发者来说，在u-boot被拷贝到可读写的RAM（这个动作称作relocation）之前，永远不要使用全局变量。<br>其次，在relocation之前，不同模块之间，确实有通过全局变量的形式传递数据的需求。怎么办？这就是global data需要解决的事情。</p>
<p>为了在relocation前通过全局变量的形式传递数据，u-boot设计了一个巧妙的方法：</p>
<ol>
<li><p>定义一个struct global_data类型的数据结构，里面保存了各色各样需要传递的数据</p>
</li>
<li><p>堆栈配置好之后，在堆栈开始的位置，为struct global_data预留空间（可参考后面的说明)，并将开始地址（就是一个struct global_data指针）保存在一个寄存器中，后续的传递，都是通过保存在寄存器中的指针实现</p>
<blockquote>
<p>board_init_f_alloc_reserve 的返回值（a0）就是global data的指针</p>
</blockquote>
</li>
</ol>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/u-boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/uboot%20%E8%BF%90%E8%A1%8C%20baremental%20bin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/uboot%20%E8%BF%90%E8%A1%8C%20baremental%20bin/" class="post-title-link" itemprop="url">uboot 运行 baremental bin</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-11 18:15:54" itemprop="dateCreated datePublished" datetime="2022-09-11T18:15:54+08:00">2022-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-06 14:14:52" itemprop="dateModified" datetime="2024-05-06T14:14:52+08:00">2024-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/u-boot/" itemprop="url" rel="index"><span itemprop="name">u-boot</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/uboot%20%E8%BF%90%E8%A1%8C%20baremental%20bin/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/uboot%20%E8%BF%90%E8%A1%8C%20baremental%20bin/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>注意: 下面的操作步骤, 开发板不要插 sd 卡</p>
</blockquote>
<h1 id="配置tftpd"><a href="#配置tftpd" class="headerlink" title="配置tftpd"></a>配置tftpd</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install tftpd-hpa</span><br><span class="line">sudo vi /etc/default/tftpd-hpa   #编辑 /etc/default/tftpd-hpa</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/default/tftpd-hpa</span></span><br><span class="line"></span><br><span class="line">TFTP_USERNAME=&quot;tftp&quot;</span><br><span class="line">TFTP_DIRECTORY=&quot;/srv/tftp&quot;</span><br><span class="line">TFTP_ADDRESS=&quot;:69&quot;</span><br><span class="line">TFTP_OPTIONS=&quot;-s&quot;</span><br><span class="line"></span><br><span class="line">sudo chmod 777 -R /srv/tftp</span><br></pre></td></tr></table></figure>
<p>配置完后, tftp 使用的目录为 <code>/srv/tftp</code></p>
<p>下载  <a target="_blank" rel="noopener" href="https://cloud.hexintek.com:10003/d/f/731200443442580601">https://cloud.hexintek.com:10003/d/f/731200443442580601</a> visionfive2_fw_payload.img 拷贝到该文件夹中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp visionfive2_fw_payload.img /srv/tftp</span><br></pre></td></tr></table></figure>

<p>本机测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tftp localhost</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">get visionfive2_fw_payload.img</span></span><br></pre></td></tr></table></figure>

<p>无错误代表没问题</p>
<h1 id="配置toolchain"><a href="#配置toolchain" class="headerlink" title="配置toolchain"></a>配置toolchain</h1>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/09/11/hxd%20new/riscv%E8%B0%83%E7%A0%94/uboot%20%E8%BF%90%E8%A1%8C%20baremental%20bin/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2022/07/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/%E6%9C%AC%E5%9C%B0git%20%E5%85%B3%E8%81%94remote%20%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9git%20%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/%E6%9C%AC%E5%9C%B0git%20%E5%85%B3%E8%81%94remote%20%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9git%20%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">git remote 批量修改</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-20 10:00:01" itemprop="dateCreated datePublished" datetime="2022-07-20T10:00:01+08:00">2022-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-15 18:53:08" itemprop="dateModified" datetime="2024-04-15T18:53:08+08:00">2024-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/07/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/%E6%9C%AC%E5%9C%B0git%20%E5%85%B3%E8%81%94remote%20%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9git%20%E8%AE%B0%E5%BD%95/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/07/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/%E6%9C%AC%E5%9C%B0git%20%E5%85%B3%E8%81%94remote%20%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9git%20%E8%AE%B0%E5%BD%95/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本地仓库<br>git init<br>git add …<br>git commit</p>
<p>git branch</p>
<h2 id="关联远程分支"><a href="#关联远程分支" class="headerlink" title="关联远程分支"></a>关联远程分支</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin &quot;ssh://liguang.zhang@web.hexintek.com:29418/android/library/crypto-proxy&quot;</span><br></pre></td></tr></table></figure>

<h2 id="远程分支与本地分支合并"><a href="#远程分支与本地分支合并" class="headerlink" title="远程分支与本地分支合并"></a>远程分支与本地分支合并</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull --rebase origin master</span><br></pre></td></tr></table></figure>

<h2 id="批量修改远程提交"><a href="#批量修改远程提交" class="headerlink" title="批量修改远程提交"></a>批量修改远程提交</h2><p>批量修改本地未上库的提交</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase -i origin/master</span><br></pre></td></tr></table></figure>
<p>需要将每一笔提交改为 edit 状态</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/07/20/%E5%B7%A5%E4%BD%9C%E7%9B%B8%E5%85%B3/%E6%9C%AC%E5%9C%B0git%20%E5%85%B3%E8%81%94remote%20%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9git%20%E8%AE%B0%E5%BD%95/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2022/07/12/TEE/linux%20cryptoapi%20%E9%80%82%E9%85%8D%E5%8F%82%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/12/TEE/linux%20cryptoapi%20%E9%80%82%E9%85%8D%E5%8F%82%E8%80%83/" class="post-title-link" itemprop="url">linux cryptoapi 适配</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-12 18:15:54" itemprop="dateCreated datePublished" datetime="2022-07-12T18:15:54+08:00">2022-07-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-06 14:19:28" itemprop="dateModified" datetime="2024-05-06T14:19:28+08:00">2024-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/07/12/TEE/linux%20cryptoapi%20%E9%80%82%E9%85%8D%E5%8F%82%E8%80%83/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/07/12/TEE/linux%20cryptoapi%20%E9%80%82%E9%85%8D%E5%8F%82%E8%80%83/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>主要介绍怎样将crypto hardware accelerate 移植到 linux crypto api中<br>参考项主要是 stm32的实现</p>
<h1 id="crypto中移植aes-引擎"><a href="#crypto中移植aes-引擎" class="headerlink" title="crypto中移植aes 引擎"></a>crypto中移植aes 引擎</h1><p>linux中 hardware ip 是以驱动的方式加载到kernel中的<br>先看一下驱动的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">stm32_dt_ids</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;st,stm32f756-cryp&quot;</span>, .data = &amp;f7_data&#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;st,stm32mp1-cryp&quot;</span>, .data = &amp;mp1_data&#125;,</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">stm32_cryp_driver</span> =</span> &#123;</span><br><span class="line">    .probe  = stm32_cryp_probe,</span><br><span class="line">    .remove = stm32_cryp_remove,</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name           = DRIVER_NAME,</span><br><span class="line">        .pm     = &amp;stm32_cryp_pm_ops,</span><br><span class="line">        .of_match_table = stm32_dt_ids,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>stm32的加密引擎是作为platform driver.</p>
<p><img src="/../OTA%E7%9B%B8%E5%85%B3/%E5%8A%A0%E5%AF%86%E6%96%B9%E6%A1%88%E6%95%B4%E7%90%86.md#%5E39c29c"><br><img src="/../OTA%E7%9B%B8%E5%85%B3/%E5%8A%A0%E5%AF%86%E6%96%B9%E6%A1%88%E6%95%B4%E7%90%86.md#%5Ea36448"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span>	crypto@<span class="number">50060000</span> &#123;</span><br><span class="line"><span class="number">14</span>		compatible = <span class="string">&quot;st,stm32f756-cryp&quot;</span>;</span><br><span class="line"><span class="number">15</span>		reg = &lt;<span class="number">0x50060000</span> <span class="number">0x400</span>&gt;;</span><br><span class="line"><span class="number">16</span>		interrupts = &lt;<span class="number">79</span>&gt;;</span><br><span class="line"><span class="number">17</span>		clocks = &lt;&amp;rcc <span class="number">0</span> STM32F7_AHB2_CLOCK(CRYP)&gt;;</span><br><span class="line"><span class="number">18</span>		resets = &lt;&amp;rcc STM32F7_AHB2_RESET(CRYP)&gt;;</span><br><span class="line"><span class="number">19</span>	&#125;;</span><br></pre></td></tr></table></figure>

<p>通过<code>platform_driver_register</code> 或者 <code>module_init</code> 注册驱动时, 会将driver 和设备绑定, 自动回调probe接口<br>一个driver可以同多个设备绑定, 每次绑定都会回调probe接口.</p>
<p>寻找设备的过程, 一般就是在device tree 中通过 of_match_table 寻找匹配的设备的过程. 匹配到后, 根据device tree中的设备信息初始化 driver中dev相关的结构体信息</p>
<h2 id="probe-注册过程"><a href="#probe-注册过程" class="headerlink" title="probe 注册过程"></a>probe 注册过程</h2>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/07/12/TEE/linux%20cryptoapi%20%E9%80%82%E9%85%8D%E5%8F%82%E8%80%83/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2022/04/25/TEE/sifive%20shield/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/25/TEE/sifive%20shield/" class="post-title-link" itemprop="url">riscv sifive world guard</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-25 18:15:54" itemprop="dateCreated datePublished" datetime="2022-04-25T18:15:54+08:00">2022-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-16 15:47:55" itemprop="dateModified" datetime="2024-04-16T15:47:55+08:00">2024-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/04/25/TEE/sifive%20shield/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/04/25/TEE/sifive%20shield/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="The-SiFive-WorldGuard-WhitePaper"><a href="#The-SiFive-WorldGuard-WhitePaper" class="headerlink" title="The SiFive WorldGuard WhitePaper"></a>The SiFive WorldGuard WhitePaper</h1><p>SiFive® Shield是一个开放的安全平台架构，包括一个安全启动、加密引擎和一个名为<code>SiFive WorldGuard</code>的硬件隔离多域解决方案。它为硬件提供了保证在同一单核或多核平台上运行并访问共享资源（如内存和外设）的不同软件应用程序之间进行隔离的手段。 该解决方案适用于任何SiFive Core IP产品和任何软件架构。它与RISC-V ISA完全兼容，不需要对其进行任何修改。</p>
<p>SiFive WorldGuard提供了核心驱动和进程驱动的模式以实现多域安全性，从而为内核、缓存、互连、外围设备和内存提供数据保护</p>
<p>在SoC内部，WID标记从内核扩展到了高速缓存、互连、外围设备、总线主控器、DMA区域和存储器, 在高性能多核系统中，应用程序或OS环境都可以被隔离和保护。对于更为普遍的单核嵌入式系统，例如，使用PID驱动的运算WID来保护和隔离用户模式和机器模式之间的执行。</p>
<p>SiFive Shield解决方案创建 “world”，聚集运行在内核和其他主控资源（如DMA通道）以及从属资源（如存储器和外设）上的应用程序。”world”的数量是硬件可配置的，取决于内核和主控器的数量、内存配置和软件架构。</p>
<p>这个解决方案并没有取代RISC-V内核的PMP机制（适用于单一内核的内存），而是将其扩展到多内核、多软件系统与其他主控器。</p>
<p>具体SiFive Shield 架构的介绍可参考 <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1D7411A7rr/">SiFive Shield开放安全平台架构</a>, 下面主要介绍的是sifive world guard 方案.</p>
<h2 id="pmp-方案"><a href="#pmp-方案" class="headerlink" title="pmp 方案"></a>pmp 方案</h2><p>由于有了特权模式管理和PMP，在RISC-V内核上可以很容易地开发出安全软件隔离的产品。基于这些硬件机制和SiFive提供的附加机制，可以为各种平台开发解决方案。</p>
<img src="images/image-20211202104658906.png" alt="image-20211202104658906" style="zoom:150%;">
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/25/TEE/sifive%20shield/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2022/04/20/hxd%20new/%E6%B1%BD%E8%BD%A6%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3/HSM%20%E7%9B%B8%E5%85%B3%E6%8E%A2%E8%AE%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/20/hxd%20new/%E6%B1%BD%E8%BD%A6%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3/HSM%20%E7%9B%B8%E5%85%B3%E6%8E%A2%E8%AE%A8/" class="post-title-link" itemprop="url">HSM 相关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-20 18:15:54" itemprop="dateCreated datePublished" datetime="2022-04-20T18:15:54+08:00">2022-04-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-16 10:48:37" itemprop="dateModified" datetime="2024-04-16T10:48:37+08:00">2024-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/04/20/hxd%20new/%E6%B1%BD%E8%BD%A6%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3/HSM%20%E7%9B%B8%E5%85%B3%E6%8E%A2%E8%AE%A8/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/04/20/hxd%20new/%E6%B1%BD%E8%BD%A6%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3/HSM%20%E7%9B%B8%E5%85%B3%E6%8E%A2%E8%AE%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HSM-作用"><a href="#HSM-作用" class="headerlink" title="HSM 作用"></a>HSM 作用</h1><p><img src="https://pic4.zhimg.com/v2-cc6c609c713dab25d187489a6a436cdf_r.jpg" alt="full hsm"></p>
<p>包含两个部分:</p>
<ol>
<li>Security building blocks负责加密&#x2F;解密的硬件操作；</li>
<li>Logical building blocks负责与Application ECU交互数据以及软件的加密&#x2F;解密操作；</li>
</ol>
<p>HSM 最重要的作用是安全边界, 和trustzone的机制类似, 提供安全的物理隔离能力, 安全rom和安全ram 无法被外部cpu 访问, 即使外部cpu 环境被破解, 也能保证hsm 运行的内容无法被探知. 当前的hsm产品中大多是过了FIPS 140-2 level3 标准的.</p>
<p><img src="https://cdn.jsdelivr.net/gh/LiguangZhang/tuchuang1@main/images/20220630170646.png"></p>
<p>密钥存储&#x2F;派生&#x2F;权限管控&#x2F;交换机制处于hsm内部(授信环境), 密钥存于安全rom或安全ram中, 无法被外部拿到.</p>
<h1 id="与-只有硬件安全ip-加-otp-方案的对比"><a href="#与-只有硬件安全ip-加-otp-方案的对比" class="headerlink" title="与 只有硬件安全ip 加 otp 方案的对比"></a>与 只有硬件安全ip 加 otp 方案的对比</h1><ol>
<li>该方案密钥即使可以通过otp 管控密钥无法被外界拿到, 但也存在无法灵活配置, 很难做到密钥派生&#x2F;密钥交换类似的需求,  在main域或其他域上的密钥更换是非常频繁的, 频繁的更换密钥能够保证前向安全(即如果密钥被泄露, 那hack 监听到的以往的数据都会变得不再安全)和重放攻击等.  比如https中使用的ssl&#x2F;tls 加密机制, 每次建立连接后都是使用的新的密钥</li>
<li>芯片的安全ip采用的算法往往是对外公开的, 没有秘密可言. 相当于说是这种方案其实只有硬解加速的作用, 一旦密钥被探知, 那整个安全链路系统是非常脆弱的.</li>
<li>hsm上执行的程序, 中间过程会锁在安全rom 安全ram内, 这种hsm 上跑的软件上层的机制其实也是安全的. 而只有安全ip的方案, 无论是做驱动还是什么都可以被探知破解.</li>
</ol>
<h1 id="HSM在智能汽车中应用的场景"><a href="#HSM在智能汽车中应用的场景" class="headerlink" title="HSM在智能汽车中应用的场景"></a>HSM在智能汽车中应用的场景</h1>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/20/hxd%20new/%E6%B1%BD%E8%BD%A6%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3/HSM%20%E7%9B%B8%E5%85%B3%E6%8E%A2%E8%AE%A8/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liguangzhang.github.io/2022/04/19/hxd%20new/%E6%97%B6%E9%92%9F%E7%AE%A1%E7%90%86/stm32%20%E7%B3%BB%E5%88%97%E6%97%B6%E9%92%9F%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="liguang.zhang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/19/hxd%20new/%E6%97%B6%E9%92%9F%E7%AE%A1%E7%90%86/stm32%20%E7%B3%BB%E5%88%97%E6%97%B6%E9%92%9F%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">stm32 系列时钟相关.md</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-19 18:15:54" itemprop="dateCreated datePublished" datetime="2022-04-19T18:15:54+08:00">2022-04-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-16 10:49:19" itemprop="dateModified" datetime="2024-04-16T10:49:19+08:00">2024-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%B6%E9%92%9F/" itemprop="url" rel="index"><span itemprop="name">时钟</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2022/04/19/hxd%20new/%E6%97%B6%E9%92%9F%E7%AE%A1%E7%90%86/stm32%20%E7%B3%BB%E5%88%97%E6%97%B6%E9%92%9F%E7%9B%B8%E5%85%B3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/04/19/hxd%20new/%E6%97%B6%E9%92%9F%E7%AE%A1%E7%90%86/stm32%20%E7%B3%BB%E5%88%97%E6%97%B6%E9%92%9F%E7%9B%B8%E5%85%B3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="stm32WB55"><a href="#stm32WB55" class="headerlink" title="stm32WB55"></a>stm32WB55</h1><h2 id="规格"><a href="#规格" class="headerlink" title="规格"></a>规格</h2><p>STM32WB无线微控制器基于运行于64 MHz的Arm® Cortex®‐M4核心（应用处理器）和运行于32 MHz的Arm Cortex‐M0+核心（网络处理器）</p>
<p><img src="/../../images/Pasted%20image%2020220607165730.png"></p>
<p>时钟树 <a href="bookxnotepro://opennote/?nb={34cf70b6-6ce4-49b0-bba3-72f42203f190}&book=ea8590e4b931844be7d58e94dbae4280&page=194&x=312&y=97&id=1">195</a></p>
<ol>
<li>HSE 时钟<br>高速外部时钟信号(HSE)有2个时钟源 <a href="bookxnotepro://opennote/?nb={34cf70b6-6ce4-49b0-bba3-72f42203f190}&book=ea8590e4b931844be7d58e94dbae4280&page=195&x=211&y=119&id=3">196</a></li>
</ol>
<ul>
<li>HSE 外部晶振</li>
<li>HSE 用户外部时钟</li>
</ul>
<ol start="2">
<li><p>外部晶振（HSE晶振） [001](外部晶振（HSE 晶振）)<br>32 MHz 外部振荡器的优点是主时钟精度非常高</p>
</li>
<li><p>外部源（HSE旁路） <a href="bookxnotepro://opennote/?nb={34cf70b6-6ce4-49b0-bba3-72f42203f190}&book=ea8590e4b931844be7d58e94dbae4280&page=195&x=175&y=572&id=5">196</a><br>由于生产工艺和所使用的晶振不同，不同芯片的HSE振荡器频率也不同。用户可以通过写入RCC时钟HSE寄存器(RCC_HSECR)中的HSETUNE位来调整应用中的HSE频率。 <a href="bookxnotepro://opennote/?nb={34cf70b6-6ce4-49b0-bba3-72f42203f190}&book=ea8590e4b931844be7d58e94dbae4280&page=196&x=326&y=123&id=6">197</a></p>
</li>
<li><p>HSI16时钟 <a href="bookxnotepro://opennote/?nb={34cf70b6-6ce4-49b0-bba3-72f42203f190}&book=ea8590e4b931844be7d58e94dbae4280&page=196&x=154&y=196&id=7">197</a><br>HSI16 时钟信号是从 16 MHz 内部振荡器生成的。<br>HSI16 振荡器的优点是成本较低（无需使用外部元件）。此外，其启动速度也要比 HSE 晶振快，但即使校准后，其精度也不及外部晶振或陶瓷谐振器。</p>
</li>
</ol>
<p>HSI16时钟还可作为备份时钟源（辅助时钟）使用，以防HSE晶振发生故障 <a href="bookxnotepro://opennote/?nb={34cf70b6-6ce4-49b0-bba3-72f42203f190}&book=ea8590e4b931844be7d58e94dbae4280&page=196&x=326&y=283&id=8">197</a></p>
<ol start="5">
<li>MSI时钟 <a href="bookxnotepro://opennote/?nb={34cf70b6-6ce4-49b0-bba3-72f42203f190}&book=ea8590e4b931844be7d58e94dbae4280&page=196&x=148&y=550&id=9">197</a></li>
</ol>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/19/hxd%20new/%E6%97%B6%E9%92%9F%E7%AE%A1%E7%90%86/stm32%20%E7%B3%BB%E5%88%97%E6%97%B6%E9%92%9F%E7%9B%B8%E5%85%B3/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">liguang.zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">158</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">130</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liguang.zhang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'dark',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'VrGRp2q7WwXjxsCNmlDIZYbC-gzGzoHsz',
      appKey     : 'JgMXmmB7yKQf2zm80TaBp3JT',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
